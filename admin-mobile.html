
<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<title>لوحة الإدارة — MZJ Cars</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&amp;display=swap" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
<style>
  :root{
    --brown:#3e2420; --beige:#bc8f74; --cream:#fff8ef; --text:#1f2937; --muted:#6b7280;
    --line:#e5e7eb; --line-strong:#d1d5db; --table-head:#fafafa;
    --card:#fff; --radius:14px; --ok:#16a34a; --danger:#ef4444; --info:#0ea5e9;
    --shadow:0 10px 24px rgba(0,0,0,.06);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--cream);color:var(--text);font-family:"Tajawal",system-ui,Arial}

  /* Topbar + tabs + auth badge */
  .topbar{position:sticky;top:0;z-index:1000;background:#fff;border-bottom:1px solid var(--line)}
  .topbar-inner{max-width:1240px;margin:auto;display:flex;align-items:center;justify-content:space-between;padding:10px 16px}
  .brand{display:flex;align-items:center;gap:10px}
  .brand .logo{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,var(--brown),#2a1613);
    display:grid;place-items:center;color:#fff;font-weight:800}
  .brand h1{margin:0;font-size:18px;color:var(--brown)}
  .tabs{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-start}
  .tab{padding:8px 12px;border:1px solid var(--line);border-radius:999px;background:#fff;text-decoration:none;color:inherit;font-weight:800;font-size:13px}
  .tab.active{background:var(--brown);border-color:var(--brown);color:#fff}
  .status-badge{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--line);background:#fff;border-radius:12px;padding:6px 10px;font-size:12px}
  .dot{width:10px;height:10px;border-radius:999px;background:#f59e0b}
  .dot.ok{background:var(--ok)} .dot.err{background:var(--danger)} .dot.warn{background:#f59e0b}

  /* Buttons */
  .btn{position:relative;border:1px solid var(--line);background:#fff;border-radius:12px;padding:10px 14px;cursor:pointer;font-weight:700;display:inline-flex;gap:8px;align-items:center;transition:.15s;font-size:13px}
  .btn:hover{transform:translateY(-1px)} .btn:active{transform:translateY(0)}
  .btn-primary{background:var(--brown);border-color:var(--brown);color:#fff}
  .btn-beige{background:var(--beige);border-color:var(--beige);color:#fff}
  .btn-ghost{background:#fff}
  .btn-danger{background:var(--danger);border-color:var(--danger);color:#fff}
  .btn-outline{background:#fff;border:1px solid var(--brown);color:var(--brown)}

  /* Layout */
  .container{max-width:1240px;margin:18px auto;padding:0 16px 48px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;margin-bottom:16px}
  .card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;gap:12px;flex-wrap:wrap}
  .section-title{display:flex;align-items:center;gap:8px;margin:0}
  .section-title svg{width:20px;height:20px;color:var(--brown)}
  .hint{color:var(--muted);font-size:12px}

  /* Inputs */
  label{font-weight:800;margin-bottom:6px;display:block;color:var(--brown);font-size:13px}
  .input-wrap{position:relative}
  .input-wrap .i{position:absolute;right:10px;top:50%;transform:translateY(-50%);color:#9ca3af}
  .input-wrap input{padding-right:36px}
  input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:#fff;outline:none;transition:.15s;font-family:"Tajawal",system-ui,Arial;font-size:13px}
  input:focus,select:focus,textarea:focus{border-color:var(--beige);box-shadow:0 0 0 3px rgba(188,143,116,.15)}
  #vin{height:44px} #notes{height:44px;resize:none}
  textarea{min-height:44px;resize:vertical}

  /* Grid */
  .grid{display:grid;gap:12px}
  .grid-4{grid-template-columns:repeat(4,1fr)}
  .grid-3{grid-template-columns:repeat(3,1fr)}
  .grid-2{grid-template-columns:repeat(2,1fr)}
  @media (max-width:1080px){ .grid-4{grid-template-columns:repeat(3,1fr)} }
  @media (max-width:860px){ .grid-4,.grid-3{grid-template-columns:repeat(2,1fr)} }
  @media (max-width:620px){ .grid-4,.grid-3,.grid-2{grid-template-columns:1fr} }
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}

  /* Tables */
  .table-wrap{overflow:auto;border:1px solid var(--line);border-radius:14px;background:#fff}
  table{width:100%;border-collapse:separate;border-spacing:0}
  thead th{position:sticky;top:0;background:var(--table-head);z-index:2;border-bottom:1px solid var(--line-strong);
    text-align:right;color:#111827;font-size:13.5px;padding:12px 10px}
  tbody td{border-top:1px solid var(--line);padding:10px;vertical-align:top;font-size:13px}
  tbody tr:nth-child(odd){background:#fff}
  tbody tr:nth-child(even){background:#fcfcfc}
  tbody tr:hover{background:#f8fafc}
  td,th{border-left:1px solid var(--line)}
  td:last-child,th:last-child{border-left:0}
  .cell-actions{display:flex;gap:6px;flex-wrap:wrap}
  .nowrap{white-space:nowrap}
  .w-120{min-width:120px}
  .w-160{min-width:160px}

  /* Import dropdown */
  .import-menu{position:relative;display:inline-block}
  .import-dropdown{position:absolute;top:110%;left:0;background:#fff;border:1px solid var(--line);border-radius:12px;
    box-shadow:0 14px 28px rgba(0,0,0,.12);min-width:260px;z-index:20;display:none;overflow:hidden}
  .import-dropdown button{display:flex;gap:8px;align-items:center;width:100%;text-align:right;background:#fff;border:0;padding:12px 14px;cursor:pointer;font-weight:700;font-size:13px}
  .import-dropdown button:hover{background:#f9fafb}

  /* Modal */
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.38);display:none;align-items:center;justify-content:center;z-index:50}
  .modal{background:#fff;border-radius:16px;box-shadow:0 24px 60px rgba(0,0,0,.35);width:min(520px,92vw);padding:16px;border:1px solid var(--line)}
  .modal header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .modal h3{margin:0;font-size:18px;color:var(--brown)}
  .modal .actions{display:flex;gap:8px;justify-content:flex-start;margin-top:12px}

  /* Toast */
  .toast{position:fixed;bottom:16px;right:16px;background:#111827;color:#fff;padding:10px 14px;border-radius:12px;box-shadow:0 10px 24px rgba(0,0,0,.25);display:none;z-index:60;font-size:13px}
  .toast.ok{background:var(--ok)} .toast.info{background:var(--info)} .toast.err{background:var(--danger)}

  /* Auth */
  .auth-wrap{min-height:60vh;display:grid;place-items:center;padding:24px}
  .auth-card{background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);padding:18px;max-width:420px;width:96%}
  .auth-card h2{margin:0 0 10px;color:var(--brown)}
  .auth-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}

  /* Checklist box */
  .checklist{border:1px dashed var(--beige);border-radius:12px;padding:12px;background:#fff8ef}
  .checklist h4{margin:0 0 8px 0;color:var(--brown);font-size:14px}
  .check-row{display:grid;grid-template-columns:18px 1fr;gap:8px;align-items:start}
  .check-row label{margin:0;display:flex;align-items:center;gap:8px;font-weight:600;font-size:13px}

  /* حركة النقل: صفوف متعددة */
  .move-row{border:1px dashed #e5e7eb;border-radius:10px;padding:8px 10px;background:#fffbf7}
  .move-row-title{font-size:12px;color:var(--muted);margin-bottom:4px;font-weight:600}

  /* إشعار حركة النقل */
  .move-alert{
    margin-top:10px;
    padding:10px 12px;
    border-radius:12px;
    display:none;
    align-items:flex-start;
    gap:10px;
    font-size:13px;
  }
  .move-alert .icon{
    margin-top:3px;
    font-size:16px;
  }
  .move-alert .title{
    font-weight:800;
    margin-bottom:4px;
    font-size:13.5px;
  }
  .move-alert ul{
    margin:0;
    padding-right:18px;
    list-style:disc;
  }
  .move-alert.success{
    background:#ecfdf3;
    border:1px solid #bbf7d0;
    color:#14532d;
  }
  .move-alert.error{
    background:#fef2f2;
    border:1px solid #fecaca;
    color:#991b1b;
  }
  .move-alert.info{
    background:#eff6ff;
    border:1px solid #bfdbfe;
    color:#1d4ed8;
  }

  .copyable{cursor:pointer;text-decoration:underline;text-decoration-style:dotted}

  
  .inner-tabs{
    display:grid;
    grid-template-columns:repeat(2,minmax(0,1fr));
    gap:8px;
    margin-bottom:16px;
  }
  .inner-tab{
    border:1px solid var(--line);
    background:#fff;
    padding:8px 10px;
    border-radius:999px;
    font-size:13px;
    cursor:pointer;
    color:var(--text);
    font-weight:800;
    text-align:center;
  }
  .inner-tab.active{
    background:var(--brown);
    color:#fff;
    border-color:var(--brown);
  }
  .inner-tab-panel{display:none;}
  .inner-tab-panel.active{display:block;}
ab-panel.active{display:block;}

  .move-row-title{
    font-weight:600;
    margin-bottom:4px;
    color:var(--brown);
  }
  .move-notes{
    width:100%;
    min-height:48px;
    resize:vertical;
  }


  .notes-col{
    display:none;
  }

  /* موبايل: تنسيق خاص لتبويب تعديل السيارات (جدول خفيف + كارت تفاصيل) */
  @media (max-width: 768px){
    /* إخفاء الأعمدة الثانوية في جدول تعديل السيارات */
    #tab-edit table#carsTable th:nth-child(4),
    #tab-edit table#carsTable td:nth-child(4), /* اللون الخارجي */
    #tab-edit table#carsTable th:nth-child(5),
    #tab-edit table#carsTable td:nth-child(5), /* اللون الداخلي */
    #tab-edit table#carsTable th:nth-child(6),
    #tab-edit table#carsTable td:nth-child(6), /* موديل */
    #tab-edit table#carsTable th:nth-child(7),
    #tab-edit table#carsTable td:nth-child(7), /* اللوحة */
    #tab-edit table#carsTable th:nth-child(9),
    #tab-edit table#carsTable td:nth-child(9), /* اسم الدفعة */
    #tab-edit table#carsTable th:nth-child(11),
    #tab-edit table#carsTable td:nth-child(11), /* الملاحظات */
    #tab-edit table#carsTable th:nth-child(12),
    #tab-edit table#carsTable td:nth-child(12) /* تحكم (أزرار) */
    {
      display:none;
    }

    #tab-edit .table-wrap{
      overflow-x:hidden;
    }
    #tab-edit table#carsTable{
      width:100%;
      font-size:11px;
    }
    #tab-edit thead th,
    #tab-edit tbody td{
      padding:6px 4px;
      white-space:normal;
    }
  }

  /* كارت تفاصيل السيارة المختارة في تبويب تعديل السيارات */
  .edit-details-card{
    margin-top:10px;
  }
  .edit-details-card .card{
    border-style:dashed;
  }
  .edit-details-card .card-body{
    display:flex;
    flex-direction:column;
    gap:6px;
    font-size:12px;
  }
  .edit-detail-row{
    display:flex;
    justify-content:space-between;
    gap:8px;
  }
  .edit-detail-label{
    color:var(--muted);
    font-weight:500;
  }
  .edit-detail-value{
    font-weight:700;
    color:var(--text);
    text-align:left;
    direction:ltr;
  }
  
  .edit-detail-input,
  .edit-detail-select,
  .edit-detail-textarea{
    flex:1;
    border:1px solid var(--line);
    border-radius:8px;
    padding:4px 8px;
    font-size:12px;
    min-width:0;
  }
  .edit-detail-textarea{
    resize:vertical;
    min-height:48px;
  }
.edit-card-actions{
    margin-top:10px;
    padding-top:8px;
    border-top:1px dashed var(--line);
    display:flex;
    flex-direction:column;
    gap:6px;
  }

  /* ===== موبايل: تحويل صفوف جدول تعديل السيارات إلى كروت ===== */
  @media (max-width: 768px){
    #tab-edit .table-wrap{
      overflow-x:visible;
    }
    #tab-edit table{
      width:100%;
      border-collapse:separate;
      border-spacing:0 12px;
    }
    #tab-edit thead{
      display:none;
    }
    #tab-edit tbody tr{
      display:block;
      background:#ffffff;
      border-radius:16px;
      padding:10px 12px;
      box-shadow:0 12px 30px rgba(15,23,42,0.12);
      border:1px solid rgba(148,163,184,0.5);
    }
    #tab-edit tbody td{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      padding:4px 0;
      font-size:12px;
      border:none;
    }
    #tab-edit tbody td strong{
      font-size:13px;
    }
    #tab-edit tbody td::before{
      flex:0 0 auto;
      margin-left:6px;
      color:#9a7a54;
      font-size:11px;
      font-weight:600;
    }
    #tab-edit tbody td:nth-child(1)::before{ content:"السيارة"; }
    #tab-edit tbody td:nth-child(2)::before{ content:"البيان"; }
    #tab-edit tbody td:nth-child(3)::before{ content:"الوكيل"; }
    #tab-edit tbody td:nth-child(4)::before{ content:"اللون الخارجي"; }
    #tab-edit tbody td:nth-child(5)::before{ content:"اللون الداخلي"; }
    #tab-edit tbody td:nth-child(6)::before{ content:"الموديل"; }
    #tab-edit tbody td:nth-child(7)::before{ content:"اللوحة"; }
    #tab-edit tbody td:nth-child(8)::before{ content:"المكان"; }
    #tab-edit tbody td:nth-child(9)::before{ content:"اسم الدفعة"; }
    #tab-edit tbody td:nth-child(10)::before{ content:"رقم الهيكل"; }
    #tab-edit tbody td:nth-child(11)::before{ content:"الملاحظات"; }
    #tab-edit tbody td:nth-child(12)::before{ content:"التحكم"; }
    #tab-edit tbody td:last-child{
      margin-top:6px;
      padding-top:8px;
      border-top:1px dashed rgba(148,163,184,0.6);
      justify-content:flex-start;
    }
    #tab-edit tbody td:last-child::before{
      margin-left:10px;
    }
    #tab-edit tbody td .cell-actions{
      width:100%;
      display:flex;
      justify-content:flex-start;
      gap:8px;
    }
  }

  @media (max-width:768px){
    .card-header .row{
      flex-wrap:wrap;
      gap:8px;
    }
    .card-header .row > *{
      margin-bottom:4px;
    }
    .import-menu{
      display:inline-flex;
      align-items:center;
    }
    .import-dropdown{
      min-width:220px;
      right:0;
      left:auto;
    }
  }
</style>
<style id="noFlash">
  html{background:#fff8ef;}
  body{opacity:0;}
</style>

<style>
  .mobile-shell{
    width:100%;
    max-width:480px;
    margin:0 auto;
    min-height:100vh;
    display:flex;
    flex-direction:column;
    background:radial-gradient(circle at top left, rgba(252,211,77,.12), transparent 55%) #020617;
    border-left:1px solid rgba(15,23,42,.95);
    border-right:1px solid rgba(15,23,42,.95);
  }
  .topbar-mobile{
    position:sticky;
    top:0;
    z-index:20;
    background:rgba(2,6,23,.96);
    backdrop-filter:blur(16px);
    border-bottom:1px solid rgba(30,64,175,.45);
  }
  .topbar-inner-mobile{
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:10px 14px;
    gap:10px;
  }
  .topbar-brand-mobile{
    display:flex;
    align-items:center;
    gap:8px;
  }
  .brand-mark-mobile{
    width:26px;
    height:26px;
    border-radius:999px;
    background:radial-gradient(circle at 30% 0,#facc6b,#b45309 45%,#111827 100%);
    display:grid;
    place-items:center;
    font-size:13px;
    font-weight:800;
    color:#111827;
    box-shadow:0 0 18px rgba(250,204,21,.9);
  }
  .brand-text-mobile{
    display:flex;
    flex-direction:column;
    gap:1px;
  }
  .brand-text-mobile .main{
    font-size:13px;
    color:#f9fafb;
    font-weight:700;
  }
  .brand-text-mobile .sub{
    font-size:10px;
    color:#9ca3af;
  }
  .topbar-actions-mobile{
    display:flex;
    align-items:center;
    gap:6px;
  }
  .chip-live-mobile{
    display:inline-flex;
    align-items:center;
    gap:4px;
    padding:3px 8px;
    border-radius:999px;
    border:1px solid rgba(55,65,81,1);
    background:rgba(15,23,42,.98);
    font-size:10px;
    color:#e5e7eb;
  }
  .chip-live-dot-mobile{
    width:8px;
    height:8px;
    border-radius:999px;
    background:#22c55e;
    box-shadow:0 0 10px rgba(34,197,94,.95);
  }
  .btn-icon-mobile{
    border:none;
    outline:none;
    padding:7px 9px;
    border-radius:999px;
    background:rgba(15,23,42,.96);
    border:1px solid rgba(55,65,81,.95);
    color:#e5e7eb;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    font-size:16px;
    cursor:pointer;
    transition:transform .12s ease, box-shadow .12s ease, background .12s ease, border-color .12s ease;
  }
  .btn-icon-mobile:hover{
    background:rgba(15,23,42,1);
    border-color:rgba(148,163,184,.9);
    box-shadow:0 10px 28px rgba(0,0,0,.8);
  }
  .btn-icon-mobile:active{
    transform:scale(.96);
    box-shadow:none;
  }
  .mobile-content{
    flex:1;
    position:relative;
    overflow:hidden;
  }
  .mobile-scroll{
    height:100%;
    overflow-y:auto;
    padding:10px 10px 14px;
    scrollbar-width:thin;
    scrollbar-color:rgba(148,163,184,.8) transparent;
  }
  .mobile-scroll::-webkit-scrollbar{
    width:6px;
  }
  .mobile-scroll::-webkit-scrollbar-track{
    background:transparent;
  }
  .mobile-scroll::-webkit-scrollbar-thumb{
    background:rgba(148,163,184,.8);
    border-radius:999px;
  }
  .drawer-backdrop{
    position:fixed;
    inset:0;
    background:rgba(15,23,42,.7);
    backdrop-filter:blur(4px);
    z-index:40;
    opacity:0;
    pointer-events:none;
    transition:opacity .18s ease-out;
  }
  .drawer-backdrop.visible{
    opacity:1;
    pointer-events:auto;
  }
  .drawer-panel{
    position:fixed;
    top:0;
    right:0;
    height:100vh;
    width:min(280px,82vw);
    background:radial-gradient(circle at top left, rgba(250,204,21,.15), transparent 55%) #020617;
    box-shadow:-12px 0 40px rgba(0,0,0,.9);
    border-left:1px solid rgba(30,64,175,.55);
    z-index:50;
    display:flex;
    flex-direction:column;
    transform:translateX(100%);
    transition:transform .22s cubic-bezier(.22,.61,.36,1);
  }
  .drawer-panel.open{
    transform:translateX(0);
  }
  .drawer-header{
    padding:12px 14px 8px;
    border-bottom:1px solid rgba(31,41,55,1);
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:8px;
  }
  .drawer-title{
    display:flex;
    flex-direction:column;
    gap:2px;
  }
  .drawer-title .main{
    font-size:14px;
    font-weight:700;
    color:#f9fafb;
  }
  .drawer-title .sub{
    font-size:11px;
    color:#9ca3af;
  }
  .drawer-close-btn{
    border:none;
    outline:none;
    padding:6px 8px;
    border-radius:999px;
    background:rgba(15,23,42,.98);
    border:1px solid rgba(55,65,81,.95);
    color:#e5e7eb;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    font-size:14px;
    cursor:pointer;
    transition:background .12s ease, transform .12s ease, box-shadow .12s ease;
  }
  .drawer-close-btn:hover{
    background:rgba(15,23,42,1);
    box-shadow:0 10px 26px rgba(0,0,0,.85);
  }
  .drawer-close-btn:active{
    transform:scale(.96);
    box-shadow:none;
  }
  .drawer-body{
    flex:1;
    overflow-y:auto;
    padding:8px 8px 12px;
  }
  .drawer-section-label{
    margin:4px 4px 6px;
    font-size:11px;
    color:#9ca3af;
  }
  .menu-list{
    list-style:none;
    padding:0;
    margin:0;
    display:flex;
    flex-direction:column;
    gap:4px;
  }
  .menu-item{border-radius:999px;overflow:hidden;}
  .menu-link{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:6px;
    padding:8px 10px;
    font-size:13px;
    color:#e5e7eb;
    text-decoration:none;
    background:rgba(15,23,42,.96);
    border:1px solid rgba(51,65,85,1);
    transition:background .12s ease, border-color .12s ease, transform .1s ease, box-shadow .12s ease;
  }
  .menu-link-main{
    display:inline-flex;
    align-items:center;
    gap:8px;
  }
  .menu-icon{
    width:22px;
    height:22px;
    border-radius:999px;
    background:radial-gradient(circle at 30% 0,#facc6b,#b45309 60%,#111827 100%);
    display:grid;
    place-items:center;
    font-size:12px;
    color:#111827;
    box-shadow:0 0 10px rgba(250,204,21,.85);
  }
  .menu-text-main{
    display:flex;
    flex-direction:column;
    gap:1px;
  }
  .menu-text-main .title{
    font-size:13px;
    font-weight:600;
  }
  .menu-text-main .desc{
    font-size:10px;
    color:#9ca3af;
  }
  .menu-link-arrow{
    font-size:12px;
    color:#9ca3af;
  }
  .menu-link:hover{
    background:rgba(15,23,42,1);
    border-color:rgba(148,163,184,.9);
    transform:translateY(-1px);
    box-shadow:0 12px 30px rgba(0,0,0,.95);
  }
  .menu-link.active{
    background:radial-gradient(circle at top left, rgba(250,204,21,.2), transparent 55%) #0b1120;
    border-color:rgba(250,204,21,.85);
    box-shadow:0 0 18px rgba(250,204,21,.45),0 14px 36px rgba(0,0,0,.95);
  }
  .menu-link.logout{
    background:rgba(127,29,29,.96);
    border-color:rgba(248,113,113,.9);
  }
  .menu-link.logout:hover{
    background:rgba(153,27,27,1);
    box-shadow:0 14px 34px rgba(127,29,29,.95);
  }
  .drawer-footer{
    padding:8px 10px 10px;
    border-top:1px solid rgba(31,41,55,1);
    font-size:10px;
    color:#6b7280;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:6px;
  }
  .drawer-footer .label-strong{
    color:#e5e7eb;
  }
  body.drawer-open{
    overscroll-behavior:none;
  }

  /* صغّر container للموبايل */
  @media (max-width: 768px){
    .container{
      max-width:100%;
      padding-inline:0;
      margin-inline:0;
    }
  }
</style>

</head>

<body>
<div class="mobile-shell">
  <!-- ===== Top Bar (Mobile) ===== -->
  <header class="topbar-mobile">
    <div class="topbar-inner-mobile">
      <div class="topbar-brand-mobile">
        <div class="brand-mark-mobile">★</div>
        <div class="brand-text-mobile">
          <span class="main">نجم الطريق</span>
          <span class="sub">لوحة الإدارة · نسخة التليفون</span>
        </div>
      </div>
      <div class="topbar-actions-mobile">
        <div class="chip-live-mobile">
          <span class="chip-live-dot-mobile" id="connDot"></span>
          <span id="connText">جارِ الاتصال…</span>
        </div>
        <button class="btn btn-ghost" id="btnSignOut" style="display:none;font-size:11px;padding:4px 9px;margin-left:6px">
          تسجيل الخروج
        </button>
        <button class="btn-icon-mobile" id="btnOpenDrawer" aria-label="فتح القائمة">
          ☰
        </button>
      </div>
    </div>
  </header>

  <!-- ===== Content Area ===== -->
  <main class="mobile-content">
    <div class="mobile-scroll">
<!-- Auth Gate -->
<div class="auth-wrap" id="authGate">
<div class="auth-card">
<h2>تسجيل الدخول</h2>
<label for="email">البريد الإلكتروني</label>
<input id="email" placeholder="you@example.com" type="email"/>
<label for="password" style="margin-top:8px">كلمة المرور</label>
<input id="password" placeholder="••••••••" type="password"/>
<div class="auth-actions">
<button class="btn btn-primary" id="btnLogin">تسجيل الدخول</button>
<button class="btn btn-outline" id="btnSignup">إنشاء حساب</button>
</div>
<p class="hint" id="authHint" style="margin-top:10px"></p>
</div>
</div>
<!-- App -->
<div id="app" style="display:none">
<div class="container">
<div class="inner-tabs">
<button class="inner-tab active" data-target="tab-add">إضافة سيارة</button>
<button class="inner-tab" data-target="tab-move">نقل السيارات</button>
<button class="inner-tab" data-target="tab-edit">تعديل السيارات</button>
<button class="inner-tab" data-target="tab-track">تتبع حركة رقم هيكل</button>
<button class="inner-tab" data-target="tab-log">سجل الحركات</button>
</div>
<div class="inner-tab-panel active" id="tab-add">
<div class="card">
<div class="card-header">
<div class="section-title">
<svg fill="none" stroke="currentColor" viewbox="0 0 24 24"><rect height="7" width="7" x="3" y="3"></rect><rect height="7" width="7" x="14" y="3"></rect><rect height="7" width="7" x="14" y="14"></rect><rect height="7" width="7" x="3" y="14"></rect></svg>
<h2 style="margin:0">إضافة سيارة</h2>
</div>
<div class="row">
<button class="btn btn-ghost" id="btnExport" title="تصدير إلى Excel">
<i class="fa-regular fa-file-excel"></i> تصدير
          </button>
<!--الجديد: زر تصدير قالب  -->
<button class="btn btn-ghost" id="btnExportBlank" title="تصدير قالب">
<i class="fa-regular fa-file"></i> تصدير قالب
          </button>
<div class="import-menu">
<button class="btn btn-ghost" id="btnImportMenu" title="استيراد من Excel">
<i class="fa-solid fa-file-import"></i> استيراد ▾
            </button>
<div class="import-dropdown" id="importDropdown">
<button data-mode="replace"><i class="fa-solid fa-arrow-rotate-left"></i> استبدال كامل (مسح القديم + إضافة الجديد)</button>
<button data-mode="append"><i class="fa-solid fa-plus"></i> إضافة فوق الحالي (بدون مسح)</button>
</div>
</div>
<input accept=".xlsx,.xls,.csv" id="fileImport" style="display:none" type="file"/>
</div>
</div>
<div class="grid grid-4">
<div>
<label for="carSelect">سيارة</label>
<div class="row" style="gap:8px;align-items:stretch">
<select id="carSelect" title="اختر السيارة"></select>
<button class="btn btn-outline" id="btnAddModel" title="إضافة موديل جديد">
<i class="fa-solid fa-plus"></i> موديل
            </button>
</div>
</div>
<div>
<label for="variantSelect">البيان</label>
<div class="row" style="gap:8px;align-items:stretch">
<select id="variantSelect" title="اختر البيان"></select>
<button class="btn btn-outline" id="btnAddVariant" title="إضافة بيان وربطه بسيارة">
<i class="fa-solid fa-plus"></i> بيان
            </button>
</div>
<div class="hint">يمكنك إضافة بيان جديد وربطه بأي سيارة</div>
</div>
<div><label for="dealer">الوكيل</label>
<div class="input-wrap">
<span class="i"><i class="fa-regular fa-building"></i></span>
<input id="dealer" placeholder="اسم الوكيل"/>
</div>
</div>
<div><label for="extColor">اللون الخارجي</label>
<div class="input-wrap">
<span class="i"><i class="fa-regular fa-circle"></i></span>
<input id="extColor" placeholder="أبيض / أسود ..."/>
</div>
</div>
<div><label for="intColor">اللون الداخلي</label>
<div class="input-wrap">
<span class="i"><i class="fa-regular fa-square"></i></span>
<input id="intColor" placeholder="جملي / أسود ..."/>
</div>
</div>
<div><label for="modelYear">موديل</label>
<div class="input-wrap">
<span class="i"><i class="fa-regular fa-calendar"></i></span>
<input id="modelYear" max="2100" min="2000" placeholder="2026" type="number"/>
</div>
</div>
<div><label for="plate">اللوحة</label>
<div class="input-wrap">
<span class="i"><i class="fa-regular fa-id-card"></i></span>
<input id="plate" placeholder="اختياري"/>
</div>
</div>
<!-- المكان: قائمة منسدلة ثابتة -->
<div>
<label for="location">المكان</label>
<select id="location" title="اختر المكان">
<option value="المستودع : المخزون المتاح">المستودع : المخزون المتاح</option>
<option value="المستودع : سيارات بها ملاحظات">المستودع : سيارات بها ملاحظات</option>
<option value="المستودع : مباع تحت التسليم">المستودع : مباع تحت التسليم</option>
<option value="المستودع : مباع تم التسليم">المستودع : مباع تم التسليم</option>
<option value="الوكالة : المخزون المتاح">الوكالة : المخزون المتاح</option>
<option value="الوكالة : سيارات بها ملاحظات">الوكالة : سيارات بها ملاحظات</option>
<option value="الوكالة : مباع تحت التسليم">الوكالة : مباع تحت التسليم</option>
<option value="الوكالة : مباع تم التسليم">الوكالة : مباع تم التسليم</option>
<option value="فرع 1 الصالة : المخزون المتاح">فرع 1 الصالة : المخزون المتاح</option>
<option value="فرع 1 الصالة : سيارات بها ملاحظات">فرع 1 الصالة : سيارات بها ملاحظات</option>
<option value="فرع 1 الصالة : مباع تحت التسليم">فرع 1 الصالة : مباع تحت التسليم</option>
<option value="فرع 1 الصالة : مباع تم التسليم">فرع 1 الصالة : مباع تم التسليم</option>
<option value="فرع 2 الملتقى : المخزون المتاح">فرع 2 الملتقى : المخزون المتاح</option>
<option value="فرع 2 الملتقى : سيارات بها ملاحظات">فرع 2 الملتقى : سيارات بها ملاحظات</option>
<option value="فرع 2 الملتقى : مباع تحت التسليم">فرع 2 الملتقى : مباع تحت التسليم</option>
<option value="فرع 2 الملتقى : مباع تم التسليم">فرع 2 الملتقى : مباع تم التسليم</option>
<option value="فرع 3 القادسية : المخزون المتاح">فرع 3 القادسية : المخزون المتاح</option>
<option value="فرع 3 القادسية : سيارات بها ملاحظات">فرع 3 القادسية : سيارات بها ملاحظات</option>
<option value="فرع 3 القادسية : مباع تحت التسليم">فرع 3 القادسية : مباع تحت التسليم</option>
<option value="فرع 3 القادسية : مباع تم التسليم">فرع 3 القادسية : مباع تم التسليم</option>
</select>
</div>
<div><label for="batchName">اسم الدفعة</label>
<div class="input-wrap">
<span class="i"><i class="fa-solid fa-layer-group"></i></span>
<input id="batchName" placeholder="دفعة رمضان / نوفمبر 2025…"/>
</div>
</div>
<div><label for="vin">رقم الهيكل</label>
<div class="input-wrap">
<span class="i"><i class="fa-solid fa-barcode"></i></span>
<input id="vin" placeholder="LVR.../KMH.../رقم"/>
</div>
</div>
<div class="grid" style="grid-template-columns:1fr">
<label for="notes">الملاحظات</label>
<textarea id="notes" placeholder="ملاحظات إضافية — نفس ارتفاع رقم الهيكل"></textarea>
</div>
</div>
<div class="row" style="margin-top:12px">
<button class="btn btn-primary" id="btnSave" title="حفظ (Ctrl+S)">
<i class="fa-regular fa-floppy-disk"></i> حفظ
        </button>
<button class="btn btn-ghost" id="btnReset" title="تفريغ الحقول (Esc)">
<i class="fa-solid fa-rotate"></i> تفريغ
        </button>
<div class="hint"></div>
</div>
</div>
</div>
<div class="inner-tab-panel" id="tab-move">
<div class="card">
<div class="card-header">
<div class="section-title">
<svg fill="none" stroke="currentColor" viewbox="0 0 24 24"><path d="M7 10l5-5 5 5"></path><path d="M7 14l5 5 5-5"></path></svg>
<h2 style="margin:0">حركة نقل السيارات (برقم الهيكل)</h2>
</div>
<span class="hint"> <b></b> </span>
<div class="row" style="gap:8px;align-items:center;flex-wrap:wrap"><label>إلى</label><select id="moveToGlobal" title="المكان الجديد"></select></div></div>
<!-- 8 صفوف نقل -->
<div class="row" style="margin:8px 0 12px;gap:8px;align-items:center;flex-wrap:wrap"><button class="btn btn-ghost" id="btnAddMoveRow" type="button"><i class="fa-solid fa-plus"></i> إضافة حركة أخرى</button></div><div class="grid" id="moveRowsContainer" style="gap:10px"></div>
<!-- datalist للاقتراحات -->
<datalist id="vinHints"></datalist>
<!-- Checklist يظهر فقط مع 'مباع تحت التسليم' -->
<div class="checklist" id="underDeliveryBox" style="display:none; margin-top:10px">
<h4>المتطلبات عند النقل إلى <b>مباع تحت التسليم</b></h4>
<div class="grid grid-2">
<div>
<div class="check-row">
<input id="chkAdminApproved" type="checkbox"/>
<label for="chkAdminApproved">موافقة إدارية</label>
</div>
<label for="adminNotes" style="margin-top:6px">ملاحظات الموافقة الإدارية</label>
<textarea id="adminNotes" placeholder="اكتب أي ملاحظات إدارية…"></textarea>
</div>
<div>
<div class="check-row">
<input id="chkFinanceApproved" type="checkbox"/>
<label for="chkFinanceApproved">موافقة مالية</label>
</div>
<label for="financeNotes" style="margin-top:6px">ملاحظات الموافقة المالية</label>
<textarea id="financeNotes" placeholder="اكتب أي ملاحظات مالية…"></textarea>
</div>
</div>
</div>
<!-- ملاحظات سيارات بها ملاحظات -->
<div class="row" style="margin-top:12px">
<button class="btn btn-ghost" id="btnFindByVin" title="عرض بيانات السيارة (أول سطر غير فارغ)">
<i class="fa-solid fa-magnifying-glass"></i> عرض البيانات
        </button>
<button class="btn btn-primary" id="btnMove" title="تنفيذ النقل">
<i class="fa-solid fa-right-left"></i> نقل
        </button>
</div>
<p class="hint" id="moveStatus" style="margin-top:8px"></p>
<!-- إشعار حركة النقل الكبير -->
<div class="move-alert" id="moveAlert">
<div class="icon">
<i class="fa-solid fa-circle-check"></i>
</div>
<div>
<div class="title" id="moveAlertTitle">نتيجة حركة النقل</div>
<ul id="moveAlertList"></ul>
</div>
</div>
<!-- بطاقة عرض بيانات السيارة -->
<div class="card" id="carDetailsBox" style="display:none;margin-top:12px">
<div class="section-title">
<svg fill="none" stroke="currentColor" viewbox="0 0 24 24"><rect height="16" rx="2" width="18" x="3" y="4"></rect><path d="M7 8h10"></path></svg>
<h2 style="margin:0">عرض بيانات السيارة</h2>
</div>
<div class="grid grid-2" id="carDetails" style="margin-top:8px"></div>
<p class="hint" id="carDetailsHint" style="margin-top:8px"></p>
</div>
</div>
</div>
<div class="inner-tab-panel" id="tab-edit">
<div class="card">
<div class="card-header">
<div class="section-title">
<svg fill="none" stroke="currentColor" viewbox="0 0 24 24"><rect height="16" rx="2" width="18" x="3" y="4"></rect><path d="M7 8h10"></path></svg>
<h2 style="margin:0">تعديل السيارات</h2>
</div>
<span class="hint"></span>
</div>
<div class="row" style="gap:8px;margin-bottom:8px">
<input id="search" placeholder="بحث سريع (سيارة / البيان / الوكيل / الألوان / الموديل / اللوحة / المكان / اسم الدفعة / رقم الهيكل)" style="flex:1; padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:#fff" title="اضغط / للبحث"/>
<button class="btn btn-ghost" id="btnClearSearch" title="مسح البحث">
<i class="fa-solid fa-minus"></i> مسح
        </button>
</div>
<div class="table-wrap">
<table id="carsTable">
<thead>
<tr>
<th>سيارة</th>
<th>البيان</th>
<th>الوكيل</th>
<th>اللون الخارجي</th>
<th>اللون الداخلي</th>
<th>موديل</th>
<th>اللوحة</th>
<th>المكان</th>
<th>اسم الدفعة</th>
<th>رقم الهيكل</th>
<th>الملاحظات</th>
<th class="w-160">تحكم</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
<div id="editCarDetailsCard" class="edit-details-card" style="display:none">
  <div class="card">
    <div class="card-header">
      <div class="section-title">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 7h16M4 12h10M4 17h7" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"></path></svg>
        <h3 style="margin:0">تفاصيل السيارة المختارة</h3>
      </div>
      <button class="btn btn-ghost" id="btnCloseEditDetails" type="button" style="font-size:12px;padding:4px 10px">
        إخفاء
      </button>
    </div>
    <div class="card-body" id="editCarDetailsBody">
      <!-- يتم تعبئة التفاصيل عند اختيار صف من الجدول -->
    </div>
    <div class="edit-card-actions">
      <span class="hint">أزرار التحكم من نفس الصف:</span>
      <div id="editCarActionsContainer"></div>
    </div>
  </div>
</div>

<p class="hint">الحفظ يتم مباشرة على Firestore.</p>
</div>
</div>
<div class="inner-tab-panel" id="tab-track">
<div class="card">
<div class="card-header">
<div class="section-title">
<svg fill="none" stroke="currentColor" viewbox="0 0 24 24"><path d="M12 8v8M8 12h8"></path></svg>
<h2 style="margin:0">تتبّع حركة رقم هيكل</h2>
</div>
<div class="row" style="gap:8px">
<input id="trackVin" list="vinHints" placeholder="اكتب رقم الهيكل لعرض جميع حركاته"/>
<button class="btn btn-ghost" id="btnClearTrack">مسح</button>
</div>
</div>
<div class="table-wrap">
<table id="trackTable">
<thead>
<tr>
<th class="w-120">#</th>
<th class="w-120">التاريخ</th>
<th>من</th>
<th>إلى</th>
<th>سيارة</th>
<th class="w-160">ملاحظات النقل</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
<p class="hint"></p>
</div>
</div>
<div class="inner-tab-panel" id="tab-log">
<div class="card">
<div class="card-header">
<div class="section-title" style="margin-bottom:0">
<svg fill="none" stroke="currentColor" viewbox="0 0 24 24"><path d="M3 5h18M3 12h18M3 19h18"></path></svg>
<h2 style="margin:0">سجل الحركات</h2>
</div>
<div class="row">
<div class="row">
<label style="margin:0 6px 0 0">تاريخ من</label>
<input id="movesFromDate" type="date"/>
</div>
<div class="row">
<label style="margin:0 6px 0 0">إلى</label>
<input id="movesToDate" type="date"/>
</div>
<button class="btn btn-ghost" id="btnClearDate">مسح التاريخ</button>
</div>
</div>
<div class="table-wrap">
<table id="movesTable">
<thead>
<tr>
<th class="w-10">#</th>
<th class="w-10">التاريخ</th>
<th>رقم الهيكل</th>
<th>سيارة</th>
<th>من</th>
<th>إلى</th>
<th class="w-10">ID</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
<div class="row" style="margin-top:6px">
<button class="btn btn-ghost" id="btnClearMoves" title="تفريغ السجل">
<i class="fa-regular ف-trash-can"></i> تفريغ
        </button>
</div>
</div>
</div>
</div>
<!-- Modals -->
<!-- إضافة موديل -->
<div class="modal-backdrop" id="modelModal">
<div aria-modal="true" class="modal" role="dialog">
<header>
<h3>إضافة موديل جديد</h3>
<button class="btn btn-ghost" data-close="modelModal"><i class="fa-solid fa-xmark"></i></button>
</header>
<label for="modelName">اسم الموديل</label>
<input id="modelName" placeholder="هيونداي توسان 2026 / سنتافي…"/>
<div class="actions">
<button class="btn btn-primary" id="confirmAddModel"><i class="fa-solid fa-check"></i> إضافة</button>
<button class="btn" data-close="modelModal">إلغاء</button>
</div>
</div>
</div>
<!-- إضافة بيان -->
<div class="modal-backdrop" id="variantModal">
<div aria-modal="true" class="modal" role="dialog">
<header>
<h3>إضافة بيان وربطه بموديل</h3>
<button class="btn btn-ghost" data-close="variantModal"><i class="fa-solid fa-xmark"></i></button>
</header>
<label for="variantModelFor">الموديل</label>
<select id="variantModelFor"></select>
<label for="variantName" style="margin-top:8px">اسم البيان</label>
<input id="variantName" placeholder="كومفورت / سمارت / رويال…"/>
<div class="actions">
<button class="btn btn-primary" id="confirmAddVariant"><i class="fa-solid fa-check"></i> إضافة</button>
<button class="btn" data-close="variantModal">إلغاء</button>
</div>
</div>
</div>
<!-- Toast -->
<div class="toast" id="toast"></div>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

  /* ===== Firebase ===== */
  const firebaseConfig = {
    apiKey: "AIzaSyC614bGqnYf4Q-weTNemzWENTpa8DjGeHw",
    authDomain: "mzj-agenda.firebaseapp.com",
    projectId: "mzj-agenda",
    storageBucket: "mzj-agenda.firebasestorage.app",
    messagingSenderId: "834700407721",
    appId: "1:834700407721:web:75c17665d4f032fd65cab8"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);
  const STATE_REF = doc(db, "mzj_admin_state", "v1");
  /* ===== Roles & Permissions (Firestore) ===== */
  const ROLE_ADMIN   = 'الادارة';
  const ROLE_IDARI   = 'اداري';
  const ROLE_BRANCH  = 'مدراء فروع';

  // هذه الصفحة admin.html مسموحة فقط لتصنيف "الادارة"
  const PAGE_ALLOWED_ROLES = [ROLE_ADMIN];

  async function fetchUserRole(user){
    try{
      // ملاحظة: الكولكشن اسمه "user" (مفرد) حسب إعدادك في Firestore
      const userDocRef = doc(db, 'user', user.uid);
      const snap = await getDoc(userDocRef);
      if(snap.exists()){
        const data = snap.data() || {};
        return data.role || null;
      }
      return null;
    }catch(err){
      console.error('Error fetching user role:', err);
      return null;
    }
  }


  /* ===== Helpers / State ===== */
  const $ = s => document.querySelector(s);
  const toast = $('#toast');
  function showToast(msg,type='ok'){toast.textContent=msg;toast.className='toast '+type;toast.style.display='block';setTimeout(()=>toast.style.display='none',1800)}
  function pad(n){return n<10?'0'+n:n}
  function now(){const d=new Date();return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;}
  function onlyDate(str){return (str||'').toString().slice(0,10)}
  function normalizeVin(v){if(!v)return'';const ar={'٠':'0','١':'1','٢':'2','٣':'3','٤':'4','٥':'5','٦':'6','٧':'7','٨':'8','٩':'9'};return v.toString().replace(/[٠-٩]/g,d=>ar[d]).toUpperCase().replace(/[\s\-\._]/g,'').trim()}
  function nextId(){return stock.length?Math.max(...stock.map(r=>Number(r.id)||0))+1:1}
  function debounce(fn,wait=250){let t;return (...args)=>{clearTimeout(t);t=setTimeout(()=>fn(...args),wait)};}

  let stock=[], moves=[], models=[], variantsMap={};

  function liftNoFlash(){
  const nf = document.getElementById('noFlash');
  if(nf) nf.remove();
  document.body.style.opacity = '1';
}
/* ===== DOM refs ===== */
  const connDot=$('#connDot'), connText=$('#connText');
  const authGate=$('#authGate'), appRoot=$('#app'), btnSignOut=$('#btnSignOut');
  const emailEl=$('#email'), passEl=$('#password'), btnLogin=$('#btnLogin'), btnSignup=$('#btnSignup'), authHint=$('#authHint');

  const carSelect=$('#carSelect'), variantSelect=$('#variantSelect');
  const dealerInput=$('#dealer'), extColorInput=$('#extColor'), intColorInput=$('#intColor');
  const modelYearInput=$('#modelYear'), plateInput=$('#plate'), locationSelect=$('#location'), batchNameInput=$('#batchName');
  const vinInput=$('#vin'), notesInput=$('#notes');
  const btnSave=$('#btnSave'), btnReset=$('#btnReset');

  const btnImportMenu=$('#btnImportMenu'), importDropdown=$('#importDropdown'), fileImport=$('#fileImport'), btnExport=$('#btnExport'), btnExportBlank=$('#btnExportBlank');

  const searchInput=$('#search'), btnClearSearch=$('#btnClearSearch'), tableBody=document.querySelector('#carsTable tbody');
  const movesTableBody=document.querySelector('#movesTable tbody'), btnClearMoves=$('#btnClearMoves');

  // سجل الحركات — فلاتر التاريخ
  const movesFromDate=$('#movesFromDate'), movesToDate=$('#movesToDate'), btnClearDate=$('#btnClearDate');

  // تتبع VIN
  const trackVin=$('#trackVin'), trackTableBody=document.querySelector('#trackTable tbody'), btnClearTrack=$('#btnClearTrack');

  // Modals
  const modelModal = $('#modelModal');
  const variantModal = $('#variantModal');
  const btnAddModel=$('#btnAddModel'), btnAddVariant=$('#btnAddVariant');
  const modelNameEl = $('#modelName');
  const confirmAddModel = $('#confirmAddModel');

  const variantModelForEl = $('#variantModelFor');
  const variantNameEl = $('#variantName');
  const confirmAddVariant = $('#confirmAddVariant');

  // حركة النقل (متعددة الصفوف)
  const moveRowsContainer = document.querySelector('#moveRowsContainer');
  const btnAddMoveRow = document.querySelector('#btnAddMoveRow');
  const moveToGlobal = document.querySelector('#moveToGlobal');
  const btnFindByVin=$('#btnFindByVin'), btnMove=$('#btnMove');
  const moveStatus=$('#moveStatus'), carDetailsBox=$('#carDetailsBox'), carDetails=$('#carDetails'), carDetailsHint=$('#carDetailsHint');

  const underDeliveryBox=$('#underDeliveryBox');
  const chkAdminApproved=$('#chkAdminApproved'), adminNotes=$('#adminNotes');
  const chkFinanceApproved=$('#chkFinanceApproved'), financeNotes=$('#financeNotes');

  // datalist للاقتراحات
  const vinHints = $('#vinHints');

  // إشعار حركة النقل الكبير
  const moveAlert = $('#moveAlert');
  const moveAlertTitle = $('#moveAlertTitle');
  const moveAlertList  = $('#moveAlertList');

  /* ===== Connection status ===== */
  function setStatus(mode, txt){
    connDot.className='dot '+(mode==='ok'?'ok':mode==='err'?'err':'warn');
    connText.textContent = txt;
  }

  /* ===== Auth Gate ===== */
  
  onAuthStateChanged(auth, async (user)=>{
  if(user){
    try{
      const role = await fetchUserRole(user);
      if(!role || !PAGE_ALLOWED_ROLES.includes(role)){
        window.location.href = 'unauthorized.html';
        return;
      }
      authGate.style.display = 'none';
      appRoot.style.display  = 'block';
      btnSignOut.style.display = 'inline-flex';
      setStatus('ok', `متصل: ${user.email} — الدور: ${role}`);
      liftNoFlash();
      await initData();
      subscribeLive();
    }catch(err){
      console.error(err);
      setStatus('err','خطأ في تحميل البيانات');
      liftNoFlash();
    }
  }else{
    appRoot.style.display   = 'none';
    authGate.style.display  = 'grid';
    btnSignOut.style.display = 'none';
    setStatus('warn','لم يتم تسجيل الدخول');
    liftNoFlash();
  }
});
btnLogin.addEventListener('click', async ()=>{
    authHint.textContent='';
    try{ await signInWithEmailAndPassword(auth, emailEl.value.trim(), passEl.value); }
    catch(e){ authHint.textContent='فشل تسجيل الدخول: '+(e?.message||e); }
  });
  btnSignup.addEventListener('click', async ()=>{
    authHint.textContent='';
    try{ await createUserWithEmailAndPassword(auth, emailEl.value.trim(), passEl.value); }
    catch(e){ authHint.textContent='تعذّر إنشاء الحساب: '+(e?.message||e); }
  });
  btnSignOut.addEventListener('click', ()=> signOut(auth));

  /* ===== Data init / subscribe ===== */
  async function initData(){
    try{
      const s=await getDoc(STATE_REF);
      if(s.exists()){
        const d=s.data()||{};
        stock = Array.isArray(d.stock)? d.stock: [];
        moves = Array.isArray(d.moves)? d.moves: [];
        models = Array.isArray(d.models)? d.models: [];
        variantsMap = d.variantsMap || {};
      }else{
        stock=[]; moves=[]; models=[]; variantsMap={};
      }
      loadModelsIntoSelects();
      if(carSelect.value) populateVariants(carSelect.value);
      renderTable(); renderMoves(); renderTrack();
      fillMoveLists();
      updateRequirementBoxes();
      setStatus('ok','تم تحميل البيانات');
    }catch(e){ setStatus('warn','تعذّر تحميل البيانات'); }
  }
  function subscribeLive(){
    try{
      onSnapshot(STATE_REF,(snap)=>{
        if(!snap.exists()) return;
        const d=snap.data()||{};
        stock = Array.isArray(d.stock)? d.stock: stock;
        moves = Array.isArray(d.moves)? d.moves: moves;
        models= Array.isArray(d.models)? d.models: models;
        variantsMap = d.variantsMap || variantsMap;
        loadModelsIntoSelects();
        if(carSelect.value) populateVariants(carSelect.value);
        renderTable(); renderMoves(); renderTrack();
        fillMoveLists();
        updateRequirementBoxes();
        setStatus('ok','مزامنة حيّة');
      },()=> setStatus('warn','انقطاع المزامنة مؤقتًا'));
    }catch(e){}
  }
  async function persistAll(){
    try{
      await setDoc(STATE_REF, { stock, moves, models, variantsMap, updatedAt: now() }, { merge:true });
      setStatus('ok','تم الحفظ');
    }catch(e){
      setStatus('err','تعذّر الحفظ'); showToast('تعذّر الحفظ إلى السحابة','err');
    }
  }

  /* ===== Models / Variants ===== */
  function loadModelsIntoSelects(){
    carSelect.innerHTML='';
    models.forEach(m=>{ const o=document.createElement('option'); o.value=m; o.textContent=m; carSelect.appendChild(o); });
    variantModelForEl.innerHTML='';
    models.forEach(m=>{ const o=document.createElement('option'); o.value=m; o.textContent=m; variantModelForEl.appendChild(o); });
  }
  function populateVariants(modelName){
    const arr=(variantsMap[modelName]||[]);
    variantSelect.innerHTML='';
    if(!arr.length){ const opt=document.createElement('option'); opt.value=''; opt.textContent='— لا توجد بيانات محددة —'; variantSelect.appendChild(opt); }
    else arr.forEach(v=>{ const opt=document.createElement('option'); opt.value=v; opt.textContent=v; variantSelect.appendChild(opt); });
  }
  carSelect.addEventListener('change',e=>{ populateVariants(e.target.value); });

  // فتح المودالات
  btnAddModel.addEventListener('click',()=>{ modelNameEl.value=''; openModal(modelModal); });
  btnAddVariant.addEventListener('click',()=>{ if(models.length && carSelect.value){ variantModelForEl.value = carSelect.value; } variantNameEl.value=''; openModal(variantModal); });

  // تأكيد إضافة موديل
  confirmAddModel.addEventListener('click', async ()=>{
    const name=(modelNameEl.value||'').trim();
    if(!name) return showToast('اكتب اسم الموديل','info');
    if(!models.includes(name)){ models.push(name); if(!variantsMap[name]) variantsMap[name]=[]; loadModelsIntoSelects(); carSelect.value=name; populateVariants(name); await persistAll(); showToast('تمت إضافة الموديل','ok');}
    else showToast('الموديل موجود بالفعل','info');
    modelModal.style.display='none';
  });

  // تأكيد إضافة بيان
  confirmAddVariant.addEventListener('click', async ()=>{
    const modelFor=(variantModelForEl.value||'').trim();
    const vName=(variantNameEl.value||'').trim();
    if(!modelFor) return showToast('اختر الموديل','info');
    if(!vName) return showToast('اكتب اسم البيان','info');
    variantsMap[modelFor]=variantsMap[modelFor]||[];
    if(!variantsMap[modelFor].includes(vName)){ variantsMap[modelFor].push(vName); if(carSelect.value===modelFor){ populateVariants(modelFor); variantSelect.value=vName; } await persistAll(); showToast('تم حفظ البيان','ok');}
    else showToast('البيان مسجّل مسبقًا','info');
    variantModal.style.display='none';
  });

  /* ===== Table render / search ===== */
  function renderTable(){
    const q=(searchInput.value||'').trim().toLowerCase();
    tableBody.innerHTML='';
    let rows=stock.slice().sort((a,b)=>a.id-b.id);
    if(q){
      rows=rows.filter(r=>{
        const hay=[r.car,r.variant,r.dealer,r.extColor,r.intColor,r.modelYear,r.plate,r.location,r.batchName,r.notes,r.vin].join(' ').toLowerCase();
        return hay.includes(q);
      });
    }
    rows.forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td><strong>${r.car||''}</strong></td>
        <td>${r.variant||''}</td>
        <td>${r.dealer||''}</td>
        <td>${r.extColor||''}</td>
        <td>${r.intColor||''}</td>
        <td class="nowrap">${r.modelYear||''}</td>
        <td class="nowrap"><span class="copyable" data-copy="${r.plate||''}" title="انسخ اللوحة">${r.plate||''}</span></td>
        <td>${r.location||''}</td>
        <td>${r.batchName||''}</td>
        <td class="nowrap"><span class="copyable" data-copy="${r.vin||''}" title="انسخ رقم الهيكل">${r.vin||''}</span></td>
        <td>${r.notes||''}</td>
        <td>
          <div class="cell-actions">
            <button class="btn btn-ghost" data-edit="${r.id}" title="تعديل">تعديل ✎</button>
            <button class="btn btn-danger" data-del="${r.id}" title="حذف">حذف 🗑</button>
          </div>
        </td>`;
      tableBody.appendChild(tr);
    });
  }

  const INLINE_EDIT_FIELDS = ['car','variant','dealer','extColor','intColor','modelYear','plate','location','batchName','vin','notes'];

  function makeRowEditable(tr, rec){
    if(!tr || !rec) return;
    tr.dataset.editing = '1';
    const tds = tr.querySelectorAll('td');
    const fields = INLINE_EDIT_FIELDS;
    fields.forEach((field, idx)=>{
      const td = tds[idx];
      if(!td) return;
      const current = rec[field] || '';
      if(field === 'location'){
        const sel = document.createElement('select');
        sel.className = 'edit-location';
        if(Array.isArray(FIXED_LOCATIONS)){
          FIXED_LOCATIONS.forEach(loc=>{
            const opt = document.createElement('option');
            opt.value = loc;
            opt.textContent = loc;
            if(loc === current) opt.selected = true;
            sel.appendChild(opt);
          });
        }
        td.innerHTML = '';
        td.appendChild(sel);
      }else if(field === 'notes'){
        const ta = document.createElement('textarea');
        ta.className = 'edit-notes';
        ta.value = current;
        ta.style.width = '100%';
        ta.style.minHeight = '40px';
        td.innerHTML = '';
        td.appendChild(ta);
      }else{
        const inp = document.createElement('input');
        inp.className = 'edit-'+field;
        inp.value = current;
        inp.style.width = '100%';
        td.innerHTML = '';
        td.appendChild(inp);
      }
    });
    const actionsTd = tds[11];
    if(actionsTd){
      actionsTd.innerHTML = '';
      const wrap = document.createElement('div');
      wrap.className = 'cell-actions';
      const btnSave = document.createElement('button');
      btnSave.className = 'btn btn-primary';
      btnSave.setAttribute('data-save-inline', rec.id);
      btnSave.textContent = 'حفظ';
      const btnCancel = document.createElement('button');
      btnCancel.className = 'btn btn-ghost';
      btnCancel.setAttribute('data-cancel-inline', rec.id);
      btnCancel.textContent = 'إلغاء';
      wrap.appendChild(btnSave);
      wrap.appendChild(btnCancel);
      actionsTd.appendChild(wrap);
    }
  }
  searchInput.addEventListener('input',renderTable);
  btnClearSearch.addEventListener('click',()=>{searchInput.value=''; renderTable();});

  /* نسخ سريع + أزرار تعديل/حذف */
  document.addEventListener('click',(e)=>{
    const pill=e.target.closest('.copyable');
    const btn=e.target.closest('button');
    if(pill){
      const txt=(pill.getAttribute('data-copy')||'').trim();
      if(txt){ navigator.clipboard.writeText(txt).then(()=>showToast('تم النسخ ✅','ok')); }
    }
    if(btn){
      const del=btn.getAttribute('data-del');
      const edit=btn.getAttribute('data-edit');
      const saveInline=btn.getAttribute('data-save-inline');
      const cancelInline=btn.getAttribute('data-cancel-inline');

      if(edit){
        const id=Number(edit);
        const rec=stock.find(r=>r.id===id);
        if(!rec) return;
        const tr=btn.closest('tr');
        makeRowEditable(tr, rec);
      }

      if(saveInline){
        const id=Number(saveInline);
        const idx=stock.findIndex(r=>r.id===id);
        if(idx<0) return;
        const tr=btn.closest('tr');
        const tds=tr.querySelectorAll('td');
        const fields=['car','variant','dealer','extColor','intColor','modelYear','plate','location','batchName','vin','notes'];
        const rec=stock[idx];
        fields.forEach((field,idxField)=>{
          const td=tds[idxField];
          if(!td) return;
          let val=rec[field]||'';
          if(field==='location'){
            const sel=td.querySelector('select');
            if(sel) val=sel.value.trim();
          }else if(field==='notes'){
            const ta=td.querySelector('textarea');
            if(ta) val=ta.value.trim();
          }else{
            const inp=td.querySelector('input');
            if(inp) val=inp.value.trim();
          }
          rec[field]=val;
        });
        stock[idx]=rec;
        persistAll();
        renderTable();
        showToast('تم التعديل بنجاح','ok');
      }

      if(cancelInline){
        renderTable();
      }

      if(del){
        const id=Number(del);
        if(confirm('تأكيد الحذف؟')){
          stock=stock.filter(r=>r.id!==id);
          persistAll();
          renderTable();
          showToast('تم الحذف','ok');
        }
      }
    }
  });


/* حفظ / تعديل */
  let editId=null;
  btnSave.addEventListener('click',async ()=>{
    const record={
      id:editId||nextId(),
      car:carSelect.value,
      variant:variantSelect.value||'',
      dealer:dealerInput.value.trim(),
      extColor:extColorInput.value.trim(),
      intColor:intColorInput.value.trim(),
      vin:normalizeVin(vinInput.value),
      modelYear:modelYearInput.value.trim(),
      plate:plateInput.value.trim(),
      location:locationSelect.value,
      batchName:batchNameInput.value.trim(),
      notes:notesInput.value.trim()
    };
    if(!record.car) return showToast('اختر السيارة أولًا','err');

    if(editId){const idx=stock.findIndex(r=>r.id===editId); if(idx>-1) stock[idx]=record; editId=null; showToast('تم التعديل','ok');}
    else {stock.push(record); showToast('تم الحفظ','ok');}
    await persistAll(); renderTable(); clearForm();
  });
  function clearForm(){
    if(models.length){carSelect.value=models[0]; populateVariants(carSelect.value); variantSelect.value=variantSelect.options[0]?.value||'';}
    dealerInput.value=''; extColorInput.value=''; intColorInput.value='';
    modelYearInput.value=''; plateInput.value='';
    locationSelect.selectedIndex=0;
    batchNameInput.value=''; vinInput.value=''; notesInput.value=''; editId=null;
  }
  btnReset.addEventListener('click',clearForm);

  /* تصدير Excel (كامل) */
  btnExport.addEventListener('click',()=>{
    const rows=stock.slice().sort((a,b)=>a.id-b.id);
    const header=["م","سيارة","البيان","الوكيل","اللون الخارجي","اللون الداخلي","موديل","اللوحة","المكان","اسم الدفعة","رقم الهيكل","الملاحظات"];
    const data=[header];
    rows.forEach(r=>data.push([r.id,r.car,r.variant,r.dealer,r.extColor,r.intColor,r.modelYear,r.plate,r.location,r.batchName||'',r.vin,r.notes]));
    const ws=XLSX.utils.aoa_to_sheet(data);
    ws['!cols']=[{wch:6},{wch:22},{wch:16},{wch:16},{wch:14},{wch:14},{wch:8},{wch:12},{wch:22},{wch:18},{wch:22},{wch:26}];
    const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"Cars");
    XLSX.writeFile(wb,"mzj-cars-inventory.xlsx"); showToast('تم تصدير الملف','ok');
  });

  /* الجديد: تصدير قالب  (عناوين فقط) */
  btnExportBlank.addEventListener('click',()=>{
    const header=["م","سيارة","البيان","الوكيل","اللون الخارجي","اللون الداخلي","موديل","اللوحة","المكان","اسم الدفعة","رقم الهيكل","الملاحظات"];
    const ws=XLSX.utils.aoa_to_sheet([header]);
    ws['!cols']=[{wch:6},{wch:22},{wch:16},{wch:16},{wch:14},{wch:14},{wch:8},{wch:12},{wch:22},{wch:18},{wch:22},{wch:26}];
    const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"Template");
    XLSX.writeFile(wb,"mzj-cars-template-blank.xlsx");
    showToast('تم تصدير القالب ','ok');
  });

  /* استيراد Excel */
  let importMode=null; const VIN_HEADERS=["رقم الهيكل","VIN","الشاص","رقم الشاص","Chassis","Chassis No","Chassis Number","الهيكل","نوع الهيكل"];
  btnImportMenu.addEventListener('click',()=>{importDropdown.style.display=importDropdown.style.display==='block'?'none':'block';});
  importDropdown.addEventListener('click',(e)=>{const btn=e.target.closest('button'); if(!btn) return; importMode=btn.getAttribute('data-mode'); importDropdown.style.display='none'; fileImport.click();});
  document.addEventListener('click',(e)=>{if(!e.target.closest('.import-menu')) importDropdown.style.display='none';});
  fileImport.addEventListener('change',(e)=>{
    const file=e.target.files[0]; if(!file) return; if(!importMode){showToast('اختر وضع الاستيراد أولًا','info'); fileImport.value=''; return;}
    const reader=new FileReader();
    reader.onload=async (evt)=>{
      try{
        const data=new Uint8Array(evt.target.result);
        const workbook=XLSX.read(data,{type:'array'}); const first=workbook.SheetNames[0]; const sheet=workbook.Sheets[first];
        const json=XLSX.utils.sheet_to_json(sheet,{header:1,defval:''});
        const header=json[0]||[]; const colIndex=name=>header.indexOf(name);

        const idxMap={
          id:colIndex("م"),car:colIndex("سيارة"),variant:colIndex("البيان"),dealer:colIndex("الوكيل"),
          extColor:colIndex("اللون الخارجي"),intColor:colIndex("اللون الداخلي"),
          modelYear:colIndex("موديل"), plate:colIndex("اللوحة"), location:colIndex("المكان"),
          batchName:colIndex("اسم الدفعة"), notes:colIndex("الملاحظات")
        };
        let idxVin=-1; for(const h of VIN_HEADERS){const i=header.indexOf(h); if(i!==-1){idxVin=i; break;}}

        const mustHave=["سيارة","البيان","الوكيل","اللون الخارجي","اللون الداخلي","موديل","اللوحة","المكان","اسم الدفعة","الملاحظات"];
        const missing = mustHave.filter(n=> colIndex(n)===-1);
        if(missing.length){ throw new Error('فشل الاستيراد — أعمدة ناقصة: '+missing.join(', ')); }

        const imported=[];
        for(let i=1;i<json.length;i++){
          const row=json[i]; if(!row || row.length===0) continue;
          const rawVin=(idxVin!==-1?row[idxVin]:'');
          imported.push({
            id:Number(row[idxMap.id])||null,
            car:row[idxMap.car]||'',
            variant:row[idxMap.variant]||'',
            dealer:row[idxMap.dealer]||'',
            extColor:row[idxMap.extColor]||'',
            intColor:row[idxMap.intColor]||'',
            modelYear:row[idxMap.modelYear]||'',
            plate:row[idxMap.plate]||'',
            location:row[idxMap.location]||'',
            batchName:row[idxMap.batchName]||'',
            notes:row[idxMap.notes]||'',
            vin:normalizeVin(rawVin)
          });
          const name=row[idxMap.car];
          if(name && !models.includes(name)){models.push(name); if(!variantsMap[name]) variantsMap[name]=[];}
        }
        if(importMode==='replace'){stock=[]; imported.forEach(r=>{r.id=nextId(); stock.push(r);});}
        else {imported.forEach(r=>{r.id=nextId(); stock.push(r);});}
        await persistAll(); loadModelsIntoSelects(); if(carSelect.value) populateVariants(carSelect.value);
        renderTable(); fillMoveLists(); updateRequirementBoxes();
        showToast(importMode==='replace'?'تم الاستبدال الكامل بالبيانات الجديدة':'تمت الإضافة إلى البيانات الحالية','ok');
      }catch(err){ showToast((err?.message)||'فشل الاستيراد — راجع تنسيق الملف','err'); }
      finally{ fileImport.value=''; importMode=null; }
    };
    reader.readAsArrayBuffer(file);
  });

  /* ===== حركة النقل — قوائم ثابتة ===== */
  const FIXED_LOCATIONS = [
    "المستودع : المخزون المتاح","المستودع : سيارات بها ملاحظات","المستودع : مباع تحت التسليم","المستودع : مباع تم التسليم",
    "الوكالة : المخزون المتاح","الوكالة : سيارات بها ملاحظات","الوكالة : مباع تحت التسليم","الوكالة : مباع تم التسليم",
    "فرع 1 الصالة : المخزون المتاح","فرع 1 الصالة : سيارات بها ملاحظات","فرع 1 الصالة : مباع تحت التسليم","فرع 1 الصالة : مباع تم التسليم",
    "فرع 2 الملتقى : المخزون المتاح","فرع 2 الملتقى : سيارات بها ملاحظات","فرع 2 الملتقى : مباع تحت التسليم","فرع 2 الملتقى : مباع تم التسليم",
    "فرع 3 القادسية : المخزون المتاح","فرع 3 القادسية : سيارات بها ملاحظات","فرع 3 القادسية : مباع تحت التسليم","فرع 3 القادسية : مباع تم التسليم"
  ];
  function fillMoveLists(){
    const opts = FIXED_LOCATIONS.map(l=> `<option value="${l}">${l}</option>`).join('');
    const fromSelects = moveRowsContainer ? moveRowsContainer.querySelectorAll('.move-from') : [];
    fromSelects.forEach(sel=> sel.innerHTML=opts);
    if(moveToGlobal) moveToGlobal.innerHTML = opts;
  }

  function fillMoveListsForRow(row){
    const opts = FIXED_LOCATIONS.map(l=> `<option value="${l}">${l}</option>`).join('');
    const fromSel = row.querySelector('.move-from');
    if(fromSel) fromSel.innerHTML = opts;
  }

  function renderCarDetails(rec){
    carDetails.innerHTML=`
      <div style="grid-column:1/-1"><b>سيارة:</b> ${rec.car??""}</div>
      <div><b>البيان:</b> ${rec.variant??""}</div>
      <div><b>الوكيل:</b> ${rec.dealer??""}</div>
      <div><b>اللون الخارجي:</b> ${rec.extColor??""}</div>
      <div><b>اللون الداخلي:</b> ${rec.intColor??""}</div>
      <div><b>موديل:</b> ${rec.modelYear??""}</div>
      <div><b>اللوحة:</b> ${rec.plate??""}</div>
      <div><b>المكان:</b> ${rec.location??""}</div>
      <div><b>اسم الدفعة:</b> ${rec.batchName??""}</div>
      <div style="grid-column:1/-1"><b>رقم الهيكل:</b> ${rec.vin??""}</div>
      <div style="grid-column:1/-1"><b>الملاحظات:</b> ${rec.notes??""}</div>`;
    carDetailsHint.textContent=rec.vin?`رقم الهيكل: ${rec.vin}`:'لا يوجد رقم هيكل محفوظ لهذه السيارة.';
    carDetailsBox.style.display='block';
  }

  function hideMoveAlert(){
    if(moveAlert){
      moveAlert.style.display='none';
      moveAlertList.innerHTML='';
    }
  }

  function showMoveAlert(type, title, lines){
    if(!moveAlert) return;
    moveAlert.className = 'move-alert ' + (type || 'info');
    moveAlertTitle.textContent = title || 'نتيجة حركة النقل';
    moveAlertList.innerHTML = '';
    (lines || []).forEach(txt=>{
      const li = document.createElement('li');
      li.textContent = txt;
      moveAlertList.appendChild(li);
    });
    moveAlert.style.display = 'flex';
  }

  /* اقتراح VIN حسب البادئة/الأرقام المكتوبة */
  function updateVinSuggestionsForPrefix(rawPrefix){
  if(!vinHints) return;
  const prefix = normalizeVin(rawPrefix||'');
  if(prefix.length < 1){
    vinHints.innerHTML = '';
    return;
  }
  const set = new Set();
  stock.forEach(r=>{
    const v = normalizeVin(r.vin||'');
    // 👇 عدّل السطر ده:
    // if(v && v.includes(prefix)) set.add(v); // يحتوي على الأرقام المكتوبة

    // ✅ خليه يبدأ بنفس اللي انت كاتبه (Prefix)
    if(v && v.startsWith(prefix)) set.add(v);
  });
  const list = Array.from(set).sort().slice(0,30);
  vinHints.innerHTML = list.map(v=>`<option value="${v}"></option>`).join('');
}



  /* اقتراح المكان "من" لكل سطر عند كتابة VIN */
  function autoFindByVinForRow(row, strictMessage=false){
    const inp = row.querySelector('.move-vin');
    const fromSel = row.querySelector('.move-from');
    const vinRaw = (inp.value||'').trim();
    if(!vinRaw){
      if(fromSel){
        fromSel.disabled=false;
        fromSel.value='';
      }
      const anyVin = moveRowsContainer.querySelectorAll('.move-vin');
      const hasAnyVin = Array.from(anyVin).some(i=> normalizeVin(i.value));
      if(!hasAnyVin){
        carDetailsBox.style.display='none';
        moveStatus.textContent='';
      }
      return;
    }
    const norm = normalizeVin(vinRaw);
    let match = stock.find(r => normalizeVin(r.vin) === norm);
    if(!match && norm.length >= 8){
      const candidates = stock.filter(r => normalizeVin(r.vin).startsWith(norm));
      if(candidates.length === 1) match = candidates[0];
    }
    if(match){
      renderCarDetails(match);
      const currentLoc = match.location || '';
      if(currentLoc && fromSel){
        fromSel.value = currentLoc;
        fromSel.disabled = true;
        moveStatus.textContent = `تم العثور: ${match.car} — المكان الحالي: ${currentLoc}`;
      }else if(fromSel){
        fromSel.disabled = false;
        moveStatus.textContent = `تم العثور: ${match.car} — لا يوجد مكان مسجل. اختر المكان يدويًا.`;
      }
    }else{
      if(strictMessage){
        const msg = 'لم يتم العثور على سيارة بهذا الرقم.';
        moveStatus.textContent = msg;
        carDetailsBox.style.display='none';
        showMoveAlert('error','لم يتم العثور على السيارة',[msg]);
      }else{
        moveStatus.textContent = '— لم يتم التعرف على السيارة بعد (أكمل رقم الهيكل).';
      }
    }
  }

  function attachMoveRowEvents(row){
    const inp = row.querySelector('.move-vin');
    if(!inp) return;
    inp.addEventListener('input', debounce(()=>{
      updateVinSuggestionsForPrefix(inp.value);
      autoFindByVinForRow(row,false);
    },150));
  }

  function createMoveRow(index){
    const row = document.createElement('div');
    row.className = 'move-row';
    row.innerHTML = `
      <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:6px">
        <div class="move-row-title">السيارة ${index}</div>
        <button type="button" class="btn btn-ghost" data-remove-move-row="1" title="مسح هذه الحركة">مسح الحركة</button>
      </div>
      <div class="grid grid-3">
        <div>
          <label>رقم الهيكل</label>
          <input class="move-vin" list="vinHints" placeholder="اكتب رقم الهيكل"/>
        </div>
        <div>
          <label>من (محدّد تلقائيًا)</label>
          <select class="move-from" title="المكان الحالي"></select>
        </div>
        <div class="notes-col">
          <label>ملاحظات هذه السيارة</label>
          <textarea class="move-notes" placeholder="ملاحظات خاصة بهذا الهيكل (اختياري)"></textarea>
        </div>
      </div>`;
    fillMoveListsForRow(row);
    attachMoveRowEvents(row);
    return row;
  }

  function renumberMoveRows(){
    const rows = moveRowsContainer.querySelectorAll('.move-row');
    rows.forEach((row,idx)=>{
      const title = row.querySelector('.move-row-title');
      if(title) title.textContent = 'السيارة ' + (idx+1);
    });
  }

  function ensureAtLeastOneMoveRow(){
    if(!moveRowsContainer) return;
    const existing = moveRowsContainer.querySelectorAll('.move-row').length;
    if(existing === 0){
      const row = createMoveRow(1);
      moveRowsContainer.appendChild(row);
    }
    renumberMoveRows();
  }

  if(btnAddMoveRow){
    btnAddMoveRow.addEventListener('click', ()=>{
      const count = moveRowsContainer.querySelectorAll('.move-row').length;
      const row = createMoveRow(count+1);
      moveRowsContainer.appendChild(row);
      renumberMoveRows();
    });
  }

  
  // مسح صف حركة نقل واحد
  document.addEventListener('click',(e)=>{
    const btn = e.target.closest('[data-remove-move-row]');
    if(!btn) return;
    const row = btn.closest('.move-row');
    if(row){
      row.remove();
      renumberMoveRows();
    }
  });

// عرض البيانات لأول VIN غير فارغ
  btnFindByVin.addEventListener('click',()=>{
    const rows = Array.from(moveRowsContainer.querySelectorAll('.move-row'));
    const firstRow = rows.find(r=> normalizeVin((r.querySelector('.move-vin')?.value||'').trim()));
    if(!firstRow){
      const msg = 'اكتب رقم الهيكل في أي سطر أولًا.';
      moveStatus.textContent = msg;
      showMoveAlert('info','لا يوجد رقم هيكل',[msg]);
      return;
    }
    autoFindByVinForRow(firstRow,true);
  });

  function updateRequirementBoxes(){
    const val = (moveToGlobal?.value || '').trim();
    const anyIssues        = /سيارات بها ملاحظات/.test(val);
    if(underDeliveryBox){
      underDeliveryBox.style.display = 'none';
    }
  }

  if(moveToGlobal){
    moveToGlobal.addEventListener('change', updateRequirementBoxes);
  }

  // تنفيذ النقل المتعدد
  btnMove.addEventListener('click', async ()=>{
    hideMoveAlert();

    const dest = (moveToGlobal?.value || '').trim();
    if(!dest){
      const msg = 'اختر مكان "إلى" أولًا قبل تنفيذ النقل.';
      moveStatus.textContent = msg;
      showMoveAlert('info','مكان الوصول مطلوب',[msg]);
      showToast(msg,'info');
      return;
    }

    const rows = Array.from(moveRowsContainer.querySelectorAll('.move-row')).map(row=>({
      row,
      vinRaw:(row.querySelector('.move-vin')?.value||'').trim(),
      fromSel:row.querySelector('.move-from'),
      notesInput:row.querySelector('.move-notes')
    }));
    const rowsWithVin = rows.filter(r=> normalizeVin(r.vinRaw));

    if(!rowsWithVin.length){
      const msg = 'لم يتم إدخال أي رقم هيكل للنقل.';
      moveStatus.textContent = msg;
      showMoveAlert('info','لا توجد حركات نقل', [msg]);
      showToast(msg,'info');
      return;
    }

    const goingUnderDeliveryRow = false;
    const goingIssuesRow        = /سيارات بها ملاحظات/.test(dest);
    const goingDeliveredRow     = /مباع تم التسليم/.test(dest);

    let movedCount = 0;
    const errors = [];
    const successLines = [];

    
for (const rowData of rowsWithVin){
      const norm = normalizeVin(rowData.vinRaw);
      const recIdx = stock.findIndex(r => normalizeVin(r.vin) === norm);
      if(recIdx < 0){
        errors.push(`لم يتم العثور على سيارة بهذا VIN: ${rowData.vinRaw}`);
        continue;
      }
      const rec = stock[recIdx];
      const toVal = dest;
      const fromSel = rowData.fromSel;
      const from = (fromSel?.value || rec.location || '').trim();
      if(!from){
        errors.push(`السيارة ${rec.car||''} (${rec.vin||rowData.vinRaw}) لا يوجد لها مكان حالي؛ حدّد المكان يدويًا في "من".`);
        continue;
      }
      if(from === toVal){
        errors.push(`السيارة ${rec.car||''} (${rec.vin||rowData.vinRaw}) موجودة بالفعل في نفس المكان.`);
        continue;
      }

      const noteText = (rowData.notesInput?.value || '').trim();

      if(goingIssuesRow && !noteText){
        errors.push(`يجب كتابة ملاحظة للسيارة ${rec.car||''} (${rec.vin||rowData.vinRaw}) عند النقل إلى مكان "سيارات بها ملاحظات".`);
        continue;
      }

      // ميتاداتا أساسية للحركة / الطلب
      const moveMeta = {
        adminApproved: null,
        adminNotes: '',
        financeApproved: null,
        financeNotes: '',
        issuesNotes: noteText
      };

      const oldLoc = rec.location || from;

            if(goingDeliveredRow){
        // في حالة "مباع تم التسليم": تسجيل طلب نقل فقط بدون تغيير مكان السيارة
        const stamp = now();
        moves.push({
          when: stamp,
          date: onlyDate(stamp),
          vin: rec.vin || '',
          car: rec.car || '',
          from: oldLoc,
          to: toVal,
          id: rec.id,
          ...moveMeta,
          // حالة الموافقات
          adminApproved: false,
          financeApproved: false,
          // فلاغات توضح أن الطلب يحتاج موافقة
          requiresAdminApproval: true,
          requiresFinanceApproval: true,
          // حالة الطلب العامة
          status: 'pending',
          // رسالة توصيفية تظهر في الداش بورد
          message: 'طلب نقل السيارة بانتظار موافقة الإدارة والمالية'
        });
        movedCount++;
        successLines.push(`تم تسجيل طلب نقل ${rec.car||''} (${rec.vin||rowData.vinRaw}) من "${oldLoc}" إلى "${toVal}" بانتظار موافقة الإدارة والمالية.`);
        continue;
      }


      // الحركات العادية (نقل فعلي)
      rec.location = toVal;
      if(goingIssuesRow && noteText){
        const existingNotes = rec.notes || '';
        rec.notes = existingNotes ? (existingNotes + " | " + noteText) : noteText;
      }
      const stamp = now();
      moves.push({
        when: stamp,
        date: onlyDate(stamp),
        vin: rec.vin || '',
        car: rec.car || '',
        from: oldLoc,
        to: toVal,
        id: rec.id,
        ...moveMeta
      });
      movedCount++;
      successLines.push(`تم نقل ${rec.car||''} (${rec.vin||rowData.vinRaw}) من "${oldLoc}" إلى "${toVal}".`);
    }

if(!movedCount){
      const title = 'لم يتم تنفيذ أي حركة نقل';
      const lines = errors.length ? errors : ['لم يتم تنفيذ أي حركة نقل.'];
      moveStatus.textContent = title;
      showMoveAlert('error', title, lines);
      showToast(title,'info');
      return;
    }

    await persistAll();
    renderTable();
    renderMoves();
    renderTrack();

    const summary = `تم نقل ${movedCount} سيارة بنجاح.`;    
    moveStatus.textContent = summary;
    const allLines = [...successLines];
    if(errors.length){
      allLines.push('— ملاحظات على الحركات التي لم تُنفذ:');
      errors.forEach(e=> allLines.push(e));
    }
    showMoveAlert(errors.length ? 'info' : 'success', 'نتيجة حركة النقل', allLines);
    showToast(summary,'ok');

    carDetailsBox.style.display='none';

    // تفريغ الحقول
    const allRows = Array.from(moveRowsContainer.querySelectorAll('.move-row'));
    allRows.forEach(row=>{
      const vin = row.querySelector('.move-vin');
      const fromSel = row.querySelector('.move-from');
      const notes = row.querySelector('.move-notes');
      if(vin) vin.value='';
      if(fromSel){ fromSel.disabled=false; fromSel.value=''; }
      if(notes) notes.value='';
    });

    chkAdminApproved.checked=false; adminNotes.value='';
    chkFinanceApproved.checked=false; financeNotes.value='';
    if(vinHints) vinHints.innerHTML='';
  });

  /* ===== سجل الحركات (عرض + فلاتر التاريخ) ===== */
  /* ===== سجل الحركات (عرض + فلاتر التاريخ) ===== */
  function filterMovesByDate(list){
    const f = movesFromDate.value || null;
    const t = movesToDate.value || null;
    if(!f && !t) return list;
    return list.filter(m=>{
      const d = m.date || onlyDate(m.when||'');
      if(f && d < f) return false;
      if(t && d > t) return false;
      return true;
    });
  }

  function renderMoves(){
    movesTableBody.innerHTML='';
    let rows = moves.slice();
    rows = filterMovesByDate(rows);
    rows.forEach((m,i)=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${i+1}</td>
        <td class="nowrap">${m.date || onlyDate(m.when||'')}</td>
        <td class="nowrap"><span class="copyable" data-copy="${m.vin||''}" title="انسخ رقم الهيكل">${m.vin||''}</span></td>
        <td>${m.car||''}</td>
        <td>${m.from||''}</td>
        <td>${m.to||''}</td>
        <td class="nowrap">${m.id||''}</td>`;
      movesTableBody.appendChild(tr);
    });
  }
  movesFromDate.addEventListener('change', renderMoves);
  movesToDate.addEventListener('change', renderMoves);
  btnClearDate.addEventListener('click', ()=>{movesFromDate.value=''; movesToDate.value=''; renderMoves();});

  /* ===== تتبّع VIN ===== */
  function renderTrack(){
    trackTableBody.innerHTML='';
    const v = normalizeVin((trackVin.value||'').trim());
    if(!v){ return; }
    const list = moves
      .filter(m=> normalizeVin(m.vin||'').startsWith(v) )
      .sort((a,b)=> (a.when||'').localeCompare(b.when||''));
    list.forEach((m,i)=>{
      const notesParts = [];
      if(m.adminApproved===true) notesParts.push('✔ موافقة إدارية');
      if(m.adminApproved===false) notesParts.push('✖ موافقة إدارية');
      if(m.adminNotes) notesParts.push('إداري: '+m.adminNotes);
      if(m.financeApproved===true) notesParts.push('✔ موافقة مالية');
      if(m.financeApproved===false) notesParts.push('✖ موافقة مالية');
      if(m.financeNotes) notesParts.push('مالي: '+m.financeNotes);
      if(m.issuesNotes) notesParts.push('ملاحظات: '+m.issuesNotes);

      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${i+1}</td>
        <td class="nowrap">${m.date || onlyDate(m.when||'')}</td>
        <td>${m.from||''}</td>
        <td>${m.to||''}</td>
        <td>${m.car||''}</td>
        <td>${notesParts.join(' — ')||''}</td>`;
      trackTableBody.appendChild(tr);
    });
  }
  trackVin.addEventListener('input', debounce(()=>{ updateVinSuggestionsForPrefix(trackVin.value); renderTrack(); }, 200));
  btnClearTrack.addEventListener('click', ()=>{ trackVin.value=''; renderTrack(); });

  /* Modals helpers */
  function openModal(el){ el.style.display='flex'; setTimeout(()=>{ const first = el.querySelector('input,select,textarea,button'); first?.focus(); }, 50); }
  function closeModalById(id){ const el = document.getElementById(id); if(el) el.style.display='none'; }
  document.addEventListener('click',(e)=>{
    const closeBtn = e.target.closest('[data-close]');
    if(closeBtn){ closeModalById(closeBtn.getAttribute('data-close')); }
    if(e.target.classList.contains('modal-backdrop')){ e.target.style.display='none'; }
  });
  document.addEventListener('keydown',(e)=>{
    if(e.key==='/'){e.preventDefault(); searchInput.focus();}
    if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='s'){e.preventDefault(); btnSave.click();}
    if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='k'){e.preventDefault(); btnAddVariant.click();}
    if(e.key==='Escape'){modelModal.style.display='none'; variantModal.style.display='none'; btnReset.click();}
  });

  /* أول تحميل */
  setStatus('warn','جارِ الاتصال…');

  /* إغلاق قائمة الاستيراد عند النقر خارجها */
  document.addEventListener('click',(e)=>{
    if(!e.target.closest('.import-menu')) importDropdown.style.display='none';
  });

  // تبويبات داخلية للصفحة
  const innerTabs = Array.from(document.querySelectorAll('.inner-tab'));
  const innerPanels = Array.from(document.querySelectorAll('.inner-tab-panel'));
  innerTabs.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      innerTabs.forEach(b=> b.classList.remove('active'));
      innerPanels.forEach(p=> p.classList.remove('active'));
      btn.classList.add('active');
      const targetId = btn.getAttribute('data-target');
      const panel = document.getElementById(targetId);
      if(panel) panel.classList.add('active');
    });
  });

  // تهيئة نموذج حركة النقل
  fillMoveLists();
  ensureAtLeastOneMoveRow();
  updateRequirementBoxes();

  // إظهار/إخفاء ملاحظات كل سيارة حسب مكان (إلى)
  function toggleNotesVisibility(){
    const dest = (moveToGlobal?.value || '').trim();
    const show = /سيارات بها ملاحظات/.test(dest);
    const notesCols = document.querySelectorAll('.notes-col');
    notesCols.forEach(col=>{
      col.style.display = show ? 'block' : 'none';
    });
  }
  if(moveToGlobal){
    moveToGlobal.addEventListener('change', toggleNotesVisibility);
    toggleNotesVisibility();
  }

  </script>
</div>
    </div>
  </main>
</div>

<!-- ===== Drawer / Side Menu ===== -->
<div class="drawer-backdrop" id="drawerBackdrop"></div>
<aside class="drawer-panel" id="drawerPanel" aria-hidden="true">
  <div class="drawer-header">
    <div class="drawer-title">
      <span class="main">قائمة الصفحات</span>
      <span class="sub">اختر صفحة العمل التي تريد فتحها</span>
    </div>
    <button class="drawer-close-btn" id="btnCloseDrawer" aria-label="إغلاق القائمة">✕</button>
  </div>
  <div class="drawer-body">
    <div class="drawer-section-label">الواجهة الرئيسية</div>
    <ul class="menu-list">
      <li class="menu-item">
        <a href="dashboard-mobile.html" class="menu-link">
          <div class="menu-link-main">
            <div class="menu-icon">DB</div>
            <div class="menu-text-main">
              <span class="title">لوحة المؤشرات</span>
              <span class="desc">نظرة سريعة على الطلبات والمخزون والأداء.</span>
            </div>
          </div>
          <span class="menu-link-arrow">‹</span>
        </a>
      </li>
      <li class="menu-item">
        <a href="photoshoot-user-mobile.html" class="menu-link">
          <div class="menu-link-main">
            <div class="menu-icon">OR</div>
            <div class="menu-text-main">
              <span class="title">إدارة الطلبات</span>
              <span class="desc">استلام، تجهيز، تصوير، نقل… خطوة بخطوة.</span>
            </div>
          </div>
          <span class="menu-link-arrow">‹</span>
        </a>
      </li>
      <li class="menu-item">
        <a href="inventory-mobile.html" class="menu-link">
          <div class="menu-link-main">
            <div class="menu-icon">IN</div>
            <div class="menu-text-main">
              <span class="title">المخزون</span>
              <span class="desc">كل السيارات حسب الفرع، الحالة، والألوان.</span>
            </div>
          </div>
          <span class="menu-link-arrow">‹</span>
        </a>
      </li>
      <li class="menu-item">
        <a href="vt-mobile.html" class="menu-link">
          <div class="menu-link-main">
            <div class="menu-icon">MV</div>
            <div class="menu-text-main">
              <span class="title">نقل السيارات</span>
              <span class="desc">نقل السيارات بين الفروع وحالة التنفيذ.</span>
            </div>
          </div>
          <span class="menu-link-arrow">‹</span>
        </a>
      </li>
      <li class="menu-item">
        <a href="cars-mobile.html" class="menu-link">
          <div class="menu-link-main">
            <div class="menu-icon">CR</div>
            <div class="menu-text-main">
              <span class="title">كل السيارات</span>
              <span class="desc">عرض شامل لكل السيارات المسجلة بالنظام.</span>
            </div>
          </div>
          <span class="menu-link-arrow">‹</span>
        </a>
      </li>
      <li class="menu-item">
        <a href="admin-mobile.html" class="menu-link active">
          <div class="menu-link-main">
            <div class="menu-icon">AD</div>
            <div class="menu-text-main">
              <span class="title">لوحة الإدارة</span>
              <span class="desc">صلاحيات المستخدمين وإعدادات النظام.</span>
            </div>
          </div>
          <span class="menu-link-arrow">‹</span>
        </a>
      </li>
    </ul>

    <div class="drawer-section-label">جلسة العمل</div>
    <ul class="menu-list">
      <li class="menu-item">
        <a href="#" class="menu-link logout">
          <div class="menu-link-main">
            <div class="menu-icon">⎋</div>
            <div class="menu-text-main">
              <span class="title">تسجيل الخروج</span>
              <span class="desc">إنهاء الجلسة الحالية بأمان.</span>
            </div>
          </div>
          <span class="menu-link-arrow">‹</span>
        </a>
      </li>
    </ul>
  </div>

  <div class="drawer-footer">
    <span>نسخة التليفون</span>
    <span class="label-strong">MZJ Workspace · Mobile</span>
  </div>
</aside>

<script>
  const btnOpenDrawer = document.getElementById("btnOpenDrawer");
  const btnCloseDrawer = document.getElementById("btnCloseDrawer");
  const drawerPanel = document.getElementById("drawerPanel");
  const drawerBackdrop = document.getElementById("drawerBackdrop");

  function openDrawer() {
    document.body.classList.add("drawer-open");
    drawerPanel.classList.add("open");
    drawerBackdrop.classList.add("visible");
  }

  function closeDrawer() {
    document.body.classList.remove("drawer-open");
    drawerPanel.classList.remove("open");
    drawerBackdrop.classList.remove("visible");
  }

  if (btnOpenDrawer) {
    btnOpenDrawer.addEventListener("click", openDrawer);
  }
  if (btnCloseDrawer) {
    btnCloseDrawer.addEventListener("click", closeDrawer);
  }
  if (drawerBackdrop) {
    drawerBackdrop.addEventListener("click", closeDrawer);
  }

  window.addEventListener("keydown", (ev) => {
    if (ev.key === "Escape") {
      closeDrawer();
    }
  });
</script>

<script>
  // كارت تفاصيل تبويب تعديل السيارات (نسخة الموبايل)
  (function(){
    const tabEdit = document.getElementById("tab-edit");
    const table = document.getElementById("carsTable");
    const detailsCard = document.getElementById("editCarDetailsCard");
    const detailsBody = document.getElementById("editCarDetailsBody");
    const actionsContainer = document.getElementById("editCarActionsContainer");
    const btnClose = document.getElementById("btnCloseEditDetails");

    if (!tabEdit || !table || !detailsCard || !detailsBody || !actionsContainer) return;

    
    function buildDetailsFromRow(tr){
      if (!tr) return;
      const cells = Array.from(tr.children);
      const get = (i) => (cells[i] && cells[i].textContent.trim()) || "";

      // نحاول قراءة id من زر التعديل في نفس الصف
      const actionsCell = cells[11] || null;
      const editBtnInRow = actionsCell ? actionsCell.querySelector("button[data-edit]") : null;
      const idStr = editBtnInRow ? editBtnInRow.getAttribute("data-edit") : null;
      const recId = idStr ? Number(idStr) : null;
      const rec = recId ? (stock.find(r => r.id === recId) || {}) : {};

      const carVal      = rec.car      || get(0);
      const variantVal  = rec.variant  || get(1);
      const dealerVal   = rec.dealer   || get(2);
      const extColVal   = rec.extColor || get(3);
      const intColVal   = rec.intColor || get(4);
      const modelVal    = rec.modelYear|| get(5);
      const plateVal    = rec.plate    || get(6);
      const locVal      = rec.location || get(7);
      const batchVal    = rec.batchName|| get(8);
      const vinVal      = rec.vin      || get(9);
      const notesVal    = rec.notes    || get(10);

      const esc = (v) => (v == null ? '' : String(v)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;"));

      let locationOptions = "";
      if (Array.isArray(FIXED_LOCATIONS)) {
        locationOptions = FIXED_LOCATIONS.map(loc => {
          const sel = (loc === locVal) ? " selected" : "";
          return `<option value="${esc(loc)}"${sel}>${esc(loc)}</option>`;
        }).join("");
      } else {
        locationOptions = `<option value="${esc(locVal)}" selected>${esc(locVal)}</option>`;
      }

      detailsBody.innerHTML = `
        <div class="edit-detail-row">
          <span class="edit-detail-label">سيارة</span>
          <input id="cardEdit_car" class="edit-detail-input" type="text" value="${esc(carVal)}" />
        </div>
        <div class="edit-detail-row">
          <span class="edit-detail-label">البيان</span>
          <input id="cardEdit_variant" class="edit-detail-input" type="text" value="${esc(variantVal)}" />
        </div>
        <div class="edit-detail-row">
          <span class="edit-detail-label">الوكيل</span>
          <input id="cardEdit_dealer" class="edit-detail-input" type="text" value="${esc(dealerVal)}" />
        </div>
        <div class="edit-detail-row">
          <span class="edit-detail-label">المكان</span>
          <select id="cardEdit_location" class="edit-detail-select">
            ${locationOptions}
          </select>
        </div>
        <div class="edit-detail-row">
          <span class="edit-detail-label">رقم الهيكل</span>
          <input id="cardEdit_vin" class="edit-detail-input" type="text" value="${esc(vinVal)}" />
        </div>
        <div class="edit-detail-row">
          <span class="edit-detail-label">الألوان</span>
          <input id="cardEdit_colors" class="edit-detail-input" type="text" value="${esc(extColVal + (intColVal ? " / " + intColVal : ""))}" />
        </div>
        <div class="edit-detail-row">
          <span class="edit-detail-label">الموديل</span>
          <input id="cardEdit_modelYear" class="edit-detail-input" type="text" value="${esc(modelVal)}" />
        </div>
        <div class="edit-detail-row">
          <span class="edit-detail-label">اللوحة</span>
          <input id="cardEdit_plate" class="edit-detail-input" type="text" value="${esc(plateVal)}" />
        </div>
        <div class="edit-detail-row">
          <span class="edit-detail-label">اسم الدفعة</span>
          <input id="cardEdit_batch" class="edit-detail-input" type="text" value="${esc(batchVal)}" />
        </div>
        <div class="edit-detail-row">
          <span class="edit-detail-label">ملاحظات</span>
          <textarea id="cardEdit_notes" class="edit-detail-textarea">${esc(notesVal)}</textarea>
        </div>
      `;

      actionsContainer.innerHTML = `
        <div class="cell-actions" style="justify-content:center;gap:12px;">
          <button class="btn btn-danger" type="button" id="cardBtnDelete">حذف</button>
          <button class="btn btn-primary" type="button" id="cardBtnSave">تعديل</button>
        </div>
      `;

      detailsCard.style.display = "block";
      detailsCard.scrollIntoView({ behavior: "smooth", block: "start" });

      const btnSave = document.getElementById("cardBtnSave");
      const btnDelete = document.getElementById("cardBtnDelete");

      if (btnSave){
        btnSave.addEventListener("click", async function(){
          if (!recId) return;
          const idx = stock.findIndex(r => r.id === recId);
          if (idx < 0) return;
          const updated = { ...stock[idx] };

          const colorsVal = document.getElementById("cardEdit_colors")?.value || "";
          let extC = "", intC = "";
          if (colorsVal.includes("/")){
            const parts = colorsVal.split("/");
            extC = parts[0].trim();
            intC = parts.slice(1).join("/").trim();
          } else {
            extC = colorsVal.trim();
          }

          updated.car       = document.getElementById("cardEdit_car")?.value.trim() || "";
          updated.variant   = document.getElementById("cardEdit_variant")?.value.trim() || "";
          updated.dealer    = document.getElementById("cardEdit_dealer")?.value.trim() || "";
          updated.location  = document.getElementById("cardEdit_location")?.value.trim() || "";
          const vinRaw      = document.getElementById("cardEdit_vin")?.value.trim() || "";
          updated.vin       = typeof normalizeVin === "function" ? normalizeVin(vinRaw) : vinRaw;
          updated.extColor  = extC;
          updated.intColor  = intC;
          updated.modelYear = document.getElementById("cardEdit_modelYear")?.value.trim() || "";
          updated.plate     = document.getElementById("cardEdit_plate")?.value.trim() || "";
          updated.batchName = document.getElementById("cardEdit_batch")?.value.trim() || "";
          updated.notes     = document.getElementById("cardEdit_notes")?.value.trim() || "";

          stock[idx] = updated;
          await persistAll();
          renderTable();

          // نرجّع نختار نفس الصف في الجدول بعد التعديل
          const rows = Array.from(table.querySelectorAll("tbody tr"));
          const newRow = rows.find(r => {
            const b = r.querySelector('button[data-edit="' + recId + '"]');
            return !!b;
          });
          if (newRow){
            newRow.scrollIntoView({ behavior: "smooth", block: "center" });
          }

          showToast('تم تعديل السيارة من كارت التفاصيل','ok');
        });
      }

      if (btnDelete){
        btnDelete.addEventListener("click", async function(){
          if (!recId) return;
          const idx = stock.findIndex(r => r.id === recId);
          if (idx < 0) return;
          if (!confirm('هل تريد حذف هذه السيارة؟')) return;
          stock.splice(idx,1);
          await persistAll();
          renderTable();
          detailsCard.style.display = "none";
          showToast('تم حذف السيارة','ok');
        });
      }
    }
if (btnClose){
      btnClose.addEventListener("click", function(){
        detailsCard.style.display = "none";
      });
    }
  })();
</script>
</body>

</html>
