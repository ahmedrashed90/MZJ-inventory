<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>نقل السيارات — MZJ Cars</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet"/>
<style>
    body {
        font-family: "Tajawal", sans-serif;
        background: #fff7ef;
        margin: 0;
        padding: 0;
    }

    .page {
        max-width: 1200px;
        margin: 40px auto;
        background: #ffffff;
        padding: 30px;
        border-radius: 14px;
        box-shadow: 0 2px 10px rgba(0,0,0,.08);
    }

    h2 {
        color: #3e2420;
        margin-bottom: 20px;
    }

    label {
        font-weight: 600;
        display: block;
        margin-bottom: 6px;
    }

    input, select, textarea {
        width: 100%;
        padding: 10px;
        border-radius: 10px;
        border: 1px solid #ddd;
        margin-bottom: 14px;
        font-size: 14px;
    }

    button {
        padding: 10px 20px;
        border-radius: 10px;
        border: none;
        cursor: pointer;
        font-size: 14px;
    }

    .btn-primary {
        background: #3e2420;
        color: #fff;
    }

    .btn-outline {
        background: #fff;
        border: 1px solid #3e2420;
        color: #3e2420;
    }

    .result-box {
        background: #eaffea;
        padding: 14px;
        border-radius: 10px;
        margin-top: 20px;
        color: #236b28;
        border: 1px solid #b3e6b5;
    }
</style>
</head>

<body>

<div class="page">

    <h2>حركة نقل السيارات (برقم الهيكل)</h2>

    <div>
        <label>رقم الهيكل</label>
        <input id="vin" placeholder="أدخل رقم الهيكل">
    </div>

    <div>
        <button class="btn-outline" onclick="searchCar()">عرض البيانات</button>
    </div>

    <hr style="margin: 25px 0">

    <div>
        <label>من (محدد تلقائيًا)</label>
        <input id="fromLocation" disabled>
    </div>

    <div>
        <label>إلى</label>
        <select id="toLocation"></select>
    </div>

    <div>
        <label>ملاحظات</label>
        <textarea id="notes" placeholder="ملاحظات على حركة النقل (اختياري)"></textarea>
    </div>

    <button class="btn-primary" onclick="doMove()">نقل</button>

    <div id="result" class="result-box" style="display:none"></div>

</div>

<script type="module">

// تحميل Firebase
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyC614bGqnYf4Q-weTNemzWENTpa8DjGeHw",
  authDomain: "mzj-agenda.firebaseapp.com",
  projectId: "mzj-agenda",
  storageBucket: "mzj-agenda.firebasestorage.app",
  messagingSenderId: "834700407721",
  appId: "1:834700407721:web:75c17665d4f032fd65cab8"
};

const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);
const STATE = doc(db, "mzj_admin_state", "v1");

let stock = [];
let moves = [];
let selectedCar = null;

// تحميل البيانات
async function loadState(){
    const snap = await getDoc(STATE);
    if(snap.exists()){
        const d = snap.data();
        stock = d.stock || [];
        moves = d.moves || [];
    }
}

// بحث عن السيارة
async function searchCar(){
    await loadState();
    const vin = document.getElementById("vin").value.trim().toLowerCase();
    if(!vin) return alert("اكتب رقم الهيكل");

    selectedCar = stock.find(c => (c.vin || "").toString().toLowerCase() === vin);

    if(!selectedCar){
        alert("لم يتم العثور على السيارة");
        return;
    }

    document.getElementById("fromLocation").value = selectedCar.location || "";

    fillLocations();
}

// بناء قائمة المواقع
function fillLocations(){
    const select = document.getElementById("toLocation");
    select.innerHTML = "";

    const used = new Set(stock.map(s => s.location || ""));

    used.forEach(loc => {
        if(!loc) return;

        // يمنع "مباع" — نفس النظام الأصلي
        if(/مباع/.test(loc)) return;

        if(loc === selectedCar.location) return;

        const opt = document.createElement("option");
        opt.value = loc;
        opt.textContent = loc;
        select.appendChild(opt);
    });
}

// تنفيذ حركة النقل
async function doMove(){
    if(!selectedCar){
        alert("ابحث عن السيارة أولاً");
        return;
    }

    const to = document.getElementById("toLocation").value;
    const notes = document.getElementById("notes").value;

    if(!to){
        alert("اختر المكان");
        return;
    }

    const recIndex = stock.findIndex(c => c.vin === selectedCar.vin);
    if(recIndex === -1) return alert("خطأ!");

    const from = selectedCar.location;
    const stamp = new Date().toISOString().replace("T"," ").split(".")[0];

    // تحديث الموقع
    stock[recIndex].location = to;

    moves.push({
        when: stamp,
        date: stamp.split(" ")[0],
        vin: selectedCar.vin,
        car: selectedCar.car || "",
        from: from,
        to: to,
        notes: notes || "",
        status: "done",
        message: "تم نقل السيارة من تبويب نقل السيارات"
    });

    await setDoc(STATE, { stock, moves }, { merge: true });

    document.getElementById("result").style.display = "block";
    document.getElementById("result").textContent =
        `تم نقل ${selectedCar.car || ""} (${selectedCar.vin}) من ${from} إلى ${to} بنجاح`;
}

</script>

</body>
</html>
