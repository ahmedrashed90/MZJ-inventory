<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© â€” MZJ Cars</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
<style>
  :root{
    --brown:#3e2420; --beige:#bc8f74; --cream:#fff8ef; --text:#1f2937; --muted:#6b7280;
    --line:#e5e7eb; --line-strong:#d1d5db; --table-head:#fafafa;
    --card:#fff; --radius:14px; --ok:#16a34a; --danger:#ef4444; --info:#0ea5e9;
    --shadow:0 10px 24px rgba(0,0,0,.06);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--cream);color:var(--text);font-family:"Tajawal",system-ui,Arial}

  /* Topbar + tabs + auth badge */
  .topbar{position:sticky;top:0;z-index:1000;background:#fff;border-bottom:1px solid var(--line)}
  .topbar-inner{max-width:1240px;margin:auto;display:flex;align-items:center;justify-content:space-between;padding:10px 16px}
  .brand{display:flex;align-items:center;gap:10px}
  .brand .logo{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,var(--brown),#2a1613);
    display:grid;place-items:center;color:#fff;font-weight:800}
  .brand h1{margin:0;font-size:18px;color:var(--brown)}
  .tabs{display:flex;gap:8px;flex-wrap:wrap}
  .tab{padding:8px 12px;border:1px solid var(--line);border-radius:999px;background:#fff;text-decoration:none;color:inherit;font-weight:800;white-space:nowrap}
  .tab.active{background:var(--brown);border-color:var(--brown);color:#fff}
  .status-badge{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--line);background:#fff;border-radius:12px;padding:6px 10px;font-size:12px}
  .dot{width:10px;height:10px;border-radius:999px;background:#f59e0b}
  .dot.ok{background:var(--ok)} .dot.err{background:var(--danger)} .dot.warn{background:#f59e0b}

  /* Buttons */
  .btn{position:relative;border:1px solid var(--line);background:#fff;border-radius:12px;padding:10px 14px;cursor:pointer;font-weight:700;display:inline-flex;gap:8px;align-items:center;transition:.15s;font-size:13px}
  .btn:hover{transform:translateY(-1px)} .btn:active{transform:translateY(0)}
  .btn-primary{background:var(--brown);border-color:var(--brown);color:#fff}
  .btn-beige{background:var(--beige);border-color:var(--beige);color:#fff}
  .btn-ghost{background:#fff}
  .btn-danger{background:var(--danger);border-color:var(--danger);color:#fff}
  .btn-outline{background:#fff;border:1px solid var(--brown);color:var(--brown)}

  /* Layout */
  .container{max-width:1240px;margin:18px auto;padding:0 16px 48px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;margin-bottom:16px}
  .card-header{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px;flex-wrap:wrap}
  .section-title{display:flex;align-items:center;gap:8px;margin:0}
  .section-title svg{width:20px;height:20px;color:var(--brown)}
  .hint{color:var(--muted);font-size:12px}

  /* Inputs */
  label{font-weight:800;margin-bottom:6px;display:block;color:var(--brown);font-size:13px}
  .input-wrap{position:relative}
  .input-wrap .i{position:absolute;right:10px;top:50%;transform:translateY(-50%);color:#9ca3af}
  .input-wrap input{padding-right:36px}
  input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:#fff;outline:none;transition:.15s;font-family:"Tajawal",system-ui,Arial;font-size:13px}
  input:focus,select:focus,textarea:focus{border-color:var(--beige);box-shadow:0 0 0 3px rgba(188,143,116,.15)}
  #vin{height:44px} #notes{height:44px;resize:none}
  textarea{min-height:44px}

  /* Grid */
  .grid{display:grid;gap:12px}
  .grid-4{grid-template-columns:repeat(4,1fr)}
  .grid-3{grid-template-columns:repeat(3,1fr)}
  .grid-2{grid-template-columns:repeat(2,1fr)}
  @media (max-width:1080px){ .grid-4{grid-template-columns:repeat(3,1fr)} }
  @media (max-width:860px){ .grid-4,.grid-3{grid-template-columns:repeat(2,1fr)} }
  @media (max-width:620px){ .grid-4,.grid-3,.grid-2{grid-template-columns:1fr} }
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}

  /* Tables */
  .table-wrap{overflow:auto;border:1px solid var(--line);border-radius:14px}
  table{width:100%;border-collapse:separate;border-spacing:0;font-size:13px}
  thead th{position:sticky;top:0;background:var(--table-head);z-index:2;border-bottom:1px solid var(--line-strong);
    text-align:right;color:#111827;font-size:13.5px;padding:12px 10px}
  tbody td{border-top:1px solid var(--line);padding:10px;vertical-align:top}
  tbody tr:nth-child(odd){background:#fff}
  tbody tr:nth-child(even){background:#fcfcfc}
  tbody tr:hover{background:#f8fafc}
  td,th{border-left:1px solid var(--line)}
  td:last-child,th:last-child{border-left:0}
  .cell-actions{display:flex;gap:6px;flex-wrap:wrap}
  .nowrap{white-space:nowrap}
  .w-120{min-width:120px}
  .w-160{min-width:160px}

  /* Import dropdown */
  .import-menu{position:relative;display:inline-block}
  .import-dropdown{position:absolute;top:110%;left:0;background:#fff;border:1px solid var(--line);border-radius:12px;
    box-shadow:0 14px 28px rgba(0,0,0,.12);min-width:260px;z-index:20;display:none;overflow:hidden}
  .import-dropdown button{display:flex;gap:8px;align-items:center;width:100%;text-align:right;background:#fff;border:0;padding:12px 14px;cursor:pointer;font-weight:700}
  .import-dropdown button:hover{background:#f9fafb}

  /* Modal */
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.38);display:none;align-items:center;justify-content:center;z-index:50}
  .modal{background:#fff;border-radius:16px;box-shadow:0 24px 60px rgba(0,0,0,.35);width:min(520px,92vw);padding:16px;border:1px solid var(--line)}
  .modal header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .modal h3{margin:0;font-size:18px;color:var(--brown)}
  .modal .actions{display:flex;gap:8px;justify-content:flex-start;margin-top:12px}

  /* Toast */
  .toast{position:fixed;bottom:16px;right:16px;background:#111827;color:#fff;padding:10px 14px;border-radius:12px;box-shadow:0 10px 24px rgba(0,0,0,.25);display:none;z-index:60;font-size:13px}
  .toast.ok{background:var(--ok)} .toast.info{background:var(--info)} .toast.err{background:var(--danger)}

  /* Auth */
  .auth-wrap{min-height:60vh;display:grid;place-items:center;padding:24px}
  .auth-card{background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);padding:18px;max-width:420px;width:96%}
  .auth-card h2{margin:0 0 10px;color:var(--brown)}
  .auth-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}

  /* Checklist box */
  .checklist{border:1px dashed var(--beige);border-radius:12px;padding:12px;background:#fff8ef}
  .checklist h4{margin:0 0 8px 0;color:var(--brown);font-size:14px}
  .check-row{display:grid;grid-template-columns:18px 1fr;gap:8px;align-items:start}
  .check-row label{margin:0;display:flex;align-items:center;gap:8px}

  .copyable{cursor:pointer;border-bottom:1px dashed rgba(0,0,0,.2)}
</style>
</head>
<body>

<!-- Topbar -->
<div class="topbar">
  <div class="topbar-inner">
    <div class="brand">
      <div class="logo" title="MZJ">MZJ</div>
      <div>
        <h1>Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</h1>
        <small class="hint">Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ø­Ù…Ø¯ Ø¨Ù† Ø°Ø¹Ø§Ø± Ø§Ù„Ø¹Ø¬Ù…ÙŠ Ù„Ù„Ø³ÙŠØ§Ø±Ø§Øª</small>
      </div>
    </div>
    <div class="tabs">
      <a class="tab active" href="admin.html">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</a>
      <a class="tab" href="inventory.html">Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</a>
      <a class="tab" href="dashboard.html">Ø§Ù„Ø¯Ø§Ø´ Ø¨ÙˆØ±Ø¯</a>
      <a class="tab" href="photoshoot.html">Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªØµÙˆÙŠØ±</a>
      <a class="tab" href="photoshoot-user.html">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</a>
      <a class="tab" href="cars.html">ÙƒÙ„ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</a>
      <a class="tab" href="Activity.html">Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·</a>
    </div>
    <div class="row">
      <div class="status-badge"><span id="connDot" class="dot warn"></span><span id="connText">Ø¬Ø§Ø±Ù Ø§Ù„Ø§ØªØµØ§Ù„â€¦</span></div>
      <button id="btnSignOut" class="btn btn-ghost" style="display:none"><i class="fa-solid fa-right-from-bracket"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
    </div>
  </div>
</div>

<!-- Auth Gate -->
<div id="authGate" class="auth-wrap">
  <div class="auth-card">
    <h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
    <label for="email">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
    <input id="email" type="email" placeholder="you@example.com"/>
    <label for="password" style="margin-top:8px">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
    <input id="password" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"/>
    <div class="auth-actions">
      <button class="btn btn-primary" id="btnLogin">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
      <button class="btn btn-outline" id="btnSignup">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
    </div>
    <p class="hint" id="authHint" style="margin-top:10px"></p>
  </div>
</div>

<!-- App -->
<div id="app" style="display:none">
  <div class="container">

    <!-- Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ Ø³ÙŠØ§Ø±Ø© -->
    <div class="card">
      <div class="card-header">
        <div class="section-title">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
          <h2 style="margin:0">Ø¥Ø¶Ø§ÙØ© Ø³ÙŠØ§Ø±Ø©</h2>
        </div>
        <div class="row">
          <button class="btn btn-ghost" id="btnExport" title="ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Excel">
            <i class="fa-regular fa-file-excel"></i> ØªØµØ¯ÙŠØ±
          </button>
          <!-- Ø§Ù„Ø¬Ø¯ÙŠØ¯: Ø²Ø± ØªØµØ¯ÙŠØ± Ù‚Ø§Ù„Ø¨ ÙØ§Ø¶ÙŠ -->
          <button class="btn btn-ghost" id="btnExportBlank" title="ØªØµØ¯ÙŠØ± Ù‚Ø§Ù„Ø¨ ÙØ§Ø¶ÙŠ">
            <i class="fa-regular fa-file"></i> ØªØµØ¯ÙŠØ± Ù‚Ø§Ù„Ø¨ ÙØ§Ø¶ÙŠ
          </button>
          <div class="import-menu">
            <button class="btn btn-ghost" id="btnImportMenu" title="Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù† Excel">
              <i class="fa-solid fa-file-import"></i> Ø§Ø³ØªÙŠØ±Ø§Ø¯ â–¾
            </button>
            <div class="import-dropdown" id="importDropdown">
              <button data-mode="replace"><i class="fa-solid fa-arrow-rotate-left"></i> Ø§Ø³ØªØ¨Ø¯Ø§Ù„ ÙƒØ§Ù…Ù„ (Ù…Ø³Ø­ Ø§Ù„Ù‚Ø¯ÙŠÙ… + Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯)</button>
              <button data-mode="append"><i class="fa-solid fa-plus"></i> Ø¥Ø¶Ø§ÙØ© ÙÙˆÙ‚ Ø§Ù„Ø­Ø§Ù„ÙŠ (Ø¨Ø¯ÙˆÙ† Ù…Ø³Ø­)</button>
            </div>
          </div>
          <input type="file" id="fileImport" accept=".xlsx,.xls,.csv" style="display:none"/>
        </div>
      </div>

      <div class="grid grid-4">
        <div>
          <label for="carSelect">Ø³ÙŠØ§Ø±Ø©</label>
          <div class="row" style="gap:8px;align-items:stretch">
            <select id="carSelect" title="Ø§Ø®ØªØ± Ø§Ù„Ø³ÙŠØ§Ø±Ø©"></select>
            <button class="btn btn-outline" id="btnAddModel" title="Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¯ÙŠÙ„ Ø¬Ø¯ÙŠØ¯">
              <i class="fa-solid fa-plus"></i> Ù…ÙˆØ¯ÙŠÙ„
            </button>
          </div>
        </div>
        <div>
          <label for="variantSelect">Ø§Ù„Ø¨ÙŠØ§Ù†</label>
          <div class="row" style="gap:8px;align-items:stretch">
            <select id="variantSelect" title="Ø§Ø®ØªØ± Ø§Ù„Ø¨ÙŠØ§Ù†"></select>
            <button class="btn btn-outline" id="btnAddVariant" title="Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù† ÙˆØ±Ø¨Ø·Ù‡ Ø¨Ø³ÙŠØ§Ø±Ø©">
              <i class="fa-solid fa-plus"></i> Ø¨ÙŠØ§Ù†
            </button>
          </div>
          <div class="hint">ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù† Ø¬Ø¯ÙŠØ¯ ÙˆØ±Ø¨Ø·Ù‡ Ø¨Ø£ÙŠ Ø³ÙŠØ§Ø±Ø©</div>
        </div>

        <div><label for="dealer">Ø§Ù„ÙˆÙƒÙŠÙ„</label>
          <div class="input-wrap">
            <span class="i"><i class="fa-regular fa-building"></i></span>
            <input id="dealer" placeholder="Ø§Ø³Ù… Ø§Ù„ÙˆÙƒÙŠÙ„"/>
          </div>
        </div>

        <div><label for="extColor">Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ</label>
          <div class="input-wrap">
            <span class="i"><i class="fa-regular fa-circle"></i></span>
            <input id="extColor" placeholder="Ø£Ø¨ÙŠØ¶ / Ø£Ø³ÙˆØ¯ ..."/>
          </div>
        </div>

        <div><label for="intColor">Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ</label>
          <div class="input-wrap">
            <span class="i"><i class="fa-regular fa-square"></i></span>
            <input id="intColor" placeholder="Ø¬Ù…Ù„ÙŠ / Ø£Ø³ÙˆØ¯ ..."/>
          </div>
        </div>

        <div><label for="modelYear">Ù…ÙˆØ¯ÙŠÙ„</label>
          <div class="input-wrap">
            <span class="i"><i class="fa-regular fa-calendar"></i></span>
            <input id="modelYear" type="number" min="2000" max="2100" placeholder="2026"/>
          </div>
        </div>

        <div><label for="plate">Ø§Ù„Ù„ÙˆØ­Ø©</label>
          <div class="input-wrap">
            <span class="i"><i class="fa-regular fa-id-card"></i></span>
            <input id="plate" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ"/>
          </div>
        </div>

        <!-- Ø§Ù„Ù…ÙƒØ§Ù†: Ù‚Ø§Ø¦Ù…Ø© Ù…Ù†Ø³Ø¯Ù„Ø© Ø«Ø§Ø¨ØªØ© -->
        <div>
          <label for="location">Ø§Ù„Ù…ÙƒØ§Ù†</label>
          <select id="location" title="Ø§Ø®ØªØ± Ø§Ù„Ù…ÙƒØ§Ù†">
            <option value="Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ : Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…ØªØ§Ø­">Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ : Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…ØªØ§Ø­</option>
            <option value="Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ : Ø³ÙŠØ§Ø±Ø§Øª Ø¨Ù‡Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§Øª">Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ : Ø³ÙŠØ§Ø±Ø§Øª Ø¨Ù‡Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§Øª</option>
            <option value="Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ : Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…">Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ : Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…</option>
            <option value="Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ : Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…">Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ : Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…</option>

            <option value="Ø§Ù„ÙˆÙƒØ§Ù„Ø© : Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…ØªØ§Ø­">Ø§Ù„ÙˆÙƒØ§Ù„Ø© : Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…ØªØ§Ø­</option>
            <option value="Ø§Ù„ÙˆÙƒØ§Ù„Ø© : Ø³ÙŠØ§Ø±Ø§Øª Ø¨Ù‡Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§Øª">Ø§Ù„ÙˆÙƒØ§Ù„Ø© : Ø³ÙŠØ§Ø±Ø§Øª Ø¨Ù‡Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§Øª</option>
            <option value="Ø§Ù„ÙˆÙƒØ§Ù„Ø© : Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…">Ø§Ù„ÙˆÙƒØ§Ù„Ø© : Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…</option>
            <option value="Ø§Ù„ÙˆÙƒØ§Ù„Ø© : Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…">Ø§Ù„ÙˆÙƒØ§Ù„Ø© : Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…</option>

            <option value="ÙØ±Ø¹ 1 Ø§Ù„ØµØ§Ù„Ø© : Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…ØªØ§Ø­">ÙØ±Ø¹ 1 Ø§Ù„ØµØ§Ù„Ø© : Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…ØªØ§Ø­</option>
            <option value="ÙØ±Ø¹ 1 Ø§Ù„ØµØ§Ù„Ø© : Ø³ÙŠØ§Ø±Ø§Øª Ø¨Ù‡Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§Øª">ÙØ±Ø¹ 1 Ø§Ù„ØµØ§Ù„Ø© : Ø³ÙŠØ§Ø±Ø§Øª Ø¨Ù‡Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§Øª</option>
            <option value="ÙØ±Ø¹ 1 Ø§Ù„ØµØ§Ù„Ø© : Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…">ÙØ±Ø¹ 1 Ø§Ù„ØµØ§Ù„Ø© : Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…</option>
            <option value="ÙØ±Ø¹ 1 Ø§Ù„ØµØ§Ù„Ø© : Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…">ÙØ±Ø¹ 1 Ø§Ù„ØµØ§Ù„Ø© : Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…</option>

            <option value="ÙØ±Ø¹ 2 Ø§Ù„Ù…Ù„ØªÙ‚Ù‰ : Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…ØªØ§Ø­">ÙØ±Ø¹ 2 Ø§Ù„Ù…Ù„ØªÙ‚Ù‰ : Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…ØªØ§Ø­</option>
            <option value="ÙØ±Ø¹ 2 Ø§Ù„Ù…Ù„ØªÙ‚Ù‰ : Ø³ÙŠØ§Ø±Ø§Øª Ø¨Ù‡Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§Øª">ÙØ±Ø¹ 2 Ø§Ù„Ù…Ù„ØªÙ‚Ù‰ : Ø³ÙŠØ§Ø±Ø§Øª Ø¨Ù‡Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§Øª</option>
            <option value="ÙØ±Ø¹ 2 Ø§Ù„Ù…Ù„ØªÙ‚Ù‰ : Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…">ÙØ±Ø¹ 2 Ø§Ù„Ù…Ù„ØªÙ‚Ù‰ : Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…</option>
            <option value="ÙØ±Ø¹ 2 Ø§Ù„Ù…Ù„ØªÙ‚Ù‰ : Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…">ÙØ±Ø¹ 2 Ø§Ù„Ù…Ù„ØªÙ‚Ù‰ : Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…</option>

            <option value="ÙØ±Ø¹ 3 Ø§Ù„Ù‚Ø§Ø¯Ø³ÙŠØ© : Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…ØªØ§Ø­">ÙØ±Ø¹ 3 Ø§Ù„Ù‚Ø§Ø¯Ø³ÙŠØ© : Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…ØªØ§Ø­</option>
            <option value="ÙØ±Ø¹ 3 Ø§Ù„Ù‚Ø§Ø¯Ø³ÙŠØ© : Ø³ÙŠØ§Ø±Ø§Øª Ø¨Ù‡Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§Øª">ÙØ±Ø¹ 3 Ø§Ù„Ù‚Ø§Ø¯Ø³ÙŠØ© : Ø³ÙŠØ§Ø±Ø§Øª Ø¨Ù‡Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§Øª</option>
            <option value="ÙØ±Ø¹ 3 Ø§Ù„Ù‚Ø§Ø¯Ø³ÙŠØ© : Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…">ÙØ±Ø¹ 3 Ø§Ù„Ù‚Ø§Ø¯Ø³ÙŠØ© : Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…</option>
            <option value="ÙØ±Ø¹ 3 Ø§Ù„Ù‚Ø§Ø¯Ø³ÙŠØ© : Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…">ÙØ±Ø¹ 3 Ø§Ù„Ù‚Ø§Ø¯Ø³ÙŠØ© : Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…</option>
          </select>
        </div>

        <div><label for="batchName">Ø§Ø³Ù… Ø§Ù„Ø¯ÙØ¹Ø©</label>
          <div class="input-wrap">
            <span class="i"><i class="fa-solid fa-layer-group"></i></span>
            <input id="batchName" placeholder="Ø¯ÙØ¹Ø© Ø±Ù…Ø¶Ø§Ù† / Ù†ÙˆÙÙ…Ø¨Ø± 2025â€¦"/>
          </div>
        </div>

        <div><label for="vin">Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„</label>
          <div class="input-wrap">
            <span class="i"><i class="fa-solid fa-barcode"></i></span>
            <input id="vin" placeholder="LVR.../KMH.../Ø±Ù‚Ù…"/>
          </div>
        </div>

        <div class="grid" style="grid-template-columns:1fr">
          <label for="notes">Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
          <textarea id="notes" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© â€” Ù†ÙØ³ Ø§Ø±ØªÙØ§Ø¹ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„"></textarea>
        </div>
      </div>

      <div class="row" style="margin-top:12px">
        <button class="btn btn-primary" id="btnSave" title="Ø­ÙØ¸ (Ctrl+S)">
          <i class="fa-regular fa-floppy-disk"></i> Ø­ÙØ¸
        </button>
        <button class="btn btn-ghost" id="btnReset" title="ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„ (Esc)">
          <i class="fa-solid fa-rotate"></i> ØªÙØ±ÙŠØº
        </button>
        <div class="hint">/ Ù„Ù„Ø¨Ø­Ø« â€” Ctrl+S Ù„Ù„Ø­ÙØ¸ â€” Ctrl+K Ù„Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†</div>
      </div>
    </div>

    <!-- Ø­Ø±ÙƒØ© Ù†Ù‚Ù„ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª (Ø¨Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„) -->
    <div class="card">
      <div class="card-header">
        <div class="section-title">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M7 10l5-5 5 5"/><path d="M7 14l5 5 5-5"/></svg>
          <h2 style="margin:0">Ø­Ø±ÙƒØ© Ù†Ù‚Ù„ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª (Ø¨Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„)</h2>
        </div>
        <span class="hint">ÙŠÙ…ÙƒÙ† Ù†Ù‚Ù„ Ø­ØªÙ‰ 8 Ø³ÙŠØ§Ø±Ø§Øª ÙÙŠ Ù†ÙØ³ Ø§Ù„Ø­Ø±ÙƒØ© â€” ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ <b>Ù…Ù†</b> ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù„ÙƒÙ„ Ø±Ù‚Ù… Ù‡ÙŠÙƒÙ„.</span>
      </div>

      <div class="grid grid-3">
        <div class="grid grid-2" style="grid-column:1/3;gap:10px">
          <!-- 8 ØµÙÙˆÙ Ù„Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ + Ù…Ù† -->
          <!-- ØµÙ 1 -->
          <div class="row" style="align-items:flex-end">
            <div style="flex:1">
              <label for="moveVin1">Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ 1</label>
              <input id="moveVin1" class="move-vin-input" list="vinHints" placeholder="Ø§ÙƒØªØ¨ Ø¨Ø¯Ø§ÙŠØ© Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„" title="VIN ÙŠØ¨Ø¯Ø£ Ø¨Ù€"/>
            </div>
            <div style="flex:1">
              <label for="moveFrom1">Ù…Ù† (Ù…Ø­Ø¯Ù‘Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§)</label>
              <select id="moveFrom1" class="move-from-select" title="Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„Ø­Ø§Ù„ÙŠ" disabled></select>
            </div>
          </div>
          <!-- ØµÙ 2 -->
          <div class="row" style="align-items:flex-end">
            <div style="flex:1">
              <label for="moveVin2">Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ 2</label>
              <input id="moveVin2" class="move-vin-input" list="vinHints" placeholder="Ø§ÙƒØªØ¨ Ø¨Ø¯Ø§ÙŠØ© Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„" title="VIN ÙŠØ¨Ø¯Ø£ Ø¨Ù€"/>
            </div>
            <div style="flex:1">
              <label for="moveFrom2">Ù…Ù† (Ù…Ø­Ø¯Ù‘Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§)</label>
              <select id="moveFrom2" class="move-from-select" title="Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„Ø­Ø§Ù„ÙŠ" disabled></select>
            </div>
          </div>
          <!-- ØµÙ 3 -->
          <div class="row" style="align-items:flex-end">
            <div style="flex:1">
              <label for="moveVin3">Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ 3</label>
              <input id="moveVin3" class="move-vin-input" list="vinHints" placeholder="Ø§ÙƒØªØ¨ Ø¨Ø¯Ø§ÙŠØ© Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„" title="VIN ÙŠØ¨Ø¯Ø£ Ø¨Ù€"/>
            </div>
            <div style="flex:1">
              <label for="moveFrom3">Ù…Ù† (Ù…Ø­Ø¯Ù‘Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§)</label>
              <select id="moveFrom3" class="move-from-select" title="Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„Ø­Ø§Ù„ÙŠ" disabled></select>
            </div>
          </div>
          <!-- ØµÙ 4 -->
          <div class="row" style="align-items:flex-end">
            <div style="flex:1">
              <label for="moveVin4">Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ 4</label>
              <input id="moveVin4" class="move-vin-input" list="vinHints" placeholder="Ø§ÙƒØªØ¨ Ø¨Ø¯Ø§ÙŠØ© Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„" title="VIN ÙŠØ¨Ø¯Ø£ Ø¨Ù€"/>
            </div>
            <div style="flex:1">
              <label for="moveFrom4">Ù…Ù† (Ù…Ø­Ø¯Ù‘Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§)</label>
              <select id="moveFrom4" class="move-from-select" title="Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„Ø­Ø§Ù„ÙŠ" disabled></select>
            </div>
          </div>
          <!-- ØµÙ 5 -->
          <div class="row" style="align-items:flex-end">
            <div style="flex:1">
              <label for="moveVin5">Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ 5</label>
              <input id="moveVin5" class="move-vin-input" list="vinHints" placeholder="Ø§ÙƒØªØ¨ Ø¨Ø¯Ø§ÙŠØ© Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„" title="VIN ÙŠØ¨Ø¯Ø£ Ø¨Ù€"/>
            </div>
            <div style="flex:1">
              <label for="moveFrom5">Ù…Ù† (Ù…Ø­Ø¯Ù‘Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§)</label>
              <select id="moveFrom5" class="move-from-select" title="Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„Ø­Ø§Ù„ÙŠ" disabled></select>
            </div>
          </div>
          <!-- ØµÙ 6 -->
          <div class="row" style="align-items:flex-end">
            <div style="flex:1">
              <label for="moveVin6">Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ 6</label>
              <input id="moveVin6" class="move-vin-input" list="vinHints" placeholder="Ø§ÙƒØªØ¨ Ø¨Ø¯Ø§ÙŠØ© Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„" title="VIN ÙŠØ¨Ø¯Ø£ Ø¨Ù€"/>
            </div>
            <div style="flex:1">
              <label for="moveFrom6">Ù…Ù† (Ù…Ø­Ø¯Ù‘Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§)</label>
              <select id="moveFrom6" class="move-from-select" title="Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„Ø­Ø§Ù„ÙŠ" disabled></select>
            </div>
          </div>
          <!-- ØµÙ 7 -->
          <div class="row" style="align-items:flex-end">
            <div style="flex:1">
              <label for="moveVin7">Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ 7</label>
              <input id="moveVin7" class="move-vin-input" list="vinHints" placeholder="Ø§ÙƒØªØ¨ Ø¨Ø¯Ø§ÙŠØ© Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„" title="VIN ÙŠØ¨Ø¯Ø£ Ø¨Ù€"/>
            </div>
            <div style="flex:1">
              <label for="moveFrom7">Ù…Ù† (Ù…Ø­Ø¯Ù‘Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§)</label>
              <select id="moveFrom7" class="move-from-select" title="Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„Ø­Ø§Ù„ÙŠ" disabled></select>
            </div>
          </div>
          <!-- ØµÙ 8 -->
          <div class="row" style="align-items:flex-end">
            <div style="flex:1">
              <label for="moveVin8">Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ 8</label>
              <input id="moveVin8" class="move-vin-input" list="vinHints" placeholder="Ø§ÙƒØªØ¨ Ø¨Ø¯Ø§ÙŠØ© Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„" title="VIN ÙŠØ¨Ø¯Ø£ Ø¨Ù€"/>
            </div>
            <div style="flex:1">
              <label for="moveFrom8">Ù…Ù† (Ù…Ø­Ø¯Ù‘Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§)</label>
              <select id="moveFrom8" class="move-from-select" title="Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„Ø­Ø§Ù„ÙŠ" disabled></select>
            </div>
          </div>
        </div>

        <div>
          <label for="moveTo">Ø¥Ù„Ù‰</label>
          <select id="moveTo" title="Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„Ø¬Ø¯ÙŠØ¯"></select>
        </div>
      </div>

      <datalist id="vinHints"></datalist>

      <!-- Checklist ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ù…Ø¹ 'Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…' -->
      <div id="underDeliveryBox" class="checklist" style="display:none; margin-top:10px">
        <h4>Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ù„ Ø¥Ù„Ù‰ <b>Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…</b></h4>
        <div class="grid grid-2">
          <div>
            <div class="check-row">
              <input type="checkbox" id="chkAdminApproved"/>
              <label for="chkAdminApproved">Ù…ÙˆØ§ÙÙ‚Ø© Ø¥Ø¯Ø§Ø±ÙŠØ©</label>
            </div>
            <label for="adminNotes" style="margin-top:6px">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©</label>
            <textarea id="adminNotes" placeholder="Ø§ÙƒØªØ¨ Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¯Ø§Ø±ÙŠØ©â€¦"></textarea>
          </div>
          <div>
            <div class="check-row">
              <input type="checkbox" id="chkFinanceApproved"/>
              <label for="chkFinanceApproved">Ù…ÙˆØ§ÙÙ‚Ø© Ù…Ø§Ù„ÙŠØ©</label>
            </div>
            <label for="financeNotes" style="margin-top:6px">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ©</label>
            <textarea id="financeNotes" placeholder="Ø§ÙƒØªØ¨ Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…Ø§Ù„ÙŠØ©â€¦"></textarea>
          </div>
        </div>
      </div>

      <!-- Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ù„ Ø¥Ù„Ù‰ Ø³ÙŠØ§Ø±Ø§Øª Ø¨Ù‡Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§Øª -->
      <div id="notesIssuesBox" class="checklist" style="display:none; margin-top:10px">
        <h4>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ù„ Ø¥Ù„Ù‰ <b>Ø³ÙŠØ§Ø±Ø§Øª Ø¨Ù‡Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§Øª</b></h4>
        <label for="issuesNotes">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ§Ø±Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…ÙƒØ§Ù†</label>
        <textarea id="issuesNotes" placeholder="Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø© Ø£Ùˆ Ø§Ù„Ø³Ø¨Ø¨â€¦"></textarea>
      </div>

      <div class="row" style="margin-top:12px">
        <button class="btn btn-ghost" id="btnFindByVin" title="Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø©">
          <i class="fa-solid fa-magnifying-glass"></i> Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        </button>
        <button class="btn btn-primary" id="btnMove" title="ØªÙ†ÙÙŠØ° Ø§Ù„Ù†Ù‚Ù„">
          <i class="fa-solid fa-right-left"></i> Ù†Ù‚Ù„
        </button>
      </div>
      <p class="hint" id="moveStatus" style="margin-top:8px"></p>

      <!-- Ø¨Ø·Ø§Ù‚Ø© Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø© -->
      <div id="carDetailsBox" class="card" style="display:none;margin-top:12px">
        <div class="section-title">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3" y="4" width="18" height="16" rx="2"/><path d="M7 8h10"/></svg>
          <h2 style="margin:0">Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø©</h2>
        </div>
        <div id="carDetails" class="grid grid-2" style="margin-top:8px"></div>
        <p class="hint" id="carDetailsHint" style="margin-top:8px"></p>
      </div>
    </div>

    <!-- Ø³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ§Øª -->
    <div class="card">
      <div class="card-header">
        <div class="section-title" style="margin-bottom:0">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 5h18M3 12h18M3 19h18"/></svg>
          <h2 style="margin:0">Ø³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ§Øª</h2>
        </div>
        <div class="row">
          <div class="row">
            <label style="margin:0 6px 0 0">ØªØ§Ø±ÙŠØ® Ù…Ù†</label>
            <input type="date" id="movesFromDate">
          </div>
          <div class="row">
            <label style="margin:0 6px 0 0">Ø¥Ù„Ù‰</label>
            <input type="date" id="movesToDate">
          </div>
          <button class="btn btn-ghost" id="btnClearDate">Ù…Ø³Ø­ Ø§Ù„ØªØ§Ø±ÙŠØ®</button>
        </div>
      </div>
      <div class="table-wrap">
        <table id="movesTable">
          <thead>
            <tr>
              <th class="w-120">#</th>
              <th class="w-120">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
              <th>Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„</th>
              <th>Ø³ÙŠØ§Ø±Ø©</th>
              <th>Ù…Ù†</th>
              <th>Ø¥Ù„Ù‰</th>
              <th class="w-120">ID</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn btn-ghost" id="btnClearMoves" title="ØªÙØ±ÙŠØº Ø§Ù„Ø³Ø¬Ù„">
          <i class="fa-regular fa-trash-can"></i> ØªÙØ±ÙŠØº
        </button>
      </div>
    </div>

    <!-- ØªØªØ¨Ø¹ VIN -->
    <div class="card">
      <div class="card-header">
        <div class="section-title">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 8v8M8 12h8"/></svg>
          <h2 style="margin:0">ØªØªØ¨Ù‘Ø¹ Ø­Ø±ÙƒØ© Ø±Ù‚Ù… Ù‡ÙŠÙƒÙ„</h2>
        </div>
        <div class="row" style="gap:8px">
          <input id="trackVin" placeholder="Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ Ù„Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø­Ø±ÙƒØ§ØªÙ‡"/>
          <button class="btn btn-ghost" id="btnClearTrack">Ù…Ø³Ø­</button>
        </div>
      </div>
      <div class="table-wrap">
        <table id="trackTable">
          <thead>
            <tr>
              <th class="w-120">#</th>
              <th class="w-120">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
              <th>Ù…Ù†</th>
              <th>Ø¥Ù„Ù‰</th>
              <th>Ø³ÙŠØ§Ø±Ø©</th>
              <th class="w-160">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù†Ù‚Ù„</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <p class="hint">ÙŠØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ÙƒØ§Ù…Ù„ Ù…Ù†Ø° Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ù„Ù„Ù†Ø¸Ø§Ù… Ø­ØªÙ‰ Ø§Ù„ØªØ³Ù„ÙŠÙ….</p>
    </div>

    <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª -->
    <div class="card">
      <div class="card-header">
        <div class="section-title">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3" y="4" width="18" height="16" rx="2"/><path d="M7 8h10"/></svg>
          <h2 style="margin:0">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</h2>
        </div>
        <span class="hint">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ â€œØ§Ù„Ù„ÙˆØ­Ø©â€ Ø£Ùˆ â€œØ±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„â€ Ù„Ù„Ù†Ø³Ø® Ø§Ù„Ø³Ø±ÙŠØ¹</span>
      </div>
      <div class="row" style="gap:8px;margin-bottom:8px">
        <input id="search" placeholder="Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹ (Ø³ÙŠØ§Ø±Ø© / Ø§Ù„Ø¨ÙŠØ§Ù† / Ø§Ù„ÙˆÙƒÙŠÙ„ / Ø§Ù„Ø£Ù„ÙˆØ§Ù† / Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„ / Ø§Ù„Ù„ÙˆØ­Ø© / Ø§Ù„Ù…ÙƒØ§Ù† / Ø§Ø³Ù… Ø§Ù„Ø¯ÙØ¹Ø© / Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„)" title="Ø§Ø¶ØºØ· / Ù„Ù„Ø¨Ø­Ø«" style="flex:1; padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:#fff">
        <button class="btn btn-ghost" id="btnClearSearch" title="Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø«">
          <i class="fa-solid fa-minus"></i> Ù…Ø³Ø­
        </button>
      </div>
      <div class="table-wrap">
        <table id="carsTable">
          <thead>
            <tr>
              <th>Ø³ÙŠØ§Ø±Ø©</th>
              <th>Ø§Ù„Ø¨ÙŠØ§Ù†</th>
              <th>Ø§Ù„ÙˆÙƒÙŠÙ„</th>
              <th>Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ</th>
              <th>Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ</th>
              <th>Ù…ÙˆØ¯ÙŠÙ„</th>
              <th>Ø§Ù„Ù„ÙˆØ­Ø©</th>
              <th>Ø§Ù„Ù…ÙƒØ§Ù†</th>
              <th>Ø§Ø³Ù… Ø§Ù„Ø¯ÙØ¹Ø©</th>
              <th>Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„</th>
              <th>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
              <th class="w-160">ØªØ­ÙƒÙ…</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <p class="hint">Ø§Ù„Ø­ÙØ¸ ÙŠØªÙ… Ù…Ø¨Ø§Ø´Ø±Ø© Ø¹Ù„Ù‰ Firestore.</p>
    </div>
  </div>
</div>

<!-- Modals -->
<!-- Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¯ÙŠÙ„ -->
<div id="modelModal" class="modal-backdrop">
  <div class="modal" role="dialog" aria-modal="true">
    <header>
      <h3>Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¯ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</h3>
      <button class="btn btn-ghost" data-close="modelModal"><i class="fa-solid fa-xmark"></i></button>
    </header>
    <label for="modelName">Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„</label>
    <input id="modelName" placeholder="Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ ØªÙˆØ³Ø§Ù† 2026 / Ø³Ù†ØªØ§ÙÙŠâ€¦"/>
    <div class="actions">
      <button class="btn btn-primary" id="confirmAddModel"><i class="fa-solid fa-check"></i> Ø¥Ø¶Ø§ÙØ©</button>
      <button class="btn" data-close="modelModal">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>
</div>

<!-- Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù† -->
<div id="variantModal" class="modal-backdrop">
  <div class="modal" role="dialog" aria-modal="true">
    <header>
      <h3>Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù† ÙˆØ±Ø¨Ø·Ù‡ Ø¨Ù…ÙˆØ¯ÙŠÙ„</h3>
      <button class="btn btn-ghost" data-close="variantModal"><i class="fa-solid fa-xmark"></i></button>
    </header>
    <label for="variantModelFor">Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„</label>
    <select id="variantModelFor"></select>
    <label for="variantName" style="margin-top:8px">Ø§Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†</label>
    <input id="variantName" placeholder="ÙƒÙˆÙ…ÙÙˆØ±Øª / Ø³Ù…Ø§Ø±Øª / Ø±ÙˆÙŠØ§Ù„â€¦"/>
    <div class="actions">
      <button class="btn btn-primary" id="confirmAddVariant"><i class="fa-solid fa-check"></i> Ø¥Ø¶Ø§ÙØ©</button>
      <button class="btn" data-close="variantModal">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div id="toast" class="toast"></div>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

  /* ===== Firebase ===== */
  const firebaseConfig = {
    apiKey: "AIzaSyC614bGqnYf4Q-weTNemzWENTpa8DjGeHw",
    authDomain: "mzj-agenda.firebaseapp.com",
    projectId: "mzj-agenda",
    storageBucket: "mzj-agenda.firebasestorage.app",
    messagingSenderId: "834700407721",
    appId: "1:834700407721:web:75c17665d4f032fd65cab8"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);
  const STATE_REF = doc(db, "mzj_admin_state", "v1");

  /* ===== Helpers / State ===== */
  const $ = s => document.querySelector(s);
  const toast = $('#toast');
  function showToast(msg,type='ok'){toast.textContent=msg;toast.className='toast '+type;toast.style.display='block';setTimeout(()=>toast.style.display='none',1800)}
  function pad(n){return n<10?'0'+n:n}
  function now(){const d=new Date();return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;}
  function onlyDate(str){return (str||'').toString().slice(0,10)}
  function normalizeVin(v){if(!v)return'';const ar={'Ù ':'0','Ù¡':'1','Ù¢':'2','Ù£':'3','Ù¤':'4','Ù¥':'5','Ù¦':'6','Ù§':'7','Ù¨':'8','Ù©':'9'};return v.toString().replace(/[Ù -Ù©]/g,d=>ar[d]).toUpperCase().replace(/[\s\-\._]/g,'').trim()}
  function nextId(){return stock.length?Math.max(...stock.map(r=>Number(r.id)||0))+1:1}
  function debounce(fn,wait=250){let t;return (...args)=>{clearTimeout(t);t=setTimeout(()=>fn(...args),wait)};}

  let stock=[], moves=[], models=[], variantsMap={};

  /* ===== DOM refs ===== */
  const connDot=$('#connDot'), connText=$('#connText');
  const authGate=$('#authGate'), appRoot=$('#app'), btnSignOut=$('#btnSignOut');
  const emailEl=$('#email'), passEl=$('#password'), btnLogin=$('#btnLogin'), btnSignup=$('#btnSignup'), authHint=$('#authHint');

  const carSelect=$('#carSelect'), variantSelect=$('#variantSelect');
  const dealerInput=$('#dealer'), extColorInput=$('#extColor'), intColorInput=$('#intColor');
  const modelYearInput=$('#modelYear'), plateInput=$('#plate'), locationSelect=$('#location'), batchNameInput=$('#batchName');
  const vinInput=$('#vin'), notesInput=$('#notes');
  const btnSave=$('#btnSave'), btnReset=$('#btnReset');

  const btnImportMenu=$('#btnImportMenu'), importDropdown=$('#importDropdown'), fileImport=$('#fileImport'), btnExport=$('#btnExport'), btnExportBlank=$('#btnExportBlank');

  const searchInput=$('#search'), btnClearSearch=$('#btnClearSearch'), tableBody=document.querySelector('#carsTable tbody');
  const movesTableBody=document.querySelector('#movesTable tbody'), btnClearMoves=$('#btnClearMoves');

  // Ø³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ§Øª â€” ÙÙ„Ø§ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ®
  const movesFromDate=$('#movesFromDate'), movesToDate=$('#movesToDate'), btnClearDate=$('#btnClearDate');

  // ØªØªØ¨Ø¹ VIN
  const trackVin=$('#trackVin'), trackTableBody=document.querySelector('#trackTable tbody'), btnClearTrack=$('#btnClearTrack');

  // Modals
  const modelModal = $('#modelModal');
  const variantModal = $('#variantModal');
  const btnAddModel=$('#btnAddModel'), btnAddVariant=$('#btnAddVariant');
  const modelNameEl = $('#modelName');
  const confirmAddModel = $('#confirmAddModel');

  const variantModelForEl = $('#variantModelFor');
  const variantNameEl = $('#variantName');
  const confirmAddVariant = $('#confirmAddVariant');

  // Ø­Ø±ÙƒØ© Ø§Ù„Ù†Ù‚Ù„
  const moveTo = $('#moveTo');
  const btnFindByVin=$('#btnFindByVin'), btnMove=$('#btnMove');
  const moveStatus=$('#moveStatus'), carDetailsBox=$('#carDetailsBox'), carDetails=$('#carDetails'), carDetailsHint=$('#carDetailsHint');
  const vinHints = $('#vinHints'); // datalist
  const moveVinInputs = Array.from(document.querySelectorAll('.move-vin-input'));
  const moveFromSelects = Array.from(document.querySelectorAll('.move-from-select'));

  // Checklist DOM
  const underDeliveryBox=$('#underDeliveryBox');
  const chkAdminApproved=$('#chkAdminApproved'), adminNotes=$('#adminNotes');
  const chkFinanceApproved=$('#chkFinanceApproved'), financeNotes=$('#financeNotes');
  const notesIssuesBox = $('#notesIssuesBox');
  const issuesNotes = $('#issuesNotes');

  /* ===== Connection status ===== */
  function setStatus(mode, txt){
    connDot.className='dot '+(mode==='ok'?'ok':mode==='err'?'err':'warn');
    connText.textContent = txt;
  }

  /* ===== Auth Gate ===== */
  onAuthStateChanged(auth, async (user)=>{
    if(user){
      authGate.style.display='none';
      appRoot.style.display='block';
      btnSignOut.style.display='inline-flex';
      setStatus('ok', `Ù…ØªØµÙ„: ${user.email}`);
      await initData();
      subscribeLive();
    }else{
      appRoot.style.display='none';
      authGate.style.display='grid';
      btnSignOut.style.display='none';
      setStatus('warn','Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
    }
  });
  btnLogin.addEventListener('click', async ()=>{
    authHint.textContent='';
    try{ await signInWithEmailAndPassword(auth, emailEl.value.trim(), passEl.value); }
    catch(e){ authHint.textContent='ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: '+(e?.message||e); }
  });
  btnSignup.addEventListener('click', async ()=>{
    authHint.textContent='';
    try{ await createUserWithEmailAndPassword(auth, emailEl.value.trim(), passEl.value); }
    catch(e){ authHint.textContent='ØªØ¹Ø°Ù‘Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨: '+(e?.message||e); }
  });
  btnSignOut.addEventListener('click', ()=> signOut(auth));

  /* ===== Data init / subscribe ===== */
  async function initData(){
    try{
      const s=await getDoc(STATE_REF);
      if(s.exists()){
        const d=s.data()||{};
        stock = Array.isArray(d.stock)? d.stock: [];
        moves = Array.isArray(d.moves)? d.moves: [];
        models = Array.isArray(d.models)? d.models: [];
        variantsMap = d.variantsMap || {};
      }else{
        stock=[]; moves=[]; models=[]; variantsMap={};
      }
      loadModelsIntoSelects();
      if(carSelect.value) populateVariants(carSelect.value);
      renderTable(); renderMoves(); renderTrack();
      fillMoveLists();
      setStatus('ok','ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
    }catch(e){ setStatus('warn','ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª'); }
  }
  function subscribeLive(){
    try{
      onSnapshot(STATE_REF,(snap)=>{
        if(!snap.exists()) return;
        const d=snap.data()||{};
        stock = Array.isArray(d.stock)? d.stock: stock;
        moves = Array.isArray(d.moves)? d.moves: moves;
        models= Array.isArray(d.models)? d.models: models;
        variantsMap = d.variantsMap || variantsMap;
        loadModelsIntoSelects();
        if(carSelect.value) populateVariants(carSelect.value);
        renderTable(); renderMoves(); renderTrack();
        fillMoveLists();
        setStatus('ok','Ù…Ø²Ø§Ù…Ù†Ø© Ø­ÙŠÙ‘Ø©');
      },()=> setStatus('warn','Ø§Ù†Ù‚Ø·Ø§Ø¹ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¤Ù‚ØªÙ‹Ø§'));
    }catch(e){}
  }
  async function persistAll(){
    try{
      await setDoc(STATE_REF, { stock, moves, models, variantsMap, updatedAt: now() }, { merge:true });
      setStatus('ok','ØªÙ… Ø§Ù„Ø­ÙØ¸');
    }catch(e){
      setStatus('err','ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø­ÙØ¸'); showToast('ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø­ÙØ¸ Ø¥Ù„Ù‰ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©','err');
    }
  }

  /* ===== Models / Variants ===== */
  function loadModelsIntoSelects(){
    carSelect.innerHTML='';
    models.forEach(m=>{ const o=document.createElement('option'); o.value=m; o.textContent=m; carSelect.appendChild(o); });
    variantModelForEl.innerHTML='';
    models.forEach(m=>{ const o=document.createElement('option'); o.value=m; o.textContent=m; variantModelForEl.appendChild(o); });
  }
  function populateVariants(modelName){
    const arr=(variantsMap[modelName]||[]);
    variantSelect.innerHTML='';
    if(!arr.length){ const opt=document.createElement('option'); opt.value=''; opt.textContent='â€” Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ø¯Ø¯Ø© â€”'; variantSelect.appendChild(opt); }
    else arr.forEach(v=>{ const opt=document.createElement('option'); opt.value=v; opt.textContent=v; variantSelect.appendChild(opt); });
  }
  carSelect.addEventListener('change',e=>{ populateVariants(e.target.value); });

  // ÙØªØ­ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„Ø§Øª
  btnAddModel.addEventListener('click',()=>{ modelNameEl.value=''; openModal(modelModal); });
  btnAddVariant.addEventListener('click',()=>{ if(models.length && carSelect.value){ variantModelForEl.value = carSelect.value; } variantNameEl.value=''; openModal(variantModal); });

  // ØªØ£ÙƒÙŠØ¯ Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¯ÙŠÙ„
  confirmAddModel.addEventListener('click', async ()=>{
    const name=(modelNameEl.value||'').trim();
    if(!name) return showToast('Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„','info');
    if(!models.includes(name)){ models.push(name); if(!variantsMap[name]) variantsMap[name]=[]; loadModelsIntoSelects(); carSelect.value=name; populateVariants(name); await persistAll(); showToast('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„','ok');}
    else showToast('Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„','info');
    modelModal.style.display='none';
  });

  // ØªØ£ÙƒÙŠØ¯ Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†
  confirmAddVariant.addEventListener('click', async ()=>{
    const modelFor=(variantModelForEl.value||'').trim();
    const vName=(variantNameEl.value||'').trim();
    if(!modelFor) return showToast('Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„','info');
    if(!vName) return showToast('Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†','info');
    variantsMap[modelFor]=variantsMap[modelFor]||[];
    if(!variantsMap[modelFor].includes(vName)){ variantsMap[modelFor].push(vName); if(carSelect.value===modelFor){ populateVariants(modelFor); variantSelect.value=vName; } await persistAll(); showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†','ok');}
    else showToast('Ø§Ù„Ø¨ÙŠØ§Ù† Ù…Ø³Ø¬Ù‘Ù„ Ù…Ø³Ø¨Ù‚Ù‹Ø§','info');
    variantModal.style.display='none';
  });

  /* ===== Table render / search ===== */
  function renderTable(){
    const q=(searchInput.value||'').trim().toLowerCase();
    tableBody.innerHTML='';
    let rows=stock.slice().sort((a,b)=>a.id-b.id);
    if(q){
      rows=rows.filter(r=>{
        const hay=[r.car,r.variant,r.dealer,r.extColor,r.intColor,r.modelYear,r.plate,r.location,r.batchName,r.notes,r.vin].join(' ').toLowerCase();
        return hay.includes(q);
      });
    }
    rows.forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td><strong>${r.car||''}</strong></td>
        <td>${r.variant||''}</td>
        <td>${r.dealer||''}</td>
        <td>${r.extColor||''}</td>
        <td>${r.intColor||''}</td>
        <td class="nowrap">${r.modelYear||''}</td>
        <td class="nowrap"><span class="copyable" data-copy="${r.plate||''}" title="Ø§Ù†Ø³Ø® Ø§Ù„Ù„ÙˆØ­Ø©">${r.plate||''}</span></td>
        <td>${r.location||''}</td>
        <td>${r.batchName||''}</td>
        <td class="nowrap"><span class="copyable" data-copy="${r.vin||''}" title="Ø§Ù†Ø³Ø® Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„">${r.vin||''}</span></td>
        <td>${r.notes||''}</td>
        <td>
          <div class="cell-actions">
            <button class="btn btn-ghost" data-edit="${r.id}" title="ØªØ¹Ø¯ÙŠÙ„">ØªØ¹Ø¯ÙŠÙ„ âœ</button>
            <button class="btn btn-danger" data-del="${r.id}" title="Ø­Ø°Ù">Ø­Ø°Ù ğŸ—‘</button>
          </div>
        </td>`;
      tableBody.appendChild(tr);
    });
  }
  searchInput.addEventListener('input',renderTable);
  btnClearSearch.addEventListener('click',()=>{searchInput.value=''; renderTable();});

  /* Ù†Ø³Ø® Ø³Ø±ÙŠØ¹ + Ø£Ø²Ø±Ø§Ø± ØªØ¹Ø¯ÙŠÙ„/Ø­Ø°Ù */
  document.addEventListener('click',(e)=>{
    const pill=e.target.closest('.copyable');
    const btn=e.target.closest('button');
    if(pill){
      const txt=(pill.getAttribute('data-copy')||'').trim();
      if(txt){ navigator.clipboard.writeText(txt).then(()=>showToast('ØªÙ… Ø§Ù„Ù†Ø³Ø® âœ…','ok')); }
    }
    if(btn){
      const edit=btn.getAttribute('data-edit'); const del=btn.getAttribute('data-del');
      if(edit){
        const id=Number(edit); const rec=stock.find(r=>r.id===id); if(!rec) return;
        editId=id; carSelect.value=rec.car||''; populateVariants(rec.car||''); variantSelect.value=rec.variant||'';
        dealerInput.value=rec.dealer||''; extColorInput.value=rec.extColor||''; intColorInput.value=rec.intColor||'';
        modelYearInput.value=rec.modelYear||''; plateInput.value=rec.plate||'';
        locationSelect.value=rec.location||locationSelect.options[0]?.value||'';
        batchNameInput.value=rec.batchName||''; vinInput.value=rec.vin||''; notesInput.value=rec.notes||''; window.scrollTo({top:0,behavior:'smooth'});
      }
      if(del){
        const id=Number(del); if(confirm('ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°ÙØŸ')){
          stock=stock.filter(r=>r.id!==id); persistAll(); renderTable(); showToast('ØªÙ… Ø§Ù„Ø­Ø°Ù','ok');
        }
      }
    }
  });

  /* Ø­ÙØ¸ / ØªØ¹Ø¯ÙŠÙ„ */
  let editId=null;
  btnSave.addEventListener('click',async ()=>{
    const record={
      id:editId||nextId(),
      car:carSelect.value,
      variant:variantSelect.value||'',
      dealer:dealerInput.value.trim(),
      extColor:extColorInput.value.trim(),
      intColor:intColorInput.value.trim(),
      vin:normalizeVin(vinInput.value),
      modelYear:modelYearInput.value.trim(),
      plate:plateInput.value.trim(),
      location:locationSelect.value,
      batchName:batchNameInput.value.trim(),
      notes:notesInput.value.trim()
    };
    if(!record.car) return showToast('Ø§Ø®ØªØ± Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ø£ÙˆÙ„Ù‹Ø§','err');

    if(editId){const idx=stock.findIndex(r=>r.id===editId); if(idx>-1) stock[idx]=record; editId=null; showToast('ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„','ok');}
    else {stock.push(record); showToast('ØªÙ… Ø§Ù„Ø­ÙØ¸','ok');}
    await persistAll(); renderTable(); clearForm();
  });
  function clearForm(){
    if(models.length){carSelect.value=models[0]; populateVariants(carSelect.value); variantSelect.value=variantSelect.options[0]?.value||'';}
    dealerInput.value=''; extColorInput.value=''; intColorInput.value='';
    modelYearInput.value=''; plateInput.value='';
    locationSelect.selectedIndex=0;
    batchNameInput.value=''; vinInput.value=''; notesInput.value=''; editId=null;
  }
  btnReset.addEventListener('click',clearForm);

  /* ØªØµØ¯ÙŠØ± Excel (ÙƒØ§Ù…Ù„) */
  btnExport.addEventListener('click',()=>{
    const rows=stock.slice().sort((a,b)=>a.id-b.id);
    const header=["Ù…","Ø³ÙŠØ§Ø±Ø©","Ø§Ù„Ø¨ÙŠØ§Ù†","Ø§Ù„ÙˆÙƒÙŠÙ„","Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ","Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ","Ù…ÙˆØ¯ÙŠÙ„","Ø§Ù„Ù„ÙˆØ­Ø©","Ø§Ù„Ù…ÙƒØ§Ù†","Ø§Ø³Ù… Ø§Ù„Ø¯ÙØ¹Ø©","Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„","Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª"];
    const data=[header];
    rows.forEach(r=>data.push([r.id,r.car,r.variant,r.dealer,r.extColor,r.intColor,r.modelYear,r.plate,r.location,r.batchName||'',r.vin,r.notes]));
    const ws=XLSX.utils.aoa_to_sheet(data);
    ws['!cols']=[{wch:6},{wch:22},{wch:16},{wch:16},{wch:14},{wch:14},{wch:8},{wch:12},{wch:22},{wch:18},{wch:22},{wch:26}];
    const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"Cars");
    XLSX.writeFile(wb,"mzj-cars-inventory.xlsx"); showToast('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ù„Ù','ok');
  });

  /* Ø§Ù„Ø¬Ø¯ÙŠØ¯: ØªØµØ¯ÙŠØ± Ù‚Ø§Ù„Ø¨ ÙØ§Ø¶ÙŠ (Ø¹Ù†Ø§ÙˆÙŠÙ† ÙÙ‚Ø·) */
  btnExportBlank.addEventListener('click',()=>{
    const header=["Ù…","Ø³ÙŠØ§Ø±Ø©","Ø§Ù„Ø¨ÙŠØ§Ù†","Ø§Ù„ÙˆÙƒÙŠÙ„","Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ","Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ","Ù…ÙˆØ¯ÙŠÙ„","Ø§Ù„Ù„ÙˆØ­Ø©","Ø§Ù„Ù…ÙƒØ§Ù†","Ø§Ø³Ù… Ø§Ù„Ø¯ÙØ¹Ø©","Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„","Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª"];
    const ws=XLSX.utils.aoa_to_sheet([header]);
    ws['!cols']=[{wch:6},{wch:22},{wch:16},{wch:16},{wch:14},{wch:14},{wch:8},{wch:12},{wch:22},{wch:18},{wch:22},{wch:26}];
    const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"Template");
    XLSX.writeFile(wb,"mzj-cars-template-blank.xlsx");
    showToast('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ù‚Ø§Ù„Ø¨ Ø§Ù„ÙØ§Ø¶ÙŠ','ok');
  });

  /* Ø§Ø³ØªÙŠØ±Ø§Ø¯ Excel */
  let importMode=null; const VIN_HEADERS=["Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„","VIN","Ø§Ù„Ø´Ø§Øµ","Ø±Ù‚Ù… Ø§Ù„Ø´Ø§Øµ","Chassis","Chassis No","Chassis Number","Ø§Ù„Ù‡ÙŠÙƒÙ„","Ù†ÙˆØ¹ Ø§Ù„Ù‡ÙŠÙƒÙ„"];
  btnImportMenu.addEventListener('click',()=>{importDropdown.style.display=importDropdown.style.display==='block'?'none':'block';});
  importDropdown.addEventListener('click',(e)=>{const btn=e.target.closest('button'); if(!btn) return; importMode=btn.getAttribute('data-mode'); importDropdown.style.display='none'; fileImport.click();});
  document.addEventListener('click',(e)=>{if(!e.target.closest('.import-menu')) importDropdown.style.display='none';});
  fileImport.addEventListener('change',(e)=>{
    const file=e.target.files[0]; if(!file) return; if(!importMode){showToast('Ø§Ø®ØªØ± ÙˆØ¶Ø¹ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø£ÙˆÙ„Ù‹Ø§','info'); fileImport.value=''; return;}
    const reader=new FileReader();
    reader.onload=async (evt)=>{
      try{
        const data=new Uint8Array(evt.target.result);
        const workbook=XLSX.read(data,{type:'array'}); const first=workbook.SheetNames[0]; const sheet=workbook.Sheets[first];
        const json=XLSX.utils.sheet_to_json(sheet,{header:1,defval:''});
        const header=json[0]||[]; const colIndex=name=>header.indexOf(name);

        const idxMap={
          id:colIndex("Ù…"),car:colIndex("Ø³ÙŠØ§Ø±Ø©"),variant:colIndex("Ø§Ù„Ø¨ÙŠØ§Ù†"),dealer:colIndex("Ø§Ù„ÙˆÙƒÙŠÙ„"),
          extColor:colIndex("Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ"),intColor:colIndex("Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ"),
          modelYear:colIndex("Ù…ÙˆØ¯ÙŠÙ„"), plate:colIndex("Ø§Ù„Ù„ÙˆØ­Ø©"), location:colIndex("Ø§Ù„Ù…ÙƒØ§Ù†"),
          batchName:colIndex("Ø§Ø³Ù… Ø§Ù„Ø¯ÙØ¹Ø©"), notes:colIndex("Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª")
        };
        let idxVin=-1; for(const h of VIN_HEADERS){const i=header.indexOf(h); if(i!==-1){idxVin=i; break;}}

        const mustHave=["Ø³ÙŠØ§Ø±Ø©","Ø§Ù„Ø¨ÙŠØ§Ù†","Ø§Ù„ÙˆÙƒÙŠÙ„","Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ","Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ","Ù…ÙˆØ¯ÙŠÙ„","Ø§Ù„Ù„ÙˆØ­Ø©","Ø§Ù„Ù…ÙƒØ§Ù†","Ø§Ø³Ù… Ø§Ù„Ø¯ÙØ¹Ø©","Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª"];
        const missing = mustHave.filter(n=> colIndex(n)===-1);
        if(missing.length){ throw new Error('ÙØ´Ù„ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ â€” Ø£Ø¹Ù…Ø¯Ø© Ù†Ø§Ù‚ØµØ©: '+missing.join(', ')); }

        const imported=[];
        for(let i=1;i<json.length;i++){
          const row=json[i]; if(!row || row.length===0) continue;
          const rawVin=(idxVin!==-1?row[idxVin]:'');
          imported.push({
            id:Number(row[idxMap.id])||null,
            car:row[idxMap.car]||'',
            variant:row[idxMap.variant]||'',
            dealer:row[idxMap.dealer]||'',
            extColor:row[idxMap.extColor]||'',
            intColor:row[idxMap.intColor]||'',
            modelYear:row[idxMap.modelYear]||'',
            plate:row[idxMap.plate]||'',
            location:row[idxMap.location]||'',
            batchName:row[idxMap.batchName]||'',
            notes:row[idxMap.notes]||'',
            vin:normalizeVin(rawVin)
          });
          const name=row[idxMap.car];
          if(name && !models.includes(name)){models.push(name); if(!variantsMap[name]) variantsMap[name]=[];}
        }
        if(importMode==='replace'){stock=[]; imported.forEach(r=>{r.id=nextId(); stock.push(r);});}
        else {imported.forEach(r=>{r.id=nextId(); stock.push(r);});}
        await persistAll(); loadModelsIntoSelects(); if(carSelect.value) populateVariants(carSelect.value);
        renderTable(); fillMoveLists(); showToast(importMode==='replace'?'ØªÙ… Ø§Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„ÙƒØ§Ù…Ù„ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©':'ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©','ok');
      }catch(err){ showToast((err?.message)||'ÙØ´Ù„ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ â€” Ø±Ø§Ø¬Ø¹ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…Ù„Ù','err'); }
      finally{ fileImport.value=''; importMode=null; }
    };
    reader.readAsArrayBuffer(file);
  });

  /* ===== Ø­Ø±ÙƒØ© Ø§Ù„Ù†Ù‚Ù„ â€” Ù‚ÙˆØ§Ø¦Ù… Ø«Ø§Ø¨ØªØ© ===== */
  const FIXED_LOCATIONS = [
"Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ : Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…ØªØ§Ø­","Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ : Ø³ÙŠØ§Ø±Ø§Øª Ø¨Ù‡Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§Øª","Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ : Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…","Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ : Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…",
"Ø§Ù„ÙˆÙƒØ§Ù„Ø© : Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…ØªØ§Ø­","Ø§Ù„ÙˆÙƒØ§Ù„Ø© : Ø³ÙŠØ§Ø±Ø§Øª Ø¨Ù‡Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§Øª","Ø§Ù„ÙˆÙƒØ§Ù„Ø© : Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…","Ø§Ù„ÙˆÙƒØ§Ù„Ø© : Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…",
"ÙØ±Ø¹ 1 Ø§Ù„ØµØ§Ù„Ø© : Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…ØªØ§Ø­","ÙØ±Ø¹ 1 Ø§Ù„ØµØ§Ù„Ø© : Ø³ÙŠØ§Ø±Ø§Øª Ø¨Ù‡Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§Øª","ÙØ±Ø¹ 1 Ø§Ù„ØµØ§Ù„Ø© : Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…","ÙØ±Ø¹ 1 Ø§Ù„ØµØ§Ù„Ø© : Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…",
"ÙØ±Ø¹ 2 Ø§Ù„Ù…Ù„ØªÙ‚Ù‰ : Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…ØªØ§Ø­","ÙØ±Ø¹ 2 Ø§Ù„Ù…Ù„ØªÙ‚Ù‰ : Ø³ÙŠØ§Ø±Ø§Øª Ø¨Ù‡Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§Øª","ÙØ±Ø¹ 2 Ø§Ù„Ù…Ù„ØªÙ‚Ù‰ : Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…","ÙØ±Ø¹ 2 Ø§Ù„Ù…Ù„ØªÙ‚Ù‰ : Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…",
"ÙØ±Ø¹ 3 Ø§Ù„Ù‚Ø§Ø¯Ø³ÙŠØ© : Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…ØªØ§Ø­","ÙØ±Ø¹ 3 Ø§Ù„Ù‚Ø§Ø¯Ø³ÙŠØ© : Ø³ÙŠØ§Ø±Ø§Øª Ø¨Ù‡Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§Øª","ÙØ±Ø¹ 3 Ø§Ù„Ù‚Ø§Ø¯Ø³ÙŠØ© : Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…","ÙØ±Ø¹ 3 Ø§Ù„Ù‚Ø§Ø¯Ø³ÙŠØ© : Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…"
  ];
  function fillMoveLists(){
    const opts = FIXED_LOCATIONS.map(l=> `<option value="${l}">${l}</option>`).join('');
    moveTo.innerHTML   = opts;
    moveFromSelects.forEach(sel=> sel.innerHTML = opts);
  }
  fillMoveLists();

  function renderCarDetails(rec){
    carDetails.innerHTML=`
      <div style="grid-column:1/-1"><b>Ø³ÙŠØ§Ø±Ø©:</b> ${rec.car??""}</div>
      <div><b>Ø§Ù„Ø¨ÙŠØ§Ù†:</b> ${rec.variant??""}</div>
      <div><b>Ø§Ù„ÙˆÙƒÙŠÙ„:</b> ${rec.dealer??""}</div>
      <div><b>Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ:</b> ${rec.extColor??""}</div>
      <div><b>Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ:</b> ${rec.intColor??""}</div>
      <div><b>Ù…ÙˆØ¯ÙŠÙ„:</b> ${rec.modelYear??""}</div>
      <div><b>Ø§Ù„Ù„ÙˆØ­Ø©:</b> ${rec.plate??""}</div>
      <div><b>Ø§Ù„Ù…ÙƒØ§Ù†:</b> ${rec.location??""}</div>
      <div><b>Ø§Ø³Ù… Ø§Ù„Ø¯ÙØ¹Ø©:</b> ${rec.batchName??""}</div>
      <div style="grid-column:1/-1"><b>Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„:</b> ${rec.vin??""}</div>
      <div style="grid-column:1/-1"><b>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</b> ${rec.notes??""}</div>`;
    carDetailsHint.textContent=rec.vin?`Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„: ${rec.vin}`:'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù… Ù‡ÙŠÙƒÙ„ Ù…Ø­ÙÙˆØ¸ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø³ÙŠØ§Ø±Ø©.';
    carDetailsBox.style.display='block';
  }

  function updateVinSuggestions(prefix){
    if(!prefix || prefix.length<2){
      vinHints.innerHTML='';
      return;
    }
    const set = new Set();
    stock.forEach(r=>{
      const v = normalizeVin(r.vin||'');
      if(v && v.startsWith(prefix)) set.add(v);
    });
    const list = Array.from(set).sort().slice(0,30);
    vinHints.innerHTML = list.map(v=>`<option value="${v}"></option>`).join('');
  }

  function autoFindByVinForRow(rowIndex){
    const inp = moveVinInputs[rowIndex];
    const fromSel = moveFromSelects[rowIndex];
    const raw = (inp.value||'').trim();
    if(!raw){
      fromSel.disabled=false;
      fromSel.value='';
      if(!moveVinInputs.some(x=>(x.value||'').trim())){
        carDetailsBox.style.display='none';
        moveStatus.textContent='';
      }
      return;
    }
    const norm = normalizeVin(raw);
    if(!norm){
      fromSel.disabled=false;
      fromSel.value='';
      return;
    }
    let match = stock.find(r=> normalizeVin(r.vin) === norm);
    if(!match && norm.length>=8){
      const candidates = stock.filter(r=> normalizeVin(r.vin).startsWith(norm));
      if(candidates.length===1) match = candidates[0];
    }
    if(match){
      const currentLoc = match.location || '';
      if(currentLoc){
        fromSel.value = currentLoc;
        fromSel.disabled = true;
      }else{
        fromSel.disabled = false;
      }
      renderCarDetails(match);
      moveStatus.textContent = `ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø·Ø± ${rowIndex+1}: ${match.car} â€” Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„Ø­Ø§Ù„ÙŠ: ${currentLoc || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}`;
    }else{
      fromSel.disabled=false;
      fromSel.value='';
      moveStatus.textContent='â€” Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ø¨Ø¹Ø¯ (Ø£ÙƒÙ…Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„).';
      if(!moveVinInputs.some(x=>(x.value||'').trim())){
        carDetailsBox.style.display='none';
      }
    }
  }

  moveVinInputs.forEach((inp,index)=>{
    inp.addEventListener('input', debounce(()=>{
      const prefix = normalizeVin((inp.value||'').trim());
      updateVinSuggestions(prefix);
      autoFindByVinForRow(index);
    },150));
  });

  // Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙŠØ¯ÙˆÙŠÙ‹Ø§
  btnFindByVin.addEventListener('click',()=>{
    const rowIndex = moveVinInputs.findIndex(inp => (inp.value||'').trim());
    if(rowIndex === -1){moveStatus.textContent='Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø£ÙˆÙ„Ù‹Ø§ ÙÙŠ Ø£Ø­Ø¯ Ø§Ù„Ø­Ù‚ÙˆÙ„.';return;}
    const vinRaw=(moveVinInputs[rowIndex].value||'').trim();
    const norm=normalizeVin(vinRaw);
    if(!norm){moveStatus.textContent='Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„ÙƒØ§Ù…Ù„ Ø£ÙˆÙ„Ù‹Ø§.';return;}
    const match=stock.find(r=>normalizeVin(r.vin)===norm);
    const fromSel = moveFromSelects[rowIndex];
    if(!match){moveStatus.textContent='Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø³ÙŠØ§Ø±Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù….'; carDetailsBox.style.display='none'; showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³ÙŠØ§Ø±Ø© Ø¨Ù‡Ø°Ø§ VIN','err'); return;}
    renderCarDetails(match);
    const currentLoc = match.location || '';
    if(currentLoc){
      fromSel.value = currentLoc;
      fromSel.disabled = true;
      moveStatus.textContent=`ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ±: ${match.car} â€” Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„Ø­Ø§Ù„ÙŠ: ${currentLoc}`;
    }else{
      fromSel.disabled = false;
      moveStatus.textContent=`ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ±: ${match.car} â€” Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙƒØ§Ù† Ù…Ø³Ø¬Ù„. Ø§Ø®ØªØ± Ø§Ù„Ù…ÙƒØ§Ù† ÙŠØ¯ÙˆÙŠÙ‹Ø§.`;
    }
  });

  // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØµÙ†Ø§Ø¯ÙŠÙ‚ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© Ø­Ø³Ø¨ "Ø¥Ù„Ù‰"
  function toggleMoveExtras(){
    const toVal = moveTo.value || '';
    const showUnder = /Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…/.test(toVal);
    const showIssues = /Ø³ÙŠØ§Ø±Ø§Øª Ø¨Ù‡Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§Øª/.test(toVal);
    underDeliveryBox.style.display = showUnder ? 'block' : 'none';
    notesIssuesBox.style.display   = showIssues ? 'block' : 'none';
  }
  moveTo.addEventListener('change', toggleMoveExtras);

  // ØªÙ†ÙÙŠØ° Ø§Ù„Ù†Ù‚Ù„ Ø§Ù„Ù…ØªØ¹Ø¯Ø¯
  btnMove.addEventListener('click', async ()=>{
    const to = moveTo.value;
    if(!to) return showToast('Ø§Ø®ØªØ± ÙˆØ¬Ù‡Ø© Ø§Ù„Ù†Ù‚Ù„ (Ø¥Ù„Ù‰)','info');

    const goingUnderDelivery = /Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…/.test(to);
    const goingIssues        = /Ø³ÙŠØ§Ø±Ø§Øª Ø¨Ù‡Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§Øª/.test(to);
    const goingDelivered     = /Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…/.test(to);

    if(goingIssues && !issuesNotes.value.trim()){
      showToast('Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ù„ Ø¥Ù„Ù‰ Ø³ÙŠØ§Ø±Ø§Øª Ø¨Ù‡Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§Øª','info');
      return;
    }

    const moveMetaTemplate = {
      adminApproved: goingUnderDelivery ? !!chkAdminApproved.checked : null,
      adminNotes:    goingUnderDelivery ? (adminNotes.value||'').trim() : '',
      financeApproved: goingUnderDelivery ? !!chkFinanceApproved.checked : null,
      financeNotes:    goingUnderDelivery ? (financeNotes.value||'').trim() : '',
      issuesNotes:   goingIssues ? (issuesNotes.value||'').trim() : ''
    };

    let movedCount = 0;
    const errors = [];

    moveVinInputs.forEach((inp,index)=>{
      const raw = (inp.value||'').trim();
      const norm = normalizeVin(raw);
      if(!norm) return;

      const recIdx = stock.findIndex(r=> normalizeVin(r.vin) === norm);
      if(recIdx<0){
        errors.push(`Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø³ÙŠØ§Ø±Ø© Ø¨Ù‡Ø°Ø§ VIN: ${raw}`);
        return;
      }
      const rec = stock[recIdx];
      const fromSel = moveFromSelects[index];
      const from = (fromSel.value || rec.location || '').trim();

      if(!from){
        errors.push(`Ø§Ù„Ø³ÙŠØ§Ø±Ø© ${rec.car||''} (${rec.vin||raw}) Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù„Ù‡Ø§ Ù…ÙƒØ§Ù† Ø­Ø§Ù„ÙŠØ› Ø­Ø¯Ù‘Ø¯ Ø§Ù„Ù…ÙƒØ§Ù† ÙŠØ¯ÙˆÙŠÙ‹Ø§.`);
        return;
      }

      if(from === to){
        errors.push(`Ø§Ù„Ø³ÙŠØ§Ø±Ø© ${rec.car||''} (${rec.vin||raw}) Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ù†ÙØ³ Ø§Ù„Ù…ÙƒØ§Ù†.`);
        return;
      }

      // Ø´Ø±Ø· Ø§Ù„Ù†Ù‚Ù„ Ø¥Ù„Ù‰ "Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…" â€” Ù„Ø§Ø²Ù… Ù…ÙˆØ§ÙÙ‚Ø© Ù…Ø§Ù„ÙŠØ© + Ø¥Ø¯Ø§Ø±ÙŠØ© Ø³Ø§Ø¨Ù‚Ø©
      if(goingDelivered){
        const history = moves.filter(m=> normalizeVin(m.vin||'') === norm);
        const hasFullApproval = history.some(m=> m.adminApproved===true && m.financeApproved===true);
        if(!hasFullApproval){
          errors.push(`Ù„Ø§ ÙŠÙ…ÙƒÙ† Ù†Ù‚Ù„ ${rec.car||''} (${rec.vin||raw}) Ø¥Ù„Ù‰ "Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…" Ù‚Ø¨Ù„ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…ÙˆØ§ÙÙ‚Ø© Ù…Ø§Ù„ÙŠØ© ÙˆØ¥Ø¯Ø§Ø±ÙŠØ© Ù…ÙƒØªÙ…Ù„Ø©.`);
          return;
        }
      }

      const moveMeta = {...moveMetaTemplate};
      const oldLoc = rec.location || from;
      rec.location = to;
      const stamp = now();
      moves.push({
        when: stamp,
        date: onlyDate(stamp),
        vin: rec.vin||'',
        car: rec.car||'',
        from: oldLoc,
        to,
        id: rec.id,
        ...moveMeta
      });
      movedCount++;
    });

    if(!movedCount){
      moveStatus.textContent = errors.length ? errors.join(' | ') : 'Ù„Ù… ÙŠØªÙ… Ø¥Ø¯Ø®Ø§Ù„ Ø£ÙŠ Ø±Ù‚Ù… Ù‡ÙŠÙƒÙ„ Ù„Ù„Ù†Ù‚Ù„.';
      showToast('Ù„Ù… ÙŠØªÙ… ØªÙ†ÙÙŠØ° Ø£ÙŠ Ø­Ø±ÙƒØ© Ù†Ù‚Ù„','info');
      return;
    }

    await persistAll();
    renderTable();
    renderMoves();
    renderTrack();

    moveStatus.textContent = `ØªÙ… Ù†Ù‚Ù„ ${movedCount} Ø³ÙŠØ§Ø±Ø© Ø¨Ù†Ø¬Ø§Ø­.` + (errors.length ? ` Ø¨Ø¹Ø¶ Ø§Ù„Ø­Ø±ÙƒØ§Øª Ù„Ù… ØªÙÙ†ÙØ°: ${errors.join(' | ')}` : '');
    carDetailsBox.style.display='none';
    vinHints.innerHTML='';

    moveVinInputs.forEach((inp,index)=>{
      inp.value='';
      const sel = moveFromSelects[index];
      sel.disabled=false;
      sel.value='';
    });

    chkAdminApproved.checked=false; adminNotes.value='';
    chkFinanceApproved.checked=false; financeNotes.value='';
    issuesNotes.value='';
    underDeliveryBox.style.display='none';
    notesIssuesBox.style.display='none';
  });

  /* ===== Ø³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ§Øª (Ø¹Ø±Ø¶ + ÙÙ„Ø§ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ®) ===== */
  function filterMovesByDate(list){
    const f = movesFromDate.value || null;
    const t = movesToDate.value || null;
    if(!f && !t) return list;
    return list.filter(m=>{
      const d = m.date || onlyDate(m.when||'');
      if(f && d < f) return false;
      if(t && d > t) return false;
      return true;
    });
  }

  function renderMoves(){
    movesTableBody.innerHTML='';
    let rows = moves.slice();
    rows = filterMovesByDate(rows);
    rows.forEach((m,i)=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${i+1}</td>
        <td class="nowrap">${m.date || onlyDate(m.when||'')}</td>
        <td class="nowrap"><span class="copyable" data-copy="${m.vin||''}" title="Ø§Ù†Ø³Ø® Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„">${m.vin||''}</span></td>
        <td>${m.car||''}</td>
        <td>${m.from||''}</td>
        <td>${m.to||''}</td>
        <td class="nowrap">${m.id||''}</td>`;
      movesTableBody.appendChild(tr);
    });
  }
  movesFromDate.addEventListener('change', renderMoves);
  movesToDate.addEventListener('change', renderMoves);
  btnClearDate.addEventListener('click', ()=>{movesFromDate.value=''; movesToDate.value=''; renderMoves();});

  /* ===== ØªØªØ¨Ù‘Ø¹ VIN ===== */
  function renderTrack(){
    trackTableBody.innerHTML='';
    const v = normalizeVin((trackVin.value||'').trim());
    if(!v){ return; }
    const list = moves.filter(m=> normalizeVin(m.vin||'') === v ).sort((a,b)=> (a.when||'').localeCompare(b.when||''));
    list.forEach((m,i)=>{
      const notesParts = [];
      if(m.adminApproved===true) notesParts.push('âœ” Ù…ÙˆØ§ÙÙ‚Ø© Ø¥Ø¯Ø§Ø±ÙŠØ©');
      if(m.adminApproved===false) notesParts.push('âœ– Ù…ÙˆØ§ÙÙ‚Ø© Ø¥Ø¯Ø§Ø±ÙŠØ©');
      if(m.adminNotes) notesParts.push('Ø¥Ø¯Ø§Ø±ÙŠ: '+m.adminNotes);
      if(m.financeApproved===true) notesParts.push('âœ” Ù…ÙˆØ§ÙÙ‚Ø© Ù…Ø§Ù„ÙŠØ©');
      if(m.financeApproved===false) notesParts.push('âœ– Ù…ÙˆØ§ÙÙ‚Ø© Ù…Ø§Ù„ÙŠØ©');
      if(m.financeNotes) notesParts.push('Ù…Ø§Ù„ÙŠ: '+m.financeNotes);
      if(m.issuesNotes) notesParts.push('Ù…Ù„Ø§Ø­Ø¸Ø§Øª: '+m.issuesNotes);

      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${i+1}</td>
        <td class="nowrap">${m.date || onlyDate(m.when||'')}</td>
        <td>${m.from||''}</td>
        <td>${m.to||''}</td>
        <td>${m.car||''}</td>
        <td>${notesParts.join(' â€” ')||''}</td>`;
      trackTableBody.appendChild(tr);
    });
  }
  trackVin.addEventListener('input', debounce(renderTrack, 200));
  btnClearTrack.addEventListener('click', ()=>{ trackVin.value=''; renderTrack(); });

  /* Modals helpers */
  function openModal(el){ el.style.display='flex'; setTimeout(()=>{ const first = el.querySelector('input,select,textarea,button'); first?.focus(); }, 50); }
  function closeModalById(id){ const el = document.getElementById(id); if(el) el.style.display='none'; }
  document.addEventListener('click',(e)=>{
    const closeBtn = e.target.closest('[data-close]');
    if(closeBtn){ closeModalById(closeBtn.getAttribute('data-close')); }
    if(e.target.classList.contains('modal-backdrop')){ e.target.style.display='none'; }
  });
  document.addEventListener('keydown',(e)=>{
    if(e.key==='/'){e.preventDefault(); searchInput.focus();}
    if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='s'){e.preventDefault(); btnSave.click();}
    if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='k'){e.preventDefault(); btnAddVariant.click();}
    if(e.key==='Escape'){modelModal.style.display='none'; variantModal.style.display='none'; btnReset.click();}
  });

  /* Ø£ÙˆÙ„ ØªØ­Ù…ÙŠÙ„ */
  setStatus('warn','Ø¬Ø§Ø±Ù Ø§Ù„Ø§ØªØµØ§Ù„â€¦');

  /* Ø¥ØºÙ„Ø§Ù‚ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§ */
  document.addEventListener('click',(e)=>{
    if(!e.target.closest('.import-menu')) importDropdown.style.display='none';
  });
</script>
</body>
</html>
