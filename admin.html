<!DOCTYPE html>
<html lang="ar" dir="rtl" data-page="admin">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>الإدارة — MZJ Cars</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
<style>
  :root{ --brown:#3e2420; --beige:#bc8f74; --bg:#faf7f3; --card:#fff; --line:#e7e5e4; --text:#1f2937; --muted:#6b7280; --radius:12px; --shadow:0 10px 28px rgba(0,0,0,.06); --ok:#16a34a; --danger:#ef4444; }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font-family:"Tajawal",system-ui,Arial}
  html.auth-wait body>*{display:none !important}
  .topbar{position:sticky;top:0;z-index:50;background:#fff;border-bottom:1px solid var(--line)}
  .topbar-inner{max-width:1240px;margin:auto;display:flex;align-items:center;justify-content:space-between;padding:10px 14px}
  .brand{display:flex;align-items:center;gap:10px}
  .logo{width:34px;height:34px;border-radius:10px;background:linear-gradient(135deg,var(--brown),#271713);display:grid;place-items:center;color:#fff;font-weight:900}
  .tabs{display:flex;gap:6px}
  .tab{font-size:12px;padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#fff;color:inherit;text-decoration:none;font-weight:800}
  .tab.active{background:var(--brown);border-color:var(--brown);color:#fff}
  .status-badge{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--line);border-radius:10px;padding:5px 8px;font-size:12px;background:#fff}
  .dot{width:8px;height:8px;border-radius:999px;background:#f59e0b}.dot.ok{background:var(--ok)}.dot.err{background:var(--danger)}
  .container{max-width:1240px;margin:14px auto;padding:0 12px;display:grid;gap:12px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:12px}
  .title{margin:0 0 6px;font-size:16px;color:var(--brown);display:flex;align-items:center;gap:8px}
  label{font-size:13px;color:#374151}
  input,select{width:100%;padding:8px 10px;border:1px solid var(--line);border-radius:10px;background:#fff}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .btn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:8px 12px;cursor:pointer;font-weight:800}
  .btn-primary{background:var(--brown);border-color:var(--brown);color:#fff}
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  @media (max-width:900px){.grid{grid-template-columns:1fr 1fr}} @media (max-width:620px){.grid{grid-template-columns:1fr}}
  .switch{display:flex;align-items:center;gap:8px}
  .switch input{width:auto}
  .help{font-size:12px;color:var(--muted)}
</style>
<script>document.documentElement.classList.add('auth-wait');</script>
</head>
<body>

<div class="topbar">
  <div class="topbar-inner">
    <div class="brand"><div class="logo">MZJ</div><div><h1 style="margin:0;font-size:17px;color:var(--brown)">الإدارة</h1><small class="help">التحكم في الأعضاء والصلاحيات</small></div></div>
    <div class="tabs">
      <a class="tab active" href="admin.html">الإدارة</a>
      <a class="tab" href="inventory.html">المخزون</a>
      <a class="tab" href="dashboard.html">الداش بورد</a>
      <a class="tab" href="photoshoot.html">طلبات التصوير</a>
    </div>
    <div class="row">
      <div class="status-badge"><span id="connDot" class="dot"></span><span id="connText">جارِ الاتصال…</span></div>
      <button id="btnSignOut" class="btn" style="display:none"><i class="fa-solid fa-right-from-bracket"></i> خروج</button>
    </div>
  </div>
</div>

<div id="authGate" style="min-height:60vh;display:grid;place-items:center;padding:20px">
  <div class="card" style="max-width:460px;width:96%">
    <h3 class="title"><i class="fa-solid fa-user-lock"></i> تسجيل الدخول</h3>
    <label>البريد الإلكتروني</label><input id="email" type="email" placeholder="you@example.com">
    <label style="margin-top:8px">كلمة المرور</label><input id="password" type="password" placeholder="••••••••">
    <div class="row" style="margin-top:8px">
      <button class="btn btn-primary" id="btnLogin">تسجيل الدخول</button>
      <button class="btn" id="btnSignup">إنشاء حساب</button>
    </div>
    <p class="help" id="authHint" style="margin-top:8px"></p>
  </div>
</div>

<div id="app" style="display:none">
  <div class="container">

    <!-- إضافة عضو + صلاحيات -->
    <div class="card">
      <h3 class="title"><i class="fa-solid fa-user-plus"></i> إضافة عضو جديد</h3>
      <div class="grid">
        <div><label>الاسم</label><input id="u_name" placeholder="الاسم الكامل"></div>
        <div><label>البريد الإلكتروني</label><input id="u_email" placeholder="user@example.com"></div>
        <div><label>القسم / الوظيفة</label><input id="u_role" placeholder="مثال: خدمة العملاء"></div>
      </div>
      <div style="margin:10px 0"><b>الصلاحيات</b></div>
      <div class="grid" id="permGrid">
        <!-- نفس الأقسام المطلوبة -->
        <label class="switch"><input type="checkbox" data-key="add_edit_car"> إضافة / تعديل سيارة</label>
        <label class="switch"><input type="checkbox" data-key="cars_transfer"> حركة نقل السيارات (برقم الهيكل)</label>
        <label class="switch"><input type="checkbox" data-key="moves_log"> سجل الحركات</label>
        <label class="switch"><input type="checkbox" data-key="vin_tracking"> تتبّع حركة رقم هيكل</label>
        <label class="switch"><input type="checkbox" data-key="cars_table"> جدول السيارات</label>
        <label class="switch"><input type="checkbox" data-key="shoot_create"> إنشاء طلب تصوير</label>
        <label class="switch"><input type="checkbox" data-key="shoot_follow"> متابعة الطلبات</label>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn btn-primary" id="btnAddUser"><i class="fa-solid fa-floppy-disk"></i> حفظ العضو</button>
      </div>
      <p class="help" id="saveHint" style="margin-top:6px"></p>
    </div>

    <!-- تلميحات الوصول السريع -->
    <div class="card">
      <h3 class="title"><i class="fa-solid fa-link"></i> روابط سريعة</h3>
      <div class="row">
        <a class="tab" href="inventory.html">إدارة المخزون</a>
        <a class="tab" href="photoshoot.html">طلبات التصوير</a>
        <a class="tab" href="dashboard.html">لوحة المؤشرات</a>
      </div>
    </div>

  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

  const cfg={apiKey:"AIzaSyC614bGqnYf4Q-weTNemzWENTpa8DjGeHw",authDomain:"mzj-agenda.firebaseapp.com",projectId:"mzj-agenda",storageBucket:"mzj-agenda.firebasestorage.app",messagingSenderId:"834700407721",appId:"1:834700407721:web:75c17665d4f032fd65cab8"};
  const app=initializeApp(cfg); const auth=getAuth(app); const db=getFirestore(app);
  const STATE_REF = doc(db,"mzj_admin_state","v1");

  const $=s=>document.querySelector(s);
  const setStatus=(m,t)=>{ $('#connDot').className='dot '+(m==='ok'?'ok':m==='err'?'err':''); $('#connText').textContent=t; };

  onAuthStateChanged(auth, async user=>{
    if(user){ $('#authGate').style.display='none'; $('#app').style.display='block'; $('#btnSignOut').style.display='inline-block'; setStatus('ok','متصل: '+user.email); }
    else    { $('#app').style.display='none'; $('#authGate').style.display='grid'; $('#btnSignOut').style.display='none'; setStatus('','لم يتم تسجيل الدخول'); }
    document.documentElement.classList.remove('auth-wait');
  });

  $('#btnLogin').onclick=async()=>{ $('#authHint').textContent=''; try{ await signInWithEmailAndPassword(auth,$('#email').value.trim(),$('#password').value); }catch(e){ $('#authHint').textContent='خطأ: '+(e?.message||e); } };
  $('#btnSignup').onclick=async()=>{ $('#authHint').textContent=''; try{ await createUserWithEmailAndPassword(auth,$('#email').value.trim(),$('#password').value); }catch(e){ $('#authHint').textContent='خطأ: '+(e?.message||e); } };
  $('#btnSignOut').onclick=()=>signOut(auth);

  // حفظ عضو وصلاحياته في وثيقة الحالة
  $('#btnAddUser').onclick = async ()=>{
    const name=$('#u_name').value.trim(), email=$('#u_email').value.trim(), role=$('#u_role').value.trim();
    if(!name || !email){ $('#saveHint').textContent='الاسم والبريد مطلوبان'; return; }
    const perms={}; document.querySelectorAll('#permGrid input[type="checkbox"]').forEach(c=> perms[c.dataset.key]=c.checked);
    try{
      const snap=await getDoc(STATE_REF);
      const data=snap.exists()? (snap.data()||{}) : {};
      const users=Array.isArray(data.users)? data.users: [];
      const idx=users.findIndex(u=> (u.email||'').toLowerCase()===email.toLowerCase());
      const rec={ name,email,role,perms,createdAt:new Date().toISOString() };
      if(idx>=0) users[idx]=rec; else users.push(rec);
      await setDoc(STATE_REF,{ users },{ merge:true });
      $('#saveHint').textContent='تم الحفظ ✅';
    }catch(e){ $('#saveHint').textContent='تعذّر الحفظ: '+(e?.message||e); }
  };
</script>
</body>
</html>
