<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>لوحة الإدارة — MZJ Cars</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
<style>
  :root{
    --brown:#3e2420; --beige:#bc8f74; --cream:#fff8ef; --text:#1f2937; --muted:#6b7280;
    --line:#e5e7eb; --line-strong:#d1d5db; --table-head:#fafafa;
    --card:#fff; --radius:14px; --ok:#16a34a; --danger:#ef4444; --info:#0ea5e9;
    --shadow:0 10px 24px rgba(0,0,0,.06)
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:"Tajawal",system-ui,Arial;
    background:var(--cream);
    color:var(--text);
  }
  a{text-decoration:none;color:inherit}
  button{font-family:"Tajawal",system-ui,Arial}
  .topbar{
    position:sticky;top:0;z-index:40;
    background:#fefaf6;
    border-bottom:1px solid #e5ded5;
    box-shadow:0 10px 24px rgba(0,0,0,.04);
  }
  .topbar-inner{
    max-width:1240px;margin:0 auto;
    padding:10px 16px;
    display:flex;justify-content:space-between;align-items:center;gap:16px;flex-wrap:wrap
  }
  .brand{display:flex;align-items:center;gap:10px}
  .logo{
    width:32px;height:32px;border-radius:10px;
    background:var(--brown);color:#fff;
    display:flex;align-items:center;justify-content:center;
    font-weight:800;font-size:14px;
  }
  .tabs{
    display:flex;flex-wrap:wrap;gap:8px;
    justify-content:center;
  }
  .tab{
    padding:6px 14px;border-radius:999px;
    background:#f9f5f1;
    border:1px solid transparent;
    font-size:13px;
  }
  .tab.active{
    background:var(--brown);
    color:#fff;
    border-color:var(--brown);
  }
  .status-badge{
    display:inline-flex;align-items:center;gap:6px;
    font-size:12px;color:var(--muted);
    background:#f9fafb;
    padding:3px 10px;border-radius:999px;
    border:1px solid #e5e7eb;
  }
  .dot{
    width:8px;height:8px;border-radius:999px;
    background:#facc15;
  }
  .dot.ok{background:#22c55e}
  .dot.err{background:#ef4444}
  .dot.warn{background:#eab308}
  .btn{
    display:inline-flex;align-items:center;justify-content:center;gap:6px;
    padding:8px 14px;border-radius:999px;
    border:1px solid transparent;
    background:var(--brown);color:#fff;font-size:13px;
    cursor:pointer;font-weight:700;
  }
  .btn-xs{padding:4px 10px;font-size:11.5px}
  .btn-primary{background:var(--brown);border-color:var(--brown);color:#fff}
  .btn-beige{background:var(--beige);border-color:var(--beige);color:#fff}
  .btn-ghost{background:#fff}
  .btn-danger{background:var(--danger);border-color:var(--danger);color:#fff}
  .btn-outline{background:#fff;border:1px solid var(--brown);color:var(--brown)}

  /* Layout */
  .container{max-width:1240px;margin:18px auto;padding:0 16px 48px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;margin-bottom:16px}
  .card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;gap:12px;flex-wrap:wrap}
  .section-title{display:flex;align-items:center;gap:8px;margin:0}
  .section-title svg{width:20px;height:20px;color:var(--brown)}
  .hint{color:var(--muted);font-size:12px}

  /* Inputs */
  label{font-weight:800;margin-bottom:6px;display:block;color:var(--brown);font-size:13px}
  .input-wrap{position:relative}
  .input-wrap .i{position:absolute;right:10px;top:50%;transform:translateY(-50%);color:#9ca3af}
  .input-wrap input{padding-right:36px}
  input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:#fff;outline:none;transition:.15s;font-family:"Tajawal",system-ui,Arial;font-size:13px}
  input:focus,select:focus,textarea:focus{border-color:var(--beige);box-shadow:0 0 0 3px rgba(188,143,116,15)}
  #vin{height:44px} #notes{height:44px;resize:none}
  textarea{min-height:44px;resize:vertical}

  /* Grid */
  .grid{display:grid;gap:12px}
  .grid-4{grid-template-columns:repeat(4,1fr)}
  .grid-3{grid-template-columns:repeat(3,1fr)}
  .grid-2{grid-template-columns:repeat(2,1fr)}
  @media (max-width:1080px){ .grid-4{grid-template-columns:repeat(3,1fr)} }
  @media (max-width:860px){ .grid-4,grid-3{grid-template-columns:repeat(2,1fr)} }
  @media (max-width:620px){ .grid-4,grid-3,grid-2{grid-template-columns:1fr} }
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}

  /* Tables */
  .table-wrap{overflow:auto;border:1px solid var(--line);border-radius:14px;background:#fff}
  table{width:100%;border-collapse:separate;border-spacing:0}
  thead th{position:sticky;top:0;background:var(--table-head);z-index:2;border-bottom:1px solid var(--line-strong);
    text-align:right;color:#111827;font-size:13.5px;padding:12px 10px}
  tbody td{border-top:1px solid var(--line);padding:10px;vertical-align:top;font-size:13px}
  tbody tr:nth-child(odd){background:#fff}
  tbody tr:nth-child(even){background:#fcfcfc}
  tbody tr:hover{background:#f8fafc}
  td,th{border-left:1px solid var(--line)}
  td:last-child,th:last-child{border-left:0}
  .cell-actions{display:flex;gap:6px;flex-wrap:wrap}
  .nowrap{white-space:nowrap}
  .w-120{min-width:120px}
  .w-160{min-width:160px}

  /* Import dropdown */
  .import-menu{position:relative;display:inline-block}
  .import-dropdown{position:absolute;top:110%;left:0;background:#fff;border:1px solid var(--line);border-radius:12px;
    box-shadow:0 14px 28px rgba(0,0,0,12);min-width:260px;z-index:20;display:none;overflow:hidden}
  .import-dropdown button{display:flex;gap:8px;align-items:center;width:100%;text-align:right;background:#fff;border:0;padding:12px 14px;cursor:pointer;font-weight:700;font-size:13px}
  .import-dropdown button:hover{background:#f9fafb}

  /* Modal */
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,38);display:none;align-items:center;justify-content:center;z-index:50}
  .modal{background:#fff;border-radius:16px;box-shadow:0 24px 60px rgba(0,0,0,35);width:min(520px,92vw);padding:16px;border:1px solid var(--line)}
  .modal header{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:8px}
  .modal footer{display:flex;justify-content:flex-end;gap:8px;margin-top:10px}
  .modal h3{margin:0;font-size:16px;color:var(--brown)}
  .modal p{margin:4px 0;font-size:13px}
  .modal .list{margin:6px 0 0;padding-right:18px;font-size:13px}
  .modal .list li{margin-bottom:3px}

  /* Toast */
  #toast{
    position:fixed;bottom:18px;right:18px;
    background:#111827;color:#fff;
    padding:10px 14px;border-radius:12px;
    box-shadow:0 10px 24px rgba(0,0,0,.25);
    display:none;font-size:13px;z-index:100
  }
  #toast.show{display:block;animation:fade .2s ease-out}
  @keyframes fade{from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:translateY(0)}}

  /* حركة نقل السيارات */
  .move-row{border:1px dashed #e5e7eb;border-radius:10px;padding:8px 10px;background:#fffbf7}
  .move-row-title{font-size:12px;color:var(--muted);margin-bottom:4px;font-weight:600}

  /* إشعار حركة النقل */
  .move-alert{
    margin-top:10px;
    padding:10px 12px;
    border-radius:12px;
    display:none;
    align-items:flex-start;
    gap:10px;
    font-size:13px;
  }
  .move-alert .icon{
    margin-top:3px;
    font-size:16px;
  }
  .move-alert .title{
    font-weight:800;
    margin-bottom:4px;
    font-size:13.5px;
  }
  .move-alert ul{
    margin:0;
    padding-right:18px;
    list-style:disc;
  }
  .move-alert.success{
    background:#ecfdf3;
    border:1px solid #bbf7d0;
    color:#14532d;
  }
  .move-alert.error{
    background:#fef2f2;
    border:1px solid #fecaca;
    color:#991b1b;
  }
  .move-alert.info{
    background:#eff6ff;
    border:1px solid #bfdbfe;
    color:#1d4ed8;
  }

  .copyable{cursor:pointer;text-decoration:underline;text-decoration-style:dotted}

  .inner-tabs{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    margin-bottom:16px;
  }
  .inner-tab{
    border:1px solid var(--line);
    background:#fff;
    padding:6px 14px;
    border-radius:999px;
    font-size:14px;
    cursor:pointer;
    color:var(--text);
  }
  .inner-tab.active{
    background:var(--brown);
    color:#fff;
    border-color:var(--brown);
  }
  .inner-tab-panel{display:none;}
  .inner-tab-panel.active{display:block;}

  .move-row-title{
    font-weight:600;
    margin-bottom:4px;
    color:var(--brown);
  }
  .move-notes{
    width:100%;
    min-height:48px;
    resize:vertical;
  }

  .notes-col{
    display:none;
  }
</style>
<style id="noFlash">
html{background:#fff8ef;}
body{opacity:0;transition:opacity .12s ease;}
#authGate{display:none !important;}
</style>
</head>
<body>
<!-- Topbar -->
<div class="topbar">
  <div class="topbar-inner">
    <div class="brand">
      <div class="logo" title="MZJ">MZJ</div>
      <div>
        <h1>لوحة إدارة السيارات</h1>
        <small class="hint">مجموعة محمد بن ذعار العجمي للسيارات</small>
      </div>
    </div>
    <div class="tabs">
      <a class="tab active" href="admin.html">الإدارة</a>
      <a class="tab" href="inventory.html">المخزون</a>
      <a class="tab" href="dashboard.html">الداش بورد</a>
      <a class="tab" href="photoshoot.html">الطلبات</a>
      <a class="tab" href="photoshoot-user.html">إدارة الطلبات</a>
      <a class="tab" href="cars.html">كل السيارات</a>
      <a class="tab" href="Activity.html">سجل النشاط</a>
    </div>
    <div class="row">
      <div class="status-badge">
        <span id="connDot" class="dot warn"></span>
        <span id="connText">جارِ الاتصال…</span>
      </div>
      <button id="btnSignOut" class="btn btn-ghost" style="display:none">
        <i class="fa-solid fa-right-from-bracket"></i> تسجيل الخروج
      </button>
    </div>
  </div>
</div>

<!-- Auth Gate -->
<div id="authGate" style="min-height:60vh;display:grid;place-items:center;padding:24px">
  <div class="card" style="max-width:440px;width:96%">
    <h2 style="margin:0 0 10px;color:var(--brown)">تسجيل الدخول</h2>
    <label>البريد الإلكتروني</label>
    <input id="email" class="input" type="email" placeholder="you@example.com"/>
    <label style="margin-top:8px">كلمة المرور</label>
    <input id="password" class="input" type="password" placeholder="••••••••"/>
    <div class="row" style="margin-top:10px">
      <button class="btn btn-primary" id="btnLogin">تسجيل الدخول</button>
      <button class="btn btn-outline" id="btnSignup">إنشاء حساب</button>
    </div>
    <p class="hint" id="authHint" style="margin-top:10px"></p>
  </div>
</div>

<!-- App -->
<div id="app" style="display:none">
  <div class="container">

    <!-- تبويبات داخلية -->
    <div class="card" style="margin-bottom:18px">
      <div class="card-header">
        <div class="section-title">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 7h16M4 12h10M4 17h7"></path></svg>
          <h2 style="margin:0">إدارة بيانات السيارات</h2>
        </div>
        <span class="hint">إضافة — تعديل — حركة نقل رقم الهيكل</span>
      </div>
      <div class="inner-tabs">
        <button class="inner-tab active" data-tab="tab-add">إضافة سيارة جديدة</button>
        <button class="inner-tab" data-tab="tab-edit">تعديل السيارات</button>
        <button class="inner-tab" data-tab="tab-move">حركة نقل السيارات</button>
        <button class="inner-tab" data-tab="tab-track">تتبّع رقم هيكل</button>
      </div>
    </div>

    <!-- تبويب الإضافة -->
    <div class="inner-tab-panel active" id="tab-add">
      <div class="card">
        <div class="card-header">
          <div class="section-title">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 8v8M8 12h8"></path></svg>
            <h2 style="margin:0">إضافة / تعديل سيارة</h2>
          </div>
          <span class="hint">الحفظ يتم مباشرة على Firestore</span>
        </div>
        <div class="grid grid-4">
          <div>
            <label for="car">السيارة</label>
            <select id="car"></select>
          </div>
          <div>
            <label for="variant">البيان</label>
            <select id="variant"></select>
          </div>
          <div>
            <label for="dealer">الوكيل</label>
            <input id="dealer" placeholder="الوكيل"/>
          </div>
          <div>
            <label for="modelYear">الموديل</label>
            <input id="modelYear" placeholder="مثال: 2026"/>
          </div>
        </div>
        <div class="grid grid-4" style="margin-top:10px">
          <div>
            <label for="extColor">اللون الخارجي</label>
            <input id="extColor" placeholder="اللون الخارجي"/>
          </div>
          <div>
            <label for="intColor">اللون الداخلي</label>
            <input id="intColor" placeholder="اللون الداخلي"/>
          </div>
          <div>
            <label for="plate">اللوحة</label>
            <input id="plate" placeholder="رقم اللوحة (إن وجد)"/>
          </div>
          <div>
            <label for="location">المكان</label>
            <select id="location"></select>
          </div>
        </div>
        <div class="grid grid-3" style="margin-top:10px">
          <div>
            <label for="batchName">اسم الدفعة</label>
            <input id="batchName" placeholder="اسم الدفعة (اختياري)"/>
          </div>
          <div>
            <label for="vin">رقم الهيكل</label>
            <input id="vin" placeholder="رقم الهيكل"/>
          </div>
          <div>
            <label for="notes">الملاحظات</label>
            <textarea id="notes" placeholder="ملاحظات إضافية — نفس ارتفاع رقم الهيكل"></textarea>
          </div>
        </div>
        <div class="row" style="margin-top:12px">
          <button class="btn btn-primary" id="btnSave" title="حفظ (Ctrl+S)">
            <i class="fa-regular fa-floppy-disk"></i> حفظ
          </button>
          <button class="btn btn-ghost" id="btnReset" title="تفريغ الحقول (Esc)">
            <i class="fa-solid fa-rotate"></i> تفريغ
          </button>
          <div class="hint"></div>
        </div>
      </div>
    </div>

    <!-- تبويب تعديل السيارات -->
    <div class="inner-tab-panel" id="tab-edit">
      <div class="card">
        <div class="card-header">
          <div class="section-title">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect height="16" rx="2" width="18" x="3" y="4"></rect><path d="M7 8h10"></path></svg>
            <h2 style="margin:0">تعديل السيارات</h2>
          </div>
          <span class="hint"></span>
        </div>
        <div class="row" style="gap:8px;margin-bottom:8px">
          <input id="search" placeholder="بحث سريع (سيارة / البيان / الوكيل / الألوان / الموديل / اللوحة / المكان / اسم الدفعة / رقم الهيكل)" style="flex:1; padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:#fff" title="اضغط / للبحث"/>
          <button class="btn btn-ghost" id="btnClearSearch" title="مسح البحث">
            <i class="fa-solid fa-minus"></i> مسح
          </button>
        </div>
        <div class="table-wrap">
          <table id="carsTable">
            <thead>
              <tr>
                <th>سيارة</th>
                <th>البيان</th>
                <th>الوكيل</th>
                <th>اللون الخارجي</th>
                <th>اللون الداخلي</th>
                <th>موديل</th>
                <th>اللوحة</th>
                <th>المكان</th>
                <th>اسم الدفعة</th>
                <th>رقم الهيكل</th>
                <th>الملاحظات</th>
                <th class="w-160">تحكم</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <p class="hint">الحفظ يتم مباشرة على Firestore.</p>
      </div>
    </div>

    <!-- تبويب حركة نقل السيارات -->
    <div class="inner-tab-panel" id="tab-move">
      <div class="card">
        <div class="card-header">
          <div class="section-title">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M7 10l5-5 5 5"></path><path d="M7 14l5 5 5-5"></path></svg>
            <h2 style="margin:0">حركة نقل السيارات (برقم الهيكل)</h2>
          </div>
          <span class="hint"><b></b></span>
          <div class="row" style="gap:8px;align-items:center;flex-wrap:wrap">
            <label>إلى</label>
            <select id="moveToGlobal" title="المكان الجديد"></select>
          </div>
        </div>

        <!-- 8 صفوف نقل -->
        <div class="row" style="margin:8px 0 12px;gap:8px;align-items:center;flex-wrap:wrap">
          <button class="btn btn-ghost" id="btnAddMoveRow" type="button">
            <i class="fa-solid fa-plus"></i> إضافة حركة أخرى
          </button>
        </div>
        <div class="grid" id="moveRowsContainer" style="gap:10px"></div>

        <!-- datalist للاقتراحات -->
        <datalist id="vinHints"></datalist>

        <!-- Checklist يظهر فقط مع 'مباع تحت التسليم' -->
        <div class="checklist" id="underDeliveryBox" style="display:none; margin-top:10px">
          <h4>المتطلبات عند النقل إلى <b>مباع تحت التسليم</b></h4>
          <div class="grid grid-2">
            <div>
              <div class="check-row">
                <input id="chkAdminApproved" type="checkbox"/>
                <label for="chkAdminApproved">موافقة إدارية</label>
              </div>
              <label for="adminNotes" style="margin-top:6px">ملاحظات الموافقة الإدارية</label>
              <textarea id="adminNotes" placeholder="اكتب أي ملاحظات إدارية…"></textarea>
            </div>
            <div>
              <div class="check-row">
                <input id="chkFinanceApproved" type="checkbox"/>
                <label for="chkFinanceApproved">موافقة مالية</label>
              </div>
              <label for="financeNotes" style="margin-top:6px">ملاحظات الموافقة المالية</label>
              <textarea id="financeNotes" placeholder="اكتب أي ملاحظات مالية…"></textarea>
            </div>
          </div>
        </div>

        <!-- إشعار الحركة -->
        <div id="moveAlert" class="move-alert">
          <div class="icon"><i id="moveAlertIcon" class="fa-solid fa-circle-info"></i></div>
          <div>
            <div id="moveAlertTitle" class="title"></div>
            <ul id="moveAlertList"></ul>
          </div>
        </div>

        <!-- تفاصيل السيارة -->
        <div id="carDetailsBox" style="display:none;margin-top:12px">
          <div class="section-title">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect height="16" rx="2" width="18" x="3" y="4"></rect><path d="M7 8h10"></path></svg>
            <h2 style="margin:0">عرض بيانات السيارة</h2>
          </div>
          <div class="grid grid-2" id="carDetails" style="margin-top:8px"></div>
          <p class="hint" id="carDetailsHint" style="margin-top:8px"></p>
        </div>
      </div>
    </div>

    <!-- تبويب تتبّع رقم هيكل -->
    <div class="inner-tab-panel" id="tab-track">
      <div class="card">
        <div class="card-header">
          <div class="section-title">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 8v8M8 12h8"></path></svg>
            <h2 style="margin:0">تتبّع حركة رقم هيكل</h2>
          </div>
          <div class="row" style="gap:8px">
            <input id="trackVin" list="vinHints" placeholder="اكتب رقم الهيكل لعرض حركته"/>
            <button class="btn btn-ghost" id="btnTrack">عرض الحركة</button>
          </div>
        </div>
        <div class="table-wrap">
          <table id="movesTable">
            <thead>
              <tr>
                <th>التاريخ</th>
                <th>رقم الهيكل</th>
                <th>السيارة</th>
                <th>من</th>
                <th>إلى</th>
                <th>نوع الحركة</th>
                <th>ملاحظات</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

  </div>
</div>

<div id="toast">تم</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

  /* ===== Firebase ===== */
  const firebaseConfig = {
    apiKey: "AIzaSyC614bGqnYf4Q-weTNemzWENTpa8DjGeHw",
    authDomain: "mzj-agenda.firebaseapp.com",
    projectId: "mzj-agenda",
    storageBucket: "mzj-agenda.firebasestorage.app",
    messagingSenderId: "834700407721",
    appId: "1:834700407721:web:75c17665d4f032fd65cab8"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);
  const STATE_REF = doc(db, "mzj_admin_state", "v1");

  /* ===== Helpers ===== */
  const $ = s => document.querySelector(s);
  const toast = $('#toast');
  const pad = n => n<10?'0'+n:n;
  const now = ()=>{const d=new Date();return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`};
  function setStatus(mode,txt){ $('#connDot').className='dot '+(mode==='ok'?'ok':mode==='err'?'err':'warn'); $('#connText').textContent=txt; }
  function showToast(msg){ toast.textContent=msg; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'),1400); }
  const trim = v => (v||'').toString().trim();

  /* ===== State ===== */
  let stock=[], moves=[], models=[], variantsMap={};
  let shootRequests=[];
  let currentFilterKey = null;

  // تبويبات داخلية
  const tabButtons = document.querySelectorAll('.inner-tab');
  const tabPanels  = document.querySelectorAll('.inner-tab-panel');
  tabButtons.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const id=btn.dataset.tab;
      tabButtons.forEach(b=>b.classList.remove('active'));
      tabPanels.forEach(p=>p.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById(id).classList.add('active');
    });
  });

  /* ===== عناصر الواجهة ===== */
  const emailInput   = $('#email');
  const passInput    = $('#password');
  const btnLogin     = $('#btnLogin');
  const btnSignup    = $('#btnSignup');
  const authHint     = $('#authHint');
  const appEl        = $('#app');
  const authGate     = $('#authGate');
  const btnSignOut   = $('#btnSignOut');

  // إضافة / تعديل
  const carSelect      = $('#car');
  const variantSelect  = $('#variant');
  const dealerInput    = $('#dealer');
  const extColorInput  = $('#extColor');
  const intColorInput  = $('#intColor');
  const modelYearInput = $('#modelYear');
  const plateInput     = $('#plate');
  const locationSelect = $('#location');
  const batchNameInput = $('#batchName');
  const vinInput       = $('#vin');
  const notesInput     = $('#notes');
  const btnSave        = $('#btnSave');
  const btnReset       = $('#btnReset');
  const btnExport      = document.createElement('button'); // سيتم استخدامه للتصدير
  const carsTableBody  = document.querySelector('#carsTable tbody');

  // تعديل
  const searchInput    = $('#search');
  const btnClearSearch = $('#btnClearSearch');

  // حركة نقل السيارات
  const moveRowsContainer = $('#moveRowsContainer');
  const moveToGlobal      = $('#moveToGlobal');
  const moveAlert         = $('#moveAlert');
  const moveAlertIcon     = $('#moveAlertIcon');
  const moveAlertTitle    = $('#moveAlertTitle');
  const moveAlertList     = $('#moveAlertList');
  const vinHints          = $('#vinHints');
  const underDeliveryBox  = $('#underDeliveryBox');
  const chkAdminApproved  = $('#chkAdminApproved');
  const chkFinanceApproved= $('#chkFinanceApproved');
  const adminNotesInput   = $('#adminNotes');
  const financeNotesInput = $('#financeNotes');
  const carDetailsBox     = $('#carDetailsBox');
  const carDetails        = $('#carDetails');
  const carDetailsHint    = $('#carDetailsHint');
  const moveStatus        = document.createElement('p'); // لتوضيح الحالة تحت تفاصيل السيارة
  moveStatus.className='hint';
  carDetailsBox.appendChild(moveStatus);

  // تتبع
  const trackVinInput  = $('#trackVin');
  const btnTrack       = $('#btnTrack');
  const movesTableBody = document.querySelector('#movesTable tbody');

  /* ===== Auth ===== */
  onAuthStateChanged(auth, async (user)=>{
    const noFlash = document.getElementById('noFlash');
    if(noFlash) noFlash.remove();
    if(user){
      authGate.style.display='none';
      appEl.style.display='block';
      btnSignOut.style.display='inline-flex';
      setStatus('ok',`متصل: ${user.email}`);
      await loadState();
      subscribeLive();
    }else{
      authGate.style.display='grid';
      appEl.style.display='none';
      btnSignOut.style.display='none';
      setStatus('warn','لم يتم تسجيل الدخول');
    }
  });
  btnLogin.addEventListener('click', async()=>{
    authHint.textContent='';
    try{
      await signInWithEmailAndPassword(auth, emailInput.value.trim(), passInput.value.trim());
      authHint.textContent='';
    }catch(e){
      authHint.textContent='تعذر تسجيل الدخول';
    }
  });
  btnSignup.addEventListener('click', async()=>{
    authHint.textContent='';
    try{
      await createUserWithEmailAndPassword(auth, emailInput.value.trim(), passInput.value.trim());
      authHint.textContent='تم إنشاء الحساب، جاري تسجيل الدخول…';
    }catch(e){
      authHint.textContent='تعذر إنشاء الحساب';
    }
  });
  btnSignOut.addEventListener('click', async()=>{ await signOut(auth); });

  /* ===== State persistence ===== */
  async function loadState(){
    try{
      const snap=await getDoc(STATE_REF);
      if(snap.exists()){
        const d=snap.data()||{};
        stock = Array.isArray(d.stock)? d.stock: [];
        moves = Array.isArray(d.moves)? d.moves: [];
        models= Array.isArray(d.models)? d.models: [];
        variantsMap = d.variantsMap || {};
        shootRequests = Array.isArray(d.shootRequests)? d.shootRequests: [];
      }else{
        stock=[]; moves=[]; models=[]; variantsMap={}; shootRequests=[];
      }
      renderAll();
    }catch(e){
      setStatus('warn','تعذّر تحميل البيانات');
    }
  }
  function subscribeLive(){
    try{
      onSnapshot(STATE_REF,(snap)=>{
        if(!snap.exists()) return;
        const d=snap.data()||{};
        stock = Array.isArray(d.stock)? d.stock: stock;
        moves = Array.isArray(d.moves)? d.moves: moves;
        models= Array.isArray(d.models)? d.models: models;
        variantsMap = d.variantsMap || variantsMap;
        shootRequests = Array.isArray(d.shootRequests)? d.shootRequests: shootRequests;
        renderAll();
        setStatus('ok','مزامنة حيّة');
      },()=> setStatus('warn','انقطاع المزامنة مؤقتًا'));
    }catch(e){}
  }
  async function persistAll(){
    try{
      await setDoc(STATE_REF,{
        stock,
        moves,
        models,
        variantsMap,
        shootRequests
      },{merge:true});
    }catch(e){
      showToast('خطأ في الحفظ');
    }
  }

  /* ===== Models / Variants ===== */
  function populateCars(){
    carSelect.innerHTML = models.map(m=>`<option value="${m}">${m}</option>`).join('');
  }
  function populateVariants(car){
    const list = variantsMap[car] || [];
    variantSelect.innerHTML = list.map(v=>`<option value="${v}">${v}</option>`).join('');
  }

  /* ===== Stock table ===== */
  function renderTable(filter=''){
    const q = filter.trim().toLowerCase();
    const rows = q
      ? stock.filter(r=>{
          const hay = [
            r.car,r.variant,r.dealer,r.extColor,r.intColor,r.modelYear,r.plate,r.location,r.batchName,r.vin,r.notes
          ].join(' ').toLowerCase();
          return hay.includes(q);
        })
      : stock.slice().sort((a,b)=>(a.id||0)-(b.id||0));

    carsTableBody.innerHTML='';
    rows.forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${r.car||''}</td>
        <td>${r.variant||''}</td>
        <td>${r.dealer||''}</td>
        <td>${r.extColor||''}</td>
        <td>${r.intColor||''}</td>
        <td>${r.modelYear||''}</td>
        <td>${r.plate||''}</td>
        <td>${r.location||''}</td>
        <td>${r.batchName||''}</td>
        <td>${r.vin||''}</td>
        <td>${r.notes||''}</td>
        <td class="cell-actions">
          <button class="btn btn-xs btn-ghost" data-edit="${r.id}"><i class="fa-regular fa-pen-to-square"></i></button>
          <button class="btn btn-xs btn-danger" data-del="${r.id}"><i class="fa-regular fa-trash-can"></i></button>
        </td>
      `;
      carsTableBody.appendChild(tr);
    });
  }

  function nextId(){
    const ids = stock.map(r=>r.id||0);
    return ids.length? Math.max(...ids)+1:1;
  }

  function normalizeVin(v){ return (v||'').toString().replace(/[^0-9A-Za-z]/g,'').toUpperCase(); }

  /* ===== Events: table edit/delete ===== */
  document.querySelector('#carsTable').addEventListener('click',(e)=>{
    const btnEdit = e.target.closest('button[data-edit]');
    const btnDel  = e.target.closest('button[data-del]');
    if(btnEdit){
      const id = parseInt(btnEdit.dataset.edit,10);
      const rec = stock.find(r=>r.id===id);
      if(rec){
        carSelect.value   = rec.car||'';
        populateVariants(carSelect.value);
        variantSelect.value = rec.variant||'';
        dealerInput.value = rec.dealer||'';
        extColorInput.value = rec.extColor||'';
        intColorInput.value = rec.intColor||'';
        modelYearInput.value = rec.modelYear||'';
        plateInput.value  = rec.plate||'';
        locationSelect.value = rec.location||'';
        batchNameInput.value = rec.batchName||'';
        vinInput.value    = rec.vin||'';
        notesInput.value  = rec.notes||'';
        editId = rec.id;
      }
    }else if(btnDel){
      const id = parseInt(btnDel.dataset.del,10);
      if(confirm('تأكيد حذف هذه السيارة؟')){
        const idx = stock.findIndex(r=>r.id===id);
        if(idx>-1){
          stock = stock.filter(r=>r.id!==id);
          persistAll();
          renderTable();
          showToast('تم الحذف');
        }
      }
    }
  });

  /* حفظ / تعديل */
  let editId=null;
  btnSave.addEventListener('click',async ()=>{
    const record={
      id:editId||nextId(),
      car:carSelect.value,
      variant:variantSelect.value||'',
      dealer:dealerInput.value.trim(),
      extColor:extColorInput.value.trim(),
      intColor:intColorInput.value.trim(),
      vin:normalizeVin(vinInput.value),
      modelYear:modelYearInput.value.trim(),
      plate:plateInput.value.trim(),
      location:locationSelect.value,
      batchName:batchNameInput.value.trim(),
      notes:notesInput.value.trim()
    };
    if(!record.car) return showToast('اختر السيارة أولًا');

    if(editId){const idx=stock.findIndex(r=>r.id===editId); if(idx>-1) stock[idx]=record; editId=null; showToast('تم التعديل');}
    else {stock.push(record); showToast('تم الحفظ');}
    await persistAll(); renderTable(); clearForm();
  });
  function clearForm(){
    if(models.length){carSelect.value=models[0]; populateVariants(carSelect.value); variantSelect.value=variantSelect.options[0]?.value||'';}
    dealerInput.value=''; extColorInput.value=''; intColorInput.value='';
    modelYearInput.value=''; plateInput.value='';
    locationSelect.selectedIndex=0;
    batchNameInput.value=''; vinInput.value=''; notesInput.value=''; editId=null;
  }
  btnReset.addEventListener('click',clearForm);

  /* ===== تصدير Excel (كامل) — (لو حابب تستخدمه من زر منفصل) ===== */
  btnExport.style.display='none';

  btnSignOut.insertAdjacentElement('afterend', btnExport);

  /* ===== حركة نقل السيارات ===== */

  function showMoveAlert(type,title,lines){
    moveAlert.classList.remove('success','error','info');
    moveAlert.classList.add(type==='success'?'success':type==='error'?'error':'info');
    moveAlertIcon.className = type==='success'
      ? 'fa-solid fa-circle-check'
      : type==='error'
        ? 'fa-solid fa-circle-xmark'
        : 'fa-solid fa-circle-info';
    moveAlertTitle.textContent=title;
    moveAlertList.innerHTML = (lines||[]).map(x=>`<li>${x}</li>`).join('');
    moveAlert.style.display='flex';
  }

  function renderCarDetails(rec){
    if(!rec){ carDetailsBox.style.display='none'; return; }
    carDetailsBox.style.display='block';
    carDetails.innerHTML = `
      <div>
        <strong>${rec.car||''}</strong><br/>
        <span class="hint">${rec.variant||''}</span>
      </div>
      <div>
        <div>اللون الخارجي: <b>${rec.extColor||'-'}</b></div>
        <div>اللون الداخلي: <b>${rec.intColor||'-'}</b></div>
      </div>
      <div>
        <div>الموديل: <b>${rec.modelYear||'-'}</b></div>
        <div>الوكيل: <b>${rec.dealer||'-'}</b></div>
      </div>
      <div>
        <div>المكان الحالي: <b>${rec.location||'-'}</b></div>
        <div>رقم الهيكل: <b class="copyable">${rec.vin||'-'}</b></div>
      </div>
    `;
    carDetailsHint.textContent = 'يمكنك مراجعة البيانات قبل تأكيد حركة النقل.';
  }

  function updateVinSuggestionsForPrefix(prefix){
    const normPrefix = normalizeVin(prefix);
    if(!normPrefix){ vinHints.innerHTML=''; return; }
    const set = new Set();
    stock.forEach(r=>{
      const v = normalizeVin(r.vin);
      if(v && v.startsWith(normPrefix)) set.add(v);
    });
    const list = Array.from(set).sort().slice(0,30);
    vinHints.innerHTML = list.map(v=>`<option value="${v}"></option>`).join('');
  }

  /* اقتراح المكان "من" لكل سطر عند كتابة VIN */
  function autoFindByVinForRow(row, strictMessage=false){
    const inp = row.querySelector('.move-vin');
    const fromSel = row.querySelector('.move-from');
    const vinRaw = (inp.value||'').trim();
    if(!vinRaw){
      if(fromSel){
        fromSel.disabled=false;
        fromSel.value='';
      }
      const anyVin = moveRowsContainer.querySelectorAll('.move-vin');
      const hasAnyVin = Array.from(anyVin).some(i=> normalizeVin(i.value));
      if(!hasAnyVin){
        carDetailsBox.style.display='none';
        moveStatus.textContent='';
      }
      return;
    }
    const norm = normalizeVin(vinRaw);
    let match = stock.find(r => normalizeVin(r.vin) === norm);
    if(!match && norm.length >= 8){
      const candidates = stock.filter(r => normalizeVin(r.vin).startsWith(norm));
      if(candidates.length === 1) match = candidates[0];
    }
    if(match){
      renderCarDetails(match);
      const currentLoc = match.location || '';
      if(currentLoc && fromSel){
        fromSel.value = currentLoc;
        fromSel.disabled = true;
        moveStatus.textContent = `تم العثور: ${match.car} — المكان الحالي: ${currentLoc}`;
      }else if(fromSel){
        fromSel.disabled = false;
        moveStatus.textContent = `تم العثور: ${match.car} — لا يوجد مكان مسجل. اختر المكان يدويًا.`;
      }
    }else{
      if(strictMessage){
        const msg = 'لم يتم العثور على سيارة بهذا الرقم.';
        moveStatus.textContent = msg;
        carDetailsBox.style.display='none';
        showMoveAlert('error','لم يتم العثور على السيارة',[msg]);
      }else{
        moveStatus.textContent = '— لم يتم التعرف على السيارة بعد (أكمل رقم الهيكل).';
      }
    }
  }

  function debounce(fn,delay){
    let t;
    return (...args)=>{
      clearTimeout(t);
      t=setTimeout(()=>fn(...args),delay);
    };
  }

  function attachMoveRowEvents(row){
    const inp = row.querySelector('.move-vin');
    if(!inp) return;
    inp.addEventListener('input', debounce(()=>{
      updateVinSuggestionsForPrefix(inp.value);
      autoFindByVinForRow(row,false);
    },150));
  }

  function createMoveRow(index){
    const row = document.createElement('div');
    row.className = 'move-row';
    row.innerHTML = `
      <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:4px">
        <div class="move-row-title">حركة رقم (${index+1})</div>
        <button type="button" class="btn btn-xs btn-ghost" data-remove-row>حذف</button>
      </div>
      <div class="grid grid-3">
        <div>
          <label>رقم الهيكل</label>
          <input class="move-vin" list="vinHints" placeholder="اكتب رقم الهيكل"/>
        </div>
        <div>
          <label>من</label>
          <select class="move-from"></select>
        </div>
        <div>
          <label>ملاحظات على هذه الحركة</label>
          <textarea class="move-notes" placeholder="ملاحظات تخص هذه الحركة فقط (اختياري)"></textarea>
        </div>
      </div>
    `;
    const fromSel = row.querySelector('.move-from');
    fromSel.innerHTML = locationSelect.innerHTML;
    attachMoveRowEvents(row);
    return row;
  }

  function ensureMoveRows(count){
    moveRowsContainer.innerHTML='';
    for(let i=0;i<count;i++){
      moveRowsContainer.appendChild(createMoveRow(i));
    }
  }

  ensureMoveRows(3);

  document.getElementById('btnAddMoveRow').addEventListener('click',()=>{
    const c = moveRowsContainer.children.length;
    moveRowsContainer.appendChild(createMoveRow(c));
  });

  moveRowsContainer.addEventListener('click',(e)=>{
    const btn = e.target.closest('[data-remove-row]');
    if(btn){
      const row = btn.closest('.move-row');
      row?.remove();
    }
  });

  /* تعبئة الأماكن في dropdown العام */
  function fillMoveToGlobal(){
    moveToGlobal.innerHTML = locationSelect.innerHTML;
  }

  /* تشغيل / إخفاء Checklist عند اختيار "مباع تحت التسليم" */
  function updateUnderDeliveryVisibility(){
    const dest = moveToGlobal.value||'';
    if(/مباع تحت التسليم/.test(dest)){
      underDeliveryBox.style.display='block';
    }else{
      underDeliveryBox.style.display='none';
      chkAdminApproved.checked=false;
      chkFinanceApproved.checked=false;
      adminNotesInput.value='';
      financeNotesInput.value='';
    }
  }
  moveToGlobal.addEventListener('change', updateUnderDeliveryVisibility);

  /* تنفيذ حركات النقل */
  async function executeMoves(){
    const dest = moveToGlobal.value||'';
    if(!dest) return showMoveAlert('error','اختر المكان الجديد',[ 'من فضلك اختر المكان "إلى" أولاً.' ]);

    const rows = Array.from(moveRowsContainer.querySelectorAll('.move-row'));
    if(!rows.length) return showMoveAlert('error','لا يوجد حركات',[ 'أضف على الأقل رقم هيكل واحد.' ]);

    const errors=[], successLines=[];
    let movedCount=0;

    const isUnderDeliveryDest = /مباع تحت التسليم/.test(dest);
    const goingDeliveredRow   = /مباع تم التسليم/.test(dest);

    const noteAdmin   = adminNotesInput.value.trim();
    const noteFinance = financeNotesInput.value.trim();

    const moveMeta = {
      adminApproved: null,
      adminNotes: '',
      financeApproved: null,
      financeNotes: '',
      issuesNotes: noteAdmin || noteFinance ? (noteAdmin + (noteFinance?(' | '+noteFinance):'')) : ''
    };

    if(isUnderDeliveryDest){
      if(!chkAdminApproved.checked || !chkFinanceApproved.checked){
        return showMoveAlert('error','المتطلبات غير مكتملة',[
          'لنقل السيارة إلى "مباع تحت التسليم" يجب وجود:',
          '✓ موافقة إدارية',
          '✓ موافقة مالية'
        ]);
      }
      moveMeta.adminApproved = true;
      moveMeta.adminNotes    = noteAdmin;
      moveMeta.financeApproved = true;
      moveMeta.financeNotes    = noteFinance;
    }

    const onlyDate = (dt)=> dt.split(' ')[0];

    for(const row of rows){
      const vinInputRow = row.querySelector('.move-vin');
      const fromSelect  = row.querySelector('.move-from');
      const rowNote     = row.querySelector('.move-notes');
      const vinRaw      = (vinInputRow.value||'').trim();
      const from        = fromSelect.value||'';
      const rowNoteText = (rowNote.value||'').trim();

      if(!vinRaw && !from && !rowNoteText) continue;
      if(!vinRaw){
        errors.push('لم يتم إدخال رقم الهيكل في إحدى الحركات.');
        continue;
      }
      const normVin = normalizeVin(vinRaw);
      const rec = stock.find(r => normalizeVin(r.vin) === normVin);
      if(!rec){
        errors.push(`لم يتم العثور على سيارة بهذا VIN: ${vinRaw}`);
        continue;
      }

      const oldLoc = rec.location || from;

      if(goingDeliveredRow){
        // في حالة "مباع تم التسليم": تسجيل طلب نقل فقط بدون تغيير مكان السيارة
        const stamp = now();
        moves.push({
          when: stamp,
          date: onlyDate(stamp),
          vin: rec.vin || '',
          car: rec.car || '',
          from: oldLoc,
          to: dest,
          id: rec.id,
          ...moveMeta,
          requiresAdminApproval: true,
          status: 'pending'
        });
        movedCount++;
        successLines.push(`تم تسجيل طلب نقل ${rec.car||''} (${rec.vin||vinRaw}) من "${oldLoc}" إلى "${dest}" بانتظار موافقة الإدارة.`);
        continue;
      }

      // نقل عادي (تغيير المكان مباشرة)
      rec.location = dest;
      const stamp  = now();
      moves.push({
        when: stamp,
        date: onlyDate(stamp),
        vin: rec.vin || '',
        car: rec.car || '',
        from: oldLoc,
        to: dest,
        id: rec.id,
        ...moveMeta
      });
      movedCount++;
      successLines.push(`تم نقل ${rec.car||''} (${rec.vin||vinRaw}) من "${oldLoc}" إلى "${dest}".`);
    }

    if(movedCount>0){
      await persistAll();
      renderTable();
    }

    if(errors.length){
      showMoveAlert('error','بعض الحركات لم تُنفّذ',errors.concat(successLines));
    }else if(movedCount>0){
      showMoveAlert('success','تم تنفيذ الحركات بنجاح',successLines);
    }else{
      showMoveAlert('info','لم يتم تنفيذ أي حركة',['تأكد من إدخال أرقام الهياكل والبيانات بشكل صحيح.']);
    }
  }

  const btnExecuteMoves = document.createElement('button');
  btnExecuteMoves.className='btn btn-primary';
  btnExecuteMoves.innerHTML='<i class="fa-solid fa-right-left"></i> تنفيذ حركات النقل';
  document.querySelector('#tab-move .card-header .hint').appendChild(btnExecuteMoves);

  btnExecuteMoves.addEventListener('click', executeMoves);

  /* ===== تتبّع حركة رقم الهيكل ===== */
  function renderMovesTable(vin){
    const norm = normalizeVin(vin);
    const filtered = moves
      .filter(m=> normalizeVin(m.vin)===norm)
      .sort((a,b)=> (a.when||'').localeCompare(b.when||''));
    movesTableBody.innerHTML='';
    filtered.forEach(m=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${m.date||''}</td>
        <td>${m.vin||''}</td>
        <td>${m.car||''}</td>
        <td>${m.from||''}</td>
        <td>${m.to||''}</td>
        <td>${/مباع تم التسليم/.test(m.to||'')?'طلب نقل لمباع تم التسليم':'نقل عادي'}</td>
        <td>${m.issuesNotes||''}</td>
      `;
      movesTableBody.appendChild(tr);
    });
  }

  btnTrack.addEventListener('click',()=>{
    const vin = trackVinInput.value.trim();
    if(!vin) return;
    renderMovesTable(vin);
  });

  trackVinInput.addEventListener('keydown',(e)=>{
    if(e.key==='Enter'){
      e.preventDefault();
      btnTrack.click();
    }
  });

  /* ===== Render all ===== */
  function renderAll(){
    populateCars();
    populateVariants(carSelect.value);
    renderTable(searchInput.value||'');
    fillMoveToGlobal();
    updateUnderDeliveryVisibility();
  }

  /* ===== بحث تعديل ===== */
  searchInput.addEventListener('input',()=> renderTable(searchInput.value||''));
  btnClearSearch.addEventListener('click',()=>{
    searchInput.value='';
    renderTable('');
  });

</script>
</body>
</html>
