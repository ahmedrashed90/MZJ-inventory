<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>MZJ إدارة الطلبات</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
<style id="noflash">html{background:#fff8ef}body{opacity:0;transition:opacity .12s ease}</style>
<meta name="color-scheme" content="light"/>
<style>
  :root{
    --brown:#3e2420; --beige:#bc8f74; --cream:#fff8ef; --card:#ffffff; --line:#e7e5e4;
    --text:#1f2937; --muted:#6b7280; --ok:#16a34a; --danger:#ef4444; --info:#0ea5e9;
    --radius:12px; --shadow:0 10px 26px rgba(0,0,0,.06); --table-head:#fafafa;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    background:var(--cream);
    color:var(--text);
    font-family:"Tajawal",system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
    line-height:1.75;
  }
  a{text-decoration:none;color:var(--brown)}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}

  /* Header */
  .top{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--line);z-index:10}
  .top .inner{max-width:1240px;margin:auto;padding:12px;display:flex;align-items:center;justify-content:space-between}
  .brand{display:flex;align-items:center;gap:10px}
  .logo{
    width:36px;height:36px;border-radius:12px;
    background:linear-gradient(135deg,#3e2420,#bc8f74);
    display:grid;place-items:center;color:#fff;font-weight:900;box-shadow:var(--shadow);
  }
  h1{margin:0;font-size:19px;color:var(--brown)}
  .chip{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--line);border-radius:999px;padding:6px 10px;font-size:12px;background:#fff}
  .dot{width:8px;height:8px;border-radius:999px;background:#f59e0b}
  .dot.ok{background:var(--ok)} .dot.err{background:var(--danger)}
  .btn{
    background:var(--brown);color:#fff;border:none;border-radius:10px;
    padding:8px 11px;font-weight:800;cursor:pointer;display:inline-flex;gap:8px;align-items:center;
  }
  .btn.secondary{background:#fff;color:var(--brown);border:1px solid var(--line)}
  .btn.ghost{background:transparent;color:var(--brown);border:1px dashed var(--line)}
  .btn.beige{background:var(--beige);color:#fff}
  .btn.danger{background:var(--danger)}
  .btn-mini{
    padding:5px 10px;
    font-size:11px;
    border-radius:999px;
  }
  .filter-kind.active-kind{
    background:var(--brown);
    color:#fff;
    border-color:var(--brown);
  }
  .no-print{}

  /* Layout */
  .wrap{max-width:1240px;margin:14px auto;padding:0 12px}
  .grid{display:grid;gap:12px}
  .cards{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow)}
  .card .inner{padding:14px}
  .metric{display:flex;align-items:center;justify-content:space-between}
  .metric .k{font-size:24px;font-weight:800;color:var(--brown)}
  .metric .l{font-size:12px;color:var(--muted)}
  .metric i{opacity:.7}

  .panel{background:#fff;border:1px solid var(--line);border-radius:12px;box-shadow:var(--shadow)}
  .panel .head{display:flex;align-items:center;justify-content:space-between;padding:12px;border-bottom:1px solid var(--line)}
  .panel .body{padding:0}

  .filters{display:flex;gap:8px;flex-wrap:wrap;padding:10px;background:#fff8ef;border-bottom:1px dashed var(--line);align-items:center}
  .filters-left{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .filters-right{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
  input,select,button,textarea{font-family:inherit}
  input[type="search"], select, input[type="date"], input[type="text"]{
    height:36px;padding:0 10px;border:1px solid var(--line);border-radius:10px;background:#fff;
  }

  .table-wrap{overflow:auto}
  table{width:100%;border-collapse:separate;border-spacing:0}
  th,td{border-bottom:1px solid var(--line);padding:8px 6px;font-size:12px;vertical-align:top}
  th{position:sticky;top:0;background:var(--table-head);text-align:right;z-index:1}
  tr:hover td{background:#fffdf8}
  .center{text-align:center}

  .muted{color:var(--muted)}
  .pill{display:inline-flex;gap:8px;align-items:center;padding:3px 9px;border-radius:999px;border:1px solid var(--line);font-size:11px}
  .pill-draft{background:#FEF3C7}
  .pill-prog{background:#DBEAFE}
  .pill-done{background:#DCFCE7}

  /* Modal */
  .modal-backdrop{
    position:fixed;inset:0;
    background:rgba(0,0,0,.38);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:50;
  }
  .modal{
    background:#fff;
    border-radius:16px;
    box-shadow:0 24px 60px rgba(0,0,0,.35);
    width:min(1100px,98vw);
    border:1px solid var(--line);
    transform:scale(.85);
    transform-origin:top center;
  }
  .modal header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:10px 12px;
    border-bottom:1px solid var(--line);
  }
  .modal .content{
    padding:10px 12px;
    max-height:calc(100vh - 140px);
    overflow:auto;
  }
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .subhint{font-size:12px;color:var(--muted)}

  .req-note-print{
    font-size:12px;
    color:#111827;
    white-space:pre-wrap;
  }

  #reqModal table th,
  #reqModal table td,
  #moveModal table th,
  #moveModal table td{
    font-size:11px;
    padding:6px 4px;
  }

  #authGate{display:none;min-height:80vh;place-items:center}
  #authCard{width:min(420px,92vw);padding:18px;border:1px solid var(--line);border-radius:var(--radius);background:#fff;box-shadow:var(--shadow)}

  @media(max-width:1000px){
    .cards{grid-template-columns:1fr}
    .panel .head{flex-direction:column;align-items:flex-start;gap:6px}
  }

  @media print {
    @page {
      size: A4 portrait;
      margin-top: 0.4in;
      margin-right: 0.03in;
      margin-bottom: 0.33in;
      margin-left: 0in;
    }

    body{background:#fff;}
    body *{visibility:hidden;}
    #reqModal, #reqModal *{visibility:visible;}
    #reqModal{
      position:static;
      inset:auto;
      background:#fff;
      display:block !important;
    }

    #reqModal .modal{
      width:100%;
      max-width:none;
      box-shadow:none;
      border:none;
      border-radius:0;
      transform:none !important;
    }
    #reqModal .content{
      padding:6px;
      max-height:none;
      overflow:visible;
    }

    #reqModal table th,
    #reqModal table td{
      padding:4px 3px;
      font-size:10px;
    }

    #reqModal .table-wrap{overflow:visible;}
    .no-print{display:none !important;}
    .top, .wrap > :not(#reqModal){display:none !important;}
  }
</style>
</head>
<body>
  <header class="top">
    <div class="inner">
      <div class="brand">
        <div class="logo">MZJ</div>
        <h1>إدارة الطلبات</h1>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <span class="chip"><span id="connDot" class="dot"></span><span id="connText">جارِ الاتصال…</span></span>
        <button id="btnSignOut" class="btn secondary" style="display:none">خروج</button>
      </div>
    </div>
  </header>

  <main class="wrap grid">
    <!-- Top metrics -->
    <section class="cards">
      <div class="card">
        <div class="inner metric">
          <div>
            <div class="l">إجمالي الطلبات</div>
            <div id="m_all" class="k">0</div>
          </div>
          <i class="fa-solid fa-list-check"></i>
        </div>
      </div>
      <div class="card">
        <div class="inner metric">
          <div>
            <div class="l">تحت الإجراء / تم التجهيز / قيد المراجعة</div>
            <div id="m_prog" class="k">0</div>
          </div>
          <i class="fa-solid fa-gears"></i>
        </div>
      </div>
      <div class="card">
        <div class="inner metric">
          <div>
            <div class="l">تم / منفّذ</div>
            <div id="m_done" class="k">0</div>
          </div>
          <i class="fa-regular fa-circle-check"></i>
        </div>
      </div>
    </section>

    <!-- Auth Gate -->
    <section id="authGate" class="panel">
      <div class="head"><strong>تسجيل الدخول</strong></div>
      <div class="body" style="padding:12px">
        <div style="display:grid;gap:10px;max-width:420px">
          <input id="email" type="text" placeholder="Email">
          <input id="password" type="password" placeholder="Password">
          <div style="display:flex;gap:8px;align-items:center">
            <button id="btnLogin" class="btn">دخول</button>
            <span id="authHint" class="muted"></span>
          </div>
        </div>
      </div>
    </section>

    <!-- Main Table -->
    <section id="app" class="panel" style="display:none">
      <div class="head">
        <strong>الطلبات (تصوير + نقل)</strong>
        <div class="muted"><span id="countShown">0</span> من <span id="countTotal">0</span></div>
      </div>
      <div class="body">
        <div class="filters">
          <div class="filters-left">
            <input id="date_from" type="date" title="من تاريخ">
            <input id="date_to" type="date" title="إلى تاريخ">
            <select id="f_status" title="الحالة">
              <option value="">كل الحالات</option>
              <option>مسودة</option>
              <option>تحت الإجراء</option>
              <option>تم التجهيز</option>
              <option>قيد المراجعة</option>
              <option>تم</option>
              <option>منفّذ</option>
            </select>
            <input id="q" type="search" placeholder="بحث: نوع الطلب / VIN / المكان / المنشئ / ملاحظة">
            <button id="f_reset" class="btn ghost"><i class="fa-solid fa-rotate-right"></i> إعادة التصفية</button>
          </div>
          <div class="filters-right">
            <button type="button" id="kind_all"   class="btn secondary btn-mini filter-kind active-kind">كل الأنواع</button>
            <button type="button" id="kind_shoot" class="btn secondary btn-mini filter-kind">طلبات التصوير</button>
            <button type="button" id="kind_move"  class="btn secondary btn-mini filter-kind">طلبات النقل</button>
          </div>
        </div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th class="center">#</th>
                <th style="min-width:80px">الطلب</th>
                <th style="min-width:110px">نوع الطلب</th>
                <th style="min-width:110px">المنشئ</th>
                <th style="min-width:90px">الحالة</th>
                <th style="min-width:130px">تاريخ الإنشاء</th>
                <th style="min-width:160px">المكان / من → إلى</th>
                <th style="min-width:160px">استلام / موافقات</th>
                <th style="min-width:140px">ملاحظات الإدارة</th>
                <th style="min-width:140px">إجراءات</th>
              </tr>
            </thead>
            <tbody id="reqTable"></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <!-- Modal: عرض طلب تصوير + نقل لمكان التصوير -->
  <div id="reqModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <header>
        <strong id="reqModalTitle">عرض طلب التصوير</strong>
        <div class="row no-print">
          <button class="btn secondary" id="btnModalReceived"><i class="fa-regular fa-handshake"></i> تأكيد الاستلام</button>
          <button class="btn beige" id="btnReceiveAndMove"><i class="fa-solid fa-truck-fast"></i> تأكيد الاستلام ونقل السيارة</button>
          <button class="btn" id="btnPrintReq"><i class="fa-solid fa-print"></i> طباعة الطلب</button>
          <button class="btn secondary" id="reqModalClose"><i class="fa-solid fa-xmark"></i> إغلاق</button>
        </div>
      </header>
      <div class="content">
        <div class="row" style="justify-content:space-between;margin-bottom:6px">
          <div class="subhint" id="reqMeta"></div>
          <div class="subhint" id="reqStatus"></div>
        </div>

        <div class="card">
          <div class="inner">
            <div class="row" style="width:100%;justify-content:space-between">
              <div style="flex:1;min-width:260px">
                <label style="display:block;margin-bottom:6px">مكان التصوير</label>
                <input id="reqPlaceRequested" type="text" readonly placeholder="—" />
              </div>
            </div>
          </div>
        </div>

        <!-- جدول تفاصيل السيارات داخل طلب التصوير -->
        <div class="table-wrap" style="margin-top:10px">
          <table>
            <thead>
              <tr>
                <th style="min-width:35px">#</th>
                <th style="min-width:130px">رقم الهيكل (VIN)</th>
                <th style="min-width:180px">السيارة + البيان</th>
                <th style="min-width:180px">الخارجي / الداخلي / الموديل</th>
                <th style="min-width:170px">مكان السيارة (حالي)</th>
                <th style="min-width:160px">مكان التصوير</th>
                <th style="min-width:200px">ملاحظات</th>
              </tr>
            </thead>
            <tbody id="reqCarsTable"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: عرض / موافقة طلب نقل -->
  <div id="moveModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <header>
        <strong id="moveModalTitle">عرض طلب النقل</strong>
        <div class="row no-print">
          <button class="btn beige" id="btnMoveApproveExecute">
            <i class="fa-solid fa-check-double"></i> موافقة إدارية وتنفيذ حركة المخزون
          </button>
          <button class="btn secondary" id="moveModalClose">
            <i class="fa-solid fa-xmark"></i> إغلاق
          </button>
        </div>
      </header>
      <div class="content">
        <div class="row" style="justify-content:space-between;margin-bottom:6px">
          <div class="subhint" id="moveMeta"></div>
          <div class="subhint" id="moveStatus"></div>
        </div>
        <div class="subhint" id="moveApprovals" style="margin-bottom:6px"></div>

        <div class="card">
          <div class="inner">
            <div class="row" style="width:100%;justify-content:space-between">
              <div style="flex:1;min-width:260px">
                <label style="display:block;margin-bottom:4px">وصف المسار</label>
                <div id="moveRouteSummary" class="muted"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- جدول تفاصيل السيارات داخل طلب النقل -->
        <div class="table-wrap" style="margin-top:10px">
          <table>
            <thead>
              <tr>
                <th style="min-width:35px">#</th>
                <th style="min-width:130px">رقم الهيكل (VIN)</th>
                <th style="min-width:160px">الموقع الحالي بالمخزون</th>
                <th style="min-width:160px">من (الطلب)</th>
                <th style="min-width:160px">إلى (الطلب)</th>
                <th style="min-width:180px">ملاحظات</th>
              </tr>
            </thead>
            <tbody id="moveCarsTable"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="chip" style="position:fixed;bottom:18px;right:18px;display:none;background:#111827;color:#fff;border-color:#111827"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
  import { 
    getFirestore, doc, getDoc, setDoc, onSnapshot,
    collection, addDoc, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

  /* ===== Firebase ===== */
  const firebaseConfig = {
    apiKey: "AIzaSyC614bGqnYf4Q-weTNemzWENTpa8DjGeHw",
    authDomain: "mzj-agenda.firebaseapp.com",
    projectId: "mzj-agenda",
    storageBucket: "mzj-agenda.firebasestorage.app",
    messagingSenderId: "834700407721",
    appId: "1:834700407721:web:75c17665d4f032fd65cab8"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);
  const STATE_REF = doc(db, "mzj_admin_state", "v1");
  const ACTIVITY_COL = collection(db, "mzj_activity_log");

  /* ===== Admin Name Logic ===== */
  const ADMIN_MAP = { };
  function displayNameFor(user){
    if(!user) return "مسؤول";
    if(user.displayName && user.displayName.trim()) return user.displayName.trim();
    const e = (user.email||"").toLowerCase();
    if(ADMIN_MAP[e]) return ADMIN_MAP[e];
    const local = e.split("@")[0]||"";
    return local.replace(/[._-]+/g," ").replace(/\b\w/g, c=>c.toUpperCase());
  }

  /* ===== State & Helpers ===== */
  let shootRequests = [];
  let stock = [];
  let moves = [];
  let moveRequests = [];

  const $ = s=>document.querySelector(s);
  const $$ = s=>Array.from(document.querySelectorAll(s));
  const pad = n=>n<10?'0'+n:n;
  const toast=$('#toast');
  const showToast=(m)=>{ toast.textContent=m; toast.style.display='block'; setTimeout(()=>toast.style.display='none',1800); };
  function now(){
    const d=new Date();
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
  }
  function onlyDate(str){return (str||'').toString().slice(0,10)}
  function setStatus(mode,txt){
    $('#connDot').className='dot '+(mode==='ok'?'ok':mode==='err'?'err':'');
    $('#connText').textContent=txt;
  }
  function toDateOnly(s){
    if(!s) return null;
    const d=s.slice(0,10);
    const [y,m,dd]=d.split('-').map(n=>parseInt(n,10));
    if(!y||!m||!dd) return null;
    return new Date(y,m-1,dd);
  }
  function inRange(createdAt, from, to){
    if(!from && !to) return true;
    const d = toDateOnly(createdAt); if(!d) return false;
    if(from && d < from) return false;
    if(to   && d > to)   return false;
    return true;
  }
  function normalizeVin(v){
    if(!v) return '';
    const ar={'٠':'0','١':'1','٢':'2','٣':'3','٤':'4','٥':'5','٦':'6','٧':'7','٨':'8','٩':'9'};
    return v.toString().replace(/[٠-٩]/g,d=>ar[d]).toUpperCase().replace(/[\s\-\._]/g,'').trim();
  }

  /* ===== Metrics ===== */
  function metrics(){
    const allCount = shootRequests.length + moveRequests.length;
    const progStatuses = new Set(['تحت الإجراء','تم التجهيز','قيد المراجعة']);
    const doneStatuses = new Set(['تم','منفّذ']);

    const progCount =
      shootRequests.filter(x=> progStatuses.has(x.status||'')).length +
      moveRequests.filter(x=> progStatuses.has(x.status||'')).length;

    const doneCount =
      shootRequests.filter(x=> doneStatuses.has(x.status||'')).length +
      moveRequests.filter(x=> doneStatuses.has(x.status||'')).length;

    $('#m_all').textContent  = allCount;
    $('#m_prog').textContent = progCount;
    $('#m_done').textContent = doneCount;
  }

  // تسجيل في Collection mzj_activity_log
  async function logActivity(actionType, details, extra={}){
    try{
      const user = auth.currentUser;
      const email = user?.email || '';
      const name  = displayNameFor(user);
      await addDoc(ACTIVITY_COL, {
        userEmail: email,
        userName : name,
        role     : extra.role || '',
        action   : actionType,
        entityType: extra.entityType || 'request',
        entityId : extra.requestId != null ? String(extra.requestId) : (extra.entityId || ''),
        details  : details || '',
        createdAt: now(),
        createdAtTs: serverTimestamp(),
        ip       : extra.ip || '',
        userAgent: navigator.userAgent || ''
      });
    }catch(e){
      console.error('logActivity error', e);
    }
  }

  async function persistAll(){
    await setDoc(
      STATE_REF,
      { shootRequests, stock, moves, moveRequests, updatedAt: now() },
      { merge:true }
    );
  }

  /* ===== استخراج مكان التصوير من طلب التصوير ===== */
  function findPlaceDeep(obj, depth=0){
    if(!obj || typeof obj!=='object' || depth>4) return null;
    const regexKey = /(place|shoot|تصوير|مكان.?التصوير|موقع)/i;

    for(const [k,v] of Object.entries(obj)){
      if(typeof v==='string' && regexKey.test(k)){
        const t = v.trim();
        if(t) return t;
      }
    }
    for(const [,v] of Object.entries(obj)){
      if(v && typeof v==='object'){
        const found = findPlaceDeep(v, depth+1);
        if(found) return found;
      }
    }
    return null;
  }

  function requestedPlaceOf(r){
    if(!r) return '';
    const direct =
      r.placeRequested || r.requestedPlace || r.place ||
      r.shoot_place || r.shootPlace || r['مكان التصوير'] ||
      (r.shoot && (r.shoot.placeRequested || r.shoot.requestedPlace || r.shoot.place || r.shoot['مكان التصوير']));
    if(direct && typeof direct==='string' && direct.trim()) return direct.trim();

    const deep = findPlaceDeep(r);
    return deep || '';
  }

  /* ===== ملخص مكان طلب النقل (من / إلى) ===== */
  function moveRequestLocationSummary(mr){
    const rows = Array.isArray(mr.rows)? mr.rows : [];
    if(!rows.length) return '-';
    const fromSet = new Set();
    const toSet   = new Set();
    rows.forEach(r=>{
      if(r.fromLocation) fromSet.add(r.fromLocation);
      if(r.toLocation)   toSet.add(r.toLocation);
    });
    const from = [...fromSet].join(' ، ') || 'غير محدد';
    const to   = [...toSet].join(' ، ')   || 'غير محدد';
    return `من: ${from} → إلى: ${to}`;
  }

  /* ===== حركة المخزون ===== */
  function currentLocationByVIN(vin){
    if(!vin) return '';
    const norm = normalizeVin(vin);
    const rec = stock.find(s=> normalizeVin(s.vin)===norm);
    return rec ? (rec.location || '') : '';
  }

  function setLocationByVIN(vinOrNorm, newLoc){
    const norm = normalizeVin(vinOrNorm);
    const idx = stock.findIndex(s=> normalizeVin(s.vin)===norm);
    if(idx>=0){ stock[idx].location = newLoc; }
  }

  async function recordMove(vin, car, from, to, stockId, reason){
    const stamp = now();
    moves.push({
      when: stamp,
      date: onlyDate(stamp),
      vin, car, from, to,
      id: stockId || '',
      by: displayNameFor(auth.currentUser)||'مسؤول',
      reason: reason || ''
    });
  }

  /* ===== فلتر نوع الطلب ===== */
  let filterKind = ''; // '' = الكل، 'shoot'، 'move'
  function setKindFilter(kind){
    filterKind = kind || '';
    $$('.filter-kind').forEach(btn=> btn.classList.remove('active-kind'));
    if(filterKind==='shoot') $('#kind_shoot').classList.add('active-kind');
    else if(filterKind==='move') $('#kind_move').classList.add('active-kind');
    else $('#kind_all').classList.add('active-kind');
    render();
  }

  $('#kind_all').addEventListener('click', ()=> setKindFilter(''));
  $('#kind_shoot').addEventListener('click', ()=> setKindFilter('shoot'));
  $('#kind_move').addEventListener('click', ()=> setKindFilter('move'));

  /* ===== جدول الطلبات الرئيسية (تصوير + نقل) ===== */
  function render(){
    const q = ($('#q').value||'').trim().toLowerCase();
    const s = $('#f_status').value||'';
    const fromVal = $('#date_from').value||'';
    const toVal   = $('#date_to').value||'';
    const fromD = fromVal ? new Date(fromVal+"T00:00:00") : null;
    const toD   = toVal   ? new Date(toVal+"T23:59:59") : null;

    let list = [
      ...shootRequests.map(r=>({kind:'shoot', data:r})),
      ...moveRequests.map(r=>({kind:'move', data:r}))
    ];

    if(filterKind){
      list = list.filter(w=> w.kind===filterKind);
    }

    if(s){
      list = list.filter(w=> (w.data.status||'')===s);
    }

    list = list.filter(w=> inRange(w.data.createdAt, fromD, toD));

    if(q){
      list = list.filter(w=>{
        const r = w.data;
        const base = [
          r.id, r.createdBy, r.createdAt, r.status,
          ...(r.rows||[]).flatMap(x=>[
            x.vin||'',x.car||'',x.variant||'',x.extColor||'',x.intColor||'',x.modelYear||'',
            x.note||'',x.fromLocation||'',x.toLocation||''
          ])
        ].join(' ').toLowerCase();
        const typeText = (w.kind==='shoot'?'طلب تصوير':'طلب نقل');
        const extra = typeText + ' ' + (moveRequestLocationSummary(r)||'');
        return (base+' '+extra).toLowerCase().includes(q);
      });
    }

    list.sort((a,b)=> (Number(b.data.id)||0)-(Number(a.data.id)||0) );
    $('#countTotal').textContent = shootRequests.length + moveRequests.length;
    $('#countShown').textContent = list.length;

    const tb = $('#reqTable'); tb.innerHTML='';

    list.forEach((w,i)=>{
      const kind = w.kind;
      const r    = w.data;
      const st   = r.status||'';
      const pillClass =
        st==='تم' || st==='منفّذ'
          ? 'pill-done'
          : (['تحت الإجراء','تم التجهيز','قيد المراجعة'].includes(st) ? 'pill-prog' : 'pill-draft');

      const typeLabel = (kind==='shoot' ? 'طلب تصوير' : 'طلب نقل');
      const placeCol  = (kind==='shoot'
        ? (requestedPlaceOf(r) || '-')
        : moveRequestLocationSummary(r));

      let adminCell = '-';
      if(kind==='shoot'){
        adminCell = r.admin?.received || '-';
      }else{
        const a = r.approvals || {};
        const parts=[];
        if(a.adminApproved)   parts.push(`إداري: ${a.adminApproved}`);
        if(a.financeApproved) parts.push(`مالية: ${a.financeApproved}`);
        adminCell = parts.join(' | ') || (r.status||'-');
      }

      const noteVal = (kind==='shoot' ? (r.admin?.notes||'') : '');

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="center">${i+1}</td>
        <td><span class="mono" style="font-weight:700">#${r.id||'?'}</span></td>
        <td>${typeLabel}</td>
        <td>${r.createdBy||''}</td>
        <td><span class="pill ${pillClass}">${st || 'مسودة'}</span></td>
        <td>${r.createdAt||''}</td>
        <td>${placeCol}</td>
        <td><div class="muted">${adminCell}</div></td>
        <td>
          <input class="js-note" data-kind="${kind}" data-id="${r.id}" type="text" placeholder="ملاحظات…" value="${noteVal.replace(/"/g,'&quot;')}" ${kind==='move'?'readonly':''}>
        </td>
        <td style="display:flex;gap:6px;flex-wrap:wrap">
          ${
            kind==='shoot'
              ? `<button class="btn js-save" data-id="${r.id}"><i class="fa-solid fa-floppy-disk"></i> حفظ</button>
                 <button class="btn secondary js-view" data-id="${r.id}"><i class="fa-regular fa-eye"></i> عرض</button>`
              : `<button class="btn secondary js-view-move" data-id="${r.id}"><i class="fa-regular fa-eye"></i> عرض</button>`
          }
        </td>`;
      tb.appendChild(tr);
    });

    // حفظ ملاحظات طلبات التصوير فقط
    $$('.js-save').forEach(el=> el.addEventListener('click', async e=>{
      const id = Number(e.currentTarget.getAttribute('data-id'));
      const noteEl = document.querySelector(`.js-note[data-kind="shoot"][data-id="${id}"]`);
      shootRequests = shootRequests.map(x=> Number(x.id)===Number(id)
        ? ({...x, admin:{...(x.admin||{}), notes:(noteEl?.value||'')}})
        : x
      );
      await logActivity(
        'تعديل ملاحظات طلب تصوير',
        `تعديل ملاحظات طلب التصوير #${id}`,
        { requestId:id }
      );
      await persistAll();
      showToast('تم حفظ الطلب');
    }));

    // فتح مودال طلب تصوير
    $$('.js-view').forEach(el=> el.addEventListener('click', e=>{
      const id = Number(e.currentTarget.getAttribute('data-id'));
      openReqModal(id);
    }));

    // فتح مودال طلب نقل
    $$('.js-view-move').forEach(el=> el.addEventListener('click', e=>{
      const id = Number(e.currentTarget.getAttribute('data-id'));
      openMoveModal(id);
    }));
  }

  /* ===== تأكيد استلام طلب تصوير ===== */
  async function markReceived(id){
    const user = auth.currentUser;
    const who = displayNameFor(user);
    const stamp = `${now()} — ${who}`;
    shootRequests = shootRequests.map(x=> Number(x.id)===Number(id)
      ? ({...x, status:'تحت الإجراء', admin:{...(x.admin||{}), received: stamp}})
      : x);
    await logActivity(
      'تأكيد استلام طلب تصوير',
      `تأكيد استلام طلب التصوير #${id}`,
      { requestId:id, entityType:'photoshoot_request' }
    );
    await persistAll();
    metrics();
    render();
    showToast('تم تأكيد الاستلام ✅');
  }

  /* ===== مودال طلب التصوير ===== */
  const reqModal = $('#reqModal');
  const reqModalClose = $('#reqModalClose');
  const reqModalTitle = $('#reqModalTitle');
  const reqMeta = $('#reqMeta');
  const reqStatus = $('#reqStatus');
  const reqPlaceRequested = $('#reqPlaceRequested');
  const reqCarsTable = $('#reqCarsTable');
  const btnModalReceived = $('#btnModalReceived');
  const btnReceiveAndMove = $('#btnReceiveAndMove');
  const btnPrintReq = $('#btnPrintReq');

  let modalCurrentId = null;
  let currentMoveId = null;

  function openReqModal(id){
    const r = shootRequests.find(x=> Number(x.id)===Number(id));
    if(!r){ showToast('الطلب غير موجود'); return; }
    modalCurrentId = id;

    const requested = requestedPlaceOf(r) || '';

    reqModalTitle.textContent = `عرض طلب التصوير #${r.id||'?'}`;
    reqMeta.textContent = `المنشئ: ${r.createdBy||'-'} — بتاريخ: ${r.createdAt||'-'}`;
    reqStatus.textContent = `الحالة: ${r.status||'-'}`;

    reqPlaceRequested.value = requested || '';

    reqCarsTable.innerHTML = '';
    const rows = Array.isArray(r.rows) ? r.rows : [];
    rows.forEach((row,i)=>{
      const vin = row.vin || '';
      const normVin = normalizeVin(vin);
      const car = row.car || '';
      const variant = row.variant || '';
      const ext = row.extColor || row.ext || '';
      const intl = row.intColor || row.int || '';
      const model = row.modelYear || row.model || '';
      const loc = currentLocationByVIN(vin) || row.location || '— غير مسجل —';
      const note = row.note || '';

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${i+1}</td>
        <td class="mono js-vin" data-vin-norm="${normVin}">${vin}</td>
        <td>
          <div>${car||'—'}</div>
          <div class="muted">${variant||''}</div>
        </td>
        <td>
          <div><b>الخارجي:</b> ${ext||'—'}</div>
          <div><b>الداخلي:</b> ${intl||'—'}</div>
          <div><b>الموديل:</b> ${model||'—'}</div>
        </td>
        <td class="mono js-current-loc" data-vin-norm="${normVin}">${loc}</td>
        <td class="mono">${requested || ''}</td>
        <td><div class="req-note-print">${note || ''}</div></td>`;
      reqCarsTable.appendChild(tr);
    });

    btnModalReceived.onclick = async ()=>{ if(modalCurrentId!=null) await markReceived(modalCurrentId); };
    btnReceiveAndMove.onclick = async ()=>{ if(modalCurrentId!=null) await receiveAndMoveAndMoveCars(modalCurrentId); };
    btnPrintReq.onclick = ()=>{ window.print(); };

    reqModal.style.display='flex';
    reqModal.setAttribute('aria-hidden','false');
  }

  async function moveAllVINsToRequested(req){
    const requested = requestedPlaceOf(req) || '';
    if(!requested){ showToast('لا يوجد مكان تصوير لهذا الطلب'); return; }

    const rows = Array.isArray(req.rows) ? req.rows : [];
    let moved = 0;

    for(const row of rows){
      const vin = row.vin || '';
      const norm = normalizeVin(vin);
      const recIdx = stock.findIndex(s=> normalizeVin(s.vin)===norm);
      if(recIdx<0) continue;

      const rec = stock[recIdx];
      const from = rec.location || '';
      const to = requested;
      if(!to || from===to) continue;

      await recordMove(rec.vin||norm, rec.car||'', from, to, rec.id, 'نقل إلى مكان التصوير');
      setLocationByVIN(norm, to);
      moved++;
    }

    if(moved>0){
      await logActivity(
        'نقل كل السيارات لمكان التصوير',
        `نقل ${moved} سيارة إلى مكان التصوير "${requested}" للطلب #${req.id}`,
        { requestId:req.id, entityType:'photoshoot_request', entityId:req.id }
      );
      await persistAll();
      openReqModal(req.id);
      showToast(`تم نقل ${moved} سيارة إلى "${requested}"`);
    }else{
      showToast('لا توجد سيارات قابلة للنقل أو كلها في مكان التصوير بالفعل');
    }
  }

  async function receiveAndMoveAndMoveCars(id){
    const idx = shootRequests.findIndex(x=> Number(x.id)===Number(id));
    if(idx<0){ showToast('الطلب غير موجود'); return; }

    const user = auth.currentUser;
    const who = displayNameFor(user);
    const stamp = `${now()} — ${who}`;

    const oldReq = shootRequests[idx];
    const updatedReq = {
      ...oldReq,
      status:'تم التجهيز',
      admin:{...(oldReq.admin||{}), received:stamp}
    };
    shootRequests[idx] = updatedReq;

    await logActivity(
      'تأكيد الاستلام ونقل السيارات',
      `تأكيد الاستلام ونقل كل السيارات لمكان التصوير للطلب #${id}`,
      { requestId:id, entityType:'photoshoot_request', entityId:id }
    );
    await persistAll();
    metrics();
    render();

    await moveAllVINsToRequested(updatedReq);
  }

  reqModalClose.addEventListener('click', ()=>{
    reqModal.style.display='none';
    reqModal.setAttribute('aria-hidden','true');
    modalCurrentId = null;
  });
  reqModal.addEventListener('click',(e)=>{ if(e.target===reqModal){ reqModalClose.click(); } });
  document.addEventListener('keydown',(e)=>{ if(e.key==='Escape' && reqModal.style.display==='flex'){ reqModalClose.click(); } });

  /* ===== مودال طلب النقل ===== */
  const moveModal = $('#moveModal');
  const moveModalClose = $('#moveModalClose');
  const moveModalTitle = $('#moveModalTitle');
  const moveMeta = $('#moveMeta');
  const moveStatus = $('#moveStatus');
  const moveApprovals = $('#moveApprovals');
  const moveRouteSummary = $('#moveRouteSummary');
  const moveCarsTable = $('#moveCarsTable');
  const btnMoveApproveExecute = $('#btnMoveApproveExecute');

  function openMoveModal(id){
    const r = moveRequests.find(x=> Number(x.id)===Number(id));
    if(!r){ showToast('طلب النقل غير موجود'); return; }
    currentMoveId = id;

    moveModalTitle.textContent = `عرض طلب النقل #${r.id||'?'}`;
    moveMeta.textContent = `المنشئ: ${r.createdBy||'-'} — بتاريخ: ${r.createdAt||'-'}`;
    moveStatus.textContent = `الحالة: ${r.status||'-'}`;

    const a = r.approvals || {};
    const adminTxt   = a.adminApproved   ? `✔ إداري: ${a.adminApproved}`   : '✖ لا يوجد موافقة إدارية بعد';
    const financeTxt = a.financeApproved ? `✔ مالية: ${a.financeApproved}` : '✖ لا يوجد موافقة مالية بعد';
    moveApprovals.textContent = adminTxt + ' | ' + financeTxt;

    moveRouteSummary.textContent = moveRequestLocationSummary(r);

    moveCarsTable.innerHTML = '';
    const rows = Array.isArray(r.rows) ? r.rows : [];
    rows.forEach((row,i)=>{
      const vin = row.vin || '';
      const normVin = normalizeVin(vin);
      const car = row.car || '';
      const fromReq = row.fromLocation || '';
      const toReq   = row.toLocation || '';
      const note    = row.note || '';
      const currentLoc = currentLocationByVIN(vin) || fromReq || '— غير مسجل —';

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${i+1}</td>
        <td class="mono" data-vin-norm="${normVin}">${vin}</td>
        <td class="mono js-move-current" data-vin-norm="${normVin}">${currentLoc}</td>
        <td>${fromReq||''}</td>
        <td>${toReq||''}</td>
        <td><div class="req-note-print">${note}</div><div class="muted">${car||''}</div></td>`;
      moveCarsTable.appendChild(tr);
    });

    btnMoveApproveExecute.onclick = async ()=>{ if(currentMoveId!=null) await approveMoveAndExecute(currentMoveId); };

    moveModal.style.display='flex';
    moveModal.setAttribute('aria-hidden','false');
  }

  async function executeMoveRequest(mr){
    const rows = Array.isArray(mr.rows)? mr.rows : [];
    if(!rows.length){ showToast('لا توجد سيارات في طلب النقل'); return 0; }

    let moved = 0;
    for(const row of rows){
      const vin = row.vin || '';
      const norm = normalizeVin(vin);
      const recIdx = stock.findIndex(s=> normalizeVin(s.vin)===norm);
      if(recIdx<0) continue;

      const rec = stock[recIdx];
      const from = rec.location || row.fromLocation || '';
      const to   = row.toLocation || '';
      if(!to || from===to) continue;

      await recordMove(rec.vin||norm, rec.car||'', from, to, rec.id, `تنفيذ طلب نقل #${mr.id}`);
      setLocationByVIN(norm, to);
      moved++;
    }

    if(moved>0){
      await logActivity(
        'تنفيذ طلب نقل',
        `تنفيذ طلب نقل #${mr.id} بعدد ${moved} سيارة`,
        { requestId:mr.id, entityType:'move_request', entityId:mr.id }
      );
      await persistAll();

      // تحديث المواقع داخل المودال
      rows.forEach(row=>{
        const norm = normalizeVin(row.vin||'');
        const cell = moveCarsTable.querySelector(`.js-move-current[data-vin-norm="${norm}"]`);
        if(cell && row.toLocation) cell.textContent = row.toLocation;
      });

      showToast(`تم تنفيذ نقل ${moved} سيارة`);
    }else{
      showToast('لا توجد سيارات قابلة للنقل أو المواقع متطابقة');
    }
    return moved;
  }

  async function approveMoveAndExecute(id){
    const idx = moveRequests.findIndex(x=> Number(x.id)===Number(id));
    if(idx<0){ showToast('طلب النقل غير موجود'); return; }

    const user = auth.currentUser;
    const who = displayNameFor(user);
    const stamp = `${now()} — ${who}`;

    let mr = moveRequests[idx];
    const approvals = {...(mr.approvals||{})};

    if(!approvals.adminApproved){
      approvals.adminApproved = stamp;
    }

    let newStatus = mr.status || '';
    const hasFinance = !!approvals.financeApproved;
    let movedCount = 0;

    // لو في موافقة مالية كمان ننفذ النقل
    if(hasFinance){
      movedCount = await executeMoveRequest(mr);
      if(movedCount>0){
        newStatus = 'منفّذ';
        mr.executedAt = now();
      }
    }else{
      newStatus = 'قيد المراجعة';
    }

    mr = {
      ...mr,
      approvals,
      status:newStatus
    };
    moveRequests[idx] = mr;

    await logActivity(
      'موافقة على طلب نقل',
      hasFinance
        ? `موافقة إدارية وتنفيذ طلب نقل #${id} (عدد السيارات المنقولة: ${movedCount})`
        : `تسجيل موافقة إدارية على طلب نقل #${id} (بانتظار الموافقة المالية)`,
      { requestId:id, entityType:'move_request', entityId:id }
    );

    await persistAll();
    metrics();
    render();

    openMoveModal(id); // إعادة فتح مع التحديث
    if(!hasFinance){
      showToast('تم تسجيل الموافقة الإدارية، بانتظار الموافقة المالية لإتمام النقل');
    }
  }

  moveModalClose.addEventListener('click', ()=>{
    moveModal.style.display='none';
    moveModal.setAttribute('aria-hidden','true');
    currentMoveId = null;
  });
  moveModal.addEventListener('click',(e)=>{ if(e.target===moveModal){ moveModalClose.click(); } });

  /* ===== Auth ===== */
  onAuthStateChanged(auth, async (user)=>{
    if(user){
      $('#authGate').style.display='none';
      $('#app').style.display='block';
      $('#btnSignOut').style.display='inline-block';
      setStatus('ok', `متصل: ${displayNameFor(user)}`);
      await initData(); subscribeLive(); metrics(); render();
      document.body.style.opacity='1';
    }else{
      $('#app').style.display='none';
      $('#authGate').style.display='block';
      $('#btnSignOut').style.display='none';
      setStatus('', 'لم يتم تسجيل الدخول');
      document.body.style.opacity='1';
    }
  });
  $('#btnLogin').addEventListener('click', async ()=>{
    $('#authHint').textContent='';
    try{
      await signInWithEmailAndPassword(auth, $('#email').value.trim(), $('#password').value);
    }catch(e){
      $('#authHint').textContent='بيانات غير صحيحة';
    }
  });
  $('#btnSignOut').addEventListener('click', ()=> signOut(auth));

  /* ===== Firestore ===== */
  async function initData(){
    const snap = await getDoc(STATE_REF);
    if(snap.exists()){
      const d = snap.data()||{};
      shootRequests = Array.isArray(d.shootRequests)? d.shootRequests: [];
      stock         = Array.isArray(d.stock)? d.stock: [];
      moves         = Array.isArray(d.moves)? d.moves: [];
      moveRequests  = Array.isArray(d.moveRequests)? d.moveRequests: [];
    }else{
      shootRequests = [];
      stock = [];
      moves = [];
      moveRequests = [];
    }
  }
  function subscribeLive(){
    onSnapshot(STATE_REF,(snap)=>{
      if(!snap.exists()) return;
      const d = snap.data()||{};
      shootRequests  = Array.isArray(d.shootRequests)? d.shootRequests: shootRequests;
      stock          = Array.isArray(d.stock)? d.stock: stock;
      moves          = Array.isArray(d.moves)? d.moves: moves;
      moveRequests   = Array.isArray(d.moveRequests)? d.moveRequests: moveRequests;

      metrics(); render();

      if(modalCurrentId!=null){
        const r = shootRequests.find(x=> Number(x.id)===Number(modalCurrentId));
        if(r){ reqStatus.textContent = `الحالة: ${r.status||'-'}`; }
      }
      if(currentMoveId!=null){
        const mr = moveRequests.find(x=> Number(x.id)===Number(currentMoveId));
        if(mr){ moveStatus.textContent = `الحالة: ${mr.status||'-'}`; }
      }
    });
  }

  // فلاتر
  $('#q').addEventListener('input', render);
  $('#f_status').addEventListener('change', render);
  $('#date_from').addEventListener('change', render);
  $('#date_to').addEventListener('change', render);
  $('#f_reset').addEventListener('click', ()=>{
    $('#q').value='';
    $('#f_status').value='';
    $('#date_from').value='';
    $('#date_to').value='';
    setKindFilter('');
  });

  document.body.style.opacity='1';
</script>
</body>
</html>
