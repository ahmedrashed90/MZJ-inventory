<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>MZJ â€” Ø¥Ø¯Ø§Ø±Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªØµÙˆÙŠØ± (Ø¹Ø±Ø¶ ØªÙØµÙŠÙ„ÙŠ + Ø§Ø®ØªÙŠØ§Ø± Ù…ÙƒØ§Ù† Ø§Ù„ØªØµÙˆÙŠØ± + ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…/Ø§Ù„ØªØ¬Ù‡ÙŠØ²)</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
<style id="noflash">html{background:#fff8ef}body{opacity:0;transition:opacity .12s ease}</style>
<meta name="color-scheme" content="light"/>
<style>
  :root{
    --brown:#3e2420; --beige:#bc8f74; --cream:#fff8ef; --card:#ffffff; --line:#e7e5e4;
    --text:#1f2937; --muted:#6b7280; --ok:#16a34a; --danger:#ef4444; --info:#0ea5e9;
    --radius:12px; --shadow:0 10px 26px rgba(0,0,0,.06); --table-head:#fafafa;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--cream);color:var(--text);font-family:"Tajawal",system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;line-height:1.75}
  a{text-decoration:none;color:var(--brown)}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}

  /* Header */
  .top{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--line);z-index:10}
  .top .inner{max-width:1240px;margin:auto;padding:12px;display:flex;align-items:center;justify-content:space-between}
  .brand{display:flex;align-items:center;gap:10px}
  .logo{width:36px;height:36px;border-radius:12px;background:linear-gradient(135deg,#3e2420,#bc8f74);display:grid;place-items:center;color:#fff;font-weight:900;box-shadow:var(--shadow)}
  h1{margin:0;font-size:19px;color:var(--brown)}
  .chip{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--line);border-radius:999px;padding:6px 10px;font-size:12px;background:#fff}
  .dot{width:8px;height:8px;border-radius:999px;background:#f59e0b}
  .dot.ok{background:var(--ok)} .dot.err{background:var(--danger)}
  .btn{background:var(--brown);color:#fff;border:none;border-radius:10px;padding:8px 11px;font-weight:800;cursor:pointer;display:inline-flex;gap:8px;align-items:center}
  .btn.secondary{background:#fff;color:var(--brown);border:1px solid var(--line)}
  .btn.ghost{background:transparent;color:var(--brown);border:1px dashed var(--line)}
  .btn.beige{background:var(--beige)}
  .btn.danger{background:var(--danger)}

  /* Layout */
  .wrap{max-width:1240px;margin:14px auto;padding:0 12px}
  .grid{display:grid;gap:12px}
  .cards{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow)}
  .card .inner{padding:14px}
  .metric{display:flex;align-items:center;justify-content:space-between}
  .metric .k{font-size:24px;font-weight:800;color:var(--brown)}
  .metric .l{font-size:12px;color:var(--muted)}
  .metric i{opacity:.7}

  .panel{background:#fff;border:1px solid var(--line);border-radius:12px;box-shadow:var(--shadow)}
  .panel .head{display:flex;align-items:center;justify-content:space-between;padding:12px;border-bottom:1px solid var(--line)}
  .panel .body{padding:0}

  .filters{display:flex;gap:8px;flex-wrap:wrap;padding:10px;background:#fff8ef;border-bottom:1px dashed var(--line)}
  input,select,button,textarea{font-family:inherit}
  input[type="search"], select, input[type="date"], input[type="text"]{height:36px;padding:0 10px;border:1px solid var(--line);border-radius:10px;background:#fff}

  .table-wrap{overflow:auto}
  table{width:100%;border-collapse:separate;border-spacing:0}
  th,td{border-bottom:1px solid var(--line);padding:10px 8px;font-size:13px;vertical-align:top}
  th{position:sticky;top:0;background:var(--table-head);text-align:right;z-index:1}
  tr:hover td{background:#fffdf8}

  .muted{color:var(--muted)}
  .pill{display:inline-flex;gap:8px;align-items:center;padding:3px 9px;border-radius:999px;border:1px solid var(--line);font-size:12px}
  .pill-draft{background:#FEF3C7}
  .pill-prog{background:#DBEAFE}
  .pill-done{background:#DCFCE7}

  /* Modal */
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.38);display:none;align-items:center;justify-content:center;z-index:50}
  .modal{background:#fff;border-radius:16px;box-shadow:0 24px 60px rgba(0,0,0,.35);width:min(1000px,96vw);border:1px solid var(--line)}
  .modal header{display:flex;align-items:center;justify-content:space-between;padding:12px;border-bottom:1px solid var(--line)}
  .modal .content{padding:12px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}

  /* Auth */
  #authGate{display:none;min-height:80vh;place-items:center}
  #authCard{width:min(420px,92vw);padding:18px;border:1px solid var(--line);border-radius:var(--radius);background:#fff;box-shadow:var(--shadow)}

  /* Responsive */
  @media(max-width:1000px){ .cards{grid-template-columns:1fr} }
</style>
</head>
<body>
  <header class="top">
    <div class="inner">
      <div class="brand">
        <div class="logo">MZJ</div>
        <h1>Ø¥Ø¯Ø§Ø±Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªØµÙˆÙŠØ± â€”</h1>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <span class="chip"><span id="connDot" class="dot"></span><span id="connText">Ø¬Ø§Ø±Ù Ø§Ù„Ø§ØªØµØ§Ù„â€¦</span></span>
        <button id="btnSignOut" class="btn secondary" style="display:none">Ø®Ø±ÙˆØ¬</button>
      </div>
    </div>
  </header>

  <main class="wrap grid">
    <!-- Top metrics -->
    <section class="cards">
      <div class="card"><div class="inner metric"><div><div class="l">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div><div id="m_all" class="k">0</div></div><i class="fa-solid fa-list-check"></i></div></div>
      <div class="card"><div class="inner metric"><div><div class="l">ØªØ­Øª Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</div><div id="m_prog" class="k">0</div></div><i class="fa-solid fa-gears"></i></div></div>
      <div class="card"><div class="inner metric"><div><div class="l">ØªÙ…</div><div id="m_done" class="k">0</div></div><i class="fa-regular fa-circle-check"></i></div></div>
    </section>

    <!-- Auth Gate -->
    <section id="authGate" class="panel">
      <div class="head"><strong>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</strong></div>
      <div class="body" style="padding:12px">
        <div style="display:grid;gap:10px;max-width:420px">
          <input id="email" type="text" placeholder="Email">
          <input id="password" type="password" placeholder="Password">
          <div style="display:flex;gap:8px;align-items:center">
            <button id="btnLogin" class="btn">Ø¯Ø®ÙˆÙ„</button>
            <span id="authHint" class="muted"></span>
          </div>
        </div>
      </div>
    </section>

    <!-- Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
    <section id="app" class="panel" style="display:none">
      <div class="head">
        <strong>Ø§Ù„Ø·Ù„Ø¨Ø§Øª (Ø¹Ø±Ø¶ ØªÙØµÙŠÙ„ÙŠ + Ø­ÙØ¸ Ù…ÙƒØ§Ù† Ø§Ù„ØªØµÙˆÙŠØ±)</strong>
        <div class="muted"><span id="countShown">0</span> Ù…Ù† <span id="countTotal">0</span></div>
      </div>
      <div class="body">
        <div class="filters">
          <input id="date_from" type="date" title="Ù…Ù† ØªØ§Ø±ÙŠØ®">
          <input id="date_to" type="date" title="Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®">
          <select id="f_status" title="Ø§Ù„Ø­Ø§Ù„Ø©">
            <option value="">ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
            <option>Ù…Ø³ÙˆØ¯Ø©</option>
            <option>ØªØ­Øª Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</option>
            <option>ØªÙ…</option>
          </select>
          <input id="q" type="search" placeholder="Ø¨Ø­Ø«: VIN / Ø§Ù„Ø³ÙŠØ§Ø±Ø© / Ø§Ù„Ù…ÙƒØ§Ù† / Ù…Ù„Ø§Ø­Ø¸Ø© / Ù…Ù†Ø´Ø¦ Ø§Ù„Ø·Ù„Ø¨">
          <button id="f_reset" class="btn ghost"><i class="fa-solid fa-rotate-right"></i> Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØµÙÙŠØ©</button>
        </div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th class="center">#</th>
                <th>Ø§Ù„Ø·Ù„Ø¨</th>
                <th>Ø§Ù„Ù…Ù†Ø´Ø¦</th>
                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡</th>
                <th>Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</th>
                <th>Ø¬Ø§Ù‡Ø²ÙŠØ© Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</th>
                <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</th>
                <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
              </tr>
            </thead>
            <tbody id="reqTable"></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <!-- Modal: Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨ -->
  <div id="reqModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <header>
        <strong id="reqModalTitle">Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨</strong>
        <div class="row">
          <button class="btn secondary" id="btnModalReceived"><i class="fa-regular fa-handshake"></i> ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</button>
          <button class="btn beige" id="btnModalPrepared"><i class="fa-solid fa-clipboard-check"></i> ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØ¬Ù‡ÙŠØ²</button>
          <button class="btn secondary" id="reqModalClose"><i class="fa-solid fa-xmark"></i> Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
      </header>
      <div class="content">
        <div class="row" style="justify-content:space-between;margin-bottom:6px">
          <div class="subhint" id="reqMeta"></div>
          <div class="subhint" id="reqStatus"></div>
        </div>

        <!-- Ø£Ù…Ø§ÙƒÙ† Ø§Ù„ØªØµÙˆÙŠØ± -->
        <div class="card" style="margin-top:8px">
          <div class="inner">
            <div class="row" style="align-items:flex-end;gap:10px">
              <div style="flex:1">
                <label style="display:block;margin-bottom:6px">Ù…ÙƒØ§Ù† Ø§Ù„ØªØµÙˆÙŠØ± (Ø§Ù„Ù…Ø·Ù„ÙˆØ¨)</label>
                <input id="reqPlaceRequested" type="text" readonly placeholder="â€” ØºÙŠØ± Ù…Ø­Ø¯Ø¯ â€”" />
              </div>
              <div style="flex:1">
                <label style="display:block;margin-bottom:6px">Ø§Ø®ØªÙŠØ§Ø± Ù…ÙƒØ§Ù† Ø§Ù„ØªØµÙˆÙŠØ± (ÙØ¹Ù„ÙŠ)</label>
                <select id="reqPlaceChosen"></select>
              </div>
              <button class="btn" id="btnSaveChosen"><i class="fa-solid fa-floppy-disk"></i> Ø­ÙØ¸ Ø§Ù„Ù…ÙƒØ§Ù†</button>
            </div>
          </div>
        </div>

        <!-- Ø¬Ø¯ÙˆÙ„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª Ø¯Ø§Ø®Ù„ Ø§Ù„Ø·Ù„Ø¨ -->
        <div class="table-wrap" style="margin-top:10px">
          <table>
            <thead>
              <tr>
                <th style="min-width:50px">#</th>
                <th style="min-width:160px">Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ (VIN)</th>
                <th style="min-width:160px">Ø§Ù„Ø³ÙŠØ§Ø±Ø©</th>
                <th>Ø§Ù„Ø¨ÙŠØ§Ù†</th>
                <th>Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ</th>
                <th>Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ</th>
                <th style="min-width:90px">Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„</th>
                <th style="min-width:220px">Ù…ÙƒØ§Ù† Ø§Ù„Ø³ÙŠØ§Ø±Ø© (Ø­Ø§Ù„ÙŠ)</th>
                <th style="min-width:220px">Ù…ÙƒØ§Ù† Ø§Ù„ØªØµÙˆÙŠØ±</th>
                <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
              </tr>
            </thead>
            <tbody id="reqCarsTable"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="chip" style="position:fixed;bottom:18px;right:18px;display:none;background:#111827;color:#fff;border-color:#111827"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

  /* ===== Firebase ===== */
  const firebaseConfig = {
    apiKey: "AIzaSyC614bGqnYf4Q-weTNemzWENTpa8DjGeHw",
    authDomain: "mzj-agenda.firebaseapp.com",
    projectId: "mzj-agenda",
    storageBucket: "mzj-agenda.firebasestorage.app",
    messagingSenderId: "834700407721",
    appId: "1:834700407721:web:75c17665d4f032fd65cab8"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);
  const STATE_REF = doc(db, "mzj_admin_state", "v1");

  /* ===== Admin Name Logic ===== */
  const ADMIN_MAP = { };
  function displayNameFor(user){
    if(!user) return "Ù…Ø³Ø¤ÙˆÙ„";
    if(user.displayName && user.displayName.trim()) return user.displayName.trim();
    const e = (user.email||"").toLowerCase();
    if(ADMIN_MAP[e]) return ADMIN_MAP[e];
    const local = e.split("@")[0]||"";
    return local.replace(/[._-]+/g," ").replace(/\b\w/g, c=>c.toUpperCase());
  }

  /* ===== Ø«Ø§Ø¨Øª Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ù„Ø§Ø®ØªÙŠØ§Ø± Ù…ÙƒØ§Ù† Ø§Ù„ØªØµÙˆÙŠØ± ===== */
  const FIXED_LOCATIONS = [
    "Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ : Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…ØªØ§Ø­","Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ : Ø³ÙŠØ§Ø±Ø§Øª Ø¨Ù‡Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§Øª","Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ : Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…","Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ : Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…",
    "Ø§Ù„ÙˆÙƒØ§Ù„Ø© : Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…ØªØ§Ø­","Ø§Ù„ÙˆÙƒØ§Ù„Ø© : Ø³ÙŠØ§Ø±Ø§Øª Ø¨Ù‡Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§Øª","Ø§Ù„ÙˆÙƒØ§Ù„Ø© : Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…","Ø§Ù„ÙˆÙƒØ§Ù„Ø© : Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…",
    "ÙØ±Ø¹ 1 Ø§Ù„ØµØ§Ù„Ø© : Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…ØªØ§Ø­","ÙØ±Ø¹ 1 Ø§Ù„ØµØ§Ù„Ø© : Ø³ÙŠØ§Ø±Ø§Øª Ø¨Ù‡Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§Øª","ÙØ±Ø¹ 1 Ø§Ù„ØµØ§Ù„Ø© : Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…","ÙØ±Ø¹ 1 Ø§Ù„ØµØ§Ù„Ø© : Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…",
    "ÙØ±Ø¹ 2 Ø§Ù„Ù…Ù„ØªÙ‚Ù‰ : Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…ØªØ§Ø­","ÙØ±Ø¹ 2 Ø§Ù„Ù…Ù„ØªÙ‚Ù‰ : Ø³ÙŠØ§Ø±Ø§Øª Ø¨Ù‡Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§Øª","ÙØ±Ø¹ 2 Ø§Ù„Ù…Ù„ØªÙ‚Ù‰ : Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…","ÙØ±Ø¹ 2 Ø§Ù„Ù…Ù„ØªÙ‚Ù‰ : Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…",
    "ÙØ±Ø¹ 3 Ø§Ù„Ù‚Ø§Ø¯Ø³ÙŠØ© : Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…ØªØ§Ø­","ÙØ±Ø¹ 3 Ø§Ù„Ù‚Ø§Ø¯Ø³ÙŠØ© : Ø³ÙŠØ§Ø±Ø§Øª Ø¨Ù‡Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§Øª","ÙØ±Ø¹ 3 Ø§Ù„Ù‚Ø§Ø¯Ø³ÙŠØ© : Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…","ÙØ±Ø¹ 3 Ø§Ù„Ù‚Ø§Ø¯Ø³ÙŠØ© : Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…"
  ];

  /* ===== State & Helpers ===== */
  let shootRequests = [];
  let stock = []; // Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ù„Ø¹Ø±Ø¶ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠ

  const $ = s=>document.querySelector(s);
  const $$ = s=>Array.from(document.querySelectorAll(s));
  const pad = n=>n<10?'0'+n:n;
  const toast=$('#toast');
  const showToast=(m)=>{ toast.textContent=m; toast.style.display='block'; setTimeout(()=>toast.style.display='none',1400); };
  function now(){ const d=new Date(); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`; }
  function setStatus(mode,txt){ $('#connDot').className='dot '+(mode==='ok'?'ok':mode==='err'?'err':''); $('#connText').textContent=txt; }
  function toDateOnly(s){ if(!s) return null; const d=s.slice(0,10); const [y,m,dd]=d.split('-').map(n=>parseInt(n,10)); if(!y||!m||!dd) return null; return new Date(y,m-1,dd); }
  function inRange(createdAt, from, to){
    if(!from && !to) return true;
    const d = toDateOnly(createdAt); if(!d) return false;
    if(from && d < from) return false;
    if(to   && d > to)   return false;
    return true;
  }
  function normalizeVin(v){ if(!v) return ''; const ar={'Ù ':'0','Ù¡':'1','Ù¢':'2','Ù£':'3','Ù¤':'4','Ù¥':'5','Ù¦':'6','Ù§':'7','Ù¨':'8','Ù©':'9'}; return v.toString().replace(/[Ù -Ù©]/g,d=>ar[d]).toUpperCase().replace(/[\s\-\._]/g,'').trim(); }

  function metrics(){
    $('#m_all').textContent = shootRequests.length;
    $('#m_prog').textContent = shootRequests.filter(x=>x.status==='ØªØ­Øª Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡').length;
    $('#m_done').textContent = shootRequests.filter(x=>x.status==='ØªÙ…').length;
  }

  /* ===== Ø£Ø¯ÙˆØ§Øª Ø­ÙØ¸ Ø¹Ø§Ù…Ø© ===== */
  async function persistRequests(newArray){
    await setDoc(STATE_REF, { shootRequests: newArray, updatedAt: now() }, { merge:true });
  }

  async function markReceived(id){
    const user = auth.currentUser;
    const who = displayNameFor(user);
    const stamp = `${now()} â€” ${who}`;
    const list = shootRequests.map(x=> Number(x.id)===Number(id)
      ? ({...x, status:'ØªØ­Øª Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡', admin:{...(x.admin||{}), received: stamp}})
      : x);
    await persistRequests(list);
    showToast('ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… âœ…');
  }

  async function markPrepared(id){
    const user = auth.currentUser;
    const who = displayNameFor(user);
    const stamp = `${now()} â€” ${who}`;
    const list = shootRequests.map(x=> Number(x.id)===Number(id)
      ? ({...x, status:'ØªÙ…', admin:{...(x.admin||{}), prepared: stamp}})
      : x);
    await persistRequests(list);
    showToast('ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØ¬Ù‡ÙŠØ² âœ…');
  }

  async function saveNotes(id, notes){
    const list = shootRequests.map(x=> Number(x.id)===Number(id)
      ? ({...x, admin:{...(x.admin||{}), notes: notes||''}})
      : x);
    await persistRequests(list);
    showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª ğŸ’¾');
  }

  /* ===== Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ===== */
  function requestedPlaceOf(r){
    return (r?.shoot && (r.shoot.requested || r.shoot.placeRequested)) || r.requestedPlace || r.placeRequested || '';
  }

  function render(){
    const q = ($('#q').value||'').trim().toLowerCase();
    const s = $('#f_status').value||'';
    const fromVal = $('#date_from').value||'';
    const toVal   = $('#date_to').value||'';
    const fromD = fromVal ? new Date(fromVal+"T00:00:00") : null;
    const toD   = toVal   ? new Date(toVal+"T23:59:59") : null;

    let list = [...shootRequests];
    if(s) list = list.filter(r=> (r.status||'')===s );
    list = list.filter(r=> inRange(r.createdAt, fromD, toD) );

    if(q){
      list = list.filter(r=>{
        const hay = [
          r.id, r.createdBy, r.createdAt, r.status,
          requestedPlaceOf(r), (r.admin?.received)||'', (r.admin?.prepared)||'', (r.admin?.notes)||'',
          ...(r.rows||[]).flatMap(x=>[x.vin||'',x.car||'',x.variant||'',x.extColor||'',x.intColor||'',x.modelYear||'',x.note||''])
        ].join(' ').toLowerCase();
        return hay.includes(q);
      });
    }
    list.sort((a,b)=> (b.id||0)-(a.id||0) );
    $('#countTotal').textContent = shootRequests.length;
    $('#countShown').textContent = list.length;

    const tb = $('#reqTable'); tb.innerHTML='';
    list.forEach((r,i)=>{
      const pillClass = r.status==='ØªÙ…' ? 'pill-done' : (r.status==='ØªØ­Øª Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡'?'pill-prog':'pill-draft');
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="center">${i+1}</td>
        <td><span class="mono" style="font-weight:700">#${r.id||'?'}</span></td>
        <td>${r.createdBy||''}</td>
        <td><span class="pill ${pillClass}">${r.status||''}</span></td>
        <td>${r.createdAt||''}</td>
        <td>
          <div class="muted" id="recv_${r.id}">${r.admin?.received||'-'}</div>
          <button class="btn secondary js-recv" data-id="${r.id}"><i class="fa-regular fa-handshake"></i> ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</button>
        </td>
        <td>
          <div class="muted" id="prep_${r.id}">${r.admin?.prepared||'-'}</div>
          <button class="btn beige js-prep" data-id="${r.id}"><i class="fa-solid fa-clipboard-check"></i> ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØ¬Ù‡ÙŠØ²</button>
        </td>
        <td>
          <input class="js-note" data-id="${r.id}" type="text" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øªâ€¦" value="${(r.admin?.notes||'').replace(/"/g,'&quot;')}">
        </td>
        <td style="display:flex;gap:6px;flex-wrap:wrap">
          <button class="btn js-save" data-id="${r.id}"><i class="fa-solid fa-floppy-disk"></i> Ø­ÙØ¸</button>
          <button class="btn secondary js-view" data-id="${r.id}"><i class="fa-regular fa-eye"></i> Ø¹Ø±Ø¶</button>
        </td>`;
      tb.appendChild(tr);
    });

    // bind
    $$('.js-recv').forEach(el=> el.addEventListener('click', async e=>{
      const id = Number(e.currentTarget.getAttribute('data-id'));
      await markReceived(id);
    }));
    $$('.js-prep').forEach(el=> el.addEventListener('click', async e=>{
      const id = Number(e.currentTarget.getAttribute('data-id'));
      await markPrepared(id);
    }));
    $$('.js-save').forEach(el=> el.addEventListener('click', async e=>{
      const id = Number(e.currentTarget.getAttribute('data-id'));
      const noteEl = document.querySelector(`.js-note[data-id="${id}"]`);
      await saveNotes(id, noteEl?.value||'');
    }));
    $$('.js-view').forEach(el=> el.addEventListener('click', e=>{
      const id = Number(e.currentTarget.getAttribute('data-id'));
      openReqModal(id);
    }));
  }

  /* ===== Ø§Ù„Ù…ÙˆØ¯Ø§Ù„: Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨ ===== */
  const reqModal = $('#reqModal');
  const reqModalClose = $('#reqModalClose');
  const reqModalTitle = $('#reqModalTitle');
  const reqMeta = $('#reqMeta');
  const reqStatus = $('#reqStatus');
  const reqPlaceRequested = $('#reqPlaceRequested');
  const reqPlaceChosen = $('#reqPlaceChosen');
  const btnSaveChosen = $('#btnSaveChosen');
  const reqCarsTable = $('#reqCarsTable');
  const btnModalReceived = $('#btnModalReceived');
  const btnModalPrepared = $('#btnModalPrepared');

  function fillShootPlacesSelect(sel){
    sel.innerHTML = `<option value="">â€” Ø§Ø®ØªØ± Ù…ÙƒØ§Ù† Ø§Ù„ØªØµÙˆÙŠØ± â€”</option>` + FIXED_LOCATIONS.map(l=> `<option value="${l}">${l}</option>`).join('');
  }
  fillShootPlacesSelect(reqPlaceChosen);

  function currentLocationByVIN(vin){
    if(!vin) return '';
    const norm = normalizeVin(vin);
    const rec = stock.find(s=> normalizeVin(s.vin)===norm);
    return rec ? (rec.location || '') : '';
  }

  let modalCurrentId = null;

  function openReqModal(id){
    const r = shootRequests.find(x=> Number(x.id)===Number(id));
    if(!r){ showToast('Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'); return; }
    modalCurrentId = id;

    reqModalTitle.textContent = `Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨ #${r.id||'?'}`;
    reqMeta.textContent = `Ø§Ù„Ù…Ù†Ø´Ø¦: ${r.createdBy||'-'} â€” Ø¨ØªØ§Ø±ÙŠØ®: ${r.createdAt||'-'}`;
    reqStatus.textContent = `Ø§Ù„Ø­Ø§Ù„Ø©: ${r.status||'-'}`;

    const requested = requestedPlaceOf(r) || '';
    reqPlaceRequested.value = requested || 'â€” ØºÙŠØ± Ù…Ø­Ø¯Ø¯ â€”';

    fillShootPlacesSelect(reqPlaceChosen);
    const chosen = (r?.shoot && (r.shoot.chosen || r.shoot.placeChosen)) ? (r.shoot.chosen || r.shoot.placeChosen) : '';
    reqPlaceChosen.value = chosen || requested || '';

    // ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª
    reqCarsTable.innerHTML = '';
    const rows = Array.isArray(r.rows) ? r.rows : [];
    rows.forEach((row,i)=>{
      const vin = row.vin || '';
      const car = row.car || '';
      const variant = row.variant || '';
      const ext = row.extColor || row.ext || '';
      const intl = row.intColor || row.int || '';
      const model = row.modelYear || row.model || '';
      const loc = currentLocationByVIN(vin) || row.location || 'â€” ØºÙŠØ± Ù…Ø³Ø¬Ù„ â€”';
      const shootPlace = (row.shootPlace || reqPlaceChosen.value || requested || '');
      const note = row.note || '';

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${i+1}</td>
        <td class="mono">${vin}</td>
        <td>${car}</td>
        <td>${variant}</td>
        <td>${ext}</td>
        <td>${intl}</td>
        <td>${model}</td>
        <td>${loc}</td>
        <td>${shootPlace || 'â€”'}</td>
        <td>${note}</td>`;
      reqCarsTable.appendChild(tr);
    });

    // Ø±Ø¨Ø· Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
    btnSaveChosen.onclick = async ()=>{
      const val = reqPlaceChosen.value || '';
      const newList = shootRequests.map(x=>{
        if(Number(x.id)===Number(id)){
          const prevShoot = x.shoot || {};
          return {...x, shoot: {...prevShoot, chosen: val}};
        }
        return x;
      });
      await persistRequests(newList);
      showToast('ØªÙ… Ø­ÙØ¸ Ù…ÙƒØ§Ù† Ø§Ù„ØªØµÙˆÙŠØ±');
      // Ø­Ø¯Ù‘Ø« Ø§Ù„Ø¹Ù…ÙˆØ¯ "Ù…ÙƒØ§Ù† Ø§Ù„ØªØµÙˆÙŠØ±" Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙÙŠ Ù†ÙØ³ Ø§Ù„Ù„Ø­Ø¸Ø©
      $$('#reqCarsTable tr').forEach((tr, idx)=>{
        const cellShoot = tr.querySelectorAll('td')[8];
        if(cellShoot) cellShoot.textContent = val || 'â€”';
      });
    };

    btnModalReceived.onclick = async ()=>{
      if(modalCurrentId==null) return;
      await markReceived(modalCurrentId);
    };

    btnModalPrepared.onclick = async ()=>{
      if(modalCurrentId==null) return;
      await markPrepared(modalCurrentId);
    };

    reqModal.style.display='flex';
    reqModal.setAttribute('aria-hidden','false');
  }

  reqModalClose.addEventListener('click', ()=>{
    reqModal.style.display='none';
    reqModal.setAttribute('aria-hidden','true');
    modalCurrentId = null;
  });
  reqModal.addEventListener('click',(e)=>{ if(e.target===reqModal){ reqModalClose.click(); } });
  document.addEventListener('keydown',(e)=>{ if(e.key==='Escape' && reqModal.style.display==='flex'){ reqModalClose.click(); } });

  /* ===== Auth ===== */
  onAuthStateChanged(auth, async (user)=>{
    if(user){
      $('#authGate').style.display='none';
      $('#app').style.display='block';
      $('#btnSignOut').style.display='inline-block';
      setStatus('ok', `Ù…ØªØµÙ„: ${displayNameFor(user)}`);
      await initData(); subscribeLive(); metrics(); render();
      document.body.style.opacity='1';
    }else{
      $('#app').style.display='none';
      $('#authGate').style.display='block';
      $('#btnSignOut').style.display='none';
      setStatus('', 'Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
      document.body.style.opacity='1';
    }
  });
  $('#btnLogin').addEventListener('click', async ()=>{
    $('#authHint').textContent='';
    try{
      await signInWithEmailAndPassword(auth, $('#email').value.trim(), $('#password').value);
    }catch(e){
      $('#authHint').textContent='Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©';
    }
  });
  $('#btnSignOut').addEventListener('click', ()=> signOut(auth));

  /* ===== Firestore ===== */
  async function initData(){
    const snap = await getDoc(STATE_REF);
    if(snap.exists()){
      const d = snap.data()||{};
      shootRequests = Array.isArray(d.shootRequests)? d.shootRequests: [];
      stock = Array.isArray(d.stock)? d.stock: []; // Ø§Ø®ØªÙŠØ§Ø±ÙŠ
    }else{
      shootRequests = []; stock = [];
    }
  }
  function subscribeLive(){
    onSnapshot(STATE_REF,(snap)=>{
      if(!snap.exists()) return;
      const d = snap.data()||{};
      shootRequests = Array.isArray(d.shootRequests)? d.shootRequests: shootRequests;
      stock = Array.isArray(d.stock)? d.stock: stock;
      metrics(); render();
      // Ù„Ùˆ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ù…ÙØªÙˆØ­ØŒ Ø­Ø¯Ù‘Ø« Ø´Ø±ÙŠØ· Ø§Ù„Ø­Ø§Ù„Ø©
      if(modalCurrentId!=null){
        const r = shootRequests.find(x=> Number(x.id)===Number(modalCurrentId));
        if(r){
          reqStatus.textContent = `Ø§Ù„Ø­Ø§Ù„Ø©: ${r.status||'-'}`;
          // ØªØ­Ø¯ÙŠØ« Ø­Ù‚ÙˆÙ„ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø© ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ø³ÙŠØªÙ… Ø¹Ø¨Ø± render()
        }
      }
    });
  }

  // ÙÙ„Ø§ØªØ±
  $('#q').addEventListener('input', render);
  $('#f_status').addEventListener('change', render);
  $('#date_from').addEventListener('change', render);
  $('#date_to').addEventListener('change', render);
  $('#f_reset').addEventListener('click', ()=>{ $('#q').value=''; $('#f_status').value=''; $('#date_from').value=''; $('#date_to').value=''; render(); });

  // Ø£Ø®ÙŠØ±Ù‹Ø§
  document.body.style.opacity='1';
</script>
</body>
</html>
