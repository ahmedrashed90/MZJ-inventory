
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MZJ — إدارة الطلبات</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --brown:#3e2420;
      --beige:#bc8f74;
      --cream:#fff8ef;
      --text:#1f2937;
      --muted:#6b7280;
      --border:#e8d6c8;
      --radius:14px;
      --shadow:0 10px 30px rgba(62,36,32,.08);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:"Tajawal",system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:var(--cream);
      color:var(--text);
    }
    a{color:inherit;text-decoration:none}
    .wrap{max-width:1200px;margin:0 auto;padding:18px}
    /* Topbar (workspace) */
    .topbar{
      background:#fff;
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow:var(--shadow);
      padding:14px 16px;
      display:flex;
      gap:14px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .brand{
      display:flex;align-items:center;gap:10px;
    }
    .logo{
      width:42px;height:42px;border-radius:14px;
      background:var(--brown);color:#fff;
      display:grid;place-items:center;
      font-weight:800;letter-spacing:.5px;
    }
    .brand h1{margin:0;font-size:16px;font-weight:800;color:var(--brown);line-height:1.1}
    .brand .sub{font-size:12px;color:var(--muted)}
    .nav{
      display:flex;gap:8px;flex-wrap:wrap;
      margin-top:10px; /* tabs a bit lower */
    }
    .tab{
      padding:10px 14px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      font-weight:700;
      font-size:13px;
      color:var(--brown);
      transition:.15s ease;
      display:inline-flex;align-items:center;gap:8px;
    }
    .tab:hover{background:#f6eee7}
    .tab.active{background:var(--brown);color:#fff;border-color:var(--brown)}
    .statusPills{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .pill{
      border:1px solid var(--border);
      background:#fff;
      border-radius:999px;
      padding:8px 12px;
      font-size:12px;
      color:var(--brown);
      display:flex;gap:8px;align-items:center;
      white-space:nowrap;
    }
    .dot{
      width:8px;height:8px;border-radius:999px;background:#f59e0b;
      box-shadow:0 0 0 4px rgba(245,158,11,.15);
    }
    .dot.ok{background:#16a34a;box-shadow:0 0 0 4px rgba(22,163,74,.12)}
    /* Page tabs */
    .pageCard{
      margin-top:16px;
      background:#fff;
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .pageHead{
      padding:14px 16px;
      display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;
      border-bottom:1px solid var(--border);
      background:linear-gradient(180deg,#fff, #fffaf6);
    }
    .pageTitle{
      display:flex;flex-direction:column;gap:4px;
    }
    .pageTitle .t{font-weight:900;color:var(--brown);font-size:16px}
    .pageTitle .d{font-size:12px;color:var(--muted)}
    .pageTabs{
      display:flex;gap:8px;flex-wrap:wrap;
    }
    .pageTabs button{
      border:1px solid var(--border);
      background:#fff;
      border-radius:999px;
      padding:10px 14px;
      font-weight:800;
      cursor:pointer;
      color:var(--brown);
      transition:.15s ease;
    }
    .pageTabs button.active{background:var(--brown);color:#fff;border-color:var(--brown)}
    .pageBody{padding:16px}
    .toolbar{
      display:flex;gap:10px;align-items:center;flex-wrap:wrap;
      margin-bottom:12px;
    }
    .input, select, textarea{
      font-family:inherit;
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 12px;
      background:#fff;
      outline:none;
    }
    .input{min-width:260px}
    .btn{
      border:1px solid var(--border);
      background:#fff;
      border-radius:12px;
      padding:10px 12px;
      cursor:pointer;
      font-weight:900;
      color:var(--brown);
      transition:.15s ease;
      display:inline-flex;gap:8px;align-items:center;
    }
    .btn.primary{background:var(--brown);color:#fff;border-color:var(--brown)}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    /* Table */
    .tableWrap{
      border:1px solid var(--border);
      border-radius:16px;
      overflow:auto;
      background:#fff;
    }
    table{width:100%;border-collapse:separate;border-spacing:0;min-width:980px}
    thead th{
      position:sticky;top:0;
      background:#fffaf6;
      border-bottom:1px solid var(--border);
      font-size:12px;color:var(--brown);
      padding:10px;
      text-align:center;
      white-space:nowrap;
    }
    tbody td{
      padding:8px;
      border-bottom:1px solid #f0e4da;
      text-align:center;
      vertical-align:middle;
    }
    tbody tr:hover{background:#fffaf6}
    .cell-muted{color:var(--muted);font-size:12px}
    .vinInput{width:150px;text-align:center;font-weight:800;letter-spacing:.5px}
    .mini{font-size:11px;color:var(--muted)}
    .danger{
      border-color:#fecaca;background:#fff1f2;color:#991b1b;
    }
    /* Orders list */
    .ordersGrid{
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
    }
    .orderRow{
      border:1px solid var(--border);
      border-radius:16px;
      background:#fff;
      padding:12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      cursor:pointer;
      transition:.12s ease;
    }
    .orderRow:hover{transform:translateY(-1px);box-shadow:0 10px 26px rgba(62,36,32,.08)}
    .orderMeta{
      display:flex;flex-direction:column;gap:6px;
    }
    .orderMeta .id{font-weight:900;color:var(--brown)}
    .chips{display:flex;gap:6px;flex-wrap:wrap}
    .chip{
      font-size:11px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      color:var(--brown);
      background:#fff;
      white-space:nowrap;
    }
    .chip.kind{background:#fffaf6}
    .progWrap{min-width:220px}
    .bar{
      height:10px;border-radius:999px;background:#f2e7df;border:1px solid var(--border);overflow:hidden
    }
    .bar > div{height:100%;width:0%;background:linear-gradient(90deg,var(--beige),var(--brown))}
    .barLabel{display:flex;justify-content:space-between;font-size:11px;color:var(--muted);margin-top:6px}
    /* Modal */
    .backdrop{
      position:fixed;inset:0;background:rgba(0,0,0,.32);
      display:none;align-items:center;justify-content:center;
      padding:18px;z-index:50;
    }
    .backdrop.show{display:flex}
    .modal{
      width:min(1100px,100%);
      max-height:90vh;
      overflow:auto;
      background:#fff;
      border-radius:18px;
      border:1px solid var(--border);
      box-shadow:0 18px 60px rgba(0,0,0,.25);
    }
    .modalHead{
      padding:14px 16px;
      border-bottom:1px solid var(--border);
      display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;
      background:linear-gradient(180deg,#fff,#fffaf6);
    }
    .modalHead .title{font-weight:900;color:var(--brown)}
    .modalBody{padding:16px;display:grid;gap:14px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:900px){.grid2{grid-template-columns:1fr}}
    .card{
      border:1px solid var(--border);
      border-radius:16px;
      padding:12px;
      background:#fff;
    }
    .card h3{margin:0 0 10px 0;font-size:13px;color:var(--brown)}
    .kv{display:grid;grid-template-columns:160px 1fr;gap:6px 10px;font-size:13px}
    .kv .k{color:var(--muted)}
    .actionsRow{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:flex-start
    }
    .noteBox{width:100%;min-height:42px;resize:vertical}
    .hint{font-size:12px;color:var(--muted);line-height:1.6}
    .footerBtns{
      display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-start
    }
    .hide{display:none !important}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo">MZJ</div>
        <div>
          <h1>محمد بن ذعار العجمي للسيارات</h1>
          <div class="sub">Workspace • إدارة الطلبات (تصوير / نقل)</div>
        </div>
      </div>

      <div class="statusPills">
        <div class="pill"><span class="dot" id="connDot"></span><span id="connText">جارٍ الاتصال…</span></div>
        <div class="pill">الدور: <b id="roleText">—</b></div>
        <div class="pill">المكان: <b id="locText">—</b></div>
      </div>

      <div class="nav" aria-label="Workspace Nav">
        <a class="tab" href="admin.html">الإدارة</a>
        <a class="tab" href="inventory.html">المخزون</a>
        <a class="tab" href="dashboard.html">الداش بورد</a>
        <a class="tab" href="vt.html">نقل السيارات</a>
        <a class="tab active" href="photoshoot-user.html">إدارة الطلبات</a>
        <a class="tab" href="cars.html">كل السيارات</a>
        <a class="tab" href="Activity.html">سجل النشاط</a>
      </div>
    </div>

    <div class="pageCard">
      <div class="pageHead">
        <div class="pageTitle">
          <div class="t">الطلبات</div>
          <div class="d">إنشاء طلب (8 VINs) • إدارة الطلبات • الطلبات المكتملة</div>
        </div>

        <div class="pageTabs">
          <button id="tabManage" class="active" type="button">إدارة الطلبات</button>
          <button id="tabCreate" type="button">إنشاء طلب</button>
          <button id="tabDone" type="button">الطلبات المكتملة</button>
        </div>
      </div>

      <div class="pageBody">
        <!-- Manage -->
        <section id="viewManage">
          <div class="toolbar">
            <select id="filterKind">
              <option value="all">الكل</option>
              <option value="move">طلب نقل</option>
              <option value="shoot">طلب تصوير</option>
            </select>
            <input id="searchText" class="input" placeholder="بحث برقم الطلب أو VIN..." />
            <button id="btnRefresh" class="btn" type="button">تحديث</button>
            <span class="mini">تحديث لحظي بدون Refresh — المودال يتحدث فورًا.</span>
          </div>
          <div id="ordersList" class="ordersGrid"></div>
          <div id="ordersEmpty" class="hint hide">لا توجد طلبات حالياً.</div>
        </section>

        <!-- Create -->
        <section id="viewCreate" class="hide">
          <div class="toolbar">
            <select id="globalType">
              <option value="shoot">طلب تصوير</option>
              <option value="move">طلب نقل</option>
            </select>
            <select id="globalTo">
              <option value="">— اختر المكان —</option>
              <option value="معرض الملتقى">معرض الملتقى</option>
              <option value="الاستديو">الاستديو</option>
              <option value="الصالة الاساسية">الصالة الاساسية</option>
              <option value="صالة القادسية">صالة القادسية</option>
            </select>
            <button id="btnClearCreate" class="btn" type="button">تفريغ</button>
            <button id="btnSubmit" class="btn primary" type="button">إرسال الطلب</button>
            <span class="mini" id="createHint">اكتب VIN فقط… البيانات تنزل تلقائيًا.</span>
          </div>

          <div class="tableWrap">
            <table>
              <thead>
                <tr>
                  <th>#</th>
                  <th>نوع الطلب</th>
                  <th>رقم الهيكل (VIN)</th>
                  <th>السيارة</th>
                  <th>البيان</th>
                  <th>الخارجي</th>
                  <th>الداخلي</th>
                  <th>الموديل</th>
                  <th>مكان السيارة</th>
                  <th id="thTo">مكان التنفيذ</th>
                  <th>ملاحظة</th>
                  <th>حذف</th>
                </tr>
              </thead>
              <tbody id="createBody"></tbody>
            </table>
          </div>
          <div class="hint" style="margin-top:10px">
            • ممنوع إنشاء طلب لهيكل خارج أماكن المستخدم (إلا <b>الادارة</b>).<br/>
            • الطلب يدعم حتى <b>8</b> أرقام هياكل داخل نفس الطلب.
          </div>
        </section>

        <!-- Done -->
        <section id="viewDone" class="hide">
          <div class="toolbar">
            <select id="filterKindDone">
              <option value="all">الكل</option>
              <option value="move">طلب نقل</option>
              <option value="shoot">طلب تصوير</option>
            </select>
            <input id="searchTextDone" class="input" placeholder="بحث برقم الطلب أو VIN..." />
          </div>
          <div id="doneList" class="ordersGrid"></div>
          <div id="doneEmpty" class="hint hide">لا توجد طلبات مكتملة.</div>
        </section>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="backdrop" id="backdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modalHead">
        <div class="title" id="modalTitle">تفاصيل الطلب</div>
        <div class="footerBtns">
          <button class="btn" id="btnCloseModal" type="button">إغلاق</button>
          <button class="btn" id="btnEditRequest" type="button">تعديل الطلب</button>
        </div>
      </div>
      <div class="modalBody">
        <div class="grid2">
          <div class="card">
            <h3>معلومات الطلب</h3>
            <div class="kv">
              <div class="k">رقم الطلب</div><div class="v" id="m_id">—</div>
              <div class="k">النوع</div><div class="v" id="m_kind">—</div>
              <div class="k">المُنشئ</div><div class="v" id="m_creator">—</div>
              <div class="k">تاريخ الإنشاء</div><div class="v" id="m_createdAt">—</div>
              <div class="k">الحالة</div><div class="v" id="m_status">—</div>
            </div>
          </div>
          <div class="card">
            <h3>التقدم</h3>
            <div class="bar"><div id="m_bar"></div></div>
            <div class="barLabel"><span>التقدم العام</span><b id="m_pct">0%</b></div>
            <div class="chips" style="margin-top:10px">
              <span class="chip" id="chip1">1 استلام: 0%</span>
              <span class="chip" id="chip2">2 إرسال: 0%</span>
              <span class="chip" id="chip3">3 استلام: 0%</span>
              <span class="chip" id="chip4">4 إنهاء: 0%</span>
            </div>
            <div class="hint" id="m_permHint" style="margin-top:10px"></div>
          </div>
        </div>

        <div class="card">
          <h3>الهيكلات داخل الطلب</h3>
          <div class="tableWrap">
            <table style="min-width:980px">
              <thead>
                <tr>
                  <th>VIN</th><th>السيارة</th><th>المكان الحالي</th><th>مكان التنفيذ</th><th>ملاحظات</th><th>مرحلة 1</th><th>مرحلة 2</th><th>مرحلة 3</th>
                </tr>
              </thead>
              <tbody id="m_rows"></tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <h3>الإجراءات</h3>
          <div class="actionsRow" style="margin-bottom:10px">
            <button class="btn primary" id="act1" type="button">1 تم استلام الطلب</button>
            <button class="btn primary" id="act2" type="button">2 تم إرسال السيارة</button>
            <button class="btn primary" id="act3" type="button">3 تم استلام السيارة</button>
            <button class="btn danger" id="act4" type="button">4 تم الانتهاء</button>
          </div>
          <textarea id="stageNote" class="noteBox" placeholder="ملاحظة (تتسجل على الإجراء)…"></textarea>
          <div class="hint">ملاحظات كل مرحلة تُسجّل في سجل النشاط + داخل الطلب.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase (Compat for static HTML) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    // === Firebase Config (mzj-agenda) ===
    const firebaseConfig = {
      apiKey: "AIzaSyC614bGqnYf4Q-weTNemzWENTpa8DjGeHw",
      authDomain: "mzj-agenda.firebaseapp.com",
      projectId: "mzj-agenda",
      storageBucket: "mzj-agenda.firebasestorage.app",
      messagingSenderId: "834700407721",
      appId: "1:834700407721:web:75c17665d4f032fd65cab8"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // ====== DOM ======
    const connDot = document.getElementById('connDot');
    const connText = document.getElementById('connText');
    const roleText = document.getElementById('roleText');
    const locText  = document.getElementById('locText');

    const tabManage = document.getElementById('tabManage');
    const tabCreate = document.getElementById('tabCreate');
    const tabDone   = document.getElementById('tabDone');

    const viewManage = document.getElementById('viewManage');
    const viewCreate = document.getElementById('viewCreate');
    const viewDone   = document.getElementById('viewDone');

    const ordersList = document.getElementById('ordersList');
    const ordersEmpty = document.getElementById('ordersEmpty');
    const doneList = document.getElementById('doneList');
    const doneEmpty = document.getElementById('doneEmpty');

    const filterKind = document.getElementById('filterKind');
    const searchText = document.getElementById('searchText');
    const btnRefresh = document.getElementById('btnRefresh');

    const filterKindDone = document.getElementById('filterKindDone');
    const searchTextDone = document.getElementById('searchTextDone');

    const createBody = document.getElementById('createBody');
    const globalType = document.getElementById('globalType');
    const globalTo   = document.getElementById('globalTo');
    const thTo       = document.getElementById('thTo');
    const btnClearCreate = document.getElementById('btnClearCreate');
    const btnSubmit  = document.getElementById('btnSubmit');
    const createHint = document.getElementById('createHint');

    const backdrop = document.getElementById('backdrop');
    const btnCloseModal = document.getElementById('btnCloseModal');
    const btnEditRequest = document.getElementById('btnEditRequest');
    const modalTitle = document.getElementById('modalTitle');

    const m_id = document.getElementById('m_id');
    const m_kind = document.getElementById('m_kind');
    const m_creator = document.getElementById('m_creator');
    const m_createdAt = document.getElementById('m_createdAt');
    const m_status = document.getElementById('m_status');

    const m_bar = document.getElementById('m_bar');
    const m_pct = document.getElementById('m_pct');
    const chip1 = document.getElementById('chip1');
    const chip2 = document.getElementById('chip2');
    const chip3 = document.getElementById('chip3');
    const chip4 = document.getElementById('chip4');
    const m_permHint = document.getElementById('m_permHint');
    const m_rows = document.getElementById('m_rows');

    const stageNote = document.getElementById('stageNote');
    const act1 = document.getElementById('act1');
    const act2 = document.getElementById('act2');
    const act3 = document.getElementById('act3');
    const act4 = document.getElementById('act4');

    // ====== State ======
    let currentUser = null;
    let userProfile = null; // {role, locations[], Name, Email}
    let unsubscribeOrders = null;
    let unsubscribeDone = null;
    let unsubscribeModal = null;
    let openedRequestId = null;
    let openedRequestDoc = null;

    const ALL_PLACES = ["معرض الملتقى","الاستديو","الصالة الاساسية","صالة القادسية"];

    // ====== Helpers ======
    const fmt = (v)=> (v==null || v==="") ? "—" : String(v);
    const nowISO = ()=> new Date().toISOString();
    const safeLower = (s)=> String(s||"").trim().toLowerCase();
    const isAdmin = ()=> userProfile && (userProfile.role === "الادارة" || userProfile.role === "admin" || userProfile.role === "Admin");
    const canTouchLocation = (loc)=> isAdmin() || (userProfile?.locations || []).includes(loc);

    function setConnected(ok, text){
      connDot.classList.toggle('ok', !!ok);
      connText.textContent = text || (ok ? "متصل" : "جارٍ الاتصال…");
    }

    function setActiveTab(which){
      tabManage.classList.toggle('active', which==='manage');
      tabCreate.classList.toggle('active', which==='create');
      tabDone.classList.toggle('active', which==='done');
      viewManage.classList.toggle('hide', which!=='manage');
      viewCreate.classList.toggle('hide', which!=='create');
      viewDone.classList.toggle('hide', which!=='done');
    }

    function escapeHtml(s){
      return String(s||"")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function pct(n){ n = Math.max(0, Math.min(100, Math.round(n))); return n + "%"; }

    function computeProgress(doc){
      const rows = Array.isArray(doc.rows) ? doc.rows : [];
      const total = rows.length || 1;
      const rcv = rows.filter(r => r?.progress?.received).length;
      const snd = rows.filter(r => r?.progress?.sent).length;
      const arv = rows.filter(r => r?.progress?.arrived).length;
      const fin = doc?.progress?.done ? 1 : 0;

      const p1 = (rcv/total)*100;
      const p2 = (snd/total)*100;
      const p3 = (arv/total)*100;
      const p4 = fin*100;
      const overall = (p1+p2+p3+p4)/4;

      return {p1,p2,p3,p4,overall, total, rcv, snd, arv, fin};
    }

    function kindLabel(doc){
      const k = doc.kind || "—";
      if(k==="move") return "نقل";
      if(k==="shoot") return "تصوير";
      if(k==="mixed") return "متعدد";
      return k;
    }

    function getRowDest(row){
      // For shoot: destination = shootLocation. For move: destination = toLocation.
      if(row.type === "shoot") return row.shootLocation || row.toLocation || "";
      if(row.type === "move") return row.toLocation || row.shootLocation || "";
      // fallback:
      return row.toLocation || row.shootLocation || "";
    }

    function getRowSource(row){
      return row.fromLocation || row.location || row.carLocation || "";
    }

    function requestIsDone(doc){
      return (doc.status === "done") || (doc.progress && doc.progress.done === true);
    }

    async function writeActivity(action, details, reqId){
      try{
        if(!currentUser) return;
        await db.collection("mzj_activity_log").add({
          action,
          details,
          requestId: reqId || null,
          ts: firebase.firestore.FieldValue.serverTimestamp(),
          date: new Date().toISOString().slice(0,10),
          user: userProfile?.Name || currentUser.email || "—",
          userEmail: currentUser.email || ""
        });
      }catch(e){
        // silent
      }
    }

    // ====== User Profile ======
    async function loadProfileByEmail(email){
      // collection: user — fields: Email / Name / role / locations
      const q1 = await db.collection("user").where("Email","==", email).limit(1).get();
      if(!q1.empty) return q1.docs[0].data();
      const q2 = await db.collection("user").where("email","==", email).limit(1).get();
      if(!q2.empty) return q2.docs[0].data();
      return null;
    }

    async function initUser(u){
      currentUser = u;
      if(!u){
        userProfile = null;
        roleText.textContent = "—";
        locText.textContent = "—";
        setConnected(false, "غير مسجل");
        detachAllSnapshots();
        renderEmptyState();
        return;
      }
      setConnected(true, "متصل");
      const p = await loadProfileByEmail(u.email);
      userProfile = p || { role:"—", locations:[], Name:u.email, Email:u.email };
      roleText.textContent = userProfile.role || "—";
      // If admin, show "كل الفروع"
      if(isAdmin()){
        locText.textContent = "كل الفروع";
      }else{
        const locs = (userProfile.locations || []).filter(Boolean);
        locText.textContent = locs.length ? locs.join("، ") : "—";
      }
      startOrdersSnapshots();
      buildCreateRows();
      applyGlobalTypeUI();
    }

    function detachAllSnapshots(){
      if(unsubscribeOrders){ unsubscribeOrders(); unsubscribeOrders = null; }
      if(unsubscribeDone){ unsubscribeDone(); unsubscribeDone = null; }
      if(unsubscribeModal){ unsubscribeModal(); unsubscribeModal = null; }
      openedRequestId = null;
      openedRequestDoc = null;
    }

    // ====== Inventory lookup by VIN ======
    async function fetchCarByVin(vin){
      const v = String(vin||"").trim();
      if(!v) return null;
      // cars docs have field 'vin' string (as shown)
      const snap = await db.collection("cars").where("vin","==", v).limit(1).get();
      if(snap.empty) return null;
      return snap.docs[0].data();
    }

    function mapCarToRow(carDoc){
      return {
        car: carDoc.car || "",
        bayan: carDoc.dealer || carDoc.batchName || "",
        exterior: carDoc.extColor || "",
        interior: carDoc.intColor || "",
        model: (carDoc.modelYear ? String(carDoc.modelYear) : ""),
        fromLocation: carDoc.location || "",
      };
    }

    // ====== Create UI ======
    function buildCreateRows(){
      createBody.innerHTML = "";
      for(let i=1;i<=8;i++){
        const tr = document.createElement("tr");
        tr.dataset.idx = String(i);
        tr.innerHTML = `
          <td><b>${i}</b></td>
          <td>
            <select class="typeSel">
              <option value="shoot">تصوير</option>
              <option value="move">نقل</option>
            </select>
          </td>
          <td>
            <input class="input vinInput" placeholder="VIN" />
            <div class="mini cell-muted statusLine"></div>
          </td>
          <td class="cell car">—</td>
          <td class="cell bayan">—</td>
          <td class="cell ext">—</td>
          <td class="cell int">—</td>
          <td class="cell model">—</td>
          <td class="cell from">—</td>
          <td>
            <select class="toSel">
              <option value="">— اختر —</option>
              ${ALL_PLACES.map(p=>`<option value="${escapeHtml(p)}">${escapeHtml(p)}</option>`).join("")}
            </select>
          </td>
          <td><input class="input noteInput" placeholder="اختياري" style="width:180px"/></td>
          <td><button class="btn danger delBtn" type="button">×</button></td>
        `;
        createBody.appendChild(tr);
      }

      // default from global selection
      createBody.querySelectorAll(".typeSel").forEach(sel=>{
        sel.value = globalType.value;
        sel.addEventListener("change", ()=> {
          applyRowTypeRules(sel.closest("tr"));
        });
      });

      createBody.querySelectorAll(".toSel").forEach(sel=>{
        sel.value = globalTo.value || "";
      });

      // VIN input events
      createBody.querySelectorAll(".vinInput").forEach(inp=>{
        inp.addEventListener("keydown", async (e)=>{
          if(e.key === "Enter"){
            e.preventDefault();
            await handleVinFill(inp);
            // move to next row vin input
            const tr = inp.closest("tr");
            const next = tr?.nextElementSibling?.querySelector?.(".vinInput");
            if(next) next.focus();
          }
        });
        inp.addEventListener("blur", async ()=>{
          await handleVinFill(inp);
        });
      });

      // Delete row resets it (does not remove)
      createBody.querySelectorAll(".delBtn").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          resetRow(btn.closest("tr"));
        });
      });

      // apply types
      createBody.querySelectorAll("tr").forEach(tr=>applyRowTypeRules(tr));
    }

    function applyGlobalTypeUI(){
      thTo.textContent = (globalType.value === "move") ? "مكان النقل" : "مكان التصوير";
      createBody.querySelectorAll(".typeSel").forEach(sel=>{
        sel.value = globalType.value;
        applyRowTypeRules(sel.closest("tr"));
      });
      createBody.querySelectorAll(".toSel").forEach(sel=>{
        if(globalTo.value) sel.value = globalTo.value;
      });
    }

    function applyRowTypeRules(tr){
      if(!tr) return;
      const type = tr.querySelector(".typeSel")?.value || "shoot";
      const toSel = tr.querySelector(".toSel");
      if(type === "move"){
        toSel?.setAttribute("data-label","toLocation");
      }else{
        toSel?.setAttribute("data-label","shootLocation");
      }
      // update header if most are same
      const all = Array.from(createBody.querySelectorAll(".typeSel")).map(s=>s.value);
      const uniq = new Set(all);
      if(uniq.size===1){
        thTo.textContent = (all[0]==="move") ? "مكان النقل" : "مكان التصوير";
      }else{
        thTo.textContent = "مكان التنفيذ";
      }
    }

    function resetRow(tr){
      if(!tr) return;
      tr.querySelector(".vinInput").value = "";
      tr.querySelector(".statusLine").textContent = "";
      ["car","bayan","ext","int","model","from"].forEach(cls=>{
        const td = tr.querySelector("."+cls);
        if(td) td.textContent = "—";
      });
      tr.querySelector(".noteInput").value = "";
      tr.querySelector(".toSel").value = globalTo.value || "";
      tr.querySelector(".typeSel").value = globalType.value;
      applyRowTypeRules(tr);
    }

    async function handleVinFill(inputEl){
      const tr = inputEl.closest("tr");
      const statusLine = tr.querySelector(".statusLine");
      const vin = String(inputEl.value||"").trim();
      if(!vin){
        statusLine.textContent = "";
        return;
      }

      statusLine.textContent = "جاري التحميل…";
      try{
        const carDoc = await fetchCarByVin(vin);
        if(!carDoc){
          statusLine.textContent = "VIN غير موجود في cars";
          fillRowFromCar(tr, null);
          return;
        }
        const mapped = mapCarToRow(carDoc);

        // Permission: must be from a location the user can touch (unless admin)
        const fromLoc = mapped.fromLocation || "";
        if(fromLoc && !canTouchLocation(fromLoc)){
          statusLine.textContent = "ممنوع: الهيكل خارج أماكن المستخدم";
          fillRowFromCar(tr, mapped, {locked:true});
          return;
        }

        statusLine.textContent = "تم التحميل";
        fillRowFromCar(tr, mapped);
      }catch(e){
        statusLine.textContent = "خطأ في تحميل VIN";
      }
    }

    function fillRowFromCar(tr, mapped, opts={}){
      const set = (cls,val)=>{ const td=tr.querySelector("."+cls); if(td) td.textContent = val ? String(val) : "—"; };
      if(!mapped){
        ["car","bayan","ext","int","model","from"].forEach(c=>set(c,""));
        return;
      }
      set("car", mapped.car);
      set("bayan", mapped.bayan);
      set("ext", mapped.exterior);
      set("int", mapped.interior);
      set("model", mapped.model);
      set("from", mapped.fromLocation);
    }

    function collectCreatePayload(){
      const rows = [];
      const trs = Array.from(createBody.querySelectorAll("tr"));
      trs.forEach(tr=>{
        const vin = String(tr.querySelector(".vinInput")?.value||"").trim();
        if(!vin) return;
        const status = (tr.querySelector(".statusLine")?.textContent||"").trim();
        if(status.includes("ممنوع") || status.includes("غير موجود")) return;

        const type = tr.querySelector(".typeSel")?.value || "shoot";
        const to = tr.querySelector(".toSel")?.value || "";
        const note = tr.querySelector(".noteInput")?.value || "";

        const row = {
          vin,
          type,
          car: tr.querySelector(".car")?.textContent || "",
          bayan: tr.querySelector(".bayan")?.textContent || "",
          exterior: tr.querySelector(".ext")?.textContent || "",
          interior: tr.querySelector(".int")?.textContent || "",
          model: tr.querySelector(".model")?.textContent || "",
          fromLocation: tr.querySelector(".from")?.textContent || "",
          toLocation: (type==="move") ? to : "",
          shootLocation: (type==="shoot") ? to : "",
          note,
          progress: { received:false, sent:false, arrived:false },
          stageNotes: { s1:"", s2:"", s3:"" }
        };
        rows.push(row);
      });

      return rows;
    }

    async function createRequest(){
      if(!currentUser || !userProfile){
        alert("غير مسجل.");
        return;
      }
      const rows = collectCreatePayload();
      if(rows.length===0){
        alert("اكتب VIN صحيح واحد على الأقل (داخل أماكن المستخدم).");
        return;
      }
      // Ensure all have destination for their type
      const missingTo = rows.find(r => (r.type==="move" && !r.toLocation) || (r.type==="shoot" && !r.shootLocation));
      if(missingTo){
        alert("اختر مكان النقل/التصوير لكل VIN.");
        return;
      }
      // Determine kind: if all same => move/shoot else mixed
      const kinds = Array.from(new Set(rows.map(r=>r.type)));
      const kind = (kinds.length===1) ? kinds[0] : "mixed";

      const payload = {
        kind,
        status: "open",
        canEdit: true,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        createdAtISO: nowISO(),
        createdByEmail: currentUser.email || "",
        createdByName: userProfile.Name || userProfile.name || currentUser.email || "",
        createdByUid: currentUser.uid || "",
        rows,
        progress: { done:false, doneAt:null, doneAtISO:null }
      };

      btnSubmit.disabled = true;
      try{
        const ref = await db.collection("requests").add(payload);
        await writeActivity("إنشاء طلب", `تم إنشاء الطلب ${ref.id} بعدد ${rows.length} VIN`, ref.id);
        alert("تم إنشاء الطلب بنجاح");
        // switch to manage
        setActiveTab('manage');
        // clear create
        buildCreateRows();
      }catch(e){
        console.error(e);
        alert("حدث خطأ أثناء إنشاء الطلب.");
      }finally{
        btnSubmit.disabled = false;
      }
    }

    // ====== Orders list snapshots ======
    function startOrdersSnapshots(){
      // Manage (open)
      if(unsubscribeOrders) unsubscribeOrders();
      unsubscribeOrders = db.collection("requests")
        .orderBy("createdAt", "desc")
        .onSnapshot((snap)=>{
          const docs = [];
          snap.forEach(d=>{
            const data = d.data() || {};
            data.__id = d.id;
            docs.push(data);
          });
          renderOrders(docs);
        }, (err)=>{
          console.error(err);
        });

      // Done list
      if(unsubscribeDone) unsubscribeDone();
      unsubscribeDone = db.collection("requests")
        .orderBy("createdAt", "desc")
        .onSnapshot((snap)=>{
          const docs = [];
          snap.forEach(d=>{
            const data = d.data() || {};
            data.__id = d.id;
            docs.push(data);
          });
          renderDone(docs);
        });
    }

    function renderEmptyState(){
      ordersList.innerHTML = "";
      doneList.innerHTML = "";
      ordersEmpty.classList.remove("hide");
      doneEmpty.classList.remove("hide");
    }

    function renderOrders(allDocs){
      if(!currentUser){ renderEmptyState(); return; }
      // open only
      const filtered = allDocs.filter(d => !requestIsDone(d));

      const kind = filterKind.value;
      const q = safeLower(searchText.value);

      const view = filtered.filter(d=>{
        if(kind !== "all" && d.kind !== kind) return false;
        if(!q) return true;
        const vins = (d.rows||[]).map(r=>r.vin).join(" ");
        return safeLower(d.__id).includes(q) || safeLower(vins).includes(q) || safeLower(d.createdByEmail).includes(q);
      });

      ordersList.innerHTML = "";
      ordersEmpty.classList.toggle("hide", view.length>0);

      view.forEach(d=>{
        const pr = computeProgress(d);
        const row = document.createElement("div");
        row.className = "orderRow";
        row.innerHTML = `
          <div class="orderMeta">
            <div class="id">طلب # ${escapeHtml(d.__id)}</div>
            <div class="chips">
              <span class="chip kind">نوع: ${escapeHtml(kindLabel(d))}</span>
              <span class="chip">VINs: ${(d.rows||[]).length}</span>
              <span class="chip">منشئ: ${escapeHtml(d.createdByName || d.createdByEmail || "—")}</span>
            </div>
          </div>
          <div class="progWrap">
            <div class="bar"><div style="width:${pct(pr.overall)}"></div></div>
            <div class="barLabel"><span>${pct(pr.overall)}</span><span>${escapeHtml(pr.rcv)}/${escapeHtml(pr.total)} استلام</span></div>
          </div>
        `;
        row.addEventListener("click", ()=> openRequest(d.__id));
        ordersList.appendChild(row);
      });
    }

    function renderDone(allDocs){
      if(!currentUser){ return; }
      const filtered = allDocs.filter(d => requestIsDone(d));

      const kind = filterKindDone.value;
      const q = safeLower(searchTextDone.value);

      const view = filtered.filter(d=>{
        if(kind !== "all" && d.kind !== kind) return false;
        if(!q) return true;
        const vins = (d.rows||[]).map(r=>r.vin).join(" ");
        return safeLower(d.__id).includes(q) || safeLower(vins).includes(q) || safeLower(d.createdByEmail).includes(q);
      });

      doneList.innerHTML = "";
      doneEmpty.classList.toggle("hide", view.length>0);

      view.forEach(d=>{
        const pr = computeProgress(d);
        const row = document.createElement("div");
        row.className = "orderRow";
        row.innerHTML = `
          <div class="orderMeta">
            <div class="id">مكتمل # ${escapeHtml(d.__id)}</div>
            <div class="chips">
              <span class="chip kind">نوع: ${escapeHtml(kindLabel(d))}</span>
              <span class="chip">VINs: ${(d.rows||[]).length}</span>
              <span class="chip">تم بواسطة: ${escapeHtml(d.createdByName || d.createdByEmail || "—")}</span>
            </div>
          </div>
          <div class="progWrap">
            <div class="bar"><div style="width:100%"></div></div>
            <div class="barLabel"><span>100%</span><span>مكتمل</span></div>
          </div>
        `;
        row.addEventListener("click", ()=> openRequest(d.__id));
        doneList.appendChild(row);
      });
    }

    // ====== Modal (live doc snapshot) ======
    async function openRequest(id){
      if(!currentUser) return;
      closeModal(); // reset previous
      openedRequestId = id;
      backdrop.classList.add("show");
      modalTitle.textContent = "تفاصيل الطلب #" + id;
      stageNote.value = "";

      // live snapshot
      unsubscribeModal = db.collection("requests").doc(id).onSnapshot((docSnap)=>{
        if(!docSnap.exists){
          closeModal();
          alert("الطلب غير موجود.");
          return;
        }
        openedRequestDoc = docSnap.data() || {};
        openedRequestDoc.__id = id;
        renderModal(openedRequestDoc);
      }, (err)=>{
        console.error(err);
      });
    }

    function closeModal(){
      if(unsubscribeModal){ unsubscribeModal(); unsubscribeModal=null; }
      openedRequestId = null;
      openedRequestDoc = null;
      backdrop.classList.remove("show");
    }

    function renderModal(doc){
      const pr = computeProgress(doc);
      m_id.textContent = doc.__id || "—";
      m_kind.textContent = kindLabel(doc);
      m_creator.textContent = (doc.createdByName || doc.createdByEmail || "—");
      m_createdAt.textContent = doc.createdAtISO || "—";
      m_status.textContent = requestIsDone(doc) ? "مكتمل" : "قيد التنفيذ";

      m_bar.style.width = pct(pr.overall);
      m_pct.textContent = pct(pr.overall);

      chip1.textContent = `1 استلام: ${pct(pr.p1)}`;
      chip2.textContent = `2 إرسال: ${pct(pr.p2)}`;
      chip3.textContent = `3 استلام: ${pct(pr.p3)}`;
      chip4.textContent = `4 إنهاء: ${pct(pr.p4)}`;

      // Edit button visibility
      const canEdit = !!doc.canEdit;
      btnEditRequest.classList.toggle("hide", !canEdit);
      // only creator or admin can edit
      const creatorOk = isAdmin() || safeLower(doc.createdByEmail) === safeLower(currentUser.email);
      btnEditRequest.disabled = !creatorOk;

      // Permission hint
      if(isAdmin()){
        m_permHint.textContent = "أنت (الادارة): تقدر تعمل أي إجراء على أي طلب.";
      }else{
        m_permHint.textContent = "الإجراءات تظهر حسب أماكنك داخل user.locations + (تم الانتهاء فقط لمقدم الطلب).";
      }

      // rows table
      m_rows.innerHTML = "";
      (doc.rows||[]).forEach(r=>{
        const tr = document.createElement("tr");
        const from = fmt(getRowSource(r));
        const dest = fmt(getRowDest(r));
        tr.innerHTML = `
          <td><b>${escapeHtml(r.vin||"")}</b></td>
          <td>${escapeHtml(r.car||"—")}</td>
          <td>${escapeHtml(from)}</td>
          <td>${escapeHtml(dest)}</td>
          <td class="cell-muted">${escapeHtml(r.note||"")}</td>
          <td>${r.progress?.received ? "✅" : "—"}</td>
          <td>${r.progress?.sent ? "✅" : "—"}</td>
          <td>${r.progress?.arrived ? "✅" : "—"}</td>
        `;
        m_rows.appendChild(tr);
      });

      // enable/disable action buttons based on permissions and progress
      // Determine if any applicable rows exist for each step:
      const rows = doc.rows || [];
      const myLocs = userProfile?.locations || [];
      const email = safeLower(currentUser?.email);

      function eligibleStep1(r){ return !r.progress?.received && (isAdmin() || canTouchLocation(getRowSource(r))); }
      function eligibleStep2(r){ return r.progress?.received && !r.progress?.sent && (isAdmin() || canTouchLocation(getRowSource(r))); }
      function eligibleStep3(r){ return r.progress?.sent && !r.progress?.arrived && (isAdmin() || canTouchLocation(getRowDest(r))); }

      const has1 = rows.some(eligibleStep1);
      const has2 = rows.some(eligibleStep2);
      const has3 = rows.some(eligibleStep3);

      act1.disabled = !has1 || requestIsDone(doc);
      act2.disabled = !has2 || requestIsDone(doc);
      act3.disabled = !has3 || requestIsDone(doc);

      // finish: only creator (or admin) and only when steps 1-3 are all complete
      const allArrived = rows.length ? rows.every(r=> r.progress?.received && r.progress?.sent && r.progress?.arrived) : false;
      const canFinish = (isAdmin() || safeLower(doc.createdByEmail) === email) && allArrived && !requestIsDone(doc);
      act4.disabled = !canFinish;

      // canEdit becomes false once any action done
      const anyAction = rows.some(r => r.progress?.received || r.progress?.sent || r.progress?.arrived);
      if(doc.canEdit && anyAction){
        // auto flip canEdit=false (server-side) — but do it once
        db.collection("requests").doc(doc.__id).update({ canEdit:false }).catch(()=>{});
      }
    }

    // ====== Actions ======
    async function updateRequestRows(step){
      if(!openedRequestId || !openedRequestDoc) return;
      const note = String(stageNote.value||"").trim();

      const doc = openedRequestDoc;
      const rows = Array.isArray(doc.rows) ? doc.rows : [];
      const updated = rows.map(r => JSON.parse(JSON.stringify(r))); // deep-ish clone

      let changed = 0;
      const actorName = userProfile?.Name || currentUser?.email || "—";
      const actorEmail = currentUser?.email || "";
      const atISO = nowISO();

      function setNote(r, key, text){
        if(!r.stageNotes) r.stageNotes = { s1:"", s2:"", s3:"" };
        r.stageNotes[key] = text || "";
      }

      for(const r of updated){
        const from = getRowSource(r);
        const dest = getRowDest(r);

        if(step===1){
          if(!r.progress?.received && (isAdmin() || canTouchLocation(from))){
            r.progress = r.progress || {received:false,sent:false,arrived:false};
            r.progress.received = true;
            r.progress.receivedAtISO = atISO;
            r.progress.receivedBy = actorName;
            r.progress.receivedByEmail = actorEmail;
            setNote(r, "s1", note);
            changed++;
          }
        }
        if(step===2){
          if(r.progress?.received && !r.progress?.sent && (isAdmin() || canTouchLocation(from))){
            r.progress.sent = true;
            r.progress.sentAtISO = atISO;
            r.progress.sentBy = actorName;
            r.progress.sentByEmail = actorEmail;
            setNote(r, "s2", note);
            changed++;
          }
        }
        if(step===3){
          if(r.progress?.sent && !r.progress?.arrived && (isAdmin() || canTouchLocation(dest))){
            r.progress.arrived = true;
            r.progress.arrivedAtISO = atISO;
            r.progress.arrivedBy = actorName;
            r.progress.arrivedByEmail = actorEmail;
            setNote(r, "s3", note);
            changed++;
          }
        }
      }

      if(changed===0){
        alert("لا توجد عناصر متاحة لهذا الإجراء حسب صلاحيتك/المكان.");
        return;
      }

      // If any action -> canEdit false
      const patch = { rows: updated, canEdit:false };

      // Finish step is special
      if(step===4){
        // only creator (or admin) and only when all arrived
        const allArrived = updated.length ? updated.every(r=> r.progress?.received && r.progress?.sent && r.progress?.arrived) : false;
        if(!allArrived){
          alert("لا يمكن الإنهاء قبل اكتمال مراحل 1-3 لكل VIN.");
          return;
        }
        const creatorOk = isAdmin() || safeLower(doc.createdByEmail) === safeLower(currentUser.email);
        if(!creatorOk){
          alert("تم الانتهاء لمقدم الطلب فقط.");
          return;
        }
        patch.status = "done";
        patch.progress = { done:true, doneAt: firebase.firestore.FieldValue.serverTimestamp(), doneAtISO: atISO, doneBy: actorName, doneByEmail: actorEmail };
        patch.doneAtISO = atISO;
      }

      // UI lock
      act1.disabled = act2.disabled = act3.disabled = act4.disabled = true;

      try{
        await db.collection("requests").doc(openedRequestId).update(patch);
        const actionText = (step===1) ? "تم استلام الطلب" : (step===2) ? "تم إرسال السيارة" : (step===3) ? "تم استلام السيارة" : "تم الانتهاء";
        await writeActivity(actionText, `طلب ${openedRequestId} — ${actionText} (${changed} VIN) — ملاحظة: ${note||"—"}`, openedRequestId);
        stageNote.value = "";
        // no need to close/reopen: onSnapshot will update modal instantly
      }catch(e){
        console.error(e);
        alert("فشل تنفيذ الإجراء.");
      }
    }

    async function editRequest(){
      // Simple edit mode: allow changing destination + notes ONLY when canEdit=true and no actions.
      if(!openedRequestId || !openedRequestDoc) return;
      const doc = openedRequestDoc;
      if(!doc.canEdit){
        alert("لا يمكن تعديل الطلب بعد بدء الإجراءات.");
        return;
      }
      const creatorOk = isAdmin() || safeLower(doc.createdByEmail) === safeLower(currentUser.email);
      if(!creatorOk){
        alert("تعديل الطلب لمنشئ الطلب فقط.");
        return;
      }

      const newNote = prompt("اكتب ملاحظة عامة للتعديل (اختياري):", "") || "";
      try{
        await db.collection("requests").doc(openedRequestId).update({
          editedAt: firebase.firestore.FieldValue.serverTimestamp(),
          editedAtISO: nowISO(),
          editedByEmail: currentUser.email || "",
          editedByName: userProfile?.Name || currentUser.email || "",
          editNote: newNote
        });
        await writeActivity("تعديل طلب", `تم تعديل الطلب ${openedRequestId}.`, openedRequestId);
        alert("تم تسجيل التعديل.");
      }catch(e){
        alert("فشل التعديل.");
      }
    }

    // ====== Events ======
    tabManage.addEventListener("click", ()=> setActiveTab('manage'));
    tabCreate.addEventListener("click", ()=> setActiveTab('create'));
    tabDone.addEventListener("click", ()=> setActiveTab('done'));

    filterKind.addEventListener("change", ()=> {});
    searchText.addEventListener("input", ()=> {});
    btnRefresh.addEventListener("click", ()=> {
      // force re-render from last snapshots; snapshots already live
      // Just trigger by resetting input value (no-op)
      searchText.dispatchEvent(new Event("input"));
    });

    filterKindDone.addEventListener("change", ()=> {});
    searchTextDone.addEventListener("input", ()=> {});

    globalType.addEventListener("change", ()=>{
      applyGlobalTypeUI();
      globalTo.value = "";
    });
    globalTo.addEventListener("change", ()=>{
      // propagate to empty rows only
      createBody.querySelectorAll("tr").forEach(tr=>{
        const vin = String(tr.querySelector(".vinInput")?.value||"").trim();
        if(!vin) tr.querySelector(".toSel").value = globalTo.value || "";
      });
    });

    btnClearCreate.addEventListener("click", ()=> buildCreateRows());
    btnSubmit.addEventListener("click", createRequest);

    btnCloseModal.addEventListener("click", closeModal);
    backdrop.addEventListener("click", (e)=>{ if(e.target === backdrop) closeModal(); });
    document.addEventListener("keydown", (e)=>{ if(e.key === "Escape" && backdrop.classList.contains("show")) closeModal(); });

    act1.addEventListener("click", ()=> updateRequestRows(1));
    act2.addEventListener("click", ()=> updateRequestRows(2));
    act3.addEventListener("click", ()=> updateRequestRows(3));
    act4.addEventListener("click", ()=> updateRequestRows(4));
    btnEditRequest.addEventListener("click", editRequest);

    // Re-render lists on filters/search changes
    function wireRerender(){
      // We don't store last docs globally; simplest: onSnapshot already calls render.
      // So we just force by triggering snapshot callbacks: not possible.
      // Instead: rely on DOM filtering in render by reading current inputs; snapshots call render with fresh docs.
      // We'll just set inputs and call nothing.
    }
    filterKind.addEventListener("change", wireRerender);
    searchText.addEventListener("input", wireRerender);
    filterKindDone.addEventListener("change", wireRerender);
    searchTextDone.addEventListener("input", wireRerender);

    // ====== Auth ======
    auth.onAuthStateChanged(async (u)=>{
      try{
        await initUser(u);
      }catch(e){
        console.error(e);
        setConnected(false, "خطأ");
      }
    });

    // Initial tab: Manage
    setActiveTab('manage');
  </script>
</body>
</html>
