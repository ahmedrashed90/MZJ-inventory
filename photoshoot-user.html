


<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MZJ إدارة الطلبات</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
  <meta name="color-scheme" content="light"/>
  <style>
    :root{
      --brown:#3e2420; --beige:#bc8f74; --cream:#fff8ef; --card:#ffffff; --line:#e7e5e4;
      --text:#1f2937; --muted:#6b7280; --ok:#16a34a; --danger:#ef4444; --info:#0ea5e9;
      --radius:12px; --shadow:0 10px 26px rgba(0,0,0,.06); --table-head:#fafafa;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:var(--cream);
      color:var(--text);
      font-family:"Tajawal",system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
      line-height:1.7;
    }
    a{text-decoration:none;color:var(--brown)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}

    /* Header */
    .top{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--line);z-index:10}
    .top .inner{
      max-width:1200px;margin:0 auto;
      display:flex;align-items:center;justify-content:space-between;
      padding:10px 16px;
    }
    .top-left{display:flex;align-items:center;gap:10px}
    .logo{
      width:36px;height:36px;border-radius:50%;
      display:flex;align-items:center;justify-content:center;
      background:radial-gradient(circle at 30% 20%,#f97316,#3e2723);
      box-shadow:0 0 0 4px rgba(188,143,116,.3);
      color:#fff;
    }
    .logo i{font-size:18px}
    .brand-title{font-weight:800;font-size:16px;margin:0;color:var(--brown)}
    .brand-sub{margin:0;font-size:12px;color:var(--muted)}
    .top-right{display:flex;align-items:center;gap:10px}
    .chip{
      font-size:11px;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#fdfaf5;
      display:inline-flex;align-items:center;gap:6px;
    }
    .chip i{font-size:11px;color:var(--brown)}
    .user-info{font-size:13px;color:var(--muted)}
    .btn{
      border-radius:999px;
      border:1px solid transparent;
      background:var(--brown);
      color:#fff;
      font-family:inherit;
      font-size:13px;
      padding:6px 12px;
      display:inline-flex;align-items:center;gap:6px;
      cursor:pointer;
      box-shadow:0 6px 18px rgba(62,36,32,.22);
    }
    .btn.ghost{
      background:transparent;
      color:var(--brown);
      border-color:var(--line);
      box-shadow:none;
    }
    .btn.secondary{
      background:#fdf7f2;
      color:var(--brown);
      border-color:var(--beige);
      box-shadow:none;
    }
    .btn.beige{
      background:var(--beige);
      color:#fff;
      border-color:var(--beige);
    }
    .btn.primary{
      background:var(--brown);
      color:#fff;
      border-color:var(--brown);
    }
    .btn:disabled{
      opacity:.7;
      cursor:default;
      box-shadow:none;
    }
    .btn-mini{font-size:11px;padding:4px 8px;box-shadow:none}
    .btn i{font-size:12px}

    /* Tabs Bar */
    .tabs{
      max-width:1200px;margin:0 auto;
      display:flex;align-items:center;gap:8px;
      padding:0 16px 10px;
      border-bottom:1px solid var(--line);
      background:#fff;
    }
    .tabs a{
      font-size:13px;
      padding:4px 10px 7px;
      border-radius:999px;
      border:1px solid transparent;
      color:var(--muted);
    }
    .tabs a.active{
      background:#f2ebe3;
      border-color:var(--beige);
      color:var(--brown);
      font-weight:700;
    }

    /* Layout */
    .wrap{
      max-width:1200px;
      margin:18px auto 40px;
      padding:0 16px 40px;
      display:flex;
      flex-direction:column;
      gap:16px;
      align-items:stretch;
    }
    @media (max-width:960px){
      .wrap{padding:0 10px 32px;}
    }

    /* Cards */
    .cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(210px,1fr));gap:10px;}
    .card{
      background:var(--card);
      border-radius:var(--radius);
      border:1px solid var(--line);
      box-shadow:var(--shadow);
    }
    .card .inner{padding:14px}
    .card-title{
      display:flex;align-items:center;justify-content:space-between;
      gap:6px;
    }
    .card-title strong{font-size:13px;color:var(--brown)}
    .card-title span{font-size:11px;color:var(--muted)}
    .stat-main{
      display:flex;align-items:baseline;gap:6px;
      margin-top:8px;
    }
    .stat-main .num{font-size:20px;font-weight:800;color:var(--brown)}
    .stat-main .label{font-size:12px;color:var(--muted)}
    .stat-sub{margin-top:4px;font-size:11px;color:var(--muted)}

    /* Status legend */
    .legend{
      display:flex;flex-wrap:wrap;gap:6px;
      margin-top:10px;font-size:11px;color:var(--muted);
    }
    .pill{
      display:inline-flex;align-items:center;gap:5px;
      padding:3px 8px;
      border-radius:999px;
      border:1px dashed var(--line);
      background:#fdfaf5;
    }
    .pill-dot{
      width:8px;height:8px;border-radius:50%;
    }
    .pill-dot.prog{background:#fbbf24}
    .pill-dot.done{background:#22c55e}
    .pill-dot.draft{background:#9ca3af}

    /* Panels */
    .panel{
      background:var(--card);
      border-radius:var(--radius);
      border:1px solid var(--line);
      box-shadow:var(--shadow);
    }
    .panel .head{
      padding:10px 14px;
      border-bottom:1px solid var(--line);
      display:flex;align-items:center;justify-content:space-between;
      gap:8px;
    }
    .panel .head strong{font-size:14px;color:var(--brown)}
    .panel .head .muted{font-size:11px;color:var(--muted)}
    .panel .body{padding:12px 14px 14px}

    .muted{color:var(--muted)}

    /* Filters */
    .filters{
      display:flex;align-items:flex-end;justify-content:space-between;
      gap:10px;flex-wrap:wrap;margin-bottom:10px;
    }
    .filters-left,.filters-right{
      display:flex;align-items:flex-end;gap:8px;
      flex-wrap:wrap;
    }
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:2px}
    input,select,textarea{
      font-family:inherit;
      font-size:13px;
      border-radius:999px;
      border:1px solid var(--line);
      padding:5px 10px;
      background:#fff;
      color:var(--text);
    }
    textarea{
      border-radius:10px;
      min-height:80px;
      resize:vertical;
    }
    input[type="date"]{padding-inline-start:10px;padding-inline-end:10px}
    input[type="search"]{min-width:200px}

    /* Table */
    .table-wrap{border-radius:10px;border:1px solid var(--line);overflow:hidden;background:#fff;}
    table{border-collapse:collapse;width:100%;table-layout:fixed;font-size:13px;}
    thead{background:var(--table-head);}
    th,td{padding:4px 6px;border-bottom:1px solid #f3f0eb;text-align:right;vertical-align:middle;}
    th{font-weight:700;font-size:11px;color:#4b5563}
    tbody tr:nth-child(even){background:#fdfaf8}
    tbody tr:hover{background:#f3eee7;cursor:pointer}
    .center{text-align:center}
    .badge{
      display:inline-flex;align-items:center;justify-content:center;
      font-size:11px;border-radius:999px;padding:2px 8px;
    }
    .badge.draft{background:#f3f4f6;color:#4b5563}
    .badge.prog{background:#fef3c7;color:#92400e}
    .badge.done{background:#dcfce7;color:#166534}
    .badge.move{background:#e0f2fe;color:#075985}
    .badge.shoot{background:#fae8ff;color:#86198f}

    .actions{display:flex;flex-wrap:wrap;gap:4px;}
    .actions .btn-mini{border-radius:8px;font-size:10px;padding:3px 7px}

    /* Status dot in header */
    .status{
      display:flex;align-items:center;gap:6px;
      font-size:11px;color:var(--muted);
    }
    .dot{
      width:9px;height:9px;border-radius:50%;
      background:#d1d5db;
    }
    .dot.ok{background:#22c55e}
    .dot.err{background:#ef4444}

    /* Modal */
    .modal-backdrop{
      position:fixed;inset:0;
      background:rgba(15,23,42,.4);
      display:none;align-items:center;justify-content:center;
      z-index:50;
    }
    .modal-backdrop.show{display:flex}
    .modal{
      background:#fff;
      border-radius:16px;
      box-shadow:0 22px 60px rgba(0,0,0,.3);
      max-width:960px;
      width:100%;
      max-height:84vh;
      display:flex;flex-direction:column;
      overflow:hidden;
    }
    .modal-header{
      padding:10px 16px;
      border-bottom:1px solid var(--line);
      display:flex;align-items:center;justify-content:space-between;gap:8px;
    }
    .modal-title{font-size:14px;font-weight:700;color:var(--brown)}
    .modal-body{
      padding:10px 16px 12px;
      overflow:auto;
    }
    .modal-footer{
      padding:8px 16px 12px;
      border-top:1px solid var(--line);
      display:flex;justify-content:flex-end;gap:6px;
    }
    .modal-close{
      border:none;background:transparent;cursor:pointer;
      color:var(--muted);
    }

    .section-title{
      font-size:13px;font-weight:700;color:var(--brown);
      margin-bottom:4px;
    }
    .subhint{
      font-size:11px;color:var(--muted);margin-bottom:6px;
    }
    .stack{display:flex;flex-direction:column;gap:6px;margin-top:8px}
    .note-box{
      background:#f9fafb;
      border-radius:10px;
      border:1px dashed var(--line);
      padding:6px 8px;
      font-size:11px;
    }
    .note-box strong{color:var(--brown)}

    .toast{
      position:fixed;
      left:50%;
      bottom:20px;
      transform:translateX(-50%);
      background:#111827;
      color:#f9fafb;
      padding:6px 12px;
      border-radius:999px;
      font-size:12px;
      display:none;
      z-index:60;
      box-shadow:0 12px 30px rgba(0,0,0,.4);
    }

    /* inner tabs */
    .inner-tabs{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-bottom:12px;
    }
    .inner-tab{
      border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      padding:6px 12px;
      font-size:13px;
      font-weight:700;
      cursor:pointer;
    }
    .inner-tab.active{
      background:var(--brown);
      color:#fff;
      border-color:var(--brown);
    }
    .tab-pane{display:none}
    .tab-pane.active{display:block}

    .small-input{
      height:32px;
      padding:6px 9px;
      border-radius:10px;
      font-size:13px;
    }

    /* ===== Process Timeline ===== */
    .process-timeline{
      padding:8px 16px 10px;
      border-bottom:1px solid var(--line);
      background:#fff8ef;
    }
    .process-timeline-title{
      font-size:12px;
      font-weight:700;
      color:var(--brown);
      margin-bottom:2px;
      text-align:right;
    }
    .process-timeline-sub{
      font-size:11px;
      color:var(--muted);
      margin-bottom:6px;
      text-align:right;
    }
    .pt-track{
      display:flex;
      justify-content:space-between;
      gap:8px;
      position:relative;
      padding:4px 2px 0;
    }
    .pt-track::before{
      content:"";
      position:absolute;
      inset-inline:14px;
      top:17px;
      height:2px;
      background:#e5e7eb;
      z-index:0;
    }
    .pt-step{
      position:relative;
      flex:1;
      text-align:center;
      padding-inline:4px;
    }
    .pt-circle{
      width:26px;
      height:26px;
      margin:0 auto 4px;
      border-radius:999px;
      display:flex;
      align-items:center;
      justify-content:center;
      border:2px solid #d1d5db;
      background:#fff;
      font-size:11px;
      font-weight:700;
      color:#6b7280;
      position:relative;
      z-index:1;
    }
    .pt-label{
      font-size:11px;
      font-weight:700;
      color:var(--brown);
      white-space:nowrap;
    }
    .pt-desc{
      font-size:10px;
      color:var(--muted);
      margin-top:2px;
      min-height:12px;
    }
    .pt-step.done .pt-circle{
      border-color:var(--ok);
      background:#dcfce7;
      color:#166534;
    }
    .pt-step.active .pt-circle{
      border-color:var(--beige);
      background:#fef3c7;
      color:#92400e;
    }
    .pt-step.upcoming .pt-circle{
      opacity:0.6;
    }
    .pt-step.done ~ .pt-step .pt-circle{
      /* keep upcoming style */
    }

    @media (max-width:720px){
      .pt-label{font-size:10px}
      .pt-desc{display:none}
    }

  
    .step-num {
      background: #3e2420;
      color: #fff;
      font-size: 10px;
      font-weight: 700;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin-left: 4px;
    }


    /* ===== Progress Bars ===== */
    .progress-wrap{margin-top:10px}
    .progress-row{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:6px}
    .progress-label{font-size:11px;color:var(--brown);font-weight:800;white-space:nowrap}
    .progress-pct{font-size:11px;color:var(--muted);white-space:nowrap}
    .bar{width:100%;height:10px;border-radius:999px;background:#e5e7eb;overflow:hidden}
    .bar-fill{height:100%;width:0%;background:var(--beige);border-radius:999px;transition:width .25s ease}
    .phase-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:10px}
    .phase-card{border:1px solid var(--line);background:#fff;border-radius:12px;padding:8px}
    .phase-title{font-size:11px;font-weight:800;color:var(--brown);margin:0 0 6px}
    .phase-meta{display:flex;align-items:center;justify-content:space-between;font-size:10px;color:var(--muted);margin-top:6px}
    @media (max-width:720px){ .phase-grid{grid-template-columns:repeat(2,1fr);} }

  </style>
</head>
<body>
<div class="top">
  <div class="inner">
    <div class="top-left">
      <div class="logo"><i class="fa-solid fa-star"></i></div>
      <div>
        <p class="brand-title">MZJ إدارة طلبات التصوير والنقل</p>
        <p class="brand-sub">مسار واحد لمتابعة جميع الطلبات من الإنشاء حتى التنفيذ</p>
      </div>
    </div>
    <div class="top-right">
      <span class="chip">
        <i class="fa-solid fa-circle-nodes"></i>
        <span class="status">
          <span id="connDot" class="dot"></span>
          <span id="connText">جارٍ الاتصال…</span>
        </span>
      </span>
      <span class="user-info" id="userLabel">غير مسجل</span>
      <button class="btn ghost btn-mini" id="btnSignOut" style="display:none">
        <i class="fa-solid fa-arrow-right-from-bracket"></i> تسجيل خروج
      </button>
    </div>
  </div>
</div>

<div class="tabs">
  <a class="tab" href="admin.html">الإدارة</a>
  <a class="tab" href="inventory.html">المخزون</a>
  <a class="tab" href="dashboard.html">الداش بورد</a>
  <a class="tab" href="vt.html">نقل السيارات</a>
  <a class="tab active" href="photoshoot-user.html">إدارة الطلبات</a>
  <a class="tab" href="cars.html">كل السيارات</a>
  <a class="tab" href="Activity.html">سجل النشاط</a>
</div>

<main class="wrap">
  <section class="cards">
    <article class="card">
      <div class="inner">
        <div class="card-title">
          <strong>إجمالي الطلبات</strong>
          <span>كل طلبات التصوير والنقل</span>
        </div>
        <div class="stat-main">
          <span class="num" id="stat_all">0</span>
          <span class="label">طلب</span>
        </div>
        <div class="stat-sub">
          آخر تحديث: <span id="stat_updated">—</span>
        </div>
      </div>
    </article>

    <article class="card">
      <div class="inner">
        <div class="card-title">
          <strong>تحت الإجراء</strong>
          <span>تصوير وتجهيز + نقل قيد المراجعة</span>
        </div>
        <div class="stat-main">
          <span class="num" id="stat_prog">0</span>
          <span class="label">طلب</span>
        </div>
        <div class="stat-sub">
          يشمل الحالات: تحت الإجراء، تم التجهيز، قيد المراجعة
        </div>
      </div>
    </article>

    <article class="card">
      <div class="inner">
        <div class="card-title">
          <strong>تم التنفيذ</strong>
          <span>تصوير مكتمل + نقل منفّذ</span>
        </div>
        <div class="stat-main">
          <span class="num" id="stat_done">0</span>
          <span class="label">طلب</span>
        </div>
        <div class="stat-sub">
          يشمل الحالات: تم، منفّذ
        </div>
      </div>
    </article>
</section>

  <!-- بوابة الدخول -->
  <section id="authGate" class="panel" style="display:block">
    <div class="head">
      <strong>تسجيل الدخول لإدارة الطلبات</strong>
      <div class="muted">مطلوب صلاحية للوصول لطلبات التصوير والنقل</div>
    </div>
    <div class="body">
      <p class="muted" style="margin-top:0;margin-bottom:8px">
        أدخل البريد الإلكتروني وكلمة المرور المستخدمة في لوحة الإدارة.
      </p>
      <form id="loginForm">
        <div style="display:flex;flex-direction:column;gap:8px;max-width:320px">
          <div>
            <label for="email">البريد الإلكتروني</label>
            <input id="email" type="email" required autocomplete="username">
          </div>
          <div>
            <label for="password">كلمة المرور</label>
            <input id="password" type="password" required autocomplete="current-password">
          </div>
          <button id="btnSignIn" class="btn" type="submit">
            <i class="fa-solid fa-right-to-bracket"></i>
            تسجيل الدخول
          </button>
        </div>
      </form>
    </div>
  </section>

  <!-- التطبيق -->
  <section id="app" class="panel" style="display:none">
    <div class="head">
      <strong>الطلبات (تصوير + نقل)</strong>
      <div class="muted"><span id="countShown">0</span> من <span id="countTotal">0</span></div>
    </div>
    <div class="body">

      <div class="inner-tabs">
        <button type="button" class="inner-tab active" data-tab="tab-create" data-mode="create">إنشاء طلب</button>
        <button type="button" class="inner-tab" data-tab="tab-manage" data-mode="manage">إدارة الطلبات</button>
        <button type="button" class="inner-tab" data-tab="tab-manage" data-mode="completed">الطلبات المكتملة</button>
      </div>

      <!-- إنشاء طلب -->
      <div id="tab-create" class="tab-pane active">
        <div class="card">
          <div class="inner">
            <div style="margin-bottom:8px;display:flex;gap:8px;flex-wrap:wrap">
              <div style="flex:1;min-width:220px">
                <label for="reqBy">مقدّم الطلب</label>
                <input id="reqBy" class="small-input" readonly title="يتم تحديده تلقائيًا من المستخدم الحالي">
              </div>
            </div>

            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th class="center">#</th>
                    <th>نوع الطلب</th>
                    <th>رقم الهيكل (VIN)</th>
                    <th>السيارة</th>
                    <th>البيان</th>
                    <th>الخارجي</th>
                    <th>الداخلي</th>
                    <th>الموديل</th>
                    <th>مكان السيارة</th>
                    <th id="placeHeader">مكان التصوير / النقل</th>
                    <th>ملاحظة</th>
                    <th class="center">حذف</th>
                  </tr>
                </thead>
                <tbody id="reqRows"></tbody>
              </table>
            </div>

            <div style="margin-top:12px;display:flex;flex-wrap:wrap;gap:8px">
              <button type="button" class="btn beige" id="btnSubmit"><i class="fa-solid fa-paper-plane"></i> إرسال الطلب</button>
              <button type="button" class="btn ghost" id="btnClear"><i class="fa-solid fa-rotate-right"></i> تفريغ</button>
            </div>

            <p class="muted" style="margin-top:8px;font-size:12px">
              اختر <b>نوع الطلب</b> لكل صف (تصوير أو نقل)، اكتب رقم الهيكل، وسيتم جلب بيانات السيارة تلقائيًا من المخزون إن توفرت.
            </p>
          </div>
        </div>
      </div>

      <!-- إدارة / مكتملة -->
      <div id="tab-manage" class="tab-pane">
        <div class="filters">
          <div class="filters-left">
            <div>
              <label>من تاريخ</label>
              <input id="date_from" type="date">
            </div>
            <div>
              <label>إلى تاريخ</label>
              <input id="date_to" type="date">
            </div>
            <div>
              <label>الحالة</label>
              <select id="f_status">
                <option value="">كل الحالات</option>
                                <option>تحت الإجراء</option>
                <option>تم التجهيز</option>
                <option>قيد المراجعة</option>
                <option>تم</option>
                <option>منفّذ</option>
              </select>
            </div>
            <div>
              <label>بحث</label>
              <input id="q" type="search" placeholder="بحث: نوع الطلب / VIN / المكان / المنشئ / ملاحظة">
            </div>
            <button id="f_reset" class="btn ghost"><i class="fa-solid fa-rotate-right"></i> إعادة التصفية</button>
          </div>
          <div class="filters-right">
            <button type="button" id="kind_all"   class="btn secondary btn-mini filter-kind active-kind">كل الأنواع</button>
            <button type="button" id="kind_shoot" class="btn secondary btn-mini filter-kind">طلبات التصوير</button>
            <button type="button" id="kind_move"  class="btn secondary btn-mini filter-kind">طلبات النقل</button>
          </div>
        </div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th class="center">#</th>
                <th style="min-width:80px">الطلب</th>
                <th style="min-width:110px">نوع الطلب</th>
                <th style="min-width:110px">المنشئ</th>
                <th style="min-width:90px">الحالة</th>
                <th style="min-width:130px">تاريخ الإنشاء</th>
                <th style="min-width:160px">المكان / من → إلى</th>
                <th style="min-width:160px">استلام / موافقات</th>
              </tr>
            </thead>
            <tbody id="reqTable"></tbody>
          </table>
        </div>
      </div>

    </div>
  </section>
</main>

<!-- Modal: تفاصيل طلب التصوير -->
<div id="reqModalBackdrop" class="modal-backdrop">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="reqModalTitle">
    <div class="modal-header">
      <div>
        <div id="reqModalTitle" class="modal-title">تفاصيل طلب التصوير</div>
        <div id="reqModalSub" class="muted" style="font-size:11px;margin-top:2px"></div>
      </div>
      <button class="modal-close" data-close-req-modal><i class="fa-solid fa-xmark"></i></button>
    </div>

    <div class="process-timeline" id="reqTimelineBox">
      <div class="process-timeline-title">مسار تنفيذ الطلب</div>
      <div class="process-timeline-sub">من استلام الطلب حتى الانتهاء.</div>
      <div class="pt-track" id="reqTimelineTrack"></div>
      <div class="progress-wrap" id="shootProgressWrap">
        <div class="progress-row">
          <div class="progress-label">نسبة إنجاز الطلب</div>
          <div class="progress-pct" id="shootOverallPct">0%</div>
        </div>
        <div class="bar"><div class="bar-fill" id="shootOverallBar"></div></div>

        <div class="phase-grid" style="margin-top:10px">
          <div class="phase-card">
            <div class="phase-title">تم استلام الطلب</div>
            <div class="bar"><div class="bar-fill" id="shootPhase1Bar"></div></div>
            <div class="phase-meta"><span id="shootPhase1Pct">0%</span><span id="shootPhase1Count">0/0</span></div>
          </div>
          <div class="phase-card">
            <div class="phase-title">تم ارسال السيارة</div>
            <div class="bar"><div class="bar-fill" id="shootPhase2Bar"></div></div>
            <div class="phase-meta"><span id="shootPhase2Pct">0%</span><span id="shootPhase2Count">0/0</span></div>
          </div>
          <div class="phase-card">
            <div class="phase-title">تم استلام السيارة</div>
            <div class="bar"><div class="bar-fill" id="shootPhase3Bar"></div></div>
            <div class="phase-meta"><span id="shootPhase3Pct">0%</span><span id="shootPhase3Count">0/0</span></div>
          </div>
          <div class="phase-card">
            <div class="phase-title">تم الانتهاء</div>
            <div class="bar"><div class="bar-fill" id="shootPhase4Bar"></div></div>
            <div class="phase-meta"><span id="shootPhase4Pct">0%</span><span id="shootPhase4Count">0/0</span></div>
          </div>
        </div>
      </div>

    </div>

    <div class="modal-body">
      <div class="section-title">تفاصيل السيارات داخل طلب التصوير</div>
      <div class="subhint">مراجعة رقم الهيكل، نوع السيارة، اللون، والموقع الحالي.</div>
      <div class="table-wrap" style="margin-top:6px;max-height:260px">
        <table>
          <thead>
            <tr>
              <th class="center">#</th>
              <th>VIN</th>
              <th>السيارة</th>
              <th>البيان</th>
              <th>اللون الخارجي</th>
              <th>اللون الداخلي</th>
              <th>الموديل</th>
              <th>الموقع الحالي</th>
              <th>مكان التصوير</th>
              <th>ملاحظة</th>
            </tr>
          </thead>
          <tbody id="reqModalRows"></tbody>
        </table>
      </div>

      <div class="stack">
        <div class="section-title" style="margin-top:10px">ملاحظات وإجراءات الإدارة</div>
        <div class="subhint">متابعة استلام الطلب وتحرك السيارات للتصوير.</div>
        <div class="note-box" id="reqModalStatusBox"></div>
        <div class="note-box" id="reqModalReceiveInfo"></div>
        <div class="note-box" id="reqModalPrepInfo"></div>
        <div>
          <label for="adminNotes">ملاحظات إضافية</label>
          <textarea id="adminNotes" placeholder="اكتب أي ملاحظات عن الطلب أو السيارات بداخله (اختياري)"></textarea>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn ghost btn-mini" data-close-req-modal>إغلاق</button>
      <button id="btnShootStep1" class="btn secondary btn-mini"><span class="step-num">1</span> <i class="fa-regular fa-clipboard-check"></i> تم استلام الطلب</button>
      <button id="btnShootStep2" class="btn secondary btn-mini"><span class="step-num">2</span> <i class="fa-solid fa-truck"></i> تم ارسال السيارة</button>
      <button id="btnShootStep3" class="btn secondary btn-mini"><span class="step-num">3</span> <i class="fa-solid fa-car-side"></i> تم استلام السيارة</button>
      <button id="btnShootStep4" class="btn secondary btn-mini"><span class="step-num">4</span> <i class="fa-solid fa-flag-checkered"></i> تم الانتهاء</button>
    </div>
  </div>
</div>

<!-- Modal: تفاصيل طلب النقل -->
<div id="moveModalBackdrop" class="modal-backdrop">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="moveModalTitle">
    <div class="modal-header">
      <div>
        <div id="moveModalTitle" class="modal-title">تفاصيل طلب النقل</div>
        <div id="moveModalSub" class="muted" style="font-size:11px;margin-top:2px"></div>
      </div>
      <button class="modal-close" data-close-move-modal><i class="fa-solid fa-xmark"></i></button>
    </div>

    <div class="process-timeline" id="moveTimelineBox">
      <div class="process-timeline-title">مسار تنفيذ الطلب</div>
      <div class="process-timeline-sub">من استلام الطلب حتى إتمام حركة النقل.</div>
      <div class="pt-track" id="moveTimelineTrack"></div>
      <div class="progress-wrap" id="moveProgressWrap">
        <div class="progress-row">
          <div class="progress-label">نسبة إنجاز طلب النقل</div>
          <div class="progress-pct" id="moveOverallPct">0%</div>
        </div>
        <div class="bar"><div class="bar-fill" id="moveOverallBar"></div></div>

        <div class="phase-grid" style="margin-top:10px">
          <div class="phase-card">
            <div class="phase-title">تم استلام الطلب</div>
            <div class="bar"><div class="bar-fill" id="movePhase1Bar"></div></div>
            <div class="phase-meta"><span id="movePhase1Pct">0%</span><span id="movePhase1Count">0/0</span></div>
          </div>
          <div class="phase-card">
            <div class="phase-title">تم ارسال السيارة</div>
            <div class="bar"><div class="bar-fill" id="movePhase2Bar"></div></div>
            <div class="phase-meta"><span id="movePhase2Pct">0%</span><span id="movePhase2Count">0/0</span></div>
          </div>
          <div class="phase-card">
            <div class="phase-title">تم استلام السيارة</div>
            <div class="bar"><div class="bar-fill" id="movePhase3Bar"></div></div>
            <div class="phase-meta"><span id="movePhase3Pct">0%</span><span id="movePhase3Count">0/0</span></div>
          </div>
          <div class="phase-card">
            <div class="phase-title">تم الانتهاء</div>
            <div class="bar"><div class="bar-fill" id="movePhase4Bar"></div></div>
            <div class="phase-meta"><span id="movePhase4Pct">0%</span><span id="movePhase4Count">0/0</span></div>
          </div>
        </div>
      </div>

    </div>

    <div class="modal-body">
      <div class="section-title">السيارات داخل طلب النقل</div>
      <div class="subhint">مراجعة رقم الهيكل، المكان قبل وبعد النقل.</div>
      <div class="table-wrap" style="margin-top:6px;max-height:260px">
        <table>
          <thead>
            <tr>
              <th class="center">#</th>
              <th>VIN</th>
              <th>السيارة</th>
              <th>البيان</th>
              <th>اللون الخارجي</th>
              <th>اللون الداخلي</th>
              <th>الموديل</th>
              <th>من</th>
              <th>إلى</th>
              <th>ملاحظة</th>
            </tr>
          </thead>
          <tbody id="moveModalRows"></tbody>
        </table>
      </div>

      <div class="stack">
        <div class="section-title" style="margin-top:10px">حالة التنفيذ</div>
        <div class="note-box" id="moveModalStatusBox"></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn ghost btn-mini" data-close-move-modal>إغلاق</button>
      <button id="btnMoveStep1" class="btn secondary btn-mini"><span class="step-num">1</span> <i class="fa-regular fa-clipboard-check"></i> تم استلام الطلب</button>
      <button id="btnMoveStep2" class="btn secondary btn-mini"><span class="step-num">2</span> <i class="fa-solid fa-truck"></i> تم ارسال السيارة</button>
      <button id="btnMoveStep3" class="btn secondary btn-mini"><span class="step-num">3</span> <i class="fa-solid fa-car-side"></i> تم استلام السيارة</button>
      <button id="btnMoveStep4" class="btn secondary btn-mini"><span class="step-num">4</span> <i class="fa-solid fa-flag-checkered"></i> تم الانتهاء</button>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
  import {
    getFirestore, doc, getDoc, setDoc, onSnapshot,
    collection, addDoc, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC614bGqnYf4Q-weTNemzWENTpa8DjGeHw",
    authDomain: "mzj-agenda.firebaseapp.com",
    projectId: "mzj-agenda",
    storageBucket: "mzj-agenda.firebasestorage.app",
    messagingSenderId: "834700407721",
    appId: "1:834700407721:web:75c17665d4f032fd65cab8"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  const STATE_REF   = doc(db, "mzj_admin_state", "v1");
  const ACTIVITY_CL = collection(db, "mzj_activity_log");

  const ROLE_ADMIN = "الادارة";
  const ROLE_IDARI = "اداري";
  const PAGE_ALLOWED_ROLES = [ROLE_ADMIN, ROLE_IDARI];


  // الصفحات المسموح بها حسب كل دور
  const ROLE_PAGES = {
    [ROLE_ADMIN]: 'ALL', // الإدارة تشوف كل الصفحات
    // الإداري: يشوف فقط الداشبورد + نقل السيارات + إدارة الطلبات + كل السيارات
    [ROLE_IDARI]: ['dashboard.html','vt.html','photoshoot-user.html','cars.html']
  };

  let currentUserRole = null;
  let currentUserLocations = [];
  let currentUserUid = null;
  let currentUserEmail = "";

  function isSuperAdmin(){
    return currentUserRole === ROLE_ADMIN;
  }
  function userMatchesPlace(place){
    if(!place) return false;
    if(!Array.isArray(currentUserLocations)) return false;
    return currentUserLocations.includes(place);
  }
  function isRequestOwner(req){
    if(currentUserUid && req.createdByUid){
      return currentUserUid === req.createdByUid;
    }
    if(currentUserEmail && req.createdByEmail){
      return currentUserEmail === req.createdByEmail;
    }
    return false;
  }

  const SHOOT_PLACES = [
    "",
    "الاستديو",
    "الصالة الاساسية",
    "صالة القادسية",
    "معرض الملتقى"
  ];

  const $  = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const pad = n => n<10 ? "0"+n : ""+n;

  function now(){
    const d=new Date();
    return d.getFullYear()+"-"+pad(d.getMonth()+1)+"-"+pad(d.getDate())+
           " "+pad(d.getHours())+":"+pad(d.getMinutes())+":"+pad(d.getSeconds());
  }
  function showToast(msg){
    const t = $("#toast");
    if(!t) return;
    t.textContent = msg;
    t.style.display = "block";
    setTimeout(()=>{t.style.display="none";}, 1800);
  }

  // إظهار أو إخفاء التابات حسب صلاحية الدور
  function applyTabsVisibility(role){
    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(tab=>{
      const href = tab.getAttribute('href') || '';
      const page = (href.split('/').pop() || '').split('?')[0];
      if(!page) return;
      const perm = ROLE_PAGES[role];
      if(!perm){
        tab.style.display = 'none';
        return;
      }
      if(perm === 'ALL') return; // الإدارة تشوف كل حاجة
      if(!perm.includes(page)){
        tab.style.display = 'none';
      }
    });
  }

  function setStatus(mode,txt){
    const dot=$("#connDot");
    const txtEl=$("#connText");
    if(!dot || !txtEl) return;
    dot.className="dot"+(mode==="ok"?" ok":mode==="err"?" err":"");
    txtEl.textContent = txt;
  }

  // ---- Fallback (خصوصاً لو الصفحة اتفتحت file://) ----
  let __authResolved = false;
  window.addEventListener("load", () => {
    setTimeout(() => {
      const gate = document.getElementById("authGate");
      const appEl = document.getElementById("app");
      const dotEl = document.getElementById("connDot");
      const txtEl = document.getElementById("connText");

      // لو الـ JS اتعطل أو auth ما ردّش، خلّي بوابة الدخول ظاهرة
      if (gate && appEl) {
        const gateHidden = getComputedStyle(gate).display === "none";
        const appHidden  = getComputedStyle(appEl).display === "none";
        if (gateHidden && appHidden) {
          gate.style.display = "block";
          appEl.style.display = "none";
        }
      }

      // لو الصفحة file:// غالباً Firebase modules بتتمنع في بعض المتصفحات
      if (location.protocol === "file:") {
        if (dotEl) dotEl.className = "dot err";
        if (txtEl) txtEl.textContent = "افتح الصفحة عبر https أو localhost";
        console.warn("Open via http(s) (e.g., localhost) instead of file://");
      }
    }, 1500);
  });

  function normalizeVin(v){
    if(!v) return "";
    const ar={'٠':'0','١':'1','٢':'2','٣':'3','٤':'4','٥':'5','٦':'6','٧':'7','٨':'8','٩':'9'};
    return v.toString().replace(/[٠-٩]/g,d=>ar[d]).toUpperCase().replace(/[\s\-\._]/g,"").trim();
  }

  // ===== Per-VIN progress model (rowStates) =====
  // rowStates: same length as rows
  // each item: { received:null, sent:null, carReceived:null, finished:null }
  function ensureRowStates(req){
    const rows = Array.isArray(req.rows)?req.rows:[];
    if(!Array.isArray(req.rowStates) || req.rowStates.length !== rows.length){
      req.rowStates = rows.map(()=>({received:null,sent:null,carReceived:null,finished:null}));
    }else{
      req.rowStates = req.rowStates.map(s=>({
        received: s?.received || null,
        sent: s?.sent || null,
        carReceived: s?.carReceived || null,
        finished: s?.finished || null
      }));
    }
    return req.rowStates;
  }

  function countDone(req, key){
    ensureRowStates(req);
    const rows = req.rowStates || [];
    const done = rows.filter(r=>!!r[key]).length;
    return {done, total: rows.length};
  }

  function pct(done,total){
    if(!total) return 0;
    return Math.round((done/total)*100);
  }

  function calcOverall(req){
    ensureRowStates(req);
    const rows = req.rowStates || [];
    const totalSteps = rows.length * 4;
    const doneSteps =
      rows.reduce((acc,r)=> acc + (r.received?1:0) + (r.sent?1:0) + (r.carReceived?1:0) + (r.finished?1:0), 0);
    const percent = totalSteps ? Math.round((doneSteps/totalSteps)*100) : 0;
    return {doneSteps,totalSteps,percent};
  }

  function updateProgressUI(req, prefix){
    const overall = calcOverall(req);
    const s1 = countDone(req,"received");
    const s2 = countDone(req,"sent");
    const s3 = countDone(req,"carReceived");
    const s4 = countDone(req,"finished");

    const set = (id,val)=>{ const el=document.getElementById(prefix+id); if(el) el.textContent=val; };
    const setw = (id,val)=>{ const el=document.getElementById(prefix+id); if(el) el.style.width=val+"%"; };

    set("OverallPct", overall.percent+"%");
    setw("OverallBar", overall.percent);

    const p1=pct(s1.done,s1.total), p2=pct(s2.done,s2.total), p3=pct(s3.done,s3.total), p4=pct(s4.done,s4.total);
    set("Phase1Pct", p1+"%"); setw("Phase1Bar", p1); set("Phase1Count", `${s1.done}/${s1.total}`);
    set("Phase2Pct", p2+"%"); setw("Phase2Bar", p2); set("Phase2Count", `${s2.done}/${s2.total}`);
    set("Phase3Pct", p3+"%"); setw("Phase3Bar", p3); set("Phase3Count", `${s3.done}/${s3.total}`);
    set("Phase4Pct", p4+"%"); setw("Phase4Bar", p4); set("Phase4Count", `${s4.done}/${s4.total}`);

    return {overall,p1,p2,p3,p4};
  }

  function responsiblePlaceForRow(kind, row, step){
    // step: "received" / "sent" / "carReceived" / "finished"
    if(kind === "move"){
      if(step === "received" || step === "sent") return row.fromLocation || "";
      if(step === "carReceived") return row.toLocation || "";
      return "";
    }
    // shoot
    if(step === "received") return row.location || "";
    if(step === "sent") return row.location || "";
    if(step === "carReceived") return row.shootPlace || row.place || "";
    return "";
  }

  function canActOnRow(kind, row, step){
    if(isSuperAdmin()) return true;
    // Step 2 (sent) admin-only
    if(step === "sent") return false;
    // Step 4: creator-only (plus admin)
    if(step === "finished") return false;

    const place = responsiblePlaceForRow(kind,row,step);
    return userMatchesPlace(place);
  }

  let shootRequests = [];
  let moveRequests  = [];
  let stock = [];
  let moves = [];

  function displayNameFor(user){
    if(!user) return "مسؤول";
    if(user.displayName && user.displayName.trim()) return user.displayName.trim();
    const e = (user.email||"").toLowerCase();
    const local = e.split("@")[0]||"";
    return local.replace(/[._-]+/g," ").replace(/\b\w/g,c=>c.toUpperCase());
  }

  async function logActivity(actionType, details, extra={}){
    try{
      const user = auth.currentUser;
      const email = user?.email || "";
      const name  = displayNameFor(user);
      await addDoc(ACTIVITY_CL,{
        userEmail: email,
        userName : name,
        role     : extra.role || "",
        action   : actionType,
        entityType: extra.entityType || "request",
        entityId : extra.requestId != null ? String(extra.requestId) : "",
        details  : details || "",
        createdAt: now(),
        createdAtTs: serverTimestamp(),
        userAgent: navigator.userAgent || ""
      });
    }catch(e){
      console.error("logActivity error", e);
    }
  }

  async function persistAll(){
    await setDoc(
      STATE_REF,
      { shootRequests, moveRequests, stock, moves, updatedAt: now() },
      { merge:true }
    );
  }

  function metrics(){
    const allCount = shootRequests.length + moveRequests.length;

    const progStatuses = new Set(["تحت الإجراء","تم التجهيز","قيد المراجعة","تحت المتابعة"]);
    const doneStatuses = new Set(["تم","منفّذ"]);

    const progCount =
      shootRequests.filter(x=> progStatuses.has(x.status||"")).length +
      moveRequests .filter(x=> progStatuses.has(x.status||"")).length;

    const doneCount =
      shootRequests.filter(x=> doneStatuses.has(x.status||"")).length +
      moveRequests .filter(x=> doneStatuses.has(x.status||"")).length;

    const elAll  = document.getElementById("stat_all");
    const elProg = document.getElementById("stat_prog");
    const elDone = document.getElementById("stat_done");
    if(elAll)  elAll.textContent  = allCount;
    if(elProg) elProg.textContent = progCount;
    if(elDone) elDone.textContent = doneCount;
  }

  function requestedPlaceOf(req){
    if(req.kind === "move") return "";
    const rows = Array.isArray(req.rows)?req.rows:[];
    if(!rows.length) return "";
    return rows[0].shootPlace || rows[0].place || "";
  }

  window._viewMode   = "manage";
  window._kindFilter = "";

  function toDateOnly(s){
    if(!s) return null;
    const d = s.slice(0,10);
    const [y,m,dd] = d.split("-").map(n=>parseInt(n,10));
    if(!y||!m||!dd) return null;
    return new Date(y,m-1,dd);
  }
  function inRange(createdAt, from, to){
    if(!from && !to) return true;
    const d = toDateOnly(createdAt); if(!d) return false;
    if(from && d < from) return false;
    if(to   && d > to)   return false;
    return true;
  }

  function applyFiltersAndSort(){
    const q = ($("#q").value||"").trim().toLowerCase();
    const s = $("#f_status").value||"";
    const fromVal = $("#date_from").value||"";
    const toVal   = $("#date_to").value||"";
    const fromD = fromVal ? new Date(fromVal+"T00:00:00") : null;
    const toD   = toVal   ? new Date(toVal+"T23:59:59") : null;

    let list = [
      ...shootRequests.map(r=>({kind:"shoot", data:r})),
      ...moveRequests .map(r=>({kind:"move",  data:r}))
    ];

    if(s){
      list = list.filter(x=> (x.data.status||"")===s);
    }
    if(fromD || toD){
      list = list.filter(x=> inRange(x.data.createdAt||"", fromD, toD));
    }
    if(q){
      list = list.filter(x=>{
        const txt = JSON.stringify(x.data).toLowerCase();
        return txt.includes(q);
      });
    }

    const kindFilter = window._kindFilter || "";
    if(kindFilter==="shoot") list = list.filter(x=>x.kind==="shoot");
    if(kindFilter==="move")  list = list.filter(x=>x.kind==="move");

    const viewMode = window._viewMode || "manage";
    if(viewMode === "manage"){
      list = list.filter(x=> !["تم","منفّذ"].includes(x.data.status||""));
    }else if(viewMode === "completed"){
      list = list.filter(x=> ["تم","منفّذ"].includes(x.data.status||""));
    }

    list.sort((a,b)=>{
      const da = a.data.createdAt||"";
      const db = b.data.createdAt||"";
      if(da===db) return 0;
      return da>db ? -1 : 1;
    });

    return list;
  }

  function render(){
    const list = applyFiltersAndSort();
    $("#countTotal").textContent = shootRequests.length + moveRequests.length;
    $("#countShown").textContent = list.length;

    const tbody = $("#reqTable");
    tbody.innerHTML = "";

    list.forEach((x,idx)=>{
      const r = x.data;
      const tr = document.createElement("tr");

      const status = r.status || "";
      let badgeClass = "badge draft";
      if(["تحت الإجراء","تم التجهيز","قيد المراجعة"].includes(status)) badgeClass = "badge prog";
      if(["تم","منفّذ"].includes(status)) badgeClass = "badge done";

      const isMove = x.kind === "move";
      const kindLabel = isMove ? "طلب نقل سيارات" : "طلب تصوير";
      const kindBadge = isMove ? "badge move" : "badge shoot";

      let placeCell = "";
      if(isMove){
        const rows = Array.isArray(r.rows)?r.rows:[];
        if(rows.length){
          const sample = rows[0];
          placeCell = (sample.fromLocation||"") + " → " + (sample.toLocation||"");
        }
      }else{
        placeCell = requestedPlaceOf(r) || "";
      }

      let approvalsText = "";
      ensureRowStates(r);
      const c1 = countDone(r,"received"), c2 = countDone(r,"sent"), c3 = countDone(r,"carReceived"), c4 = countDone(r,"finished");
      const p1 = pct(c1.done,c1.total), p2 = pct(c2.done,c2.total), p3 = pct(c3.done,c3.total), p4 = pct(c4.done,c4.total);
      approvalsText =
        `استلام الطلب: ${p1}% (${c1.done}/${c1.total})
`+
        `ارسال السيارة: ${p2}% (${c2.done}/${c2.total})
`+
        `استلام السيارة: ${p3}% (${c3.done}/${c3.total})
`+
        `الانتهاء: ${p4}% (${c4.done}/${c4.total})`;
      }else{
        const admin = r.admin || {};
        const recv  = admin.received;
        const prep  = admin.prepared;
        const recvText = recv ? ("تم استلام الطلب في: "+recv) : "لم يتم استلام الطلب بعد";
        const prepText = prep ? ("تم ارسال السيارة للتصوير في: "+prep) : "لم يتم الارسال بعد";
        approvalsText = recvText + "\n" + prepText;
      }

      tr.innerHTML = `
        <td class="center">${idx+1}</td>
        <td>#${r.id||"-"}</td>
        <td><span class="${kindBadge}">${kindLabel}</span></td>
        <td>${r.createdBy||""}</td>
        <td><span class="${badgeClass}">${status||"—"}</span></td>
        <td>${r.createdAt||""}</td>
        <td>${placeCell}</td>
        <td style="white-space:pre-line">${approvalsText}</td>
      `;

      tr.addEventListener("click",()=>{
        if(isMove) openMoveModal(r); else openReqModal(r);
      });

      tbody.appendChild(tr);
    });
  }

  /* ==== إنشاء الطلب من النموذج ==== */
  const reqRowsBody   = document.getElementById("reqRows");
  const placeHeaderEl = document.getElementById("placeHeader");

  function buildFormRows(){
    if(!reqRowsBody) return;
    reqRowsBody.innerHTML = "";
    for(let i=0;i<8;i++){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="center">${i+1}</td>
        <td>
          <select class="small-input req-kind">
            <option value="shoot" selected>طلب تصوير</option>
            <option value="move">طلب نقل</option>
          </select>
        </td>
        <td><input class="small-input mono req-vin" placeholder="VIN"></td>
        <td><input class="small-input req-car" readonly placeholder="—"></td>
        <td><input class="small-input req-variant" readonly placeholder="—"></td>
        <td><input class="small-input req-ext" readonly placeholder="—"></td>
        <td><input class="small-input req-int" readonly placeholder="—"></td>
        <td class="center"><input class="small-input center req-year" readonly placeholder="—"></td>
        <td><input class="small-input req-location" readonly placeholder="—"></td>
        <td>
          <select class="small-input req-place">
            <option value="">— اختر —</option>
            ${SHOOT_PLACES.map(p=> p ? `<option>${p}</option>` : "").join("")}
          </select>
        </td>
        <td><input class="small-input req-note" placeholder="اختياري"></td>
        <td class="center">
          <button type="button" class="btn ghost btn-mini req-row-clear"><i class="fa-solid fa-xmark"></i></button>
        </td>
      `;
      reqRowsBody.appendChild(tr);
    }

    const u = auth.currentUser;
    const rb = document.getElementById("reqBy");
    if(rb){
      rb.value = (u && (u.displayName || u.email)) || "";
      rb.readOnly = true;
    }
    updatePlaceHeader();
  }

  function updatePlaceHeader(){
    if(!placeHeaderEl || !reqRowsBody) return;
    const anyMove = Array.from(reqRowsBody.querySelectorAll(".req-kind"))
      .some(sel => sel.value === "move");
    placeHeaderEl.textContent = anyMove ? "مكان النقل" : "مكان التصوير";
  }

  if(reqRowsBody){
    reqRowsBody.addEventListener("change",(e)=>{
      if(e.target.classList && e.target.classList.contains("req-kind")){
        updatePlaceHeader();
      }
    });

    reqRowsBody.addEventListener("click",(e)=>{
      const btn = e.target.closest(".req-row-clear");
      if(!btn) return;
      const tr = btn.closest("tr");
      if(!tr) return;
      tr.querySelectorAll("input,select").forEach(el=>{
        if(el.classList.contains("req-kind")) el.value="shoot";
        else el.value="";
      });
      updatePlaceHeader();
    });

    reqRowsBody.addEventListener("blur",(e)=>{
      const vinInput = e.target.closest(".req-vin");
      if(!vinInput) return;
      const norm = normalizeVin(vinInput.value);
      vinInput.value = norm;
      if(!norm) return;
      const rec = stock.find(r=> normalizeVin(r.vin)===norm);
      const tr = vinInput.closest("tr");
      if(rec){
        tr.querySelector(".req-car").value      = rec.car || "";
        tr.querySelector(".req-variant").value  = rec.variant || "";
        tr.querySelector(".req-ext").value      = rec.extColor || "";
        tr.querySelector(".req-int").value      = rec.intColor || "";
        tr.querySelector(".req-year").value     = rec.modelYear || "";
        tr.querySelector(".req-location").value = rec.location || "";
        showToast("تم جلب بيانات السيارة");
      }else{
        tr.querySelector(".req-car").value      = "";
        tr.querySelector(".req-variant").value  = "";
        tr.querySelector(".req-ext").value      = "";
        tr.querySelector(".req-int").value      = "";
        tr.querySelector(".req-year").value     = "";
        tr.querySelector(".req-location").value = "";
        showToast("لا يوجد هيكل مطابق");
      }
    }, true);
  }

  function collectFormRows(){
    const shootRows = [];
    const moveRows  = [];
    if(!reqRowsBody) return {shootRows,moveRows};

    reqRowsBody.querySelectorAll("tr").forEach(tr=>{
      const vin = normalizeVin(tr.querySelector(".req-vin")?.value || "");
      if(!vin) return;
      const kind      = tr.querySelector(".req-kind")?.value || "shoot";
      const car       = tr.querySelector(".req-car")?.value || "";
      const variant   = tr.querySelector(".req-variant")?.value || "";
      const extColor  = tr.querySelector(".req-ext")?.value || "";
      const intColor  = tr.querySelector(".req-int")?.value || "";
      const modelYear = tr.querySelector(".req-year")?.value || "";
      const location  = tr.querySelector(".req-location")?.value || "";
      const place     = tr.querySelector(".req-place")?.value || "";
      const note      = tr.querySelector(".req-note")?.value || "";

      if(kind === "move"){
        moveRows.push({
          vin,car,variant,extColor,intColor,modelYear,
          fromLocation: location,
          toLocation  : place,
          note
        });
      }else{
        shootRows.push({
          vin,car,variant,extColor,intColor,modelYear,
          location,
          shootPlace: place,
          note
        });
      }
    });

    return {shootRows,moveRows};
  }

  async function saveNewRequest(){
    const rb = document.getElementById("reqBy");
    const user = auth.currentUser;
    const createdBy =
      (rb && rb.value && rb.value.trim()) ||
      (user && (user.displayName || user.email)) ||
      "غير محدد";

    const createdByUid = user ? user.uid : null;
    const createdByEmail = user ? (user.email || "") : "";

    const {shootRows,moveRows} = collectFormRows();
    if(!shootRows.length && !moveRows.length){
      showToast("أدخل هيكل واحد على الأقل");
      return;
    }

    if(shootRows.length){
      const nextId = shootRequests.length
        ? Math.max(...shootRequests.map(r=> Number(r.id)||0))+1
        : 1;
      const status = "تحت الإجراء";

      const req = {
        id: nextId,
        createdAt: now(),
        createdBy,
        createdByUid,
        createdByEmail,
        rows: shootRows,
        rowStates: shootRows.map(()=>({received:null,sent:null,carReceived:null,finished:null})),
        status,
        admin:{ received:null, prepared:null, carReceived:null, finished:null }
      };
      shootRequests.push(req);

      await logActivity(
        "إرسال طلب تصوير",
        "عدد الهياكل: "+shootRows.length+" | الطلب #"+nextId,
        {requestId:nextId, entityType:"photoshoot_request"}
      );
    }

    if(moveRows.length){
      const nextMoveId = moveRequests.length
        ? Math.max(...moveRequests.map(r=> Number(r.id)||0))+1
        : 1;
      const status = "قيد المراجعة";

      const mr = {
        id: nextMoveId,
        type:"VIN_MOVE",
        createdAt: now(),
        createdBy,
        createdByUid,
        createdByEmail,
        rows: moveRows,
        rowStates: moveRows.map(()=>({received:null,sent:null,carReceived:null,finished:null})),
        status,
        executedAt: null,
        admin:{ received:null, sent:null, carReceived:null, finished:null }
      };
      moveRequests.push(mr);

      await logActivity(
        "إرسال طلب نقل سيارات",
        "عدد السيارات في الطلب: "+moveRows.length+" | الطلب #"+nextMoveId,
        {requestId:nextMoveId, entityType:"move_request"}
      );
    }

    await persistAll();
    metrics();
    render();
    buildFormRows();
    showToast("تم إرسال الطلب");
  }
  if(btnSubmit) btnSubmit.addEventListener("click", ()=> saveNewRequest());
  if(btnClear)  btnClear .addEventListener("click", ()=> buildFormRows());

  /* ==== inner tabs ==== */
  const innerTabsEls = Array.from(document.querySelectorAll(".inner-tab"));
  const tabPanesEls  = Array.from(document.querySelectorAll(".tab-pane"));
  innerTabsEls.forEach(btn=>{
    btn.addEventListener("click",()=>{
      innerTabsEls.forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");

      const targetId = btn.getAttribute("data-tab");
      tabPanesEls.forEach(p=>{
        if(p.id === targetId) p.classList.add("active");
        else p.classList.remove("active");
      });

      const mode = btn.getAttribute("data-mode") || "manage";
      if(targetId === "tab-manage"){
        window._viewMode = mode;
        render();
      }
    });
  });

  /* ==== kind filters ==== */
  function applyKindButtons(active){
    $$(".filter-kind").forEach(b=>b.classList.remove("active-kind"));
    if(active) active.classList.add("active-kind");
  }
  const btnKindAll  = document.getElementById("kind_all");
  const btnKindShoot= document.getElementById("kind_shoot");
  const btnKindMove = document.getElementById("kind_move");

  if(btnKindAll) btnKindAll.addEventListener("click", ()=>{
    window._kindFilter = "";
    applyKindButtons(btnKindAll);
    render();
  });
  if(btnKindShoot) btnKindShoot.addEventListener("click", ()=>{
    window._kindFilter = "shoot";
    applyKindButtons(btnKindShoot);
    render();
  });
  if(btnKindMove) btnKindMove.addEventListener("click", ()=>{
    window._kindFilter = "move";
    applyKindButtons(btnKindMove);
    render();
  });

  if($("#f_reset")){
    $("#f_reset").addEventListener("click",()=>{
      $("#date_from").value = "";
      $("#date_to").value   = "";
      $("#f_status").value  = "";
      $("#q").value         = "";
      window._kindFilter    = "";
      applyKindButtons(btnKindAll);
      render();
    });
  }
  ["date_from","date_to","f_status","q"].forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.addEventListener("input",()=>render());
  });

  /* ===== Process Timeline helpers ===== */
  function renderTimelineSteps(steps, trackId){
    const track = document.getElementById(trackId);
    if(!track) return;
    let firstActive = false;
    const html = steps.map((s,idx)=>{
      let state="";
      if(s.done) state="done";
      else if(!firstActive){state="active"; firstActive=true;}
      else state="upcoming";
      return `
        <div class="pt-step ${state}">
          <div class="pt-circle">${idx+1}</div>
          <div class="pt-label">${s.label}</div>
          <div class="pt-desc">${s.desc||""}</div>
        </div>
      `;
    }).join("");
    track.innerHTML = html;
  }

  
  function renderShootTimeline(req){
    ensureRowStates(req);
    const st = updateProgressUI(req,"shoot");
    const steps = [
      { label:"تم استلام الطلب",  desc: st.p1+"% مكتمل", done: st.p1===100 },
      { label:"تم ارسال السيارة", desc: st.p2+"% مكتمل", done: st.p2===100 },
      { label:"تم استلام السيارة",desc: st.p3+"% مكتمل", done: st.p3===100 },
      { label:"تم الانتهاء",      desc: st.p4+"% مكتمل", done: st.p4===100 }
    ];
    renderTimelineSteps(steps,"reqTimelineTrack");
  }


  
  function renderMoveTimeline(moveReq){
    ensureRowStates(moveReq);
    const st = updateProgressUI(moveReq,"move");
    const steps = [
      { label:"تم استلام الطلب",  desc: st.p1+"% مكتمل", done: st.p1===100 },
      { label:"تم ارسال السيارة", desc: st.p2+"% مكتمل", done: st.p2===100 },
      { label:"تم استلام السيارة",desc: st.p3+"% مكتمل", done: st.p3===100 },
      { label:"تم الانتهاء",      desc: st.p4+"% مكتمل", done: st.p4===100 }
    ];
    renderTimelineSteps(steps,"moveTimelineTrack");
  }


  /* ==== تصوير: إجراءات ==== */
  function updateShootRequestLocal(updated){
    shootRequests = shootRequests.map(r=> r.id===updated.id ? updated : r);
  }

  
  async function markShootStep1(req){
    const base = (shootRequests || []).find(r => r.id === req.id) || req;
    ensureRowStates(base);
    const rows = Array.isArray(base.rows)?base.rows:[];
    const ts = now();
    let changed = 0;

    rows.forEach((row,idx)=>{
      if(!canActOnRow("shoot", row, "received")) return;
      if(!base.rowStates[idx].received){
        base.rowStates[idx].received = ts;
        changed++;
      }
    });

    if(!changed){ showToast("لا توجد سيارات تابعة لمكانك في هذه الخطوة"); return; }

    // status derived
    base.status = calcOverall(base).percent === 100 ? "تم" : "تحت الإجراء";

    updateShootRequestLocal(base);
    await persistAll();
    metrics(); render(); renderShootTimeline(base);
    showToast("تم استلام الطلب (للسيارات التابعة لمكانك)");
  }



  
  async function markShootStep2(req){
    // إرسال السيارة: Admin فقط
    if(!isSuperAdmin()){
      showToast("غير مسموح: خطوة الإرسال للإدارة فقط");
      return;
    }
    const base = (shootRequests || []).find(r => r.id === req.id) || req;
    ensureRowStates(base);
    const ts = now();
    let changed = 0;

    (base.rowStates||[]).forEach((s)=>{
      if(!s.sent){ s.sent = ts; changed++; }
      if(!s.received) s.received = ts;
    });

    moveCarsToShootPlace(base.rows || []);
    base.status = calcOverall(base).percent === 100 ? "تم" : "تحت الإجراء";

    updateShootRequestLocal(base);
    await persistAll();
    metrics(); render(); renderShootTimeline(base);
    showToast("تم تسجيل إرسال السيارات للتصوير");
  }



  
  async function markShootStep3(req){
    const base = (shootRequests || []).find(r => r.id === req.id) || req;
    ensureRowStates(base);
    const rows = Array.isArray(base.rows)?base.rows:[];
    const ts = now();
    let changed = 0;

    rows.forEach((row,idx)=>{
      if(!canActOnRow("shoot", row, "carReceived")) return;
      const st = base.rowStates[idx];
      if(!st.received) st.received = ts;
      if(!st.sent && isSuperAdmin()) st.sent = ts; // لو الإدارة ونسيت خطوة الإرسال
      if(!st.carReceived){
        st.carReceived = ts;
        changed++;
      }
    });

    if(!changed){ showToast("لا توجد سيارات تابعة لمكانك في هذه الخطوة"); return; }

    base.status = calcOverall(base).percent === 100 ? "تم" : "تحت الإجراء";
    updateShootRequestLocal(base);
    await persistAll();
    metrics(); render(); renderShootTimeline(base);
    showToast("تم استلام السيارة (للسيارات التابعة لمكانك)");
  }



  
  async function markShootStep4(req){
    const base = (shootRequests || []).find(r => r.id === req.id) || req;
    ensureRowStates(base);

    // يظهر لمقدم الطلب أو الإدارة فقط
    if(!(isSuperAdmin() || isRequestOwner(base))){
      showToast("زر الإنهاء لمقدم الطلب فقط");
      return;
    }

    // لازم كل السيارات تكون مستلمة (مرحلة 3) قبل الإنهاء
    const st3 = countDone(base,"carReceived");
    if(st3.done !== st3.total){
      showToast("لا يمكن الإنهاء قبل استلام كل السيارات");
      return;
    }

    const ts = now();
    (base.rowStates||[]).forEach(s=>{
      if(!s.received) s.received = ts;
      if(!s.sent) s.sent = ts;
      if(!s.carReceived) s.carReceived = ts;
      if(!s.finished) s.finished = ts;
    });

    base.status = "تم";
    updateShootRequestLocal(base);
    await persistAll();
    metrics(); render(); renderShootTimeline(base);
    showToast("تم الانتهاء من الطلب");
  }



  
  async function markMoveStep1(req){
    const base = (moveRequests || []).find(r => r.id === req.id) || req;
    ensureRowStates(base);
    const rows = Array.isArray(base.rows)?base.rows:[];
    const ts = now();
    let changed = 0;

    rows.forEach((row,idx)=>{
      if(!canActOnRow("move", row, "received")) return;
      if(!base.rowStates[idx].received){
        base.rowStates[idx].received = ts;
        changed++;
      }
    });

    if(!changed){ showToast("لا توجد سيارات تابعة لمكانك في هذه الخطوة"); return; }

    base.status = calcOverall(base).percent === 100 ? "منفّذ" : "تحت الإجراء";

    updateMoveRequestLocal(base);
    await persistAll();
    metrics(); render(); renderMoveTimeline(base);
    showToast("تم استلام طلب النقل (للسيارات التابعة لمكانك)");
  }



  
  async function markMoveStep2(req){
    if(!isSuperAdmin()){
      showToast("غير مسموح: خطوة الإرسال للإدارة فقط");
      return;
    }
    const base = (moveRequests || []).find(r => r.id === req.id) || req;
    ensureRowStates(base);
    const ts = now();

    (base.rowStates||[]).forEach(s=>{
      if(!s.received) s.received = ts;
      if(!s.sent) s.sent = ts;
    });

    base.status = calcOverall(base).percent === 100 ? "منفّذ" : "تحت الإجراء";
    updateMoveRequestLocal(base);
    await persistAll();
    metrics(); render(); renderMoveTimeline(base);
    showToast("تم تسجيل إرسال السيارات");
  }



  
  async function markMoveStep3(req){
    const base = (moveRequests || []).find(r => r.id === req.id) || req;
    ensureRowStates(base);
    const rows = Array.isArray(base.rows)?base.rows:[];
    const ts = now();
    let changed = 0;

    rows.forEach((row,idx)=>{
      if(!canActOnRow("move", row, "carReceived")) return;
      const st = base.rowStates[idx];
      if(!st.received) st.received = ts;
      if(!st.sent && isSuperAdmin()) st.sent = ts;
      if(!st.carReceived){
        st.carReceived = ts;
        changed++;
      }
    });

    if(!changed){ showToast("لا توجد سيارات تابعة لمكانك في هذه الخطوة"); return; }

    base.status = calcOverall(base).percent === 100 ? "منفّذ" : "تحت الإجراء";
    updateMoveRequestLocal(base);
    await persistAll();
    metrics(); render(); renderMoveTimeline(base);
    showToast("تم استلام السيارة في موقعها الجديد (للسيارات التابعة لمكانك)");
  }



  
  async function markMoveStep4(req){
    const base = (moveRequests || []).find(r => r.id === req.id) || req;
    ensureRowStates(base);

    if(!(isSuperAdmin() || isRequestOwner(base))){
      showToast("زر الإنهاء لمقدم الطلب فقط");
      return;
    }

    const st3 = countDone(base,"carReceived");
    if(st3.done !== st3.total){
      showToast("لا يمكن الإنهاء قبل استلام كل السيارات");
      return;
    }

    const ts = now();
    (base.rowStates||[]).forEach(s=>{
      if(!s.received) s.received = ts;
      if(!s.sent) s.sent = ts;
      if(!s.carReceived) s.carReceived = ts;
      if(!s.finished) s.finished = ts;
    });

    base.status     = "منفّذ";
    base.executedAt = ts;

    applyMoveToStock(base.rows || []);
    updateMoveRequestLocal(base);
    await persistAll();
    metrics(); render(); renderMoveTimeline(base);
    showToast("تم الانتهاء من طلب النقل وتحديث المخزون");
  }


  
  
  function updateMoveRequestLocal(updated){
    moveRequests = (moveRequests || []).map(r => r.id === updated.id ? updated : r);
  }

  function moveCarsToShootPlace(rows){
    if (!Array.isArray(rows) || !rows.length) return;
    const newStock = (stock || []).map(rec => ({...rec}));
    rows.forEach(row => {
      const vin = normalizeVin(row.vin || "");
      if (!vin) return;
      const idx = newStock.findIndex(s => normalizeVin(s.vin) === vin);
      if (idx === -1) return;
      const place = row.shootPlace || row.place || "";
      if (place) newStock[idx].location = place;
    });
    stock = newStock;
  }

  function applyMoveToStock(rows){
    if (!Array.isArray(rows) || !rows.length) return;
    const newStock = (stock || []).map(rec => ({...rec}));
    rows.forEach(row => {
      const vin = normalizeVin(row.vin || "");
      if (!vin) return;
      const idx = newStock.findIndex(s => normalizeVin(s.vin) === vin);
      if (idx === -1) return;
      const toLoc = row.toLocation || row.place || "";
      if (toLoc) newStock[idx].location = toLoc;
    });
    stock = newStock;
  }

  let currentShootReqId = null;
  let currentMoveReqId  = null;

  function openReqModal(req){
    currentShootReqId = req.id;
    const backdrop = document.getElementById("reqModalBackdrop");
    if (!backdrop) return;
    const titleEl  = document.getElementById("reqModalTitle");
    const subEl    = document.getElementById("reqModalSub");
    const rowsBody = document.getElementById("reqModalRows");
    const statusBox= document.getElementById("reqModalStatusBox");
    const recvBox  = document.getElementById("reqModalReceiveInfo");
    const prepBox  = document.getElementById("reqModalPrepInfo");
    const notesEl  = document.getElementById("adminNotes");

    if (titleEl) titleEl.textContent = "تفاصيل طلب التصوير #" + (req.id || "-");
    if (subEl) subEl.textContent = (req.createdAt || "") + " — " + (req.createdBy || "");

    rowsBody.innerHTML = "";
    const rows = Array.isArray(req.rows) ? req.rows : [];
    rows.forEach((row, idx) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="center">${idx+1}</td>
        <td>${row.vin || ""}</td>
        <td>${row.car || ""}</td>
        <td>${row.variant || ""}</td>
        <td>${row.extColor || ""}</td>
        <td>${row.intColor || ""}</td>
        <td>${row.modelYear || ""}</td>
        <td>${row.location || ""}</td>
        <td>${row.shootPlace || row.place || ""}</td>
        <td>${row.note || ""}</td>
      `;
      rowsBody.appendChild(tr);
    });

    const admin = req.admin || {};
    if (statusBox) {
      statusBox.textContent = "الحالة الحالية: " + (req.status || "—");
    }
    if (recvBox) {
      recvBox.textContent = admin.received
        ? ("تم استلام الطلب في: " + admin.received)
        : "لم يتم استلام الطلب بعد";
    }
    if (prepBox) {
      prepBox.textContent = admin.prepared
        ? ("تم ارسال السيارة للتصوير في: " + admin.prepared)
        : "لم يتم ارسال السيارة بعد";
    }
    if (notesEl) {
      notesEl.value = req.adminNotes || "";
    }

    
    // صلاحيات الأزرار داخل المودال (تصوير)
    const b1 = document.getElementById("btnShootStep1");
    const b2 = document.getElementById("btnShootStep2");
    const b3 = document.getElementById("btnShootStep3");
    const b4 = document.getElementById("btnShootStep4");

    ensureRowStates(req);
    const rows = Array.isArray(req.rows)?req.rows:[];
    const can1 = rows.some((row)=> canActOnRow("shoot",row,"received"));
    const can3 = rows.some((row)=> canActOnRow("shoot",row,"carReceived"));
    if(b1) b1.disabled = !can1;
    if(b3) b3.disabled = !can3;
    if(b2) b2.disabled = !isSuperAdmin();

    const isFinisher = isSuperAdmin() || isRequestOwner(req);
    if(b4){
      b4.style.display = isFinisher ? "inline-flex" : "none";
      const st3 = countDone(req,"carReceived");
      b4.disabled = !(st3.total>0 && st3.done===st3.total);
    }
renderShootTimeline(req);
    backdrop.classList.add("show");
  }

  function openMoveModal(req){
    currentMoveReqId = req.id;
    const backdrop = document.getElementById("moveModalBackdrop");
    if (!backdrop) return;
    const titleEl  = document.getElementById("moveModalTitle");
    const subEl    = document.getElementById("moveModalSub");
    const rowsBody = document.getElementById("moveModalRows");
    const statusBox= document.getElementById("moveModalStatusBox");

    if (titleEl) titleEl.textContent = "تفاصيل طلب النقل #" + (req.id || "-");
    if (subEl) subEl.textContent    = (req.createdAt || "") + " — " + (req.createdBy || "");

    rowsBody.innerHTML = "";
    const rows = Array.isArray(req.rows) ? req.rows : [];
    rows.forEach((row, idx) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="center">${idx+1}</td>
        <td>${row.vin || ""}</td>
        <td>${row.car || ""}</td>
        <td>${row.variant || ""}</td>
        <td>${row.extColor || ""}</td>
        <td>${row.intColor || ""}</td>
        <td>${row.modelYear || ""}</td>
        <td>${row.fromLocation || ""}</td>
        <td>${row.toLocation || ""}</td>
        <td>${row.note || ""}</td>
      `;
      rowsBody.appendChild(tr);
    });

    const admin = req.admin || {};
    const lines = [];
    lines.push(admin.received ? "تم استلام الطلب في: " + admin.received : "لم يتم استلام الطلب بعد");
    lines.push(admin.sent ? "تم ارسال السيارة في: " + admin.sent : "لم يتم ارسال السيارة بعد");
    lines.push(admin.carReceived ? "تم استلام السيارة في: " + admin.carReceived : "لم يتم استلام السيارة بعد");
    if (req.executedAt) {
      lines.push("تم الانتهاء في: " + req.executedAt);
    } else {
      lines.push("لم يتم الانتهاء بعد");
    }
    if (statusBox) {
      statusBox.textContent = lines.join(" | ");
    }

    
    // صلاحيات الأزرار داخل المودال (نقل)
    const b1 = document.getElementById("btnMoveStep1");
    const b2 = document.getElementById("btnMoveStep2");
    const b3 = document.getElementById("btnMoveStep3");
    const b4 = document.getElementById("btnMoveStep4");

    ensureRowStates(req);
    const rows = Array.isArray(req.rows)?req.rows:[];
    const can1 = rows.some((row)=> canActOnRow("move",row,"received"));
    const can3 = rows.some((row)=> canActOnRow("move",row,"carReceived"));
    if(b1) b1.disabled = !can1;
    if(b3) b3.disabled = !can3;
    if(b2) b2.disabled = !isSuperAdmin();

    const isFinisher = isSuperAdmin() || isRequestOwner(req);
    if(b4){
      b4.style.display = isFinisher ? "inline-flex" : "none";
      const st3 = countDone(req,"carReceived");
      b4.disabled = !(st3.total>0 && st3.done===st3.total);
    }
renderMoveTimeline(req);
    backdrop.classList.add("show");
  }

  (function bindModalEvents(){
    const reqBackdrop  = document.getElementById("reqModalBackdrop");
    const moveBackdrop = document.getElementById("moveModalBackdrop");

    document.querySelectorAll("[data-close-req-modal]").forEach(btn => {
      btn.addEventListener("click", () => {
        if (reqBackdrop) reqBackdrop.classList.remove("show");
      });
    });
    document.querySelectorAll("[data-close-move-modal]").forEach(btn => {
      btn.addEventListener("click", () => {
        if (moveBackdrop) moveBackdrop.classList.remove("show");
      });
    });

    const notesEl = document.getElementById("adminNotes");

    const btnS1 = document.getElementById("btnShootStep1");
    const btnS2 = document.getElementById("btnShootStep2");
    const btnS3 = document.getElementById("btnShootStep3");
    const btnS4 = document.getElementById("btnShootStep4");

    function withCurrentShoot(fn){
      if (currentShootReqId == null) return;
      const idx = (shootRequests || []).findIndex(r => r.id === currentShootReqId);
      if (idx === -1) return;
      if (notesEl) {
        shootRequests[idx].adminNotes = notesEl.value || "";
      }
      fn(shootRequests[idx]);
    }

    if (btnS1) btnS1.addEventListener("click", () => withCurrentShoot(markShootStep1));
    if (btnS2) btnS2.addEventListener("click", () => withCurrentShoot(markShootStep2));
    if (btnS3) btnS3.addEventListener("click", () => withCurrentShoot(markShootStep3));
    if (btnS4) btnS4.addEventListener("click", () => withCurrentShoot(markShootStep4));

    const btnM1 = document.getElementById("btnMoveStep1");
    const btnM2 = document.getElementById("btnMoveStep2");
    const btnM3 = document.getElementById("btnMoveStep3");
    const btnM4 = document.getElementById("btnMoveStep4");

    function withCurrentMove(fn){
      if (currentMoveReqId == null) return;
      const idx = (moveRequests || []).findIndex(r => r.id === currentMoveReqId);
      if (idx === -1) return;
      fn(moveRequests[idx]);
    }

    if (btnM1) btnM1.addEventListener("click", () => withCurrentMove(markMoveStep1));
    if (btnM2) btnM2.addEventListener("click", () => withCurrentMove(markMoveStep2));
    if (btnM3) btnM3.addEventListener("click", () => withCurrentMove(markMoveStep3));
    if (btnM4) btnM4.addEventListener("click", () => withCurrentMove(markMoveStep4));
  })();


  async function fetchUserRole(user){
    currentUserUid = user?.uid || null;
    currentUserEmail = user?.email || "";
    currentUserRole = null;
    currentUserLocations = [];
    try{
      const snap = await getDoc(doc(db,"user", user.uid));
      if(snap.exists()){
        const data = snap.data() || {};
        currentUserRole = data.role || null;
        const loc = data.locations;
        if(Array.isArray(loc)){
          currentUserLocations = loc;
        }else if(typeof loc === "string" && loc.trim()){
          currentUserLocations = [loc.trim()];
        }else{
          currentUserLocations = [];
        }
        if(data.email){
          currentUserEmail = data.email;
        }
        return currentUserRole;
      }
    }catch(e){
      console.error("fetch role error", e);
    }
    return currentUserRole;
  }


  function showAuthGate(){
    document.getElementById("authGate").style.display = "block";
    document.getElementById("app").style.display      = "none";
  }
  function showApp(){
    document.getElementById("authGate").style.display = "none";
    document.getElementById("app").style.display      = "block";
  }

  onAuthStateChanged(auth, async (user)=>{ __authResolved = true;
    if(!user){
      $("#userLabel").textContent = "غير مسجل";
      $("#btnSignOut").style.display = "none";
      showAuthGate();
      return;
    }
    $("#userLabel").textContent = user.email || "";
    $("#btnSignOut").style.display = "inline-flex";

    const role = await fetchUserRole(user);
    if(!role || !PAGE_ALLOWED_ROLES.includes(role)){
      // تحويل مباشر لصفحة عدم الصلاحية
      window.location.href = "unauthorized.html";
      return;
    }
    setStatus("ok","متصل بحساب الإدارة");
    showApp();
    // تطبيق صلاحيات التابات حسب الدور
    applyTabsVisibility(role);
    buildFormRows();

    // ✅ تحميل حالة النظام (المخزون + الطلبات) من STATE_REF
    onSnapshot(STATE_REF, (snap) => {
      const data = snap.data() || {};
      shootRequests = Array.isArray(data.shootRequests) ? data.shootRequests : [];
      moveRequests  = Array.isArray(data.moveRequests)  ? data.moveRequests  : [];
      stock         = Array.isArray(data.stock)         ? data.stock         : [];
      moves         = Array.isArray(data.moves)         ? data.moves         : [];

      metrics();
      render();
      const su = document.getElementById("stat_updated");
      if (su) su.textContent = data.updatedAt || "—";
    });
  });

  document.getElementById("btnSignOut")?.addEventListener("click",async ()=>{
    await signOut(auth);
  });

  const loginForm = document.getElementById("loginForm");
  if(loginForm){
    loginForm.addEventListener("submit",async (e)=>{
      e.preventDefault();
      const email = document.getElementById("email").value.trim();
      const pass  = document.getElementById("password").value;
      const btn   = document.getElementById("btnSignIn");
      try{
        btn.disabled = true;
        await signInWithEmailAndPassword(auth,email,pass);
        showToast("تم تسجيل الدخول");
      }catch(err){
        console.error(err);
        alert("بيانات الدخول غير صحيحة");
      }finally{
        btn.disabled = false;
      }
    });
  }
</script>
</body>
</html>
