
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>MZJ — إدارة الطلبات</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
<style>
:root{
  --brown:#3e2420;
  --beige:#bc8f74;
  --cream:#fff8ef;
  --line:#e8d6c8;
  --muted:#6b7280;
  --radius:14px;
  --shadow:0 10px 30px rgba(62,36,32,.08);
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:"Tajawal",system-ui,-apple-system,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#fff8ef,#fff);color:#1f2937}
a{text-decoration:none}
.container{max-width:1180px;margin:0 auto;padding:18px}
/* Topbar */
.topbar{background:#fff;border:1px solid var(--line);border-radius:18px;box-shadow:var(--shadow);padding:12px 14px;display:flex;align-items:center;gap:12px;justify-content:space-between}
.brand{display:flex;align-items:center;gap:10px}
.logo{width:44px;height:44px;border-radius:14px;background:var(--brown);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:800;letter-spacing:.5px}
.brand-title{display:flex;flex-direction:column;line-height:1.2}
.brand-title b{font-size:16px}
.brand-title span{font-size:12px;color:var(--muted)}
.nav{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
.tab{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:999px;border:1px solid var(--line);background:#fff;color:var(--brown);font-weight:700;font-size:13px;transition:.2s}
.tab:hover{background:#fbf2eb}
.tab.active{background:var(--brown);color:#fff;border-color:var(--brown)}
.status-pill{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.pill{padding:8px 12px;border-radius:999px;border:1px solid var(--line);background:#fff;color:var(--muted);font-size:12px}
.dot{width:8px;height:8px;border-radius:999px;background:#f59e0b;display:inline-block}
/* Internal tabs (requested to be lower) */
.page-tabs-wrap{margin-top:16px}
.page-tabs{background:#fff;border:1px solid var(--line);border-radius:18px;box-shadow:var(--shadow);padding:10px;display:flex;gap:10px;flex-wrap:wrap}
.page-tab{flex:0 0 auto}
/* Cards */
.card{background:#fff;border:1px solid var(--line);border-radius:18px;box-shadow:var(--shadow)}
.card-hd{padding:14px 16px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
.card-hd h2{margin:0;font-size:16px;color:var(--brown)}
.card-bd{padding:14px 16px}
.btn{border:0;border-radius:12px;padding:10px 14px;font-weight:800;cursor:pointer;transition:.2s;font-family:inherit}
.btn.primary{background:var(--brown);color:#fff}
.btn.primary:hover{filter:brightness(0.95)}
.btn.ghost{background:#fff;border:1px solid var(--line);color:var(--brown)}
.btn.ghost:hover{background:#fbf2eb}
.btn.danger{background:#fee2e2;color:#991b1b}
.btn:disabled{opacity:.5;cursor:not-allowed}
.input, select{font-family:inherit;border:1px solid var(--line);border-radius:12px;padding:10px 12px;background:#fff;outline:none}
.input:focus, select:focus{border-color:#d7b7a2;box-shadow:0 0 0 3px rgba(188,143,116,.18)}
.table-wrap{overflow:auto;border:1px solid var(--line);border-radius:16px}
table{width:100%;border-collapse:separate;border-spacing:0;min-width:980px}
thead th{position:sticky;top:0;background:#fff7f0;border-bottom:1px solid var(--line);padding:10px 12px;font-size:12px;color:var(--brown);text-align:right}
tbody td{border-bottom:1px solid #f2e4da;padding:10px 12px;vertical-align:middle;font-size:13px}
tbody tr:hover{background:#fffdfb}
.badge{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);border-radius:999px;padding:6px 10px;font-size:12px;color:var(--brown);background:#fff}
.badge.type-move{background:#fff;}
.badge.type-shoot{background:#fff;}
.muted{color:var(--muted)}
.small{font-size:12px}
.flex{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
/* Modal */
.backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:flex-start;justify-content:center;padding:24px;overflow:auto;z-index:50}
.backdrop.show{display:flex}
.modal{width:min(1080px,100%);background:#fff;border-radius:22px;border:1px solid var(--line);box-shadow:0 30px 80px rgba(0,0,0,.25);overflow:hidden}
.modal-hd{padding:14px 16px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;gap:12px}
.modal-hd b{font-size:16px;color:var(--brown)}
.grid2{display:grid;grid-template-columns:1.1fr .9fr;gap:12px;padding:14px 16px}
@media(max-width:980px){.grid2{grid-template-columns:1fr}}
.box{border:1px solid var(--line);border-radius:18px;padding:12px;background:#fff}
.box h3{margin:0 0 8px 0;font-size:13px;color:var(--brown)}
.kv{display:grid;grid-template-columns:140px 1fr;gap:8px;font-size:13px}
.kv div{padding:6px 0;border-bottom:1px dashed #f2e4da}
.kv div:nth-child(odd){color:var(--muted)}
.kv div:nth-last-child(-n+2){border-bottom:none}
.progress{height:10px;background:#f3e5da;border-radius:999px;overflow:hidden}
.progress > i{display:block;height:100%;background:var(--brown);width:0%}
.actions{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.notearea{width:100%;min-height:84px;resize:vertical}
.hint{margin-top:8px;color:var(--muted);font-size:12px}
</style>
</head>
<body>
<div class="container">
  <!-- TOP BAR -->
  <div class="topbar">
    <div class="brand">
      <div class="logo">MZJ</div>
      <div class="brand-title">
        <b>محمد بن ذعار العجمي للسيارات</b>
        <span>Workspace · إدارة الطلبات</span>
      </div>
    </div>
    <div class="nav" aria-label="روابط الصفحات">
      <a class="tab" href="admin.html">الإدارة</a>
      <a class="tab" href="inventory.html">المخزون</a>
      <a class="tab" href="dashboard.html">الداش بورد</a>
      <a class="tab" href="vt.html">نقل السيارات</a>
      <a class="tab active" href="photoshoot-user.html">إدارة الطلبات</a>
      <a class="tab" href="cars.html">كل السيارات</a>
      <a class="tab" href="Activity.html">سجل النشاط</a>
    </div>
    <div class="status-pill">
      <div class="pill"><span class="dot" id="connDot"></span> <span id="connText">جارٍ الاتصال…</span></div>
      <div class="pill">الدور: <b id="roleText">—</b></div>
      <div class="pill">المكان: <b id="locText">—</b></div>
    </div>
  </div>

  <!-- INTERNAL TABS (lower) -->
  <div class="page-tabs-wrap">
    <div class="page-tabs">
      <button class="btn ghost page-tab" id="tabManageBtn">إدارة الطلبات</button>
      <button class="btn ghost page-tab" id="tabCreateBtn">إنشاء طلب</button>
      <button class="btn ghost page-tab" id="tabDoneBtn">الطلبات المكتملة</button>
    </div>
  </div>

  <!-- MANAGE -->
  <div class="card" id="manageView" style="margin-top:14px">
    <div class="card-hd">
      <h2>إدارة الطلبات (قيد التنفيذ)</h2>
      <div class="flex">
        <select id="filterKind">
          <option value="all">الكل</option>
          <option value="move">طلبات نقل</option>
          <option value="shoot">طلبات تصوير</option>
        </select>
        <input class="input" id="searchVin" placeholder="بحث VIN داخل الطلبات" style="min-width:260px"/>
        <button class="btn ghost" id="refreshBtn">تحديث</button>
      </div>
    </div>
    <div class="card-bd">
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>رقم</th>
              <th>النوع</th>
              <th>VINs</th>
              <th>من</th>
              <th>إلى/تنفيذ</th>
              <th>المنشئ</th>
              <th>التقدم</th>
            </tr>
          </thead>
          <tbody id="requestsTbody">
            <tr><td colspan="7" class="muted">جارٍ التحميل…</td></tr>
          </tbody>
        </table>
      </div>
      <div class="hint">الترتيب: الأحدث أولاً — التحديث لحظي بدون Refresh.</div>
    </div>
  </div>

  <!-- CREATE -->
  <div class="card" id="createView" style="margin-top:14px;display:none">
    <div class="card-hd">
      <h2>إنشاء طلب (نقل / تصوير)</h2>
      <div class="flex">
        <select id="createKind">
          <option value="move">طلب نقل</option>
          <option value="shoot">طلب تصوير</option>
        </select>
        <select id="createToLocation">
          <option value="">— اختر مكان التنفيذ —</option>
        </select>
        <button class="btn primary" id="submitRequestBtn">إرسال الطلب</button>
        <button class="btn ghost" id="clearCreateBtn">تفريغ</button>
      </div>
    </div>
    <div class="card-bd">
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>رقم الهيكل (VIN)</th>
              <th>السيارة</th>
              <th>البيان</th>
              <th>الخارجي</th>
              <th>الداخلي</th>
              <th>الموديل</th>
              <th>مكان السيارة</th>
              <th>مكان التنفيذ</th>
              <th>ملاحظة</th>
              <th>حذف</th>
            </tr>
          </thead>
          <tbody id="createTbody"></tbody>
        </table>
      </div>
      <div class="hint" id="createHint">اكتب VIN فقط… والبيانات بتنزل تلقائي. الطلب يدعم حتى 8 هياكل.</div>
    </div>
  </div>

  <!-- DONE -->
  <div class="card" id="doneView" style="margin-top:14px;display:none">
    <div class="card-hd">
      <h2>الطلبات المكتملة</h2>
      <div class="flex">
        <select id="doneFilterKind">
          <option value="all">الكل</option>
          <option value="move">نقل</option>
          <option value="shoot">تصوير</option>
        </select>
      </div>
    </div>
    <div class="card-bd">
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>رقم</th>
              <th>النوع</th>
              <th>VINs</th>
              <th>من</th>
              <th>إلى/تنفيذ</th>
              <th>المنشئ</th>
              <th>تاريخ الإنهاء</th>
            </tr>
          </thead>
          <tbody id="doneTbody">
            <tr><td colspan="7" class="muted">جارٍ التحميل…</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- MODAL -->
<div class="backdrop" id="modalBackdrop" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="modal-hd">
      <b id="modalTitle">تفاصيل الطلب</b>
      <button class="btn ghost" id="modalCloseBtn">إغلاق</button>
    </div>

    <div class="grid2">
      <div class="box">
        <h3>التقدم</h3>
        <div class="flex" style="justify-content:space-between">
          <div class="badge" id="overallPct">0%</div>
          <div class="muted small">التقدم العام</div>
        </div>
        <div class="progress" style="margin:10px 0 8px 0"><i id="progressBar"></i></div>
        <div class="flex small muted">
          <span class="badge">1 استلام الطلب</span>
          <span class="badge">2 إرسال السيارة</span>
          <span class="badge">3 استلام السيارة</span>
          <span class="badge">4 تم الانتهاء</span>
        </div>
      </div>

      <div class="box">
        <h3>معلومات الطلب</h3>
        <div class="kv">
          <div>رقم الطلب</div><div id="kvId">—</div>
          <div>النوع</div><div id="kvKind">—</div>
          <div>المنشئ</div><div id="kvCreator">—</div>
          <div>الحالة</div><div id="kvStatus">—</div>
          <div>تاريخ الإنشاء</div><div id="kvCreatedAt">—</div>
          <div>مكان التنفيذ</div><div id="kvTo">—</div>
        </div>
      </div>

      <div class="box" style="grid-column:1/-1">
        <h3>المسؤولون حسب المكان (توضيح سريع)</h3>
        <div class="kv" style="grid-template-columns:190px 1fr">
          <div>المكان الحالي (أصل السيارة)</div><div id="kvFromLoc">—</div>
          <div>مكان التنفيذ (نقل/تصوير)</div><div id="kvToLoc">—</div>
          <div>مسؤول المكان الحالي</div><div id="kvFromOwner">—</div>
          <div>مسؤول مكان التنفيذ</div><div id="kvToOwner">—</div>
        </div>
        <div class="hint">المسؤول يظهر حسب المكان (ومن ضمنهم الإدارة تقدر تعمل أي إجراء).</div>
      </div>

      <div class="box" style="grid-column:1/-1">
        <h3>الهياكل داخل الطلب</h3>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>VIN</th>
                <th>السيارة</th>
                <th>المكان الحالي</th>
                <th>مكان التنفيذ</th>
                <th>المرحلة 1</th>
                <th>المرحلة 2</th>
                <th>المرحلة 3</th>
                <th>ملاحظات</th>
              </tr>
            </thead>
            <tbody id="modalRowsTbody">
              <tr><td colspan="8" class="muted">—</td></tr>
            </tbody>
          </table>
        </div>
        <div class="hint">كل مرحلة تظهر: (تم/لا) + اسم المنفذ + ملاحظة المرحلة إن وجدت.</div>
      </div>

      <div class="box" style="grid-column:1/-1">
        <h3>الإجراءات</h3>
        <div class="actions">
          <button class="btn primary" id="act1">1 تم استلام الطلب</button>
          <button class="btn primary" id="act2">2 تم إرسال السيارة</button>
          <button class="btn primary" id="act3">3 تم استلام السيارة</button>
          <button class="btn primary" id="act4">4 تم الانتهاء</button>
          <span class="badge" id="whoCan" style="margin-inline-start:auto">—</span>
        </div>
        <textarea class="input notearea" id="actionNote" placeholder="ملاحظة (تتسجل على الإجراء)…"></textarea>
        <div class="hint">ESC يقفل المودال.</div>
      </div>
    </div>
  </div>
</div>

<script type="module">
/* Firebase v9 (module) */
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import {
  getAuth, onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import {
  getFirestore, collection, doc, getDoc, getDocs, query, where, orderBy, limit, onSnapshot,
  addDoc, serverTimestamp, updateDoc, runTransaction
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {'apiKey': 'AIzaSyC614bGqnYf4Q-weTNemzWENTpa8DjGeHw', 'authDomain': 'mzj-agenda.firebaseapp.com', 'projectId': 'mzj-agenda', 'storageBucket': 'mzj-agenda.firebasestorage.app', 'messagingSenderId': '834700407721', 'appId': '1:834700407721:web:75c17665d4f032fd65cab8'};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* Locations + owners */
const LOCATIONS = ["معرض الملتقى","الاستديو","الصالة الاساسية","صالة القادسية"];
const LOCATION_OWNER = {
  "الاستديو": "Mohammed.ezat1989@gmail.com",
  "الصالة الاساسية": "aldynmtwlys@gmail.com",
  "صالة القادسية": "alaasamak100@gmail.com",
  "معرض الملتقى": "kamelashraf948@gmail.com"
};
const PHOTO_ADMIN_EMAIL = "an9036663@gmail.com";

/* UI refs */
const connDot = document.getElementById('connDot');
const connText = document.getElementById('connText');
const roleText = document.getElementById('roleText');
const locText = document.getElementById('locText');

const tabManageBtn = document.getElementById('tabManageBtn');
const tabCreateBtn = document.getElementById('tabCreateBtn');
const tabDoneBtn = document.getElementById('tabDoneBtn');
const manageView = document.getElementById('manageView');
const createView = document.getElementById('createView');
const doneView = document.getElementById('doneView');

const requestsTbody = document.getElementById('requestsTbody');
const doneTbody = document.getElementById('doneTbody');
const filterKind = document.getElementById('filterKind');
const doneFilterKind = document.getElementById('doneFilterKind');
const searchVin = document.getElementById('searchVin');
const refreshBtn = document.getElementById('refreshBtn');

const createKind = document.getElementById('createKind');
const createToLocation = document.getElementById('createToLocation');
const createTbody = document.getElementById('createTbody');
const submitRequestBtn = document.getElementById('submitRequestBtn');
const clearCreateBtn = document.getElementById('clearCreateBtn');
const createHint = document.getElementById('createHint');

/* Modal */
const modalBackdrop = document.getElementById('modalBackdrop');
const modalCloseBtn = document.getElementById('modalCloseBtn');
const modalTitle = document.getElementById('modalTitle');
const overallPct = document.getElementById('overallPct');
const progressBar = document.getElementById('progressBar');
const kvId = document.getElementById('kvId');
const kvKind = document.getElementById('kvKind');
const kvCreator = document.getElementById('kvCreator');
const kvStatus = document.getElementById('kvStatus');
const kvCreatedAt = document.getElementById('kvCreatedAt');
const kvTo = document.getElementById('kvTo');
const kvFromLoc = document.getElementById('kvFromLoc');
const kvToLoc = document.getElementById('kvToLoc');
const kvFromOwner = document.getElementById('kvFromOwner');
const kvToOwner = document.getElementById('kvToOwner');
const modalRowsTbody = document.getElementById('modalRowsTbody');
const act1 = document.getElementById('act1');
const act2 = document.getElementById('act2');
const act3 = document.getElementById('act3');
const act4 = document.getElementById('act4');
const whoCan = document.getElementById('whoCan');
const actionNote = document.getElementById('actionNote');

/* State */
let currentUser = null;
let userProfile = null;
let isAdmin = false;
let userEmail = "";
let userLocation = ""; // optional single location in profile
let manageUnsub = null;
let doneUnsub = null;
let modalUnsub = null;
let activeRequest = null;

/* Helpers */
const fmtDate = (ts)=>{
  try {
    if(!ts) return "—";
    const d = ts.toDate ? ts.toDate() : new Date(ts);
    return d.toLocaleString("ar-SA");
  } catch(e){ return "—"; }
};
const kindLabel = (k)=> k==="move" ? "نقل" : (k==="shoot" ? "تصوير" : "—");
const escClose = (e)=>{ if(e.key==="Escape") closeModal(); };
document.addEventListener('keydown', escClose);

function setView(which){
  manageView.style.display = which==="manage" ? "" : "none";
  createView.style.display = which==="create" ? "" : "none";
  doneView.style.display = which==="done" ? "" : "none";
  tabManageBtn.classList.toggle('primary', which==="manage");
  tabCreateBtn.classList.toggle('primary', which==="create");
  tabDoneBtn.classList.toggle('primary', which==="done");
  // keep visual
  [tabManageBtn,tabCreateBtn,tabDoneBtn].forEach(b=>b.classList.remove('primary'));
  if(which==="manage") tabManageBtn.classList.add('primary');
  if(which==="create") tabCreateBtn.classList.add('primary');
  if(which==="done") tabDoneBtn.classList.add('primary');
}
tabManageBtn.onclick = ()=>setView("manage");
tabCreateBtn.onclick = ()=>setView("create");
tabDoneBtn.onclick = ()=>setView("done");

function fillToLocations(){
  createToLocation.innerHTML = '<option value="">— اختر مكان التنفيذ —</option>';
  LOCATIONS.forEach(l=>{
    const o=document.createElement('option');
    o.value=l; o.textContent=l;
    createToLocation.appendChild(o);
  });
}
fillToLocations();

function connection(ok){
  connDot.style.background = ok ? "#22c55e" : "#f59e0b";
  connText.textContent = ok ? "متصل" : "جارٍ الاتصال…";
}

async function loadUserProfileByEmail(email){
  // Try doc(uid) first
  try {
    const d = await getDoc(doc(db,"user", currentUser.uid));
    if(d.exists()) return d.data();
  } catch(e){}
  // Fallback query by Email field
  try {
    const qy = query(collection(db,"user"), where("Email","==",email), limit(1));
    const snap = await getDocs(qy);
    if(!snap.empty) return snap.docs[0].data();
  } catch(e){}
  // Try "members" collection if used
  try {
    const qy2 = query(collection(db,"members"), where("email","==",email), limit(1));
    const snap2 = await getDocs(qy2);
    if(!snap2.empty) return snap2.docs[0].data();
  } catch(e){}
  return null;
}

function computeIsAdmin(profile){
  const r = (profile?.role || profile?.Role || "").toString().trim();
  return r==="الإدارة" || r==="ادارة" || r==="admin" || r==="Admin" || r==="الاداره";
}

function getUserLocations(profile){
  // support locations array or single location
  const locs = profile?.locations || profile?.Locations || profile?.location || profile?.Location || [];
  if(Array.isArray(locs)) return locs.map(x=>String(x).trim()).filter(Boolean);
  if(typeof locs === "string" && locs.trim()) return [locs.trim()];
  return [];
}

function ownerForLocation(loc){
  return LOCATION_OWNER[loc] || "—";
}

async function findCarByVin(vin){
  const v = String(vin||"").trim();
  if(!v) return null;
  const qy = query(collection(db,"cars"), where("vin","==",v), limit(1));
  const snap = await getDocs(qy);
  if(snap.empty) return null;
  const d = snap.docs[0];
  return { id:d.id, ...d.data() };
}

function makeEmptyRow(index){
  const tr = document.createElement('tr');
  tr.dataset.idx = String(index);
  tr.innerHTML = `
    <td class="muted">${index+1}</td>
    <td><input class="input vinInput" placeholder="VIN" style="min-width:140px"></td>
    <td class="carName muted">—</td>
    <td class="carVariant muted">—</td>
    <td class="carExt muted">—</td>
    <td class="carInt muted">—</td>
    <td class="carYear muted">—</td>
    <td class="carLoc muted">—</td>
    <td class="execLoc muted">—</td>
    <td><input class="input noteInput" placeholder="اختياري" style="min-width:180px"></td>
    <td><button class="btn danger delBtn" title="حذف">×</button></td>
  `;
  const vinInput = tr.querySelector('.vinInput');
  const delBtn = tr.querySelector('.delBtn');
  delBtn.onclick = ()=>{ tr.remove(); rebuildCreateIndexes(); ensureCreateRows(); };
  vinInput.addEventListener('change', ()=>onVinChanged(tr));
  vinInput.addEventListener('blur', ()=>onVinChanged(tr));
  return tr;
}

function rebuildCreateIndexes(){
  [...createTbody.querySelectorAll('tr')].forEach((tr,i)=>{
    tr.dataset.idx = String(i);
    tr.querySelector('td').textContent = String(i+1);
  });
}

function ensureCreateRows(){
  const rows = [...createTbody.querySelectorAll('tr')];
  if(rows.length===0){
    for(let i=0;i<3;i++) createTbody.appendChild(makeEmptyRow(i));
    return;
  }
  // If last row has VIN and less than 8, add a new row
  const last = rows[rows.length-1];
  const lastVin = last.querySelector('.vinInput')?.value?.trim();
  if(lastVin && rows.length<8) createTbody.appendChild(makeEmptyRow(rows.length));
  // clamp to 8
  while(createTbody.querySelectorAll('tr').length>8) createTbody.lastElementChild.remove();
}

async function onVinChanged(tr){
  const vin = tr.querySelector('.vinInput')?.value?.trim();
  if(!vin) return;
  tr.querySelector('.carName').textContent = "جارٍ التحميل…";
  const car = await findCarByVin(vin);
  if(!car){
    tr.querySelector('.carName').textContent = "غير موجود";
    tr.querySelector('.carVariant').textContent = "—";
    tr.querySelector('.carExt').textContent = "—";
    tr.querySelector('.carInt').textContent = "—";
    tr.querySelector('.carYear').textContent = "—";
    tr.querySelector('.carLoc').textContent = "—";
    tr.querySelector('.execLoc').textContent = "—";
    ensureCreateRows();
    return;
  }
  tr.dataset.carid = car.id;
  tr.dataset.fromloc = (car.location||car.Location||"").toString();
  tr.querySelector('.carName').textContent = (car.car||"—");
  tr.querySelector('.carVariant').textContent = (car.variant||"—");
  tr.querySelector('.carExt').textContent = (car.extColor||car.extcolor||"—");
  tr.querySelector('.carInt').textContent = (car.intColor||car.intcolor||"—");
  tr.querySelector('.carYear').textContent = (car.modelYear||car.year||"—");
  tr.querySelector('.carLoc').textContent = (car.location||"—");
  // execution location from header selection
  tr.querySelector('.execLoc').textContent = createToLocation.value || "—";
  ensureCreateRows();
}

createToLocation.addEventListener('change', ()=>{
  [...createTbody.querySelectorAll('tr')].forEach(tr=>{
    tr.querySelector('.execLoc').textContent = createToLocation.value || "—";
  });
});

createKind.addEventListener('change', ()=>{
  const k = createKind.value;
  createToLocation.value = "";
  fillToLocations();
  createHint.textContent = k==="move"
    ? "طلب نقل: اختر مكان النقل (الوجهة)، واكتب VIN فقط…"
    : "طلب تصوير: اختر مكان التصوير (الاستديو/..)، واكتب VIN فقط…";
});

clearCreateBtn.onclick = ()=>{
  createTbody.innerHTML = "";
  ensureCreateRows();
  actionNote.value="";
};
ensureCreateRows();

/* Permissions model per your sheet */
function canCreateForRows(kind, toLoc, rows){
  if(isAdmin) return {ok:true, reason:""};
  if(!userEmail) return {ok:false, reason:"غير مسجل"};
  if(kind==="shoot" && userEmail !== PHOTO_ADMIN_EMAIL) {
    return {ok:false, reason:"إنشاء طلب تصوير مسموح لمدير التصوير فقط (إلا الإدارة)."};
  }
  if(kind==="move") {
    // creator must be destination owner
    const destOwner = ownerForLocation(toLoc);
    if(destOwner !== userEmail) return {ok:false, reason:"في النقل: منشئ الطلب لازم يكون مسؤول مكان الوجهة (إلا الإدارة)."};
  }
  // For both kinds: allow adding vins from any locations (as per examples)
  return {ok:true, reason:""};
}

function canDoActionOnRequest(req, actionNo){
  if(isAdmin) return true;
  if(!req || !userEmail) return false;
  const creator = req.createdByEmail || req.createdBy || "";
  const toLoc = req.toLocation || req.execLocation || "";
  const destOwner = ownerForLocation(toLoc);

  if(actionNo===4) return (creator===userEmail);
  // actions 1&2 are for each row's fromLocation owner
  // action 3 is destination owner
  if(actionNo===3) return (destOwner===userEmail);
  if(actionNo===1 || actionNo===2) {
    // permitted if user is owner of ANY fromLocation among rows
    const vins = req.vins || [];
    const ok = vins.some(v=> ownerForLocation(v.fromLocation)===userEmail);
    return ok;
  }
  return false;
}

function stagePctForReq(req){
  const vins = req.vins || [];
  if(vins.length===0) return 0;
  let doneSteps=0, totalSteps=0;
  for(const v of vins){
    const st = (req.rowStates && req.rowStates[v.vin]) || {};
    totalSteps += 3; // stages 1-3 per vin
    if(st.step1?.done) doneSteps++;
    if(st.step2?.done) doneSteps++;
    if(st.step3?.done) doneSteps++;
  }
  // request finished counts as extra one step globally
  totalSteps += 1;
  if(req.finished?.done) doneSteps += 1;
  return Math.round((doneSteps/totalSteps)*100);
}

function uniq(arr){
  return [...new Set(arr.filter(Boolean))];
}

function renderManageRow(docId, req){
  const tr = document.createElement('tr');
  tr.style.cursor = "pointer";
  const pct = stagePctForReq(req);
  const vins = (req.vins||[]).map(x=>x.vin).filter(Boolean);
  const froms = uniq((req.vins||[]).map(x=>x.fromLocation));
  const to = req.toLocation || "—";
  tr.innerHTML = `
    <td><b>#${req.number||docId}</b></td>
    <td><span class="badge">${kindLabel(req.kind)}</span></td>
    <td class="small">${vins.slice(0,3).join("، ")}{vins.length>3 ? "… ("+vins.length+")" : ""}</td>
    <td class="small">${froms.join("، ")||"—"}</td>
    <td class="small">${to}</td>
    <td class="small muted">${req.createdByEmail||req.createdBy||"—"}</td>
    <td><span class="badge">${pct}%</span></td>
  `;
  tr.addEventListener('click', ()=>openModal(docId));
  return tr;
}

function renderDoneRow(docId, req){
  const tr = document.createElement('tr');
  const vins = (req.vins||[]).map(x=>x.vin).filter(Boolean);
  const froms = uniq((req.vins||[]).map(x=>x.fromLocation));
  const to = req.toLocation || "—";
  tr.innerHTML = `
    <td><b>#${req.number||docId}</b></td>
    <td><span class="badge">${kindLabel(req.kind)}</span></td>
    <td class="small">${vins.slice(0,3).join("، ")}{vins.length>3 ? "… ("+vins.length+")" : ""}</td>
    <td class="small">${froms.join("، ")||"—"}</td>
    <td class="small">${to}</td>
    <td class="small muted">${req.createdByEmail||req.createdBy||"—"}</td>
    <td class="small">${fmtDate(req.finished?.at || req.completedAt)}</td>
  `;
  tr.addEventListener('click', ()=>openModal(docId));
  return tr;
}

function listenManage(){
  if(manageUnsub) manageUnsub();
  const qy = query(collection(db,"requests"), orderBy("createdAt","desc"));
  manageUnsub = onSnapshot(qy, (snap)=>{
    const kind = filterKind.value;
    const needle = (searchVin.value||"").trim();
    const rows = [];
    snap.forEach(d=>{
      const req = d.data();
      const isDone = !!req.finished?.done;
      if(isDone) return;
      if(kind!=="all" && req.kind!==kind) return;
      if(needle){
        const vins = (req.vins||[]).map(x=>String(x.vin||""));
        if(!vins.some(v=>v.includes(needle))) return;
      }
      rows.push(renderManageRow(d.id, req));
    });
    requestsTbody.innerHTML = "";
    if(rows.length===0){
      const tr=document.createElement('tr');
      tr.innerHTML = `<td colspan="7" class="muted">لا توجد طلبات حالياً.</td>`;
      requestsTbody.appendChild(tr);
    } else {
      rows.forEach(r=>requestsTbody.appendChild(r));
    }
  }, (err)=>{
    requestsTbody.innerHTML = `<tr><td colspan="7" class="muted">حدث خطأ في التحميل.</td></tr>`;
    console.error(err);
  });
}

function listenDone(){
  if(doneUnsub) doneUnsub();
  const qy = query(collection(db,"requests"), orderBy("createdAt","desc"));
  doneUnsub = onSnapshot(qy, (snap)=>{
    const kind = doneFilterKind.value;
    const rows = [];
    snap.forEach(d=>{
      const req = d.data();
      const isDone = !!req.finished?.done;
      if(!isDone) return;
      if(kind!=="all" && req.kind!==kind) return;
      rows.push(renderDoneRow(d.id, req));
    });
    doneTbody.innerHTML = "";
    if(rows.length===0){
      const tr=document.createElement('tr');
      tr.innerHTML = `<td colspan="7" class="muted">لا توجد طلبات مكتملة.</td>`;
      doneTbody.appendChild(tr);
    } else {
      rows.forEach(r=>doneTbody.appendChild(r));
    }
  });
}

filterKind.onchange = ()=>listenManage();
doneFilterKind.onchange = ()=>listenDone();
searchVin.addEventListener('input', ()=>listenManage());
refreshBtn.onclick = ()=>listenManage();

/* Create request */
submitRequestBtn.onclick = async ()=>{
  try {
    if(!currentUser) return alert("غير مسجل");
    const kind = createKind.value;
    const toLoc = createToLocation.value;
    if(!toLoc) return alert("اختر مكان التنفيذ");
    // gather rows with VIN
    const trs = [...createTbody.querySelectorAll('tr')];
    const vins = [];
    for(const tr of trs){
      const vin = tr.querySelector('.vinInput')?.value?.trim();
      if(!vin) continue;
      const fromLoc = tr.dataset.fromloc || "";
      const note = tr.querySelector('.noteInput')?.value?.trim() || "";
      if(!fromLoc) {
        return alert("VIN غير محمّل/غير موجود: " + vin);
      }
      vins.push({ vin, fromLocation: fromLoc, toLocation: toLoc, note });
    }
    if(vins.length===0) return alert("اكتب VIN واحد على الأقل");
    if(vins.length>8) return alert("الحد الأقصى 8 هياكل");

    const perm = canCreateForRows(kind, toLoc, vins);
    if(!perm.ok) return alert(perm.reason);

    submitRequestBtn.disabled = true;

    // counter
    const counterRef = doc(db,"meta","requests_counter");
    const requestRef = await runTransaction(db, async (tx)=>{
      const cSnap = await tx.get(counterRef);
      let next = 1;
      if(cSnap.exists()) next = (cSnap.data().last||0) + 1;
      tx.set(counterRef, { last: next }, { merge:true });
      // create request
      const reqCol = collection(db,"requests");
      const reqDocRef = doc(reqCol);
      const rowStates = {};
      for(const v of vins){
        rowStates[v.vin] = {
          step1: {done:false, at:null, byEmail:"", byName:"", note:""},
          step2: {done:false, at:null, byEmail:"", byName:"", note:""},
          step3: {done:false, at:null, byEmail:"", byName:"", note:""}
        };
      }
      tx.set(reqDocRef, {
        number: next,
        kind,
        toLocation: toLoc,
        createdAt: serverTimestamp(),
        createdByUid: currentUser.uid,
        createdByEmail: userEmail,
        createdByName: userProfile?.Name || userProfile?.name || "",
        vins,
        rowStates,
        finished: {done:false, at:null, byEmail:"", byName:"", note:""}
      });
      return reqDocRef;
    });

    alert("تم إنشاء الطلب");
    createTbody.innerHTML = "";
    ensureCreateRows();
    setView("manage");
  } catch(e) {
    console.error(e);
    alert("حدث خطأ أثناء إنشاء الطلب");
  } finally {
    submitRequestBtn.disabled = false;
  }
};

/* Modal logic */
function openModal(reqId){
  closeModal();
  modalBackdrop.classList.add('show');
  actionNote.value = "";
  const ref = doc(db,"requests",reqId);
  modalUnsub = onSnapshot(ref, (snap)=>{
    if(!snap.exists()) return;
    const req = snap.data();
    activeRequest = { id:reqId, ...req };
    renderModal(activeRequest);
  });
}

function closeModal(){
  modalBackdrop.classList.remove('show');
  if(modalUnsub) modalUnsub();
  modalUnsub=null;
  activeRequest=null;
}
modalCloseBtn.onclick = closeModal;
modalBackdrop.addEventListener('click', (e)=>{ if(e.target===modalBackdrop) closeModal(); });

function renderModal(req){
  modalTitle.textContent = `تفاصيل الطلب #${req.number||req.id}`;
  kvId.textContent = `#${req.number||req.id}`;
  kvKind.textContent = kindLabel(req.kind);
  kvCreator.textContent = req.createdByEmail || "—";
  kvStatus.textContent = req.finished?.done ? "مكتمل" : "قيد التنفيذ";
  kvCreatedAt.textContent = fmtDate(req.createdAt);
  kvTo.textContent = req.toLocation || "—";

  const vins = req.vins || [];
  const froms = uniq(vins.map(v=>v.fromLocation));
  const toLoc = req.toLocation || "";
  kvFromLoc.textContent = froms.join("، ") || "—";
  kvToLoc.textContent = toLoc || "—";
  // owners: if multiple froms, show list
  kvFromOwner.textContent = froms.length ? froms.map(l=>`${l} — ${ownerForLocation(l)}`).join(" | ") : "—";
  kvToOwner.textContent = toLoc ? `${toLoc} — ${ownerForLocation(toLoc)}` : "—";

  // table rows
  modalRowsTbody.innerHTML = "";
  if(vins.length===0){
    const tr=document.createElement('tr');
    tr.innerHTML = `<td colspan="8" class="muted">لا توجد هياكل داخل الطلب.</td>`;
    modalRowsTbody.appendChild(tr);
  } else {
    for(const v of vins){
      const st = (req.rowStates && req.rowStates[v.vin]) || {};
      const s1 = st.step1 || {};
      const s2 = st.step2 || {};
      const s3 = st.step3 || {};
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td><b>${v.vin}</b></td>
        <td class="muted">${v.carName||""}</td>
        <td>${v.fromLocation||"—"}</td>
        <td>${req.toLocation||"—"}</td>
        <td class="small">${s1.done ? "✅ "+(s1.byEmail||"") : "—"}</td>
        <td class="small">${s2.done ? "✅ "+(s2.byEmail||"") : "—"}</td>
        <td class="small">${s3.done ? "✅ "+(s3.byEmail||"") : "—"}</td>
        <td class="small muted">${[s1.note,s2.note,s3.note].filter(Boolean).join(" | ") || "—"}</td>
      `;
      modalRowsTbody.appendChild(tr);
    }
  }

  // progress
  const pct = stagePctForReq(req);
  overallPct.textContent = `${pct}%`;
  progressBar.style.width = `${pct}%`;

  // action enabled
  act1.disabled = !canDoActionOnRequest(req,1);
  act2.disabled = !canDoActionOnRequest(req,2);
  act3.disabled = !canDoActionOnRequest(req,3);
  act4.disabled = !canDoActionOnRequest(req,4) || !!req.finished?.done;

  whoCan.textContent = isAdmin ? "أنت (الإدارة): تقدر تعمل أي إجراء." : "الصلاحيات حسب المكان/المنشئ.";
}

async function logActivity(payload){
  try {
    await addDoc(collection(db,"mzj_activity_log"), {
      ...payload,
      createdAt: serverTimestamp()
    });
  } catch(e){ /* ignore if no permission */ }
}

function userName(){
  return userProfile?.Name || userProfile?.name || "";
}

async function applyAction(actionNo){
  if(!activeRequest) return;
  const req = activeRequest;
  if(!canDoActionOnRequest(req, actionNo)) return alert("لا توجد صلاحية");
  const note = actionNote.value.trim();

  const reqRef = doc(db,"requests", req.id);
  await runTransaction(db, async (tx)=>{
    const snap = await tx.get(reqRef);
    if(!snap.exists()) throw new Error("missing");
    const cur = snap.data();
    const vins = cur.vins || [];
    const rowStates = cur.rowStates || {};

    const now = new Date();
    const byEmail = userEmail;
    const byName = userName();

    if(actionNo===4){
      if(cur.finished?.done) return;
      tx.update(reqRef, {
        "finished": { done:true, at: serverTimestamp(), byEmail, byName, note }
      });
      return;
    }

    // actions 1 & 2: apply to vins where current user is owner of fromLocation OR admin
    // action 3: apply to vins where current user is owner of destination OR admin
    for(const v of vins){
      const vin = v.vin;
      const fromLoc = v.fromLocation;
      const toLoc = cur.toLocation;
      const allow = isAdmin || (actionNo===3 ? ownerForLocation(toLoc)===byEmail : ownerForLocation(fromLoc)===byEmail);
      if(!allow) continue;
      const st = rowStates[vin] || { step1:{done:false}, step2:{done:false}, step3:{done:false} };
      if(actionNo===1 && !st.step1?.done){
        st.step1 = { done:true, at: serverTimestamp(), byEmail, byName, note };
      }
      if(actionNo===2 && st.step1?.done && !st.step2?.done){
        st.step2 = { done:true, at: serverTimestamp(), byEmail, byName, note };
      }
      if(actionNo===3 && st.step2?.done && !st.step3?.done){
        st.step3 = { done:true, at: serverTimestamp(), byEmail, byName, note };
        // update car location when received at destination (move OR shoot)
        // We'll update cars collection doc by VIN lookup (best-effort outside tx) -> cannot tx across query
      }
      rowStates[vin] = st;
    }
    tx.update(reqRef, { rowStates });
  });

  // After stage3, update cars location (best effort)
  try {
    const reqNowSnap = await getDoc(doc(db,"requests",req.id));
    if(reqNowSnap.exists()){
      const cur = reqNowSnap.data();
      const toLoc = cur.toLocation;
      const vins = cur.vins||[];
      for(const v of vins){
        const st = cur.rowStates?.[v.vin];
        if(st?.step3?.done){
          // find car by VIN
          const car = await findCarByVin(v.vin);
          if(car){
            await updateDoc(doc(db,"cars",car.id), { location: toLoc, updatedAt: serverTimestamp() });
          }
        }
      }
    }
  } catch(e){ console.warn(e); }

  await logActivity({
    requestId: req.id,
    requestNumber: req.number||null,
    actionNo,
    note,
    byEmail: userEmail,
    byName: userName()
  });

  actionNote.value = "";
}

act1.onclick = ()=>applyAction(1);
act2.onclick = ()=>applyAction(2);
act3.onclick = ()=>applyAction(3);
act4.onclick = ()=>applyAction(4);

/* Start */
setView("manage");
connection(false);

onAuthStateChanged(auth, async (u)=>{
  currentUser = u;
  if(!u){
    connection(false);
    roleText.textContent = "—";
    locText.textContent = "—";
    requestsTbody.innerHTML = `<tr><td colspan="7" class="muted">غير مسجل.</td></tr>`;
    doneTbody.innerHTML = `<tr><td colspan="7" class="muted">غير مسجل.</td></tr>`;
    return;
  }
  userEmail = (u.email||"").toLowerCase();
  connection(true);

  userProfile = await loadUserProfileByEmail(u.email||"");
  isAdmin = computeIsAdmin(userProfile);
  const locs = getUserLocations(userProfile);
  userLocation = locs[0] || "";
  roleText.textContent = (userProfile?.role || userProfile?.Role || (isAdmin ? "الإدارة" : "—")) || "—";
  locText.textContent = isAdmin ? "كل الفروع" : (userLocation || "—");

  listenManage();
  listenDone();
});
</script>
</body>
</html>
