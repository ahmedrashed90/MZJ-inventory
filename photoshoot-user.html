
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>MZJ Workspace — الطلبات</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
<style>
:root{
  --brown:#3e2420;
  --beige:#bc8f74;
  --cream:#fff8ef;

  --text:#111827;
  --muted:#6b7280;
  --line:rgba(62,36,32,.12);

  --ok:#16a34a;
  --warn:#f59e0b;
  --err:#ef4444;

  --r12:12px;
  --r16:16px;
  --r20:20px;

  --shadow1:0 10px 35px rgba(15, 23, 42, .10);
  --shadow2:0 25px 70px rgba(15, 23, 42, .16);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:"Tajawal",system-ui,-apple-system,Segoe UI,Roboto,Arial;
  color:var(--text);
  background:
    radial-gradient(1200px 500px at 20% -10%, rgba(188,143,116,.18), transparent 60%),
    radial-gradient(900px 500px at 80% 0%, rgba(62,36,32,.14), transparent 60%),
    linear-gradient(180deg,#fff8ef,#fff3e9 40%, #fff8ef);
}
a{color:inherit;text-decoration:none}
button,input,select{font-family:inherit}

/* Topbar */
.topbar{
  position:sticky;top:0;z-index:50;
  backdrop-filter: blur(12px) saturate(140%);
  background: rgba(255,255,255,.76);
  border-bottom:1px solid var(--line);
}
.topbar-inner{
  max-width:1280px;margin:0 auto;
  padding:14px 18px;
  display:flex;gap:14px;align-items:center;justify-content:space-between;flex-wrap:wrap;
}
.brand{display:flex;gap:10px;align-items:center;min-width:260px}
.brandMark{
  width:44px;height:44px;border-radius:16px;
  background: linear-gradient(145deg, var(--brown), #241110);
  box-shadow: 0 14px 28px rgba(62,36,32,.22);
  display:flex;align-items:center;justify-content:center;
  color:#fff;font-weight:900;letter-spacing:.5px;
}
.brandText{display:flex;flex-direction:column;gap:2px}
.brandText b{font-size:15px;color:var(--brown);line-height:1}
.brandText small{font-size:12px;color:var(--muted);line-height:1.1}

/* Primary Tabs (Orders / New Request) */
.primaryTabs{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.pTab{
  border:1px solid var(--line);
  background:rgba(255,255,255,.92);
  color:var(--brown);
  font-weight:900;
  padding:10px 16px;
  border-radius:999px;
  cursor:pointer;
  transition:.18s ease;
}
.pTab:hover{transform:translateY(-1px);box-shadow:0 12px 28px rgba(15,23,42,.08)}
.pTab.active{background:var(--brown);border-color:var(--brown);color:#fff}

/* Chips */
.chips{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.chip{
  display:inline-flex;gap:8px;align-items:center;
  padding:8px 10px;border-radius:999px;
  border:1px solid var(--line);
  background:rgba(255,255,255,.92);
  font-size:12px;font-weight:900;color:var(--brown);
}
.dot{width:8px;height:8px;border-radius:999px;background:var(--beige)}
.chip.ok{border-color:rgba(22,163,74,.25);background:rgba(240,253,244,.9);color:#14532d}
.chip.err{border-color:rgba(239,68,68,.25);background:rgba(254,242,242,.9);color:#7f1d1d}

/* Buttons/Inputs */
.btn{
  border:1px solid var(--line);
  background:rgba(255,255,255,.95);
  color:var(--brown);
  padding:10px 12px;
  border-radius:12px;
  font-weight:900;
  cursor:pointer;
  display:inline-flex;gap:8px;align-items:center;
  transition:.18s ease;
}
.btn:hover{transform:translateY(-1px);box-shadow:0 14px 30px rgba(15,23,42,.10)}
.btn.primary{background:var(--brown);border-color:var(--brown);color:#fff}
.btn.danger{background:rgba(254,242,242,.95);border-color:rgba(239,68,68,.25);color:#7f1d1d}
.btn:disabled{opacity:.5;cursor:not-allowed;transform:none;box-shadow:none}

.input, select{
  border:1px solid rgba(62,36,32,.14);
  background:rgba(255,255,255,.95);
  border-radius:14px;
  padding:11px 12px;
  outline:none;
  min-width:220px;
  font-weight:800;
}
.input:focus, select:focus{
  border-color:rgba(188,143,116,.9);
  box-shadow:0 0 0 5px rgba(188,143,116,.18);
}
.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
.small{font-size:12px;color:var(--muted)}

/* Layout */
.wrap{max-width:1280px;margin:0 auto;padding:18px}
.card{
  background:rgba(255,255,255,.92);
  border:1px solid var(--line);
  border-radius:20px;
  box-shadow:var(--shadow1);
  overflow:hidden;
}
.cardHd{
  padding:16px 16px;
  display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap;
  border-bottom:1px solid rgba(62,36,32,.08);
  background:
    radial-gradient(800px 220px at 20% -30%, rgba(188,143,116,.20), transparent 60%),
    linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,250,246,.92));
}
.title{display:flex;flex-direction:column;gap:4px}
.title h2{margin:0;font-size:16px;color:var(--brown);letter-spacing:.2px}
.title small{color:var(--muted);font-size:12px}
.cardBd{padding:16px}

/* Table */
.tableWrap{
  border:1px solid rgba(62,36,32,.10);
  border-radius:16px;
  overflow:hidden;
  background:rgba(255,255,255,.95);
}
table{width:100%;border-collapse:separate;border-spacing:0;min-width:980px}
th,td{padding:12px 12px;border-bottom:1px solid rgba(62,36,32,.08);font-size:13px;vertical-align:top}
th{
  background:rgba(255,248,239,.92);
  color:var(--brown);
  font-weight:900;
  position:sticky;top:0;z-index:1;
}
tbody tr:hover td{background:rgba(255,253,251,.92)}
.pill{
  display:inline-flex;align-items:center;gap:8px;
  padding:6px 10px;border-radius:999px;
  border:1px solid transparent;
  font-size:12px;font-weight:900;
}
.pill.ok{background:rgba(236,253,245,.92);color:#065f46;border-color:rgba(167,243,208,.75)}
.pill.warn{background:rgba(255,251,235,.92);color:#92400e;border-color:rgba(253,230,138,.85)}
.progress{height:10px;background:rgba(62,36,32,.12);border-radius:999px;overflow:hidden}
.progress > div{height:100%;background:var(--brown);width:0%;transition:width .12s linear}

/* New Request */
.twoCol{display:grid;grid-template-columns:1fr 1fr;gap:14px}
@media(max-width:980px){.twoCol{grid-template-columns:1fr}}
.box{
  border:1px solid rgba(62,36,32,.10);
  border-radius:18px;
  background:rgba(255,255,255,.92);
  padding:14px;
}
.box b{color:var(--brown)}
.vinRow{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px}
.vinList{display:flex;gap:10px;flex-direction:column;margin-top:12px}
.vinItem{
  border:1px solid rgba(62,36,32,.10);
  background:rgba(255,253,251,.92);
  border-radius:16px;
  padding:12px;
  display:flex;gap:12px;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;
}
.vinItem .left{display:flex;flex-direction:column;gap:4px}
.vinItem .left .vin{font-weight:900;color:var(--brown)}
.vinItem .left .loc{font-size:12px;color:var(--muted)}
.vinItem .meta{font-size:12px;color:var(--muted);white-space:pre-line}
.vinItem .actions{display:flex;gap:8px;align-items:center}

/* Modal */
.backdrop{
  position:fixed;inset:0;z-index:1000;
  background:rgba(15,23,42,.55);
  display:none;align-items:center;justify-content:center;
  padding:16px;
}
.backdrop.show{display:flex}
.modal{
  width:100%;
  max-width:1040px;
  border-radius:24px;
  overflow:hidden;
  background:rgba(255,255,255,.94);
  border:1px solid rgba(255,255,255,.28);
  box-shadow:var(--shadow2);
}
.modalHd{
  padding:16px 18px;
  display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
  border-bottom:1px solid rgba(62,36,32,.10);
  background:
    radial-gradient(900px 260px at 20% -40%, rgba(188,143,116,.25), transparent 60%),
    linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,248,239,.92));
}
.modalHd h3{margin:0;color:var(--brown);font-size:16px;font-weight:900}
.modalBd{padding:18px}
.grid2{display:grid;grid-template-columns:1.05fr .95fr;gap:14px}
@media(max-width:980px){.grid2{grid-template-columns:1fr}}
.pre{
  margin-top:10px;
  padding:12px;
  border-radius:18px;
  border:1px dashed rgba(188,143,116,.50);
  background:rgba(255,253,251,.92);
  font-size:12px;
  line-height:1.8;
  white-space:pre-line;
}
.stageBtns{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}

/* Toast */
.toast{
  position:fixed;left:18px;bottom:18px;z-index:2000;
  background:#111827;color:#fff;
  padding:10px 12px;border-radius:14px;
  opacity:0;transform:translateY(10px);
  transition:.2s;
}
.toast.show{opacity:1;transform:none}
.hidden{display:none!important}

/* Create modal table inputs */
.cellInput, .cellSelect{
  width:100%;
  border:1px solid var(--line);
  background:#fff;
  border-radius:999px;
  padding:10px 12px;
  font-family:inherit;
  font-size:13px;
  outline:none;
}
.cellInput:focus, .cellSelect:focus{
  border-color:#dcc3b2;
  box-shadow:0 0 0 4px rgba(220,195,178,.35);
}
.cellMuted{ color:var(--muted); font-size:12px; }
.btnX{
  width:36px;height:36px;border-radius:999px;border:1px solid var(--line);
  background:#fff; cursor:pointer; display:inline-flex; align-items:center; justify-content:center;
}
.btnX:hover{ background:#f6eee7; }
.pill{
  display:inline-flex; align-items:center; gap:6px;
  padding:6px 10px; border-radius:999px; border:1px solid var(--line); background:#fff;
  font-size:12px; white-space:nowrap;
}
.pill.bad{ border-color:#f3c0c0; background:#fff7f7; color:#7a1f1f;}
.pill.ok{ border-color:#cfead6; background:#f3fbf6; color:#14532d;}

</style>
</head>

<body>

<div class="topbar">
  <div class="topbar-inner">
    <div class="brand">
      <div class="brandMark">MZJ</div>
      <div class="brandText">
        <b>محمد بن ذعار العجمي للسيارات</b>
        <small>Workspace • إدارة الطلبات</small>
      </div>
    </div>

    <div class="chips">
      <span class="chip" id="authBadge"><span class="dot"></span>جارٍ الاتصال…</span>
      <span class="chip" id="roleBadge">الدور: —</span>
      <span class="chip" id="locBadge">الأماكن: —</span>
      <span class="chip" id="projBadge">Project: —</span>
      <button class="btn danger" id="btnSignOut" style="display:none">تسجيل خروج</button>
    </div>
  </div>
</div>

<div class="wrap">

  <!-- ORDERS TAB -->
  <section id="ordersTab">
    <div class="card">
      <div class="cardHd">
        <div class="title">
          <h2>إدارة الطلبات</h2>
          <small>بحث VIN • فتح المودال للتنفيذ — تحديث لحظي بدون Refresh</small>
        </div>
        <div class="controls">
          <select id="filterKind">
            <option value="all">الكل</option>
            <option value="move">نقل</option>
            <option value="shoot">تصوير</option>
          </select>
          <input class="input mono" id="searchVin" placeholder="بحث برقم الهيكل VIN" />
          <button class="btn" id="btnOpenCreate">طلب جديد</button>
          <button class="btn primary" id="btnRefresh">تحديث</button>
        </div>
      </div>

      <div class="cardBd">
        <div class="tableWrap">
          <div style="overflow:auto">
            <table>
              <thead>
                <tr>
                  <th>رقم</th>
                  <th>نوع</th>
                  <th>VINs</th>
                  <th>من</th>
                  <th>إلى</th>
                  <th>المنشئ</th>
                  <th>التقدم</th>
                  <th>فتح</th>
                </tr>
              </thead>
              <tbody id="reqTbody">
                <tr><td colspan="8" class="small">جارٍ التحميل…</td></tr>
              </tbody>
            </table>
          </div>
        </div>
        <div class="small" style="margin-top:10px">
          هيكل VIN داخل الطلب: <b class="mono">vins: [{vin, fromLocation}]</b> — المصدر الأساسي للمكان: <b class="mono">inventory/{VIN}</b>
        </div>
      </div>
    </div>
  </section>

  </div>



<!-- Create Request Modal (Table-style) -->
<div class="backdrop" id="createBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" style="max-width:1200px">
    <div class="modalHd">
      <h3>إنشاء طلب سريع</h3>
      <div class="controls">
        <button class="btn" id="btnCloseCreate">إغلاق</button>
      </div>
    </div>

    <div class="modalBd">
      <div class="small" style="margin-bottom:10px">
        اكتب رقم الهيكل فقط — سيتم سحب البيانات تلقائياً من <span class="mono">inventory/{VIN}</span>.
        الطلب يدعم أكثر من رقم هيكل. يمكنك اختيار <b>نوع الطلب</b> لكل سطر (نقل / تصوير).
      </div>

      <div class="tableWrap" style="border:1px solid var(--line); border-radius:14px; overflow:auto;">
        <table class="table" id="createTable" style="min-width:1080px">
          <thead>
            <tr>
              <th style="width:52px">#</th>
              <th style="width:150px">نوع الطلب</th>
              <th style="width:160px">رقم الهيكل (VIN)</th>
              <th>السيارة</th>
              <th style="width:160px">البيان</th>
              <th style="width:110px">الخارجي</th>
              <th style="width:110px">الداخلي</th>
              <th style="width:90px">الموديل</th>
              <th style="width:210px">مكان السيارة</th>
              <th style="width:210px">مكان التصوير / النقل</th>
              <th style="width:170px">ملاحظة</th>
              <th style="width:70px">حذف</th>
            </tr>
          </thead>
          <tbody id="createTbody"></tbody>
        </table>
      </div>

      <div class="row" style="margin-top:14px; justify-content:flex-end; gap:10px">
        <button class="btn" id="btnClearDraft">تفريغ</button>
        <button class="btn primary" id="btnSubmitDraft">إرسال الطلب</button>
      </div>

      <div class="small" id="createHint" style="margin-top:10px; color:var(--muted)">
        ملاحظة: لو كتبت VIN خارج أماكن المستخدم، سيتم منعه تلقائياً (إلا Admin).
      </div>
    </div>
  </div>
</div>


<!-- Modal -->
<div class="backdrop" id="modalBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <div class="modalHd">
      <h3 id="modalTitle">تفاصيل الطلب</h3>
      <div class="controls">
        <button class="btn" id="btnCloseModal">إغلاق</button>
      </div>
    </div>
    <div class="modalBd">
      <div class="grid2">
        <div class="box">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
            <div>
              <b>التقدم العام</b>
              <div class="small" id="modalMeta">—</div>
            </div>
            <div style="min-width:240px">
              <div class="progress"><div id="modalProgressBar"></div></div>
              <div class="small" id="modalProgressText" style="margin-top:6px">0%</div>
            </div>
          </div>
          <div class="pre" id="modalStages">—</div>
        </div>

        <div class="box">
          <div>
            <b>إجراءات</b>
            <div class="small">الأزرار حسب الأماكن + Admin • تم الانتهاء = منشئ الطلب</div>
          </div>

          <div class="stageBtns">
            <button class="btn" id="btnStageReceived">1) تم استلام الطلب</button>
            <button class="btn" id="btnStageSent">2) تم إرسال السيارة</button>
            <button class="btn" id="btnStageArrived">3) تم استلام السيارة</button>
            <button class="btn primary" id="btnStageFinished">4) تم الانتهاء</button>
          </div>

          <div class="pre" id="permHint" style="margin-top:12px">—</div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
import { getAuth, onAuthStateChanged, setPersistence, browserLocalPersistence, signOut } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, updateDoc, serverTimestamp, collection, query, orderBy, limit, onSnapshot, where, getDocs } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

/** Firebase Config */
const firebaseConfig = {
  apiKey: "AIzaSyC614bGqnYf4Q-weTNemzWENTpa8DjGeHw",
  authDomain: "mzj-agenda.firebaseapp.com",
  projectId: "mzj-agenda",
  storageBucket: "mzj-agenda.firebasestorage.app",
  messagingSenderId: "834700407721",
  appId: "1:834700407721:web:75c17665d4f032fd65cab8"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
try{ await setPersistence(auth, browserLocalPersistence); }catch(e){}

const el=(id)=>document.getElementById(id);
const authBadge=el("authBadge");
const roleBadge=el("roleBadge");
const locBadge=el("locBadge");
const projBadge=el("projBadge");
const btnSignOut=el("btnSignOut");

projBadge.textContent = "Project: " + (firebaseConfig.projectId || "—");

let currentUser=null;
let userProfile=null;
let requestsUnsub=null;
let modalUnsub=null;
let activeReqId=null;

/** Draft 
/* =========================
   CREATE REQUEST (TABLE)
========================= */
const createBackdrop = el("createBackdrop");
const btnOpenCreate  = el("btnOpenCreate");
const btnCloseCreate = el("btnCloseCreate");
const createTbody    = el("createTbody");
const btnClearDraft  = el("btnClearDraft");
const btnSubmitDraft = el("btnSubmitDraft");

let draftRows = [];

function makeEmptyRow(){
  return {
    type: "shoot",   // shoot | move
    vin: "",
    carName: "",
    trim: "",
    ext: "",
    int: "",
    model: "",
    fromLocation: "",
    targetLocation: "",
    note: "",
    status: "idle", // idle | loading | ok | blocked | notfound
    msg: ""
  };
}
function ensureRows(n=8){
  if(draftRows.length===0){
    for(let i=0;i<n;i++) draftRows.push(makeEmptyRow());
  }
}

function isAdmin(){
  return normalizeRole(userProfile?.role||"") === "admin";
}

function rowCanUseVin(r){
  if(isAdmin()) return true;
  const locs = (userProfile?.locations||[]);
  return !!r.fromLocation && locs.includes(r.fromLocation);
}

function renderCreateTable(){
  ensureRows(8);
  createTbody.innerHTML = "";
  draftRows.forEach((r, idx)=>{
    const tr = document.createElement("tr");
    const statusPill = (() => {
      if(r.status==="loading") return `<span class="pill">جارٍ التحميل…</span>`;
      if(r.status==="ok") return `<span class="pill ok">جاهز</span>`;
      if(r.status==="blocked") return `<span class="pill bad">غير مصرح</span>`;
      if(r.status==="notfound") return `<span class="pill bad">غير موجود</span>`;
      return `<span class="pill">—</span>`;
    })();

    tr.innerHTML = `
      <td class="mono">${idx+1}</td>

      <td>
        <select class="cellSelect" data-k="type" data-i="${idx}">
          <option value="shoot" ${r.type==="shoot"?"selected":""}>طلب تصوير</option>
          <option value="move" ${r.type==="move"?"selected":""}>طلب نقل</option>
        </select>
      </td>

      <td>
        <input class="cellInput mono" data-k="vin" data-i="${idx}" placeholder="VIN" value="${escapeHtml(r.vin)}" />
        <div class="cellMuted" style="margin-top:6px">${statusPill} ${r.msg?`<span class="cellMuted">${escapeHtml(r.msg)}</span>`:""}</div>
      </td>

      <td>${r.carName?escapeHtml(r.carName):"—"}</td>
      <td>${r.trim?escapeHtml(r.trim):"—"}</td>
      <td>${r.ext?escapeHtml(r.ext):"—"}</td>
      <td>${r.int?escapeHtml(r.int):"—"}</td>
      <td class="mono">${r.model?escapeHtml(r.model):"—"}</td>

      <td>${r.fromLocation?escapeHtml(r.fromLocation):"—"}</td>

      <td>
        <input class="cellInput" data-k="targetLocation" data-i="${idx}"
          placeholder="${r.type==='shoot'?'مكان التصوير (مثال: الاستديو)':'الوجهة (toLocation)'}"
          value="${escapeHtml(r.targetLocation)}" />
      </td>

      <td>
        <input class="cellInput" data-k="note" data-i="${idx}" placeholder="اختياري" value="${escapeHtml(r.note)}" />
      </td>

      <td style="text-align:center">
        <button class="btnX" title="حذف السطر" data-k="del" data-i="${idx}">✕</button>
      </td>
    `;
    createTbody.appendChild(tr);
  });

  // Delegate events
  createTbody.querySelectorAll("[data-k]").forEach(elm=>{
    const k = elm.getAttribute("data-k");
    const i = +elm.getAttribute("data-i");
    if(k==="del"){
      elm.addEventListener("click", ()=>{
        draftRows.splice(i,1);
        if(draftRows.length<8) draftRows.push(makeEmptyRow());
        renderCreateTable();
      });
      return;
    }
    if(k==="vin"){
      elm.addEventListener("keydown",(e)=>{
        if(e.key==="Enter"){
          e.preventDefault();
          loadVinIntoRow(i);
          setTimeout(()=>{
            const next = createTbody.querySelector(`[data-k="vin"][data-i="${Math.min(i+1,draftRows.length-1)}"]`);
            next?.focus?.();
          }, 50);
        }
      });
      elm.addEventListener("blur", ()=>{
        const v = (elm.value||"").trim();
        if(v && v!==draftRows[i].vin){ draftRows[i].vin = v; loadVinIntoRow(i); }
      });
      elm.addEventListener("input", ()=>{
        draftRows[i].vin = (elm.value||"").trim();
      });
      return;
    }
    if(k==="type"){
      elm.addEventListener("change", ()=>{
        draftRows[i].type = elm.value;
        renderCreateTable();
      });
      return;
    }
    elm.addEventListener("input", ()=>{
      draftRows[i][k] = elm.value;
    });
  });
}

async function loadVinIntoRow(i){
  const r = draftRows[i];
  const vin = (r.vin||"").trim();
  if(!vin) return;

  r.status = "loading";
  r.msg = "";
  renderCreateTable();

  try{
    const invRef = doc(db, "inventory", vin);
    const snap = await getDoc(invRef);
    if(!snap.exists()){
      r.status = "notfound";
      r.msg = "VIN غير موجود في inventory";
      renderCreateTable();
      return;
    }
    const inv = snap.data() || {};
    r.carName = inv.car || inv.carName || inv.makeModel || inv.name || inv.title || "";
    r.trim = inv.trim || inv.variant || inv.statement || inv.desc || "";
    r.ext = inv.extColor || inv.exterior || inv.exteriorColor || inv.colorExt || "";
    r.int = inv.intColor || inv.interior || inv.interiorColor || inv.colorInt || "";
    r.model = String(inv.model || inv.year || inv.modelYear || "");
    r.fromLocation = inv.location || inv.branch || inv.place || "";

    if(!rowCanUseVin(r)){
      r.status = "blocked";
      r.msg = "ممنوع إنشاء طلب لهيكل خارج أماكن المستخدم";
      renderCreateTable();
      return;
    }

    r.status = "ok";
    r.msg = "";
    renderCreateTable();

    if(i===draftRows.length-1){
      draftRows.push(makeEmptyRow());
      renderCreateTable();
    }
  }catch(err){
    r.status = "blocked";
    r.msg = (err?.message||"خطأ").slice(0,120);
    renderCreateTable();
  }
}

function getValidDraftRows(){
  return draftRows
    .map(r=>({ ...r, vin:(r.vin||"").trim(), targetLocation:(r.targetLocation||"").trim() }))
    .filter(r=>r.vin);
}

function canSubmit(){
  const rows = getValidDraftRows();
  if(rows.length===0) return {ok:false, msg:"اكتب VIN واحد على الأقل."};

  for(const r of rows){
    if(r.status!=="ok") return {ok:false, msg:`VIN ${r.vin}: غير جاهز (تأكد أنه موجود ومصرح).`};
    if(!r.targetLocation) return {ok:false, msg:`VIN ${r.vin}: اكتب ${r.type==="shoot"?"مكان التصوير":"الوجهة"}.`};
  }
  return {ok:true, msg:""};
}

function resetDraft(){
  draftRows = [];
  ensureRows(8);
  renderCreateTable();
}

function openCreate(){
  if(!currentUser){ toast("غير مسجل", true); return; }
  createBackdrop.classList.add("show");
  ensureRows(8);
  renderCreateTable();
  setTimeout(()=>{ 
    const firstVin = createTbody.querySelector('[data-k="vin"][data-i="0"]');
    firstVin?.focus?.();
  }, 0);
}
function closeCreate(){ createBackdrop.classList.remove("show"); }

btnOpenCreate?.addEventListener("click", openCreate);
btnCloseCreate?.addEventListener("click", closeCreate);
createBackdrop?.addEventListener("click",(e)=>{ if(e.target===createBackdrop) closeCreate(); });

btnClearDraft?.addEventListener("click", ()=>{
  resetDraft();
  toast("تم تفريغ القائمة");
});

btnSubmitDraft?.addEventListener("click", async ()=>{
  const chk = canSubmit();
  if(!chk.ok){ toast(chk.msg, true); return; }

  const rows = getValidDraftRows();
  const groups = rows.reduce((acc,r)=>{ (acc[r.type] ||= []).push(r); return acc; }, {});
  btnSubmitDraft.disabled = true;
  btnSubmitDraft.textContent = "جارٍ الإرسال…";

  try{
    for(const [type, list] of Object.entries(groups)){
      const reqId = await nextRequestId();
      const reqDoc = doc(db, "requests", String(reqId));
      const payloadRows = list.map(r=>({
        vin: r.vin,
        type: r.type,
        car: r.carName || "",
        trim: r.trim || "",
        ext: r.ext || "",
        int: r.int || "",
        model: r.model || "",
        fromLocation: r.fromLocation || "",
        targetLocation: r.targetLocation || "",
        note: r.note || "",
        progress: { step1:false, step2:false, step3:false, step4:false },
        ts: serverTimestamp()
      }));
      const kind = (type==="move") ? "move" : "shoot";

      await setDoc(reqDoc, {
        kind,
        createdAt: nowIso(),
        createdByUid: currentUser?.email || currentUser?.uid || "",
        createdByEmail: currentUser?.email || "",
        createdByName: userProfile?.name || "",
        canEdit: true,
        rows: payloadRows,
        progress: { overall: 0, step1: 0, step2: 0, step3: 0, step4: 0 },
        status: "open",
      }, { merge:true });

      await logActivity(`إنشاء طلب ${kind} #${reqId}`, `تم إنشاء الطلب رقم #${reqId} بعدد ${payloadRows.length} VIN`);
    }

    toast("تم إرسال الطلب ✅");
    closeCreate();
    resetDraft();
    await refreshOrders();
  }catch(err){
    toast("فشل إرسال الطلب: " + (err?.message||"خطأ"), true);
  }finally{
    btnSubmitDraft.disabled = false;
    btnSubmitDraft.textContent = "إرسال الطلب";
  }
});

/* ESC closes whichever modal is open (create first, then details) */
document.addEventListener("keydown",(e)=>{
  if(e.key!=="Escape") return;
  if(createBackdrop?.classList.contains("show")){ closeCreate(); return; }
  if(el("modalBackdrop")?.classList.contains("show")){ closeModal(); return; }
});


cation).filter(Boolean),

    createdByUid: currentUser.uid,
    createdByName: currentUser.email || "",
    createdAt: new Date().toISOString(),
    updatedAt: serverTimestamp(),
    canEdit:true,
    stages:{received:{done:false},sent:{done:false},arrived:{done:false},finished:{done:false}},
    progress:0
  };

  try{
    await setDoc(doc(db,"requests",reqId), payload);
    toast("تم إنشاء الطلب ✅");
    closeCreate();
    draftVins = [];
    el("newTo").value="";
    

  }catch(e){
    toast("فشل إنشاء الطلب: "+(e.message||e), true);
  }
});



/* Boot */
onAuthStateChanged(auth, async (u)=>{
  currentUser = u || null;
  if(!u){
    userProfile=null;
    setAuthUI();
    el("reqTbody").innerHTML = `<tr><td colspan="8" class="small">سجّل دخول من صفحة الـ Workspace الأساسية ثم افتح هذه الصفحة على نفس الدومين.</td></tr>`;
    return;
  }
  userProfile = await loadUserProfile(u);
  setAuthUI();
  watchRequests();
});


async function logActivity(action, details){
  try{
    const ref = doc(collection(db, "mzj_activity_log"));
    await setDoc(ref, {
      action: action || "",
      details: details || "",
      ts: serverTimestamp(),
      date: new Date().toISOString().slice(0,10),
      user: currentUserProfile?.name || currentUser?.email || ""
    });
  }catch(e){ /* ignore */ }
}

</script>

</body>
</html>
