

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>MZJ Workspace — إدارة الطلبات</title>

<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

<style>
:root{
  --brown:#3e2420;
  --beige:#e8d6c8;
  --cream:#fff8ef;
  --text:#1f2937;
  --muted:#6b7280;
  --line:#ead9cc;
  --card:#ffffff;
  --radius:14px;
  --ok:#0f5132;
  --okbg:#f3fff6;
  --warn:#7a1010;
  --warnbg:#fff5f5;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:'Tajawal', sans-serif;
  background:var(--cream);
  color:var(--text);
}

/* =======================
   TOP BAR (كما طلبت)
======================= */
.dashboard-topbar{
  background:#fff;
  border-bottom:1px solid var(--beige);
  padding:14px 20px;
  position:sticky;
  top:0;
  z-index:50;
}
.dashboard-tabs{
  display:flex;
  gap:10px;
  overflow-x:auto;
  white-space:nowrap;
}
.dashboard-tabs::-webkit-scrollbar{height:4px}
.dashboard-tabs::-webkit-scrollbar-thumb{
  background:#dcc3b2;
  border-radius:10px;
}
.dashboard-tab{
  padding:10px 18px;
  border-radius:999px;
  border:1px solid var(--beige);
  background:#fff;
  color:var(--brown);
  font-size:14px;
  font-weight:500;
  line-height:1;
  white-space:nowrap;
  cursor:pointer;
  transition:all .2s ease;
}
.dashboard-tab:hover{background:#f6eee7}
.dashboard-tab.active{
  background:var(--brown);
  color:#fff;
  border-color:var(--brown);
}

.container{max-width:1200px;margin:18px auto;padding:0 16px 60px}
.card{
  background:var(--card);
  border:1px solid var(--line);
  border-radius:var(--radius);
  box-shadow:0 10px 26px rgba(62,36,32,.06);
}
.card-hd{
  padding:14px 16px;
  border-bottom:1px solid var(--line);
  display:flex;
  gap:10px;
  align-items:center;
  justify-content:space-between;
  flex-wrap:wrap;
}
.card-hd h2{margin:0;font-size:16px;font-weight:900;color:var(--brown)}
.card-bd{padding:14px 16px}

.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.spacer{flex:1}

.badge{
  display:inline-flex;align-items:center;gap:8px;
  padding:8px 10px;border-radius:999px;font-size:13px;
  border:1px solid var(--line);background:#fff;color:var(--brown);
}
.small{font-size:12px;color:var(--muted)}

.btn{
  border:1px solid var(--line);
  background:#fff;
  color:var(--brown);
  border-radius:12px;
  padding:10px 12px;
  font-weight:900;
  cursor:pointer;
  transition:.15s ease;
  display:inline-flex;
  gap:8px;
  align-items:center;
  justify-content:center;
}
.btn:hover{background:#f7f0ea}
.btn.primary{background:var(--brown);border-color:var(--brown);color:#fff}
.btn.primary:hover{filter:brightness(.95)}
.btn.danger{background:#b42318;border-color:#b42318;color:#fff}
.btn.danger:hover{filter:brightness(.95)}
.btn[disabled]{opacity:.55;cursor:not-allowed}

.input,.select, .small-input{
  padding:10px 12px;border-radius:12px;border:1px solid var(--line);
  background:#fff;min-width:220px;
  font-family:inherit;
}
.small-input{min-width:0;padding:8px 10px;border-radius:10px;font-size:13px}
/* ===== Create table compact mode ===== */
#inner-create .table th, #inner-create .table td{font-size:12px;padding:6px 8px}
#inner-create .small-input{padding:6px 8px;font-size:12px;border-radius:8px}
#inner-create .req-vin{width:70px}
#inner-create .req-year{width:70px}
#inner-create .req-ext,#inner-create .req-int{width:90px}
#inner-create .req-location{width:110px}
#inner-create .req-place{width:110px}
.mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
.center{text-align:center}

.hr{height:1px;background:var(--line);margin:12px 0}

.alert{margin-top:10px;padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#fff;color:var(--text);font-size:13px}
.alert.err{border-color:#f2b8b5;background:var(--warnbg);color:var(--warn)}
.alert.ok{border-color:#b7e3c5;background:var(--okbg);color:var(--ok)}

.tableWrap{overflow:auto;border:1px solid var(--line);border-radius:12px}
.table{width:100%;border-collapse:collapse}
.table th,.table td{
  padding:10px 10px;
  border-bottom:1px solid var(--line);
  font-size:13px;
  vertical-align:middle;
  background:#fff;
}
.table th{background:#faf6f2;color:var(--brown);font-weight:900}
.table tr:last-child td{border-bottom:none}
.muted{color:var(--muted)}

/* Inner tabs */
.inner-tabs{display:flex;gap:10px;flex-wrap:wrap}
.inner-tab{
  padding:10px 14px;border-radius:999px;border:1px solid var(--line);
  background:#fff;color:var(--brown);font-weight:900;cursor:pointer;
}
.inner-tab.active{background:var(--brown);border-color:var(--brown);color:#fff}

/* Modal */
.modal-backdrop{
  position:fixed;inset:0;background:rgba(0,0,0,.35);
  display:none;align-items:center;justify-content:center;z-index:1000;padding:18px;
}
.modal{
  width:min(1100px, 100%);
  max-height:92vh;
  overflow:auto;
  background:#fff;
  border-radius:18px;
  border:1px solid var(--line);
  box-shadow:0 20px 60px rgba(0,0,0,.25);
}
.modal-hd{
  padding:14px 16px;
  border-bottom:1px solid var(--line);
  display:flex;align-items:center;gap:10px;justify-content:space-between;
  flex-wrap:wrap;
}
.modal-hd .title{font-weight:900;color:var(--brown);font-size:16px}
.modal-bd{padding:14px 16px}
.modal-ft{
  padding:12px 12px;
  border-top:1px solid var(--line);
  background:#faf6f2;
}
.ft-grid{display:grid;grid-template-columns:repeat(6,minmax(0,1fr));gap:10px}
@media (max-width:920px){.ft-grid{grid-template-columns:repeat(3,minmax(0,1fr))}}
@media (max-width:520px){.ft-grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
.ft-btn{width:100%;border-radius:14px;padding:12px 10px}

/* Progress */
.progress-wrap{padding:12px;border:1px solid var(--line);border-radius:14px;background:#fff}
.progress-row{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px}
.progress-row .p-title{font-weight:900;color:var(--brown);font-size:13px}
.progress-row .p-val{color:var(--muted);font-size:12px}
.bar{height:10px;background:#f2e8e0;border-radius:999px;overflow:hidden}
.bar>div{height:100%;background:var(--brown);width:0%;transition:width .2s ease}
.stage-grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px;margin-top:10px}
@media (max-width:920px){.stage-grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
.stage{border:1px solid var(--line);border-radius:14px;padding:10px;background:#fff}
.stage .s-title{font-weight:900;color:var(--brown);font-size:12px}
.stage .s-val{color:var(--muted);font-size:12px;margin-top:4px}
</style>
</head>

<body>

<!-- TOP BAR -->
<div class="dashboard-topbar">
  <div class="dashboard-tabs">
    <div class="dashboard-tab active" data-page="orders">إدارة الطلبات</div>
    <div class="dashboard-tab" data-page="cars">كل السيارات</div>
    <div class="dashboard-tab" data-page="activity">سجل النشاط</div>
  </div>
</div>

<div class="container">

  <!-- LOGIN CARD -->
  <div class="card" id="loginCard">
    <div class="card-hd">
      <h2>تسجيل الدخول</h2>
      <div class="row">
        <span class="badge" id="authState">جارٍ الاتصال…</span>
        <span class="badge" id="roleBadge">—</span>
        <span class="badge" id="locBadge">—</span>
        <button class="btn" id="btnLogout" style="display:none"><i class="fa-solid fa-right-from-bracket"></i>تسجيل خروج</button>
      </div>
    </div>
    <div class="card-bd">
      <div class="row">
        <input class="input" id="loginEmail" type="email" placeholder="البريد الإلكتروني" autocomplete="email">
        <input class="input" id="loginPass" type="password" placeholder="كلمة المرور" autocomplete="current-password">
        <button class="btn primary" id="btnLogin"><i class="fa-solid fa-right-to-bracket"></i>تسجيل الدخول</button>
      </div>
      <div class="alert" id="loginMsg" style="display:none"></div>
      <div class="small" style="margin-top:8px">يفتح فقط من خلال https أو localhost (مش file://).</div>
    </div>
  </div>

  <!-- ORDERS PAGE -->
  <div class="card" id="page-orders" style="display:none; margin-top:14px">
    <div class="card-hd">
      <h2>الطلبات</h2>
      <div class="inner-tabs">
        <button class="inner-tab active" data-inner="create">إنشاء طلب</button>
        <button class="inner-tab" data-inner="manage">إدارة الطلبات</button>
        <button class="inner-tab" data-inner="done">الطلبات المكتملة</button>
      </div>
    </div>

    <!-- Create -->
    <div class="card-bd" id="inner-create">
      <div class="row">
        <input class="input" id="reqBy" placeholder="مقدم الطلب" readonly>
        <select class="select" id="reqType">
          <option value="auto" selected>تحديد تلقائي من الصفوف</option>
          <option value="shoot">تصوير فقط</option>
          <option value="move">نقل فقط</option>
        </select>
        <button class="btn" id="btnAddRow"><i class="fa-solid fa-plus"></i>إضافة سيارة</button>
        <button class="btn" id="btnResetRows"><i class="fa-solid fa-rotate"></i>إعادة ضبط الجدول</button>
        <span class="spacer"></span>
        <button class="btn primary" id="btnSubmit"><i class="fa-solid fa-paper-plane"></i>إنشاء الطلب</button>
      </div>

      <div class="hr"></div>

      <div class="small">اكتب VIN في الصف — البيانات بتنزل تلقائي من <b>stock</b> (mzj_admin_state/v1). التنفيذ النهائي على <b>requests</b> + <b>rows</b>.</div>

      <div class="tableWrap" style="margin-top:10px">
        <table class="table">
          <thead>
            <tr>
              <th style="width:60px" class="center">#</th>
              <th style="width:120px">نوع</th>
              <th style="width:60px">VIN</th>
              <th>السيارة</th>
              <th>الفئة</th>
              <th style="width:40px">الخارجي</th>
              <th style="width:40px">الداخلي</th>
              <th style="width:90px" class="center">الموديل</th>
              <th style="width:120px">المكان</th>
              <th style="width:120px" id="placeHeader">مكان التصوير</th>
              <th style="width:80px">ملاحظة</th>
              <th style="width:70px" class="center">مسح</th>
            </tr>
          </thead>
          <tbody id="reqRowsBody"></tbody>
        </table>
      </div>
    </div>

    <!-- Manage -->
    <div class="card-bd" id="inner-manage" style="display:none">
      <div class="row">
        <select class="select" id="filterKind">
          <option value="all">الكل</option>
          <option value="shoot">تصوير</option>
          <option value="move">نقل</option>
          <option value="mixed">مختلط</option>
        </select>
        <input class="input" id="searchBox" placeholder="بحث: رقم الطلب / المنشئ / VIN">
        <span class="spacer"></span>
        <span class="badge" id="manageCount">—</span>
      </div>

      <div class="tableWrap" style="margin-top:10px">
        <table class="table">
          <thead>
            <tr>
              <th style="width:90px">رقم</th>
              <th style="width:90px">النوع</th>
              <th>الحالة</th>
              <th style="width:200px">المنشئ</th>
              <th style="width:170px">آخر تحديث</th>
              <th style="width:130px">إجراءات</th>
            </tr>
          </thead>
          <tbody id="ordersTbody"></tbody>
        </table>
      </div>
    </div>

    <!-- Done -->
    <div class="card-bd" id="inner-done" style="display:none">
      <div class="small">يعرض الطلبات المكتملة فقط.</div>
      <div class="tableWrap" style="margin-top:10px">
        <table class="table">
          <thead>
            <tr>
              <th style="width:90px">رقم</th>
              <th style="width:90px">النوع</th>
              <th style="width:200px">المنشئ</th>
              <th style="width:170px">وقت الإنهاء</th>
              <th style="width:130px">فتح</th>
            </tr>
          </thead>
          <tbody id="doneTbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- CARS -->
  <div class="card" id="page-cars" style="display:none; margin-top:14px">
    <div class="card-hd"><h2>كل السيارات</h2><span class="small">مصدر الـ Auto-fill هو stock من mzj_admin_state/v1.</span></div>
    <div class="card-bd">
      <div class="row">
        <input class="input mono" id="vinLookup" placeholder="ابحث عن VIN">
        <button class="btn" id="btnLookup"><i class="fa-solid fa-magnifying-glass"></i>بحث</button>
        <span class="spacer"></span>
        <span class="badge" id="stockCount">—</span>
      </div>
      <div class="alert" id="lookupRes" style="display:none"></div>
    </div>
  </div>

  <!-- ACTIVITY -->
  <div class="card" id="page-activity" style="display:none; margin-top:14px">
    <div class="card-hd"><h2>سجل النشاط</h2><span class="small">مرئي للإدارة فقط</span></div>
    <div class="card-bd">
      <div class="small" id="activityHint">—</div>
      <div class="tableWrap" style="margin-top:10px">
        <table class="table">
          <thead><tr><th style="width:180px">الوقت</th><th style="width:200px">المستخدم</th><th>الإجراء</th><th>التفاصيل</th></tr></thead>
          <tbody id="activityTbody"></tbody>
        </table>
      </div>
    </div>
  </div>

</div>

<!-- MODAL -->
<div class="modal-backdrop" id="modalBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <div class="modal-hd">
      <div class="title" id="modalTitle">تفاصيل الطلب</div>
      <div class="row">
        <span class="badge" id="modalMeta">—</span>
        <button class="btn" id="btnCloseModal"><i class="fa-solid fa-xmark"></i>إغلاق</button>
      </div>
    </div>

    <div class="modal-bd">
      <div class="progress-wrap">
        <div class="progress-row"><div class="p-title">Progress عام</div><div class="p-val" id="overallVal">0%</div></div>
        <div class="bar"><div id="overallBar"></div></div>

        <div class="stage-grid">
          <div class="stage"><div class="s-title">1) تم استلام الطلب</div><div class="s-val" id="s1Val">0/0 — 0%</div><div class="bar" style="margin-top:6px"><div id="s1Bar"></div></div></div>
          <div class="stage"><div class="s-title">2) تم إرسال السيارة</div><div class="s-val" id="s2Val">0/0 — 0%</div><div class="bar" style="margin-top:6px"><div id="s2Bar"></div></div></div>
          <div class="stage"><div class="s-title">3) تم استلام السيارة</div><div class="s-val" id="s3Val">0/0 — 0%</div><div class="bar" style="margin-top:6px"><div id="s3Bar"></div></div></div>
          <div class="stage"><div class="s-title">4) تم الانتهاء</div><div class="s-val" id="s4Val">—</div><div class="bar" style="margin-top:6px"><div id="s4Bar"></div></div></div>
        </div>
      </div>

      <div class="hr"></div>

      <div class="tableWrap">
        <table class="table">
          <thead><tr>
            <th style="width:60px" class="center">#</th>
            <th style="width:140px">VIN</th>
            <th>السيارة</th>
            <th style="width:170px">المكان</th>
            <th style="width:170px">الوجهة</th>
            <th style="width:110px">النوع</th>
            <th style="width:160px">حالة التنفيذ</th>
            <th style="width:220px">تعديل الوجهة</th>
          </tr></thead>
          <tbody id="rowsTbody"></tbody>
        </table>
      </div>

      <div class="small" style="margin-top:10px" id="permHint">—</div>
    </div>

    <div class="modal-ft">
      <div class="ft-grid">
        <button class="btn ft-btn" id="btnEditReq"><i class="fa-solid fa-pen-to-square"></i>تعديل الطلب</button>
        <button class="btn primary ft-btn" id="btnStep1">1 تم استلام الطلب</button>
        <button class="btn primary ft-btn" id="btnStep2">2 تم إرسال السيارة</button>
        <button class="btn primary ft-btn" id="btnStep3">3 تم استلام السيارة</button>
        <button class="btn primary ft-btn" id="btnStep4"><i class="fa-solid fa-flag-checkered"></i>4 تم الانتهاء</button>
        <button class="btn ft-btn" id="btnRefreshModal"><i class="fa-solid fa-rotate"></i>تحديث</button>
      </div>
      <div class="small" style="margin-top:8px">ترتيب التنفيذ ثابت: 1 → 2 → 3 → 4 (الإنهاء لمقدم الطلب + الإدارة).</div>
    </div>
  </div>
</div>

<!-- Firebase (Compat) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
/* =======================
   CONFIG (إلزامي)
======================= */
const firebaseConfig = {
     apiKey: "AIzaSyC614bGqnYf4Q-weTNemzWENTpa8DjGeHw",
    authDomain: "mzj-agenda.firebaseapp.com",
    projectId: "mzj-agenda",
    storageBucket: "mzj-agenda.firebasestorage.app",
    messagingSenderId: "834700407721",
    appId: "1:834700407721:web:75c17665d4f032fd65cab8" // الصق config هنا (نفس مشروع mzj-agenda)
  // apiKey: "...",
  // authDomain: "...",
  // projectId: "mzj-agenda",
  // ...
};

try{ firebase.initializeApp(firebaseConfig); }catch(e){}

const auth = firebase.auth();
const db   = firebase.firestore();

// refs
const authState = document.getElementById('authState');
const roleBadge = document.getElementById('roleBadge');
const locBadge  = document.getElementById('locBadge');
const btnLogout = document.getElementById('btnLogout');

const loginMsg  = document.getElementById('loginMsg');
const loginCard = document.getElementById('loginCard');

const pageOrders   = document.getElementById('page-orders');
const pageCars     = document.getElementById('page-cars');
const pageActivity = document.getElementById('page-activity');

const innerTabs = document.querySelectorAll('.inner-tab');
const innerCreate = document.getElementById('inner-create');
const innerManage = document.getElementById('inner-manage');
const innerDone   = document.getElementById('inner-done');

const reqBy = document.getElementById('reqBy');
const reqRowsBody = document.getElementById('reqRowsBody');
const placeHeaderEl = document.getElementById('placeHeader');
const btnAddRow = document.getElementById('btnAddRow');
const btnResetRows = document.getElementById('btnResetRows');
const btnSubmit = document.getElementById('btnSubmit');
const reqType = document.getElementById('reqType');

const filterKind = document.getElementById('filterKind');
const searchBox  = document.getElementById('searchBox');
const ordersTbody = document.getElementById('ordersTbody');
const doneTbody   = document.getElementById('doneTbody');
const manageCount = document.getElementById('manageCount');

const vinLookup = document.getElementById('vinLookup');
const btnLookup = document.getElementById('btnLookup');
const lookupRes = document.getElementById('lookupRes');
const stockCount = document.getElementById('stockCount');

const activityHint = document.getElementById('activityHint');
const activityTbody = document.getElementById('activityTbody');

// Modal
const modalBackdrop = document.getElementById('modalBackdrop');
const btnCloseModal = document.getElementById('btnCloseModal');
const btnRefreshModal = document.getElementById('btnRefreshModal');
const modalTitle = document.getElementById('modalTitle');
const modalMeta  = document.getElementById('modalMeta');
const rowsTbody  = document.getElementById('rowsTbody');
const permHint   = document.getElementById('permHint');

const overallVal = document.getElementById('overallVal');
const overallBar = document.getElementById('overallBar');
const s1Val = document.getElementById('s1Val');
const s2Val = document.getElementById('s2Val');
const s3Val = document.getElementById('s3Val');
const s4Val = document.getElementById('s4Val');
const s1Bar = document.getElementById('s1Bar');
const s2Bar = document.getElementById('s2Bar');
const s3Bar = document.getElementById('s3Bar');
const s4Bar = document.getElementById('s4Bar');

const btnEditReq = document.getElementById('btnEditReq');
const btnStep1 = document.getElementById('btnStep1');
const btnStep2 = document.getElementById('btnStep2');
const btnStep3 = document.getElementById('btnStep3');
const btnStep4 = document.getElementById('btnStep4');

// state
let currentUser = null;
let userProfile = null; // from user/{uid}
let stock = [];         // from mzj_admin_state/v1 -> data.stock
let unsubState = null;
let unsubRequests = null;
let unsubDone = null;
let unsubActivity = null;

let openRequestId = null;
let openRequestDoc = null;
let openRows = [];
let unsubOpenReq = null;
let unsubOpenRows = null;
let editMode = false;

// helpers
function showAlert(type, text){
  loginMsg.style.display='block';
  loginMsg.className = 'alert ' + (type==='err' ? 'err' : 'ok');
  loginMsg.textContent = text;
}
function normalizeVin(v){
  return String(v||"").trim().toUpperCase().replace(/\s+/g,'');
}
function myEmail(){ return currentUser ? (currentUser.email||"") : ""; }
function myUid(){ return currentUser ? (currentUser.uid||"") : ""; }
function myName(){ return (userProfile && userProfile.name) ? userProfile.name : (currentUser ? (currentUser.displayName||currentUser.email||"") : ""); }
function myRole(){ return userProfile ? (userProfile.role||"") : ""; }
function myLocations(){ return (userProfile && Array.isArray(userProfile.locations)) ? userProfile.locations : []; }
function isAdmin(){ return myRole()==="الادارة"; }
function isIdari(){ return myRole()==="اداري"; }
function includesLoc(loc){ return myLocations().includes(loc); }
function fmtTs(ts){
  if(!ts) return "—";
  try{
    if(ts.toDate) return ts.toDate().toISOString().replace('T',' ').slice(0,19);
  }catch(e){}
  return "—";
}
function kindLabel(k){ return k==="shoot" ? "تصوير" : (k==="move" ? "نقل" : (k==="mixed"?"مختلط":"—")); }
function statusLabel(req){ return (req && req.finishedAt) ? "مكتملة" : "تحت المتابعة"; }
function isCreator(req){
  const em = (req && req.createdByEmail) ? req.createdByEmail : "";
  return em && em === myEmail();
}
function rowSourcePlace(r){ return r.location || r.fromLocation || ""; }
function rowDestPlace(r){
  if(r.kind==="shoot") return r.shootPlace || "";
  return r.toLocation || "";
}

function setProfileBadges(){
  authState.textContent = currentUser ? "مسجل ✅" : "غير مسجل";
  roleBadge.textContent = userProfile ? ("الدور: " + (myRole()||"—")) : "—";
  locBadge.textContent  = userProfile ? ("الأماكن: " + (myLocations().length||0)) : "—";
}

function showPage(page){
  // top tabs
  document.querySelectorAll('.dashboard-tab').forEach(t=>t.classList.remove('active'));
  document.querySelector('.dashboard-tab[data-page="'+page+'"]')?.classList.add('active');
  pageOrders.style.display = (page==='orders') ? 'block' : 'none';
  pageCars.style.display = (page==='cars') ? 'block' : 'none';
  pageActivity.style.display = (page==='activity') ? 'block' : 'none';
}

document.querySelectorAll('.dashboard-tab').forEach(tab=>{
  tab.addEventListener('click', ()=>showPage(tab.dataset.page));
});

function showInner(which){
  innerTabs.forEach(t=>t.classList.remove('active'));
  document.querySelector('.inner-tab[data-inner="'+which+'"]')?.classList.add('active');
  innerCreate.style.display = (which==='create')?'block':'none';
  innerManage.style.display = (which==='manage')?'block':'none';
  innerDone.style.display   = (which==='done')  ?'block':'none';
}
innerTabs.forEach(t=>t.addEventListener('click', ()=>showInner(t.dataset.inner)));

function openModal(){
  modalBackdrop.style.display='flex';
  modalBackdrop.setAttribute('aria-hidden','false');
}
function closeModal(){
  modalBackdrop.style.display='none';
  modalBackdrop.setAttribute('aria-hidden','true');
  editMode=false;
  openRequestId=null; openRequestDoc=null; openRows=[];
  rowsTbody.innerHTML='';
  if(unsubOpenReq){unsubOpenReq();unsubOpenReq=null;}
  if(unsubOpenRows){unsubOpenRows();unsubOpenRows=null;}
}
btnCloseModal.addEventListener('click', closeModal);
modalBackdrop.addEventListener('click', e=>{ if(e.target===modalBackdrop) closeModal(); });
document.addEventListener('keydown', e=>{ if(e.key==='Escape' && modalBackdrop.style.display==='flex') closeModal(); });

/* =======================
   Stock (Auto-fill source)
======================= */
function watchAdminState(){
  if(unsubState){unsubState();unsubState=null;}
  unsubState = db.collection("mzj_admin_state").doc("v1").onSnapshot(snap=>{
    const data = snap.exists ? (snap.data()||{}) : {};
    stock = Array.isArray(data.stock) ? data.stock : [];
    stockCount.textContent = "stock: " + stock.length;
  });
}

function updatePlaceHeader(){
  // If any row kind = move => header = مكان النقل else مكان التصوير
  const kinds = Array.from(reqRowsBody.querySelectorAll('.req-kind')).map(el=>el.value);
  const anyMove = kinds.includes('move');
  placeHeaderEl.textContent = anyMove ? "مكان النقل" : "مكان التصوير";
}

/* =======================
   Create Request (8 rows)
======================= */
const SHOOT_PLACES = ["الاستديو","الصالة الاساسية","صالة القادسية","معرض الملتقى"];

function renumberRows(){
  Array.from(reqRowsBody.querySelectorAll('tr')).forEach((tr, idx)=>{
    const c = tr.querySelector('td.center');
    if(c) c.textContent = String(idx+1);
  });
}

function addFormRow(prefill={}){
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td class="center">1</td>
    <td>
      <select class="small-input req-kind">
        <option value="shoot" selected>طلب تصوير</option>
        <option value="move">طلب نقل</option>
      </select>
    </td>
    <td><input class="small-input mono req-vin req-vin" placeholder="VIN"></td>
    <td><input class="small-input req-car" readonly placeholder="—"></td>
    <td><input class="small-input req-variant" readonly placeholder="—"></td>
    <td><input class="small-input req-ext req-ext" readonly placeholder="—"></td>
    <td><input class="small-input req-int req-int" readonly placeholder="—"></td>
    <td class="center"><input class="small-input center req-year req-year" readonly placeholder="—"></td>
    <td><input class="small-input req-location req-location" readonly placeholder="—"></td>
    <td>
      <select class="small-input req-place req-place">
        <option value="">— اختر —</option>
        ${SHOOT_PLACES.map(p=> p ? `<option value="${p}">${p}</option>` : "").join("")}
      </select>
    </td>
    <td><input class="small-input req-note" placeholder="اختياري"></td>
    <td class="center">
      <button type="button" class="btn danger req-row-remove" title="حذف الصف">
        <i class="fa-solid fa-trash"></i>
      </button>
    </td>
  `;
  reqRowsBody.appendChild(tr);

  // Prefill if provided
  if(prefill.kind) tr.querySelector('.req-kind').value = prefill.kind;
  if(prefill.vin) tr.querySelector('.req-vin').value = prefill.vin;
  if(prefill.place) tr.querySelector('.req-place').value = prefill.place;
  if(prefill.note) tr.querySelector('.req-note').value = prefill.note;

  reqBy.value = myName();
  updatePlaceHeader();
  renumberRows();
}

function buildFormRows(){
  // default: 1 row only
  reqRowsBody.innerHTML='';
  addFormRow();
}

btnAddRow.addEventListener('click', ()=>addFormRow());
btnResetRows.addEventListener('click', buildFormRows);
reqRowsBody.addEventListener('change', (e)=>{
  if(e.target.closest('.req-kind')) updatePlaceHeader();
});

// Remove row (or clear if it's the last row)
reqRowsBody.addEventListener('click', (e)=>{
  const btn = e.target.closest('.req-row-remove');
  if(!btn) return;
  const tr = btn.closest('tr');

  // لو ده آخر صف: امسح البيانات بدل الحذف
  const totalRows = reqRowsBody.querySelectorAll('tr').length;
  if(totalRows<=1){
    tr.querySelectorAll('input,select').forEach(el=>{
      if(el.classList.contains('req-kind')) el.value='shoot';
      else if(el.classList.contains('req-place')) el.value='';
      else el.value='';
    });
  }else{
    tr.remove();
  }
  updatePlaceHeader();
  renumberRows();
});

// Auto fill on blur of VIN (✅ requirement)
reqRowsBody.addEventListener('blur', (e)=>{
  const vinInput = e.target.closest('.req-vin');
  if(!vinInput) return;
  const norm = normalizeVin(vinInput.value);
  vinInput.value = norm;
  if(!norm) return;

  const rec = stock.find(r=> normalizeVin(r.vin)===norm);
  const tr = vinInput.closest('tr');

  if(rec){
    tr.querySelector(".req-car").value      = rec.car || "";
    tr.querySelector(".req-variant").value  = rec.variant || "";
    tr.querySelector(".req-ext").value      = rec.extColor || "";
    tr.querySelector(".req-int").value      = rec.intColor || "";
    tr.querySelector(".req-year").value     = rec.modelYear || "";
    tr.querySelector(".req-location").value = rec.location || "";
  }else{
    tr.querySelector(".req-car").value      = "";
    tr.querySelector(".req-variant").value  = "";
    tr.querySelector(".req-ext").value      = "";
    tr.querySelector(".req-int").value      = "";
    tr.querySelector(".req-year").value     = "";
    tr.querySelector(".req-location").value = "";
  }
}, true);

function collectRows(){
  const rows=[];
  reqRowsBody.querySelectorAll('tr').forEach(tr=>{
    const vin = normalizeVin(tr.querySelector('.req-vin')?.value||'');
    if(!vin) return;
    const kind = tr.querySelector('.req-kind')?.value || 'shoot';
    const car = tr.querySelector('.req-car')?.value||'';
    const variant = tr.querySelector('.req-variant')?.value||'';
    const extColor = tr.querySelector('.req-ext')?.value||'';
    const intColor = tr.querySelector('.req-int')?.value||'';
    const modelYear = tr.querySelector('.req-year')?.value||'';
    const location = tr.querySelector('.req-location')?.value||'';
    const place = tr.querySelector('.req-place')?.value||'';
    const note = tr.querySelector('.req-note')?.value||'';

    rows.push({
      vin, kind, car, variant, extColor, intColor, modelYear,
      location,
      shootPlace: kind==='shoot' ? place : "",
      toLocation: kind==='move' ? place : "",
      note,
      steps: {}
    });
  });
  return rows;
}

function computeRequestKind(rows){
  const forced = reqType.value;
  if(forced==='shoot' || forced==='move') return forced;
  const kinds = Array.from(new Set(rows.map(r=>r.kind)));
  if(kinds.length===1) return kinds[0];
  return 'mixed';
}

async function logAction(action, details){
  try{
    await db.collection("mzj_activity_log").add({
      action, details,
      userEmail: myEmail(),
      userName: myName(),
      ts: firebase.firestore.FieldValue.serverTimestamp(),
      date: new Date().toISOString().slice(0,10),
    });
  }catch(e){}
}

btnSubmit.addEventListener('click', async ()=>{
  const rows = collectRows();
  if(!rows.length){
    alert("اكتب على الأقل VIN واحد.");
    return;
  }
  // Ensure place selected for each row
  const missing = rows.some(r=>{
    const dest = r.kind==='shoot' ? r.shootPlace : r.toLocation;
    return !dest;
  });
  if(missing){
    alert("لازم تختار مكان التصوير/النقل لكل VIN.");
    return;
  }

  btnSubmit.disabled = true;
  try{
    const kind = computeRequestKind(rows);
    // Create request
    const reqRef = await db.collection("requests").add({
      kind,
      status: "تحت المتابعة",
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
      createdByUid: myUid(),
      createdByEmail: myEmail(),
      createdByName: myName(),
      total: rows.length
    });

    // Write rows as subcollection (docId = VIN to avoid duplicates)
    const batch = db.batch();
    rows.forEach(r=>{
      const rowId = r.vin; // stable
      const rowRef = reqRef.collection("rows").doc(rowId);
      batch.set(rowRef, {
        ...r,
        __vinLower: r.vin.toLowerCase(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      }, {merge:true});
    });
    await batch.commit();

    await logAction("إنشاء طلب", `تم إنشاء طلب (${kind}) — عدد VINs: ${rows.length}`);

    alert("تم إنشاء الطلب ✅");
    buildFormRows();
    showInner('manage');
  }catch(e){
    console.error(e);
    alert("حصل خطأ أثناء إنشاء الطلب.");
  }finally{
    btnSubmit.disabled = false;
  }
});

/* =======================
   Permissions + Progress
======================= */
function canDoStep(row, stepNo){
  // الإدارة: كل الصلاحيات
  if(isAdmin()) return true;

  // الإداري فقط
  if(!isIdari()) return false;

  const src = rowSourcePlace(row);   // مكان السيارة الحالي (المصدر)
  const dst = rowDestPlace(row);     // الوجهة (مكان التصوير أو مكان النقل)

  // ✅ المرحلة 1 و 2: مسؤول المصدر فقط (نفس مكان السيارة)
  if(stepNo===1 || stepNo===2) return includesLoc(src);

  // ✅ المرحلة 3 تختلف حسب نوع الصف:
  // - نقل: "استلام السيارة" = منشئ الطلب (الصالة التي طلبت) فقط
  // - تصوير: "استلام السيارة المطلوبة للتصوير" = مسؤول الوجهة (مكان التصوير) فقط
  if(stepNo===3){
    if((row.kind||'') === 'move'){
      return isCreator(openRequestDoc); // منشئ الطلب
    }
    return includesLoc(dst); // تصوير
  }

  return false;
}

function stageText(row){
  const r=!!row.steps?.received?.at;
  const s=!!row.steps?.sent?.at;
  const c=!!row.steps?.carReceived?.at;
  if(!r&&!s&&!c) return "لم يبدأ";
  if(r&&!s) return "تم استلام الطلب";
  if(r&&s&&!c) return "تم إرسال السيارة";
  if(r&&s&&c) return "تم استلام السيارة";
  return "تحت المتابعة";
}

function calcProgress(rows, req){
  const total=rows.length||0;
  const s1=rows.filter(r=>r.steps?.received?.at).length;
  const s2=rows.filter(r=>r.steps?.sent?.at).length;
  const s3=rows.filter(r=>r.steps?.carReceived?.at).length;
  const done=req&&req.finishedAt?1:0;

  const s1p=total?Math.round((s1/total)*100):0;
  const s2p=total?Math.round((s2/total)*100):0;
  const s3p=total?Math.round((s3/total)*100):0;
  const s4p=done?100:0;

  const totalSteps=total*3+1;
  const completedSteps=s1+s2+s3+(done?1:0);
  const overall=totalSteps?Math.round((completedSteps/totalSteps)*100):0;

  return {total,s1,s2,s3,done,s1p,s2p,s3p,s4p,overall};
}

function renderProgress(){
  const p=calcProgress(openRows, openRequestDoc);
  overallVal.textContent=p.overall+"%"; overallBar.style.width=p.overall+"%";
  s1Val.textContent=`${p.s1}/${p.total} — ${p.s1p}%`; s1Bar.style.width=p.s1p+"%";
  s2Val.textContent=`${p.s2}/${p.total} — ${p.s2p}%`; s2Bar.style.width=p.s2p+"%";
  s3Val.textContent=`${p.s3}/${p.total} — ${p.s3p}%`; s3Bar.style.width=p.s3p+"%";
  s4Val.textContent=(openRequestDoc&&openRequestDoc.finishedAt)?"مكتمل ✅":"غير مكتمل"; s4Bar.style.width=p.s4p+"%";

  const canFinish = (p.total>0 && p.s3===p.total) && (isAdmin() || isCreator(openRequestDoc)) && !(openRequestDoc&&openRequestDoc.finishedAt);
  btnStep4.disabled = !canFinish;

  const anyAction = openRows.some(r=>r.steps?.received?.at||r.steps?.sent?.at||r.steps?.carReceived?.at) || (openRequestDoc&&openRequestDoc.finishedAt);
  const canEdit = !anyAction && (isAdmin() || isCreator(openRequestDoc));
  btnEditReq.disabled = !canEdit;
  btnEditReq.innerHTML = editMode ? '<i class="fa-solid fa-floppy-disk"></i>حفظ تعديل الطلب' : '<i class="fa-solid fa-pen-to-square"></i>تعديل الطلب';

  permHint.textContent = `صلاحيتك: ${isAdmin()?"الادارة":(isIdari()?"اداري":"—")} — الإداري يعمل فقط على الأماكن المرتبطة بحسابه.`;
}

function renderRowsTable(){
  rowsTbody.innerHTML='';
  openRows.forEach((row,idx)=>{
    const tr=document.createElement('tr');
    const src=rowSourcePlace(row);
    const dst=rowDestPlace(row);

    tr.innerHTML = `
      <td class="center">${idx+1}</td>
      <td class="mono">${row.vin||row.__id||"—"}</td>
      <td>${row.car||"—"}</td>
      <td class="muted">${src||"—"}</td>
      <td class="muted">${dst||"—"}</td>
      <td>${kindLabel(row.kind)}</td>
      <td>${stageText(row)}</td>
    `;

    const editTd=document.createElement('td');
    if(editMode){
      const sel=document.createElement('select');
      sel.className='select';
      sel.style.minWidth='200px';

      const current = (row.kind==='shoot') ? (row.shootPlace||"") : (row.toLocation||"");
      const opts = Array.from(new Set([current, ...SHOOT_PLACES, ...myLocations()])).filter(Boolean);

      opts.forEach(o=>{
        const op=document.createElement('option');
        op.value=o; op.textContent=o;
        if(o===current) op.selected=true;
        sel.appendChild(op);
      });
      sel.dataset.rowId = row.__id || row.vin;
      sel.dataset.kind  = row.kind || 'shoot';
      editTd.appendChild(sel);
    }else{
      editTd.textContent="—";
      editTd.className='muted';
    }

    tr.appendChild(editTd);
    rowsTbody.appendChild(tr);
  });
}

async function applyStep(stepNo){
  if(!openRequestId) return;
  const key = stepNo===1 ? "received" : (stepNo===2 ? "sent" : "carReceived");
  const targets = openRows.filter(r=>canDoStep(r,stepNo) && !r.steps?.[key]?.at);

  if(!targets.length){
    alert("لا توجد VINs مسموح بها لتنفيذ هذه المرحلة (أو منفذة بالفعل).");
    return;
  }

  // enforce order per VIN
  const violates = targets.some(r=>{
    if(stepNo===2) return !r.steps?.received?.at;
    if(stepNo===3) return !r.steps?.sent?.at;
    return false;
  });
  if(violates){
    alert("لا يمكن تنفيذ المرحلة قبل إتمام المرحلة السابقة لنفس VIN.");
    return;
  }

  const reqRef = db.collection("requests").doc(String(openRequestId));
  const batch = db.batch();
  const now = firebase.firestore.FieldValue.serverTimestamp();

  targets.forEach(row=>{
    const rowId = row.__id || row.vin;
    const rowRef = reqRef.collection("rows").doc(String(rowId));
    const stepObj = { at: now, byUid: myUid(), byEmail: myEmail(), byName: myName() };
    batch.set(rowRef, { steps: { [key]: stepObj }, updatedAt: now }, { merge:true });

    // Step2: update current location to destination
    if(stepNo===2){
      const newLoc = rowDestPlace(row);
      if(newLoc) batch.set(rowRef, { location: newLoc }, { merge:true });
    }
  });

  batch.set(reqRef, { updatedAt: now }, { merge:true });
  await batch.commit();

  await logAction(
    stepNo===1 ? "تم استلام الطلب" : (stepNo===2 ? "تم إرسال السيارة" : "تم استلام السيارة"),
    `طلب #${openRequestId} — مرحلة ${stepNo} — عدد ${targets.length}`
  );
}

async function finishRequest(){
  const p = calcProgress(openRows, openRequestDoc);
  if(!(p.total>0 && p.s3===p.total)){
    alert("لا يمكن الإنهاء قبل اكتمال “تم استلام السيارة” لكل VIN.");
    return;
  }
  if(!(isAdmin() || isCreator(openRequestDoc))){
    alert("ليس لديك صلاحية لإنهاء الطلب.");
    return;
  }
  if(openRequestDoc && openRequestDoc.finishedAt){
    alert("الطلب مكتمل بالفعل.");
    return;
  }

  const reqRef = db.collection("requests").doc(String(openRequestId));
  await reqRef.set({
    finishedAt: firebase.firestore.FieldValue.serverTimestamp(),
    finishedByEmail: myEmail(),
    finishedByName: myName(),
    status: "مكتملة",
    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
  }, { merge:true });

  await logAction("تم الانتهاء", `تم إنهاء الطلب #${openRequestId} بواسطة ${myName()}`);
}

btnStep1.addEventListener('click', ()=>applyStep(1));
btnStep2.addEventListener('click', ()=>applyStep(2));
btnStep3.addEventListener('click', ()=>applyStep(3));
btnStep4.addEventListener('click', finishRequest);

btnRefreshModal.addEventListener('click', ()=>{ renderRowsTable(); renderProgress(); });

btnEditReq.addEventListener('click', async ()=>{
  if(!openRequestId) return;

  if(!editMode){
    editMode=true;
    renderRowsTable(); renderProgress();
    return;
  }

  const anyAction = openRows.some(r=>r.steps?.received?.at||r.steps?.sent?.at||r.steps?.carReceived?.at) || (openRequestDoc&&openRequestDoc.finishedAt);
  if(anyAction){
    alert("لا يمكن تعديل الطلب بعد بدء أي إجراء.");
    editMode=false;
    renderRowsTable(); renderProgress();
    return;
  }

  const selects = rowsTbody.querySelectorAll('select[data-row-id]');
  const reqRef = db.collection("requests").doc(String(openRequestId));
  const batch = db.batch();
  const now = firebase.firestore.FieldValue.serverTimestamp();

  selects.forEach(sel=>{
    const rowId = sel.dataset.rowId;
    const kind  = sel.dataset.kind;
    const newDest = sel.value;
    const rowRef = reqRef.collection("rows").doc(String(rowId));
    if(kind==='shoot') batch.set(rowRef, { shootPlace:newDest, updatedAt: now }, { merge:true });
    else batch.set(rowRef, { toLocation:newDest, updatedAt: now }, { merge:true });
  });

  batch.set(reqRef, { updatedAt: now }, { merge:true });
  await batch.commit();

  await logAction("تعديل الطلب", `تم تعديل وجهات الطلب #${openRequestId} بواسطة ${myName()}`);

  editMode=false;
});

/* =======================
   Open Request (Realtime)
======================= */
async function openRequest(requestId){
  openRequestId = String(requestId);
  editMode = false;

  const reqRef = db.collection("requests").doc(String(requestId));

  if(unsubOpenReq){unsubOpenReq();unsubOpenReq=null;}
  if(unsubOpenRows){unsubOpenRows();unsubOpenRows=null;}

  unsubOpenReq = reqRef.onSnapshot(snap=>{
    if(!snap.exists) return;
    openRequestDoc = snap.data() || {};
    modalTitle.textContent = `تفاصيل الطلب #${requestId}`;
    modalMeta.textContent = `${kindLabel(openRequestDoc.kind)} — ${statusLabel(openRequestDoc)}`;
    renderProgress();
  });

  unsubOpenRows = reqRef.collection("rows").onSnapshot(snap=>{
    openRows=[];
    snap.forEach(doc=>{
      const d = doc.data() || {};
      d.__id = doc.id;
      openRows.push(d);
    });
    openRows.sort((a,b)=>String(a.vin||a.__id).localeCompare(String(b.vin||b.__id)));
    renderRowsTable();
    renderProgress();
  });

  openModal();
}

/* =======================
   Lists (Manage + Done)
======================= */
function passesSearch(req, q){
  q = String(q||"").trim().toLowerCase();
  if(!q) return true;
  const id = String(req.__id||"");
  const creator = String(req.createdByName||req.createdByEmail||"");
  // also match any VIN by cached field if exists
  const vins = Array.isArray(req.vins) ? req.vins.join(' ') : '';
  return id.toLowerCase().includes(q) || creator.toLowerCase().includes(q) || vins.toLowerCase().includes(q);
}

function renderManage(all){
  const kind = filterKind.value;
  const q = searchBox.value || "";
  let list = all.filter(r=>!r.finishedAt);
  if(kind!=="all") list = list.filter(r=>r.kind===kind);
  if(q.trim()) list = list.filter(r=>passesSearch(r,q));

  list.sort((a,b)=>{
    const at = (a.updatedAt&&a.updatedAt.toMillis)?a.updatedAt.toMillis():0;
    const bt = (b.updatedAt&&b.updatedAt.toMillis)?b.updatedAt.toMillis():0;
    return bt-at;
  });

  manageCount.textContent = `تحت المتابعة: ${list.length}`;
  ordersTbody.innerHTML='';
  list.forEach(req=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td><b>#${req.__id}</b></td>
      <td>${kindLabel(req.kind)}</td>
      <td>${statusLabel(req)}</td>
      <td class="muted">${req.createdByName||req.createdByEmail||"—"}</td>
      <td class="muted">${fmtTs(req.updatedAt||req.createdAt)}</td>
      <td><button class="btn primary" data-open="${req.__id}"><i class="fa-solid fa-up-right-from-square"></i>فتح</button></td>
    `;
    tr.querySelector('[data-open]').addEventListener('click', ()=>openRequest(req.__id));
    ordersTbody.appendChild(tr);
  });
}

function renderDone(all){
  const list = all.filter(r=>!!r.finishedAt).sort((a,b)=>{
    const at=(a.finishedAt&&a.finishedAt.toMillis)?a.finishedAt.toMillis():0;
    const bt=(b.finishedAt&&b.finishedAt.toMillis)?b.finishedAt.toMillis():0;
    return bt-at;
  });

  doneTbody.innerHTML='';
  list.forEach(req=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td><b>#${req.__id}</b></td>
      <td>${kindLabel(req.kind)}</td>
      <td class="muted">${req.createdByName||req.createdByEmail||"—"}</td>
      <td class="muted">${fmtTs(req.finishedAt)}</td>
      <td><button class="btn primary" data-open="${req.__id}">فتح</button></td>
    `;
    tr.querySelector('[data-open]').addEventListener('click', ()=>openRequest(req.__id));
    doneTbody.appendChild(tr);
  });
}

function watchRequests(){
  if(unsubRequests){unsubRequests();unsubRequests=null;}
  if(unsubDone){unsubDone();unsubDone=null;}

  unsubRequests = db.collection("requests").onSnapshot(snap=>{
    const all=[];
    snap.forEach(doc=>{
      const d=doc.data()||{};
      d.__id=doc.id;
      all.push(d);
    });
    renderManage(all);
    renderDone(all);
  });
}
filterKind.addEventListener('change', ()=>{ /* list re-rendered by snapshot; use cached? */ });
searchBox.addEventListener('input', ()=>{ /* list re-rendered by snapshot; use cached? */ });

/* =======================
   Activity Log (Admin only)
======================= */
function watchActivity(){
  if(unsubActivity){unsubActivity();unsubActivity=null;}
  if(!isAdmin()){
    activityHint.textContent="هذا القسم مرئي للإدارة فقط.";
    activityTbody.innerHTML='';
    return;
  }
  activityHint.textContent="آخر 50 حركة.";
  unsubActivity = db.collection("mzj_activity_log").orderBy("ts","desc").limit(50).onSnapshot(snap=>{
    activityTbody.innerHTML='';
    snap.forEach(doc=>{
      const d=doc.data()||{};
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td class="muted">${fmtTs(d.ts)}</td>
        <td class="muted">${(d.userName||d.userEmail||"—")}</td>
        <td>${d.action||"—"}</td>
        <td class="muted">${d.details||"—"}</td>
      `;
      activityTbody.appendChild(tr);
    });
  });
}

/* =======================
   Cars lookup (stock)
======================= */
btnLookup.addEventListener('click', ()=>{
  const v = normalizeVin(vinLookup.value);
  vinLookup.value = v;
  if(!v) return;
  const rec = stock.find(r=>normalizeVin(r.vin)===v);
  lookupRes.style.display='block';
  if(rec){
    lookupRes.className='alert ok';
    lookupRes.textContent = `✅ ${rec.car||"—"} — ${rec.variant||"—"} — ${rec.modelYear||"—"} | ${rec.location||"—"}`;
  }else{
    lookupRes.className='alert err';
    lookupRes.textContent = "⛔ لا يوجد VIN مطابق داخل stock.";
  }
});

/* =======================
   Auth
======================= */
document.getElementById('btnLogin').addEventListener('click', async ()=>{
  const email = (document.getElementById('loginEmail').value||"").trim();
  const pass  = (document.getElementById('loginPass').value||"").trim();
  if(!email || !pass){
    showAlert('err','اكتب البريد وكلمة المرور.');
    return;
  }
  try{
    await auth.signInWithEmailAndPassword(email, pass);
    showAlert('ok','تم تسجيل الدخول ✅');
  }catch(e){
    console.error(e);
    showAlert('err','فشل تسجيل الدخول: ' + (e.code||''));
  }
});
btnLogout.addEventListener('click', async ()=>{ await auth.signOut(); });

async function loadUserProfile(u){
  const snap = await db.collection("user").doc(u.uid).get();
  return snap.exists ? (snap.data()||{}) : null;
}

auth.onAuthStateChanged(async (u)=>{
  currentUser = u || null;

  if(!u){
    userProfile=null;
    btnLogout.style.display='none';
    setProfileBadges();
    pageOrders.style.display='none';
    pageCars.style.display='none';
    pageActivity.style.display='none';
    showPage('orders');
    if(unsubRequests){unsubRequests();unsubRequests=null;}
    if(unsubActivity){unsubActivity();unsubActivity=null;}
    if(unsubState){unsubState();unsubState=null;}
    return;
  }

  btnLogout.style.display='inline-flex';
  userProfile = await loadUserProfile(u);
  setProfileBadges();

  // Show main pages
  loginCard.style.display='block';
  pageOrders.style.display='block';
  showPage('orders');
  showInner('create');
  buildFormRows();

  watchAdminState();
  watchRequests();
  watchActivity();
});
</script>

</body>
</html>




