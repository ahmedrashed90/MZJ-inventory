
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MZJ إدارة الطلبات</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
  <meta name="color-scheme" content="light"/>
  <style>
    :root{
      --brown:#3e2420; --beige:#bc8f74; --cream:#fff8ef; --card:#ffffff; --line:#e7e5e4;
      --text:#1f2937; --muted:#6b7280; --ok:#16a34a; --danger:#ef4444; --info:#0ea5e9;
      --radius:12px; --shadow:0 10px 26px rgba(0,0,0,.06); --table-head:#fafafa;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:var(--cream);
      color:var(--text);
      font-family:"Tajawal",system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
      line-height:1.7;
    }
    a{text-decoration:none;color:var(--brown)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}

    /* Header */
    .top{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--line);z-index:10}
    .top .inner{
      max-width:1200px;margin:0 auto;
      display:flex;align-items:center;justify-content:space-between;
      padding:10px 16px;
    }
    .top-left{display:flex;align-items:center;gap:10px}
    .logo{
      width:36px;height:36px;border-radius:50%;
      display:flex;align-items:center;justify-content:center;
      background:radial-gradient(circle at 30% 20%,#f97316,#3e2723);
      box-shadow:0 0 0 4px rgba(188,143,116,.3);
      color:#fff;
    }
    .logo i{font-size:18px}
    .brand-title{font-weight:800;font-size:16px;margin:0;color:var(--brown)}
    .brand-sub{margin:0;font-size:12px;color:var(--muted)}
    .top-right{display:flex;align-items:center;gap:10px}
    .chip{
      font-size:11px;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#fdfaf5;
      display:inline-flex;align-items:center;gap:6px;
    }
    .chip i{font-size:11px;color:var(--brown)}
    .user-info{font-size:13px;color:var(--muted)}
    .btn{
      border-radius:999px;
      border:1px solid transparent;
      background:var(--brown);
      color:#fff;
      font-family:inherit;
      font-size:13px;
      padding:6px 12px;
      display:inline-flex;align-items:center;gap:6px;
      cursor:pointer;
      box-shadow:0 6px 18px rgba(62,36,32,.22);
    }
    .btn.ghost{
      background:transparent;
      color:var(--brown);
      border-color:var(--line);
      box-shadow:none;
    }
    .btn.secondary{
      background:#fdf7f2;
      color:var(--brown);
      border-color:var(--beige);
      box-shadow:none;
    }
    .btn.beige{
      background:var(--beige);
      color:#fff;
      border-color:var(--beige);
    }
    .btn.primary{
      background:var(--brown);
      color:#fff;
      border-color:var(--brown);
    }
    .btn:disabled{
      opacity:.7;
      cursor:default;
      box-shadow:none;
    }
    .btn-mini{font-size:11px;padding:4px 8px;box-shadow:none}
    .btn i{font-size:12px}

    /* Tabs Bar */
    .tabs{
      max-width:1200px;margin:0 auto;
      display:flex;align-items:center;gap:8px;
      padding:0 16px 10px;
      border-bottom:1px solid var(--line);
      background:#fff;
    }
    .tabs a{
      font-size:13px;
      padding:4px 10px 7px;
      border-radius:999px;
      border:1px solid transparent;
      color:var(--muted);
    }
    .tabs a.active{
      background:#f2ebe3;
      border-color:var(--beige);
      color:var(--brown);
      font-weight:700;
    }

    /* Layout */
    .wrap{
      max-width:1200px;
      margin:18px auto 40px;
      padding:0 16px 40px;
      display:flex;
      flex-direction:column;
      gap:16px;
      align-items:stretch;
    }
    @media (max-width:960px){
      .wrap{padding:0 10px 32px;}
    }

    /* Cards */
    .cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(210px,1fr));gap:10px;}
    .card{
      background:var(--card);
      border-radius:var(--radius);
      border:1px solid var(--line);
      box-shadow:var(--shadow);
    }
    .card .inner{padding:14px}
    .card-title{
      display:flex;align-items:center;justify-content:space-between;
      gap:6px;
    }
    .card-title strong{font-size:13px;color:var(--brown)}
    .card-title span{font-size:11px;color:var(--muted)}
    .stat-main{
      display:flex;align-items:baseline;gap:6px;
      margin-top:8px;
    }
    .stat-main .num{font-size:20px;font-weight:800;color:var(--brown)}
    .stat-main .label{font-size:12px;color:var(--muted)}
    .stat-sub{margin-top:4px;font-size:11px;color:var(--muted)}

    /* Status legend */
    .legend{
      display:flex;flex-wrap:wrap;gap:6px;
      margin-top:10px;font-size:11px;color:var(--muted);
    }
    .pill{
      display:inline-flex;align-items:center;gap:5px;
      padding:3px 8px;
      border-radius:999px;
      border:1px dashed var(--line);
      background:#fdfaf5;
    }
    .pill-dot{
      width:8px;height:8px;border-radius:50%;
    }
    .pill-dot.prog{background:#fbbf24}
    .pill-dot.done{background:#22c55e}
    .pill-dot.draft{background:#9ca3af}

    /* Panels */
    .panel{
      background:var(--card);
      border-radius:var(--radius);
      border:1px solid var(--line);
      box-shadow:var(--shadow);
    }
    .panel .head{
      padding:10px 14px;
      border-bottom:1px solid var(--line);
      display:flex;align-items:center;justify-content:space-between;
      gap:8px;
    }
    .panel .head strong{font-size:14px;color:var(--brown)}
    .panel .head .muted{font-size:11px;color:var(--muted)}
    .panel .body{padding:12px 14px 14px}

    .muted{color:var(--muted)}

    /* Filters */
    .filters{
      display:flex;align-items:flex-end;justify-content:space-between;
      gap:10px;flex-wrap:wrap;margin-bottom:10px;
    }
    .filters-left,.filters-right{
      display:flex;align-items:flex-end;gap:8px;
      flex-wrap:wrap;
    }
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:2px}
    input,select,textarea{
      font-family:inherit;
      font-size:13px;
      border-radius:999px;
      border:1px solid var(--line);
      padding:5px 10px;
      background:#fff;
      color:var(--text);
    }
    textarea{
      border-radius:10px;
      min-height:80px;
      resize:vertical;
    }
    input[type="date"]{padding-inline-start:10px;padding-inline-end:10px}
    input[type="search"]{min-width:200px}

    /* Table */
    .table-wrap{border-radius:10px;border:1px solid var(--line);overflow:hidden;background:#fff;}
    table{border-collapse:collapse;width:100%;table-layout:fixed;font-size:13px;}
    thead{background:var(--table-head);}
    th,td{padding:4px 6px;border-bottom:1px solid #f3f0eb;text-align:right;vertical-align:middle;}
    th{font-weight:700;font-size:11px;color:#4b5563}
    tbody tr:nth-child(even){background:#fdfaf8}
    tbody tr:hover{background:#f3eee7;cursor:pointer}
    .center{text-align:center}
    .badge{
      display:inline-flex;align-items:center;justify-content:center;
      font-size:11px;border-radius:999px;padding:2px 8px;
    }
    .badge.draft{background:#f3f4f6;color:#4b5563}
    .badge.prog{background:#fef3c7;color:#92400e}
    .badge.done{background:#dcfce7;color:#166534}
    .badge.move{background:#e0f2fe;color:#075985}
    .badge.shoot{background:#fae8ff;color:#86198f}

    .actions{display:flex;flex-wrap:wrap;gap:4px;}
    .actions .btn-mini{border-radius:8px;font-size:10px;padding:3px 7px}

    /* Status dot in header */
    .status{
      display:flex;align-items:center;gap:6px;
      font-size:11px;color:var(--muted);
    }
    .dot{
      width:9px;height:9px;border-radius:50%;
      background:#d1d5db;
    }
    .dot.ok{background:#22c55e}
    .dot.err{background:#ef4444}

    /* Modal */
    .modal-backdrop{
      position:fixed;inset:0;
      background:rgba(15,23,42,.4);
      display:none;align-items:center;justify-content:center;
      z-index:50;
    }
    .modal-backdrop.show{display:flex}
    .modal{
      background:#fff;
      border-radius:16px;
      box-shadow:0 22px 60px rgba(0,0,0,.3);
      max-width:960px;
      width:100%;
      max-height:84vh;
      display:flex;flex-direction:column;
      overflow:hidden;
    }
    .modal-header{
      padding:10px 16px;
      border-bottom:1px solid var(--line);
      display:flex;align-items:center;justify-content:space-between;gap:8px;
    }
    .modal-title{font-size:14px;font-weight:700;color:var(--brown)}
    .modal-body{
      padding:10px 16px 12px;
      overflow:auto;
    }
    .modal-footer{
      padding:8px 16px 12px;
      border-top:1px solid var(--line);
      display:flex;justify-content:flex-end;gap:6px;
    }
    .modal-close{
      border:none;background:transparent;cursor:pointer;
      color:var(--muted);
    }

    .section-title{
      font-size:13px;font-weight:700;color:var(--brown);
      margin-bottom:4px;
    }
    .subhint{
      font-size:11px;color:var(--muted);margin-bottom:6px;
    }
    .stack{display:flex;flex-direction:column;gap:6px;margin-top:8px}
    .note-box{
      background:#f9fafb;
      border-radius:10px;
      border:1px dashed var(--line);
      padding:6px 8px;
      font-size:11px;
    }
    .note-box strong{color:var(--brown)}

    .toast{
      position:fixed;
      left:50%;
      bottom:20px;
      transform:translateX(-50%);
      background:#111827;
      color:#f9fafb;
      padding:6px 12px;
      border-radius:999px;
      font-size:12px;
      display:none;
      z-index:60;
      box-shadow:0 12px 30px rgba(0,0,0,.4);
    }

    /* inner tabs */
    .inner-tabs{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-bottom:12px;
    }
    .inner-tab{
      border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      padding:6px 12px;
      font-size:13px;
      font-weight:700;
      cursor:pointer;
    }
    .inner-tab.active{
      background:var(--brown);
      color:#fff;
      border-color:var(--brown);
    }
    .tab-pane{display:none}
    .tab-pane.active{display:block}

    .small-input{
      height:32px;
      padding:6px 9px;
      border-radius:10px;
      font-size:13px;
    }

    /* ===== Process Timeline ===== */
    .process-timeline{
      padding:8px 16px 10px;
      border-bottom:1px solid var(--line);
      background:#fff8ef;
    }
    .process-timeline-title{
      font-size:12px;
      font-weight:700;
      color:var(--brown);
      margin-bottom:2px;
      text-align:right;
    }
    .process-timeline-sub{
      font-size:11px;
      color:var(--muted);
      margin-bottom:6px;
      text-align:right;
    }
    .pt-track{
      display:flex;
      justify-content:space-between;
      gap:8px;
      position:relative;
      padding:4px 2px 0;
    }
    .pt-track::before{
      content:"";
      position:absolute;
      inset-inline:14px;
      top:17px;
      height:2px;
      background:#e5e7eb;
      z-index:0;
    }
    .pt-step{
      position:relative;
      flex:1;
      text-align:center;
      padding-inline:4px;
    }
    .pt-circle{
      width:26px;
      height:26px;
      margin:0 auto 4px;
      border-radius:999px;
      display:flex;
      align-items:center;
      justify-content:center;
      border:2px solid #d1d5db;
      background:#fff;
      font-size:11px;
      font-weight:700;
      color:#6b7280;
      position:relative;
      z-index:1;
    }
    .pt-label{
      font-size:11px;
      font-weight:700;
      color:var(--brown);
      white-space:nowrap;
    }
    .pt-desc{
      font-size:10px;
      color:var(--muted);
      margin-top:2px;
      min-height:12px;
    }
    .pt-step.done .pt-circle{
      border-color:var(--ok);
      background:#dcfce7;
      color:#166534;
    }
    .pt-step.active .pt-circle{
      border-color:var(--beige);
      background:#fef3c7;
      color:#92400e;
    }
    .pt-step.upcoming .pt-circle{
      opacity:0.6;
    }
    .pt-step.done ~ .pt-step .pt-circle{
      /* keep upcoming style */
    }

    @media (max-width:720px){
      .pt-label{font-size:10px}
      .pt-desc{display:none}
    }

  </style>
</head>
<body>
<div class="top">
  <div class="inner">
    <div class="top-left">
      <div class="logo"><i class="fa-solid fa-star"></i></div>
      <div>
        <p class="brand-title">MZJ إدارة طلبات التصوير والنقل</p>
        <p class="brand-sub">مسار واحد لمتابعة جميع الطلبات من الإنشاء حتى التنفيذ</p>
      </div>
    </div>
    <div class="top-right">
      <span class="chip">
        <i class="fa-solid fa-circle-nodes"></i>
        <span class="status">
          <span id="connDot" class="dot"></span>
          <span id="connText">جارٍ الاتصال…</span>
        </span>
      </span>
      <span class="user-info" id="userLabel">غير مسجل</span>
      <button class="btn ghost btn-mini" id="btnSignOut" style="display:none">
        <i class="fa-solid fa-arrow-right-from-bracket"></i> تسجيل خروج
      </button>
    </div>
  </div>
</div>

<div class="tabs">
  <a class="tab" href="admin.html">الإدارة</a>
  <a class="tab" href="inventory.html">المخزون</a>
  <a class="tab" href="dashboard.html">الداش بورد</a>
  <a class="tab" href="vt.html">نقل السيارات</a>
  <a class="tab active" href="photoshoot-user.html">إدارة الطلبات</a>
  <a class="tab" href="cars.html">كل السيارات</a>
  <a class="tab" href="Activity.html">سجل النشاط</a>
</div>

<main class="wrap">
  <section class="cards">
    <article class="card">
      <div class="inner">
        <div class="card-title">
          <strong>إجمالي الطلبات</strong>
          <span>كل طلبات التصوير والنقل</span>
        </div>
        <div class="stat-main">
          <span class="num" id="stat_all">0</span>
          <span class="label">طلب</span>
        </div>
        <div class="stat-sub">
          آخر تحديث: <span id="stat_updated">—</span>
        </div>
      </div>
    </article>

    <article class="card">
      <div class="inner">
        <div class="card-title">
          <strong>تحت الإجراء</strong>
          <span>تصوير وتجهيز + نقل قيد المراجعة</span>
        </div>
        <div class="stat-main">
          <span class="num" id="stat_prog">0</span>
          <span class="label">طلب</span>
        </div>
        <div class="stat-sub">
          يشمل الحالات: تحت الإجراء، تم التجهيز، قيد المراجعة
        </div>
      </div>
    </article>

    <article class="card">
      <div class="inner">
        <div class="card-title">
          <strong>تم التنفيذ</strong>
          <span>تصوير مكتمل + نقل منفّذ</span>
        </div>
        <div class="stat-main">
          <span class="num" id="stat_done">0</span>
          <span class="label">طلب</span>
        </div>
        <div class="stat-sub">
          يشمل الحالات: تم، منفّذ
        </div>
      </div>
    </article>

    <article class="card">
      <div class="inner">
        <div class="card-title">
          <strong>حالات المسودة</strong>
          <span>طلبات لم تُرسل بعد</span>
        </div>
        <div class="stat-main">
          <span class="num" id="stat_draft">0</span>
          <span class="label">طلب</span>
        </div>
        <div class="stat-sub">
          استخدم هذا القسم لمراجعة المسودات وتحويلها لطلبات فعلية
        </div>
      </div>
    </article>

    <article class="card" style="grid-column:1/-1">
      <div class="inner">
        <div class="card-title">
          <strong>دليل الحالات</strong>
          <span>فهم سريع لمسار الطلب</span>
        </div>
        <div class="legend">
          <span class="pill"><span class="pill-dot draft"></span> <span>مسودة: لم يتم إرسال الطلب رسميًا</span></span>
          <span class="pill"><span class="pill-dot prog"></span> <span>تحت الإجراء / تم التجهيز / قيد المراجعة</span></span>
          <span class="pill"><span class="pill-dot done"></span> <span>تم (تصوير مكتمل) / منفّذ (نقل مكتمل)</span></span>
        </div>
      </div>
    </article>
  </section>

  <!-- بوابة الدخول -->
  <section id="authGate" class="panel" style="display:none">
    <div class="head">
      <strong>تسجيل الدخول لإدارة الطلبات</strong>
      <div class="muted">مطلوب صلاحية للوصول لطلبات التصوير والنقل</div>
    </div>
    <div class="body">
      <p class="muted" style="margin-top:0;margin-bottom:8px">
        أدخل البريد الإلكتروني وكلمة المرور المستخدمة في لوحة الإدارة.
      </p>
      <form id="loginForm">
        <div style="display:flex;flex-direction:column;gap:8px;max-width:320px">
          <div>
            <label for="email">البريد الإلكتروني</label>
            <input id="email" type="email" required autocomplete="username">
          </div>
          <div>
            <label for="password">كلمة المرور</label>
            <input id="password" type="password" required autocomplete="current-password">
          </div>
          <button id="btnSignIn" class="btn" type="submit">
            <i class="fa-solid fa-right-to-bracket"></i>
            تسجيل الدخول
          </button>
        </div>
      </form>
    </div>
  </section>

  <!-- التطبيق -->
  <section id="app" class="panel" style="display:none">
    <div class="head">
      <strong>الطلبات (تصوير + نقل)</strong>
      <div class="muted"><span id="countShown">0</span> من <span id="countTotal">0</span></div>
    </div>
    <div class="body">

      <div class="inner-tabs">
        <button type="button" class="inner-tab active" data-tab="tab-create" data-mode="create">إنشاء طلب</button>
        <button type="button" class="inner-tab" data-tab="tab-manage" data-mode="manage">إدارة الطلبات</button>
        <button type="button" class="inner-tab" data-tab="tab-manage" data-mode="completed">الطلبات المكتملة</button>
      </div>

      <!-- إنشاء طلب -->
      <div id="tab-create" class="tab-pane active">
        <div class="card">
          <div class="inner">
            <div style="margin-bottom:8px;display:flex;gap:8px;flex-wrap:wrap">
              <div style="flex:1;min-width:220px">
                <label for="reqBy">مقدّم الطلب</label>
                <input id="reqBy" class="small-input" readonly title="يتم تحديده تلقائيًا من المستخدم الحالي">
              </div>
            </div>

            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th class="center">#</th>
                    <th>نوع الطلب</th>
                    <th>رقم الهيكل (VIN)</th>
                    <th>السيارة</th>
                    <th>البيان</th>
                    <th>الخارجي</th>
                    <th>الداخلي</th>
                    <th>الموديل</th>
                    <th>مكان السيارة</th>
                    <th id="placeHeader">مكان التصوير / النقل</th>
                    <th>ملاحظة</th>
                    <th class="center">حذف</th>
                  </tr>
                </thead>
                <tbody id="reqRows"></tbody>
              </table>
            </div>

            <div style="margin-top:12px;display:flex;flex-wrap:wrap;gap:8px">
              <button type="button" class="btn secondary" id="btnDraft"><i class="fa-regular fa-floppy-disk"></i> حفظ كمسودة</button>
              <button type="button" class="btn beige" id="btnSubmit"><i class="fa-solid fa-paper-plane"></i> إرسال الطلب</button>
              <button type="button" class="btn ghost" id="btnClear"><i class="fa-solid fa-rotate-right"></i> تفريغ</button>
            </div>

            <p class="muted" style="margin-top:8px;font-size:12px">
              اختر <b>نوع الطلب</b> لكل صف (تصوير أو نقل)، اكتب رقم الهيكل، وسيتم جلب بيانات السيارة تلقائيًا من المخزون إن توفرت.
            </p>
          </div>
        </div>
      </div>

      <!-- إدارة / مكتملة -->
      <div id="tab-manage" class="tab-pane">
        <div class="filters">
          <div class="filters-left">
            <div>
              <label>من تاريخ</label>
              <input id="date_from" type="date">
            </div>
            <div>
              <label>إلى تاريخ</label>
              <input id="date_to" type="date">
            </div>
            <div>
              <label>الحالة</label>
              <select id="f_status">
                <option value="">كل الحالات</option>
                <option>مسودة</option>
                <option>تحت الإجراء</option>
                <option>تم التجهيز</option>
                <option>قيد المراجعة</option>
                <option>تم</option>
                <option>منفّذ</option>
              </select>
            </div>
            <div>
              <label>بحث</label>
              <input id="q" type="search" placeholder="بحث: نوع الطلب / VIN / المكان / المنشئ / ملاحظة">
            </div>
            <button id="f_reset" class="btn ghost"><i class="fa-solid fa-rotate-right"></i> إعادة التصفية</button>
          </div>
          <div class="filters-right">
            <button type="button" id="kind_all"   class="btn secondary btn-mini filter-kind active-kind">كل الأنواع</button>
            <button type="button" id="kind_shoot" class="btn secondary btn-mini filter-kind">طلبات التصوير</button>
            <button type="button" id="kind_move"  class="btn secondary btn-mini filter-kind">طلبات النقل</button>
          </div>
        </div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th class="center">#</th>
                <th style="min-width:80px">الطلب</th>
                <th style="min-width:110px">نوع الطلب</th>
                <th style="min-width:110px">المنشئ</th>
                <th style="min-width:90px">الحالة</th>
                <th style="min-width:130px">تاريخ الإنشاء</th>
                <th style="min-width:160px">المكان / من → إلى</th>
                <th style="min-width:160px">استلام / موافقات</th>
              </tr>
            </thead>
            <tbody id="reqTable"></tbody>
          </table>
        </div>
      </div>

    </div>
  </section>
</main>

<!-- Modal: تفاصيل طلب التصوير -->
<div id="reqModalBackdrop" class="modal-backdrop">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="reqModalTitle">
    <div class="modal-header">
      <div>
        <div id="reqModalTitle" class="modal-title">تفاصيل طلب التصوير</div>
        <div id="reqModalSub" class="muted" style="font-size:11px;margin-top:2px"></div>
      </div>
      <button class="modal-close" data-close-req-modal><i class="fa-solid fa-xmark"></i></button>
    </div>

    <div class="process-timeline" id="reqTimelineBox">
      <div class="process-timeline-title">مسار تنفيذ الطلب</div>
      <div class="process-timeline-sub">من استلام الطلب حتى الانتهاء.</div>
      <div class="pt-track" id="reqTimelineTrack"></div>
    </div>

    <div class="modal-body">
      <div class="section-title">تفاصيل السيارات داخل طلب التصوير</div>
      <div class="subhint">مراجعة رقم الهيكل، نوع السيارة، اللون، والموقع الحالي.</div>
      <div class="table-wrap" style="margin-top:6px;max-height:260px">
        <table>
          <thead>
            <tr>
              <th class="center">#</th>
              <th>VIN</th>
              <th>السيارة</th>
              <th>البيان</th>
              <th>اللون الخارجي</th>
              <th>اللون الداخلي</th>
              <th>الموديل</th>
              <th>الموقع الحالي</th>
              <th>مكان التصوير</th>
              <th>ملاحظة</th>
            </tr>
          </thead>
          <tbody id="reqModalRows"></tbody>
        </table>
      </div>

      <div class="stack">
        <div class="section-title" style="margin-top:10px">ملاحظات وإجراءات الإدارة</div>
        <div class="subhint">متابعة استلام الطلب وتحرك السيارات للتصوير.</div>
        <div class="note-box" id="reqModalStatusBox"></div>
        <div class="note-box" id="reqModalReceiveInfo"></div>
        <div class="note-box" id="reqModalPrepInfo"></div>
        <div>
          <label for="adminNotes">ملاحظات إضافية</label>
          <textarea id="adminNotes" placeholder="اكتب أي ملاحظات عن الطلب أو السيارات بداخله (اختياري)"></textarea>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn ghost btn-mini" data-close-req-modal>إغلاق</button>
      <button id="btnShootStep1" class="btn secondary btn-mini"><i class="fa-regular fa-clipboard-check"></i> تم استلام الطلب</button>
      <button id="btnShootStep2" class="btn secondary btn-mini"><i class="fa-solid fa-truck"></i> تم ارسال السيارة</button>
      <button id="btnShootStep3" class="btn secondary btn-mini"><i class="fa-solid fa-car-side"></i> تم استلام السيارة</button>
      <button id="btnShootStep4" class="btn primary btn-mini"><i class="fa-solid fa-flag-checkered"></i> تم الانتهاء</button>
    </div>
  </div>
</div>

<!-- Modal: تفاصيل طلب النقل -->
<div id="moveModalBackdrop" class="modal-backdrop">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="moveModalTitle">
    <div class="modal-header">
      <div>
        <div id="moveModalTitle" class="modal-title">تفاصيل طلب النقل</div>
        <div id="moveModalSub" class="muted" style="font-size:11px;margin-top:2px"></div>
      </div>
      <button class="modal-close" data-close-move-modal><i class="fa-solid fa-xmark"></i></button>
    </div>

    <div class="process-timeline" id="moveTimelineBox">
      <div class="process-timeline-title">مسار تنفيذ الطلب</div>
      <div class="process-timeline-sub">من استلام الطلب حتى إتمام حركة النقل.</div>
      <div class="pt-track" id="moveTimelineTrack"></div>
    </div>

    <div class="modal-body">
      <div class="section-title">السيارات داخل طلب النقل</div>
      <div class="subhint">مراجعة رقم الهيكل، المكان قبل وبعد النقل.</div>
      <div class="table-wrap" style="margin-top:6px;max-height:260px">
        <table>
          <thead>
            <tr>
              <th class="center">#</th>
              <th>VIN</th>
              <th>السيارة</th>
              <th>البيان</th>
              <th>اللون الخارجي</th>
              <th>اللون الداخلي</th>
              <th>الموديل</th>
              <th>من</th>
              <th>إلى</th>
              <th>ملاحظة</th>
            </tr>
          </thead>
          <tbody id="moveModalRows"></tbody>
        </table>
      </div>

      <div class="stack">
        <div class="section-title" style="margin-top:10px">حالة التنفيذ</div>
        <div class="note-box" id="moveModalStatusBox"></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn ghost btn-mini" data-close-move-modal>إغلاق</button>
      <button id="btnMoveStep1" class="btn secondary btn-mini"><i class="fa-regular fa-clipboard-check"></i> تم استلام الطلب</button>
      <button id="btnMoveStep2" class="btn secondary btn-mini"><i class="fa-solid fa-truck"></i> تم ارسال السيارة</button>
      <button id="btnMoveStep3" class="btn secondary btn-mini"><i class="fa-solid fa-car-side"></i> تم استلام السيارة</button>
      <button id="btnMoveStep4" class="btn primary btn-mini"><i class="fa-solid fa-flag-checkered"></i> تم الانتهاء</button>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
  import {
    getFirestore, doc, getDoc, setDoc, onSnapshot,
    collection, addDoc, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC614bGqnYf4Q-weTNemzWENTpa8DjGeHw",
    authDomain: "mzj-agenda.firebaseapp.com",
    projectId: "mzj-agenda",
    storageBucket: "mzj-agenda.firebasestorage.app",
    messagingSenderId: "834700407721",
    appId: "1:834700407721:web:75c17665d4f032fd65cab8"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  const STATE_REF   = doc(db, "mzj_admin_state", "v1");
  const ACTIVITY_CL = collection(db, "mzj_activity_log");

  const ROLE_ADMIN = "الادارة";
  const ROLE_IDARI = "اداري";
  const PAGE_ALLOWED_ROLES = [ROLE_ADMIN, ROLE_IDARI];


  // الصفحات المسموح بها حسب كل دور
  const ROLE_PAGES = {
    [ROLE_ADMIN]: 'ALL', // الإدارة تشوف كل الصفحات
    // الإداري: يشوف فقط الداشبورد + نقل السيارات + إدارة الطلبات + كل السيارات
    [ROLE_IDARI]: ['dashboard.html','vt.html','photoshoot-user.html','cars.html']
  };

  let currentUserRole = null;
  let currentUserLocations = [];
  let currentUserUid = null;
  let currentUserEmail = "";

  function isSuperAdmin(){
    return currentUserRole === ROLE_ADMIN;
  }
  function userMatchesPlace(place){
    if(!place) return false;
    if(!Array.isArray(currentUserLocations)) return false;
    return currentUserLocations.includes(place);
  }
  function isRequestOwner(req){
    if(currentUserUid && req.createdByUid){
      return currentUserUid === req.createdByUid;
    }
    if(currentUserEmail && req.createdByEmail){
      return currentUserEmail === req.createdByEmail;
    }
    return false;
  }

  const SHOOT_PLACES = [
    "",
    "الاستديو",
    "الصالة الاساسية",
    "صالة القادسية",
    "معرض الملتقى"
  ];

  const $  = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const pad = n => n<10 ? "0"+n : ""+n;

  function now(){
    const d=new Date();
    return d.getFullYear()+"-"+pad(d.getMonth()+1)+"-"+pad(d.getDate())+
           " "+pad(d.getHours())+":"+pad(d.getMinutes())+":"+pad(d.getSeconds());
  }
  function showToast(msg){
    const t = $("#toast");
    if(!t) return;
    t.textContent = msg;
    t.style.display = "block";
    setTimeout(()=>{t.style.display="none";}, 1800);
  }

  // إظهار أو إخفاء التابات حسب صلاحية الدور
  function applyTabsVisibility(role){
    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(tab=>{
      const href = tab.getAttribute('href') || '';
      const page = (href.split('/').pop() || '').split('?')[0];
      if(!page) return;
      const perm = ROLE_PAGES[role];
      if(!perm){
        tab.style.display = 'none';
        return;
      }
      if(perm === 'ALL') return; // الإدارة تشوف كل حاجة
      if(!perm.includes(page)){
        tab.style.display = 'none';
      }
    });
  }

  function setStatus(mode,txt){
    const dot=$("#connDot");
    const txtEl=$("#connText");
    if(!dot || !txtEl) return;
    dot.className="dot"+(mode==="ok"?" ok":mode==="err"?" err":"");
    txtEl.textContent = txt;
  }
  function normalizeVin(v){
    if(!v) return "";
    const ar={'٠':'0','١':'1','٢':'2','٣':'3','٤':'4','٥':'5','٦':'6','٧':'7','٨':'8','٩':'9'};
    return v.toString().replace(/[٠-٩]/g,d=>ar[d]).toUpperCase().replace(/[\s\-\._]/g,"").trim();
  }

  let shootRequests = [];
  let moveRequests  = [];
  let stock = [];
  let moves = [];

  function displayNameFor(user){
    if(!user) return "مسؤول";
    if(user.displayName && user.displayName.trim()) return user.displayName.trim();
    const e = (user.email||"").toLowerCase();
    const local = e.split("@")[0]||"";
    return local.replace(/[._-]+/g," ").replace(/\b\w/g,c=>c.toUpperCase());
  }

  async function logActivity(actionType, details, extra={}){
    try{
      const user = auth.currentUser;
      const email = user?.email || "";
      const name  = displayNameFor(user);
      await addDoc(ACTIVITY_CL,{
        userEmail: email,
        userName : name,
        role     : extra.role || "",
        action   : actionType,
        entityType: extra.entityType || "request",
        entityId : extra.requestId != null ? String(extra.requestId) : "",
        details  : details || "",
        createdAt: now(),
        createdAtTs: serverTimestamp(),
        userAgent: navigator.userAgent || ""
      });
    }catch(e){
      console.error("logActivity error", e);
    }
  }

  async function persistAll(){
    await setDoc(
      STATE_REF,
      { shootRequests, moveRequests, stock, moves, updatedAt: now() },
      { merge:true }
    );
  }

  function metrics(){
    const allCount = shootRequests.length + moveRequests.length;
    const progStatuses = new Set(["تحت الإجراء","تم التجهيز","قيد المراجعة"]);
    const doneStatuses = new Set(["تم","منفّذ"]);

    const progCount =
      shootRequests.filter(x=> progStatuses.has(x.status||"")).length +
      moveRequests .filter(x=> progStatuses.has(x.status||"")).length;

    const doneCount =
      shootRequests.filter(x=> doneStatuses.has(x.status||"")).length +
      moveRequests .filter(x=> doneStatuses.has(x.status||"")).length;

    const draftCount =
      shootRequests.filter(x=> (x.status||"")==="مسودة").length +
      moveRequests .filter(x=> (x.status||"")==="مسودة").length;

    $("#stat_all").textContent   = allCount;
    $("#stat_prog").textContent  = progCount;
    $("#stat_done").textContent  = doneCount;
    $("#stat_draft").textContent = draftCount;
  }

  function requestedPlaceOf(req){
    if(req.kind === "move") return "";
    const rows = Array.isArray(req.rows)?req.rows:[];
    if(!rows.length) return "";
    return rows[0].shootPlace || rows[0].place || "";
  }

  window._viewMode   = "manage";
  window._kindFilter = "";

  function toDateOnly(s){
    if(!s) return null;
    const d = s.slice(0,10);
    const [y,m,dd] = d.split("-").map(n=>parseInt(n,10));
    if(!y||!m||!dd) return null;
    return new Date(y,m-1,dd);
  }
  function inRange(createdAt, from, to){
    if(!from && !to) return true;
    const d = toDateOnly(createdAt); if(!d) return false;
    if(from && d < from) return false;
    if(to   && d > to)   return false;
    return true;
  }

  function applyFiltersAndSort(){
    const q = ($("#q").value||"").trim().toLowerCase();
    const s = $("#f_status").value||"";
    const fromVal = $("#date_from").value||"";
    const toVal   = $("#date_to").value||"";
    const fromD = fromVal ? new Date(fromVal+"T00:00:00") : null;
    const toD   = toVal   ? new Date(toVal+"T23:59:59") : null;

    let list = [
      ...shootRequests.map(r=>({kind:"shoot", data:r})),
      ...moveRequests .map(r=>({kind:"move",  data:r}))
    ];

    if(s){
      list = list.filter(x=> (x.data.status||"")===s);
    }
    if(fromD || toD){
      list = list.filter(x=> inRange(x.data.createdAt||"", fromD, toD));
    }
    if(q){
      list = list.filter(x=>{
        const txt = JSON.stringify(x.data).toLowerCase();
        return txt.includes(q);
      });
    }

    const kindFilter = window._kindFilter || "";
    if(kindFilter==="shoot") list = list.filter(x=>x.kind==="shoot");
    if(kindFilter==="move")  list = list.filter(x=>x.kind==="move");

    const viewMode = window._viewMode || "manage";
    if(viewMode === "manage"){
      list = list.filter(x=> !["تم","منفّذ"].includes(x.data.status||""));
    }else if(viewMode === "completed"){
      list = list.filter(x=> ["تم","منفّذ"].includes(x.data.status||""));
    }

    list.sort((a,b)=>{
      const da = a.data.createdAt||"";
      const db = b.data.createdAt||"";
      if(da===db) return 0;
      return da>db ? -1 : 1;
    });

    return list;
  }

  function render(){
    const list = applyFiltersAndSort();
    $("#countTotal").textContent = shootRequests.length + moveRequests.length;
    $("#countShown").textContent = list.length;

    const tbody = $("#reqTable");
    tbody.innerHTML = "";

    list.forEach((x,idx)=>{
      const r = x.data;
      const tr = document.createElement("tr");

      const status = r.status || "";
      let badgeClass = "badge draft";
      if(["تحت الإجراء","تم التجهيز","قيد المراجعة"].includes(status)) badgeClass = "badge prog";
      if(["تم","منفّذ"].includes(status)) badgeClass = "badge done";

      const isMove = x.kind === "move";
      const kindLabel = isMove ? "طلب نقل سيارات" : "طلب تصوير";
      const kindBadge = isMove ? "badge move" : "badge shoot";

      let placeCell = "";
      if(isMove){
        const rows = Array.isArray(r.rows)?r.rows:[];
        if(rows.length){
          const sample = rows[0];
          placeCell = (sample.fromLocation||"") + " → " + (sample.toLocation||"");
        }
      }else{
        placeCell = requestedPlaceOf(r) || "";
      }

      let approvalsText = "";
      if(isMove){
        const admin = r.admin || {};
        let lines = [];
        lines.push(admin.received ? "تم استلام الطلب في: "+admin.received : "لم يتم استلام الطلب بعد");
        lines.push(admin.sent ? "تم ارسال السيارة في: "+admin.sent : "لم يتم ارسال السيارة بعد");
        lines.push(admin.carReceived ? "تم استلام السيارة في: "+admin.carReceived : "لم يتم استلام السيارة بعد");
        if(r.executedAt){
          lines.push("تم الانتهاء في: "+r.executedAt);
        }else{
          lines.push("لم يتم الانتهاء بعد");
        }
        approvalsText = lines.join("\n");
      }else{
        const admin = r.admin || {};
        const recv  = admin.received;
        const prep  = admin.prepared;
        const recvText = recv ? ("تم استلام الطلب في: "+recv) : "لم يتم استلام الطلب بعد";
        const prepText = prep ? ("تم ارسال السيارة للتصوير في: "+prep) : "لم يتم الارسال بعد";
        approvalsText = recvText + "\n" + prepText;
      }

      tr.innerHTML = `
        <td class="center">${idx+1}</td>
        <td>#${r.id||"-"}</td>
        <td><span class="${kindBadge}">${kindLabel}</span></td>
        <td>${r.createdBy||""}</td>
        <td><span class="${badgeClass}">${status||"—"}</span></td>
        <td>${r.createdAt||""}</td>
        <td>${placeCell}</td>
        <td style="white-space:pre-line">${approvalsText}</td>
      `;

      tr.addEventListener("click",()=>{
        if(isMove) openMoveModal(r); else openReqModal(r);
      });

      tbody.appendChild(tr);
    });
  }

  /* ==== إنشاء الطلب من النموذج ==== */
  const reqRowsBody   = document.getElementById("reqRows");
  const placeHeaderEl = document.getElementById("placeHeader");

  function buildFormRows(){
    if(!reqRowsBody) return;
    reqRowsBody.innerHTML = "";
    for(let i=0;i<8;i++){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="center">${i+1}</td>
        <td>
          <select class="small-input req-kind">
            <option value="shoot" selected>طلب تصوير</option>
            <option value="move">طلب نقل</option>
          </select>
        </td>
        <td><input class="small-input mono req-vin" placeholder="VIN"></td>
        <td><input class="small-input req-car" readonly placeholder="—"></td>
        <td><input class="small-input req-variant" readonly placeholder="—"></td>
        <td><input class="small-input req-ext" readonly placeholder="—"></td>
        <td><input class="small-input req-int" readonly placeholder="—"></td>
        <td class="center"><input class="small-input center req-year" readonly placeholder="—"></td>
        <td><input class="small-input req-location" readonly placeholder="—"></td>
        <td>
          <select class="small-input req-place">
            <option value="">— اختر —</option>
            ${SHOOT_PLACES.map(p=> p ? `<option>${p}</option>` : "").join("")}
          </select>
        </td>
        <td><input class="small-input req-note" placeholder="اختياري"></td>
        <td class="center">
          <button type="button" class="btn ghost btn-mini req-row-clear"><i class="fa-solid fa-xmark"></i></button>
        </td>
      `;
      reqRowsBody.appendChild(tr);
    }

    const u = auth.currentUser;
    const rb = document.getElementById("reqBy");
    if(rb){
      rb.value = (u && (u.displayName || u.email)) || "";
      rb.readOnly = true;
    }
    updatePlaceHeader();
  }

  function updatePlaceHeader(){
    if(!placeHeaderEl || !reqRowsBody) return;
    const anyMove = Array.from(reqRowsBody.querySelectorAll(".req-kind"))
      .some(sel => sel.value === "move");
    placeHeaderEl.textContent = anyMove ? "مكان النقل" : "مكان التصوير";
  }

  if(reqRowsBody){
    reqRowsBody.addEventListener("change",(e)=>{
      if(e.target.classList && e.target.classList.contains("req-kind")){
        updatePlaceHeader();
      }
    });

    reqRowsBody.addEventListener("click",(e)=>{
      const btn = e.target.closest(".req-row-clear");
      if(!btn) return;
      const tr = btn.closest("tr");
      if(!tr) return;
      tr.querySelectorAll("input,select").forEach(el=>{
        if(el.classList.contains("req-kind")) el.value="shoot";
        else el.value="";
      });
      updatePlaceHeader();
    });

    reqRowsBody.addEventListener("blur",(e)=>{
      const vinInput = e.target.closest(".req-vin");
      if(!vinInput) return;
      const norm = normalizeVin(vinInput.value);
      vinInput.value = norm;
      if(!norm) return;
      const rec = stock.find(r=> normalizeVin(r.vin)===norm);
      const tr = vinInput.closest("tr");
      if(rec){
        tr.querySelector(".req-car").value      = rec.car || "";
        tr.querySelector(".req-variant").value  = rec.variant || "";
        tr.querySelector(".req-ext").value      = rec.extColor || "";
        tr.querySelector(".req-int").value      = rec.intColor || "";
        tr.querySelector(".req-year").value     = rec.modelYear || "";
        tr.querySelector(".req-location").value = rec.location || "";
        showToast("تم جلب بيانات السيارة");
      }else{
        tr.querySelector(".req-car").value      = "";
        tr.querySelector(".req-variant").value  = "";
        tr.querySelector(".req-ext").value      = "";
        tr.querySelector(".req-int").value      = "";
        tr.querySelector(".req-year").value     = "";
        tr.querySelector(".req-location").value = "";
        showToast("لا يوجد هيكل مطابق");
      }
    }, true);
  }

  function collectFormRows(){
    const shootRows = [];
    const moveRows  = [];
    if(!reqRowsBody) return {shootRows,moveRows};

    reqRowsBody.querySelectorAll("tr").forEach(tr=>{
      const vin = normalizeVin(tr.querySelector(".req-vin")?.value || "");
      if(!vin) return;
      const kind      = tr.querySelector(".req-kind")?.value || "shoot";
      const car       = tr.querySelector(".req-car")?.value || "";
      const variant   = tr.querySelector(".req-variant")?.value || "";
      const extColor  = tr.querySelector(".req-ext")?.value || "";
      const intColor  = tr.querySelector(".req-int")?.value || "";
      const modelYear = tr.querySelector(".req-year")?.value || "";
      const location  = tr.querySelector(".req-location")?.value || "";
      const place     = tr.querySelector(".req-place")?.value || "";
      const note      = tr.querySelector(".req-note")?.value || "";

      if(kind === "move"){
        moveRows.push({
          vin,car,variant,extColor,intColor,modelYear,
          fromLocation: location,
          toLocation  : place,
          note
        });
      }else{
        shootRows.push({
          vin,car,variant,extColor,intColor,modelYear,
          location,
          shootPlace: place,
          note
        });
      }
    });

    return {shootRows,moveRows};
  }

  async function saveNewRequest(asDraft){
    const rb = document.getElementById("reqBy");
    const user = auth.currentUser;
    const createdBy =
      (rb && rb.value && rb.value.trim()) ||
      (user && (user.displayName || user.email)) ||
      "غير محدد";

    const createdByUid = user ? user.uid : null;
    const createdByEmail = user ? (user.email || "") : "";

    const {shootRows,moveRows} = collectFormRows();
    if(!shootRows.length && !moveRows.length){
      showToast("أدخل هيكل واحد على الأقل");
      return;
    }

    if(shootRows.length){
      const nextId = shootRequests.length
        ? Math.max(...shootRequests.map(r=> Number(r.id)||0))+1
        : 1;
      const status = asDraft ? "مسودة" : "تحت الإجراء";

      const req = {
        id: nextId,
        createdAt: now(),
        createdBy,
        createdByUid,
        createdByEmail,
        rows: shootRows,
        status,
        admin:{ received:null, prepared:null, carReceived:null, finished:null }
      };
      shootRequests.push(req);

      await logActivity(
        asDraft ? "إنشاء طلب تصوير (مسودة)" : "إرسال طلب تصوير",
        "عدد الهياكل: "+shootRows.length+" | الطلب #"+nextId,
        {requestId:nextId, entityType:"photoshoot_request"}
      );
    }

    if(moveRows.length){
      const nextMoveId = moveRequests.length
        ? Math.max(...moveRequests.map(r=> Number(r.id)||0))+1
        : 1;
      const status = asDraft ? "مسودة" : "قيد المراجعة";

      const mr = {
        id: nextMoveId,
        type:"VIN_MOVE",
        createdAt: now(),
        createdBy,
        createdByUid,
        createdByEmail,
        rows: moveRows,
        status,
        executedAt: null,
        admin:{ received:null, sent:null, carReceived:null, finished:null }
      };
      moveRequests.push(mr);

      await logActivity(
        asDraft ? "إنشاء مسودة طلب نقل سيارات" : "إرسال طلب نقل سيارات",
        "عدد السيارات في الطلب: "+moveRows.length+" | الطلب #"+nextMoveId,
        {requestId:nextMoveId, entityType:"move_request"}
      );
    }

    await persistAll();
    metrics();
    render();
    buildFormRows();
    showToast(asDraft ? "تم حفظ المسودة" : "تم إرسال الطلب");
  }

  const btnDraft  = document.getElementById("btnDraft");
  const btnSubmit = document.getElementById("btnSubmit");
  const btnClear  = document.getElementById("btnClear");
  if(btnDraft)  btnDraft .addEventListener("click", ()=> saveNewRequest(true));
  if(btnSubmit) btnSubmit.addEventListener("click", ()=> saveNewRequest(false));
  if(btnClear)  btnClear .addEventListener("click", ()=> buildFormRows());

  /* ==== inner tabs ==== */
  const innerTabsEls = Array.from(document.querySelectorAll(".inner-tab"));
  const tabPanesEls  = Array.from(document.querySelectorAll(".tab-pane"));
  innerTabsEls.forEach(btn=>{
    btn.addEventListener("click",()=>{
      innerTabsEls.forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");

      const targetId = btn.getAttribute("data-tab");
      tabPanesEls.forEach(p=>{
        if(p.id === targetId) p.classList.add("active");
        else p.classList.remove("active");
      });

      const mode = btn.getAttribute("data-mode") || "manage";
      if(targetId === "tab-manage"){
        window._viewMode = mode;
        render();
      }
    });
  });

  /* ==== kind filters ==== */
  function applyKindButtons(active){
    $$(".filter-kind").forEach(b=>b.classList.remove("active-kind"));
    if(active) active.classList.add("active-kind");
  }
  const btnKindAll  = document.getElementById("kind_all");
  const btnKindShoot= document.getElementById("kind_shoot");
  const btnKindMove = document.getElementById("kind_move");

  if(btnKindAll) btnKindAll.addEventListener("click", ()=>{
    window._kindFilter = "";
    applyKindButtons(btnKindAll);
    render();
  });
  if(btnKindShoot) btnKindShoot.addEventListener("click", ()=>{
    window._kindFilter = "shoot";
    applyKindButtons(btnKindShoot);
    render();
  });
  if(btnKindMove) btnKindMove.addEventListener("click", ()=>{
    window._kindFilter = "move";
    applyKindButtons(btnKindMove);
    render();
  });

  if($("#f_reset")){
    $("#f_reset").addEventListener("click",()=>{
      $("#date_from").value = "";
      $("#date_to").value   = "";
      $("#f_status").value  = "";
      $("#q").value         = "";
      window._kindFilter    = "";
      applyKindButtons(btnKindAll);
      render();
    });
  }
  ["date_from","date_to","f_status","q"].forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.addEventListener("input",()=>render());
  });

  /* ===== Process Timeline helpers ===== */
  function renderTimelineSteps(steps, trackId){
    const track = document.getElementById(trackId);
    if(!track) return;
    let firstActive = false;
    const html = steps.map((s,idx)=>{
      let state="";
      if(s.done) state="done";
      else if(!firstActive){state="active"; firstActive=true;}
      else state="upcoming";
      return `
        <div class="pt-step ${state}">
          <div class="pt-circle">${idx+1}</div>
          <div class="pt-label">${s.label}</div>
          <div class="pt-desc">${s.desc||""}</div>
        </div>
      `;
    }).join("");
    track.innerHTML = html;
  }

  function renderShootTimeline(req){
    const admin = req.admin || {};
    const status = req.status || "";
    const steps = [
      {
        label:"تم استلام الطلب",
        desc: admin.received || "لم يتم الاستلام بعد",
        done: !!admin.received
      },
      {
        label:"تم ارسال السيارة",
        desc: admin.prepared || "لم يتم الارسال بعد",
        done: !!admin.prepared
      },
      {
        label:"تم استلام السيارة",
        desc: admin.carReceived || "لم يتم الاستلام بعد",
        done: !!admin.carReceived
      },
      {
        label:"تم الانتهاء",
        desc: status==="تم" ? (admin.finished || "تم إنهاء الطلب") : "لم يتم الانتهاء بعد",
        done: status==="تم"
      }
    ];
    renderTimelineSteps(steps,"reqTimelineTrack");
  }

  function renderMoveTimeline(moveReq){
    const admin = moveReq.admin || {};
    const executed = moveReq.executedAt || "";
    const status   = moveReq.status || "";
    const steps = [
      {
        label:"تم استلام الطلب",
        desc: admin.received || "لم يتم الاستلام بعد",
        done: !!admin.received
      },
      {
        label:"تم ارسال السيارة",
        desc: admin.sent || "لم يتم الارسال بعد",
        done: !!admin.sent
      },
      {
        label:"تم استلام السيارة",
        desc: admin.carReceived || "لم يتم الاستلام بعد",
        done: !!admin.carReceived
      },
      {
        label:"تم الانتهاء",
        desc: executed || (status==="منفّذ" ? (admin.finished || "تم تنفيذ الطلب") : "لم يتم الانتهاء بعد"),
        done: status==="منفّذ"
      }
    ];
    renderTimelineSteps(steps,"moveTimelineTrack");
  }

  /* ==== تصوير: إجراءات ==== */
  function updateShootRequestLocal(updated){
    shootRequests = shootRequests.map(r=> r.id===updated.id ? updated : r);
  }

  async function markShootStep1(req){
    const base = (shootRequests || []).find(r => r.id === req.id) || req;
    const admin = { ...(base.admin || {}) };
    if (!admin.received) admin.received = now();
    const clone = { ...base, admin };
    if (clone.status === "مسودة") clone.status = "تحت الإجراء";
    updateShootRequestLocal(clone);
    await persistAll();
    metrics(); render(); renderShootTimeline(clone);
    showToast("تم استلام الطلب");
  }


  async function markShootStep2(req){
    // خطوة إرسال السيارة للتصوير — نجعلها تراكمية
    const base = (shootRequests || []).find(r => r.id === req.id) || req;
    const admin = { ...(base.admin || {}) };
    const ts = now();
    if (!admin.received) admin.received = ts;
    if (!admin.prepared) admin.prepared = ts;
    const clone = { ...base, admin };
    if (clone.status === "مسودة") clone.status = "تحت الإجراء";
    moveCarsToShootPlace(clone.rows || []);
    updateShootRequestLocal(clone);
    await persistAll();
    metrics(); render(); renderShootTimeline(clone);
    showToast("تم ارسال السيارة للتصوير وتحديث أماكن السيارات");
  }


  async function markShootStep3(req){
    // تأكيد استلام السيارة في موقع التصوير — نجعلها تراكمية
    const base = (shootRequests || []).find(r => r.id === req.id) || req;
    const admin = { ...(base.admin || {}) };
    const ts = now();
    if (!admin.received) admin.received = ts;
    if (!admin.prepared) admin.prepared = ts;
    if (!admin.carReceived) admin.carReceived = ts;
    const clone = { ...base, admin };
    updateShootRequestLocal(clone);
    await persistAll();
    metrics(); render(); renderShootTimeline(clone);
    showToast("تم تأكيد استلام السيارة بموقع التصوير");
  }


  async function markShootStep4(req){
    // إنهاء طلب التصوير — نجعل كل الخطوات مكتملة
    const base = (shootRequests || []).find(r => r.id === req.id) || req;
    const admin = { ...(base.admin || {}) };
    const ts = now();
    if (!admin.received) admin.received = ts;
    if (!admin.prepared) admin.prepared = ts;
    if (!admin.carReceived) admin.carReceived = ts;
    if (!admin.finished) admin.finished = ts;
    const clone = { ...base, admin };
    clone.status = "تم";
    updateShootRequestLocal(clone);
    await persistAll();
    metrics(); render(); renderShootTimeline(clone);
    showToast("تم الانتهاء من طلب التصوير");
  }


  async function markMoveStep1(req){
    // استلام طلب النقل — نأخذ أحدث نسخة من الطلب ونجعل الخطوة الأولى مكتملة
    const base = (moveRequests || []).find(r => r.id === req.id) || req;
    const admin = { ...(base.admin || {}) };
    if (!admin.received) admin.received = now();
    const clone = { ...base, admin };
    if (clone.status === "مسودة") clone.status = "قيد المراجعة";
    updateMoveRequestLocal(clone);
    await persistAll();
    metrics(); render(); renderMoveTimeline(clone);
    showToast("تم استلام الطلب");
  }


  async function markMoveStep2(req){
    // إرسال السيارة — تراكمياً: نتأكد أن استلام الطلب مسجل أيضاً
    const base = (moveRequests || []).find(r => r.id === req.id) || req;
    const admin = { ...(base.admin || {}) };
    const ts = now();
    if (!admin.received) admin.received = ts;
    if (!admin.sent) admin.sent = ts;
    const clone = { ...base, admin };
    if (clone.status === "مسودة" || clone.status === "قيد المراجعة") clone.status = "تحت الإجراء";
    updateMoveRequestLocal(clone);
    await persistAll();
    metrics(); render(); renderMoveTimeline(clone);
    showToast("تم ارسال السيارة");
  }


  async function markMoveStep3(req){
    // استلام السيارة في الموقع الجديد — تراكمياً نضمن كل ما قبلها
    const base = (moveRequests || []).find(r => r.id === req.id) || req;
    const admin = { ...(base.admin || {}) };
    const ts = now();
    if (!admin.received) admin.received = ts;
    if (!admin.sent) admin.sent = ts;
    if (!admin.carReceived) admin.carReceived = ts;
    const clone = { ...base, admin };
    updateMoveRequestLocal(clone);
    await persistAll();
    metrics(); render(); renderMoveTimeline(clone);
    showToast("تم استلام السيارة في الموقع الجديد");
  }


  async function markMoveStep4(req){
    // إنهاء طلب النقل — لو منتهي قبل كده نمنع التكرار، وإلا نكمل كل الخطوات
    const latest = (moveRequests || []).find(r => r.id === req.id) || req;
    if (latest.executedAt) {
      showToast("تم الانتهاء من الطلب مسبقًا");
      return;
    }
    const admin = { ...(latest.admin || {}) };
    const ts = now();
    if (!admin.received) admin.received = ts;
    if (!admin.sent) admin.sent = ts;
    if (!admin.carReceived) admin.carReceived = ts;
    if (!admin.finished) admin.finished = ts;

    const clone = { ...latest, admin };
    clone.status     = "منفّذ";
    clone.executedAt = ts;

    applyMoveToStock(clone.rows || []);
    updateMoveRequestLocal(clone);
    await persistAll();
    metrics(); render(); renderMoveTimeline(clone);
    showToast("تم تنفيذ حركة النقل وتحديث المخزون");
  }

  
  async function fetchUserRole(user){
    currentUserUid = user?.uid || null;
    currentUserEmail = user?.email || "";
    currentUserRole = null;
    currentUserLocations = [];
    try{
      const snap = await getDoc(doc(db,"user", user.uid));
      if(snap.exists()){
        const data = snap.data() || {};
        currentUserRole = data.role || null;
        const loc = data.locations;
        if(Array.isArray(loc)){
          currentUserLocations = loc;
        }else if(typeof loc === "string" && loc.trim()){
          currentUserLocations = [loc.trim()];
        }else{
          currentUserLocations = [];
        }
        if(data.email){
          currentUserEmail = data.email;
        }
        return currentUserRole;
      }
    }catch(e){
      console.error("fetch role error", e);
    }
    return currentUserRole;
  }


  function showAuthGate(){
    document.getElementById("authGate").style.display = "block";
    document.getElementById("app").style.display      = "none";
  }
  function showApp(){
    document.getElementById("authGate").style.display = "none";
    document.getElementById("app").style.display      = "block";
  }

  onAuthStateChanged(auth, async (user)=>{
    if(!user){
      $("#userLabel").textContent = "غير مسجل";
      $("#btnSignOut").style.display = "none";
      showAuthGate();
      return;
    }
    $("#userLabel").textContent = user.email || "";
    $("#btnSignOut").style.display = "inline-flex";

    const role = await fetchUserRole(user);
    if(!role || !PAGE_ALLOWED_ROLES.includes(role)){
      // تحويل مباشر لصفحة عدم الصلاحية
      window.location.href = "unauthorized.html";
      return;
    }
    setStatus("ok","متصل بحساب الإدارة");
    showApp();
    // تطبيق صلاحيات التابات حسب الدور
    applyTabsVisibility(role);
    buildFormRows();

    // ✅ تحميل حالة النظام (المخزون + الطلبات) من STATE_REF
    onSnapshot(STATE_REF, (snap) => {
      const data = snap.data() || {};
      shootRequests = Array.isArray(data.shootRequests) ? data.shootRequests : [];
      moveRequests  = Array.isArray(data.moveRequests)  ? data.moveRequests  : [];
      stock         = Array.isArray(data.stock)         ? data.stock         : [];
      moves         = Array.isArray(data.moves)         ? data.moves         : [];

      metrics();
      render();
      const su = document.getElementById("stat_updated");
      if (su) su.textContent = data.updatedAt || "—";
    });
  });

  document.getElementById("btnSignOut")?.addEventListener("click",async ()=>{
    await signOut(auth);
  });

  const loginForm = document.getElementById("loginForm");
  if(loginForm){
    loginForm.addEventListener("submit",async (e)=>{
      e.preventDefault();
      const email = document.getElementById("email").value.trim();
      const pass  = document.getElementById("password").value;
      const btn   = document.getElementById("btnSignIn");
      try{
        btn.disabled = true;
        await signInWithEmailAndPassword(auth,email,pass);
        showToast("تم تسجيل الدخول");
      }catch(err){
        console.error(err);
        alert("بيانات الدخول غير صحيحة");
      }finally{
        btn.disabled = false;
      }
    });
  }
</script>
</body>
</html>
