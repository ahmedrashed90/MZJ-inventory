<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MZJ — إدارة الطلبات</title>

  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --brown:#3e2420;
      --beige:#e8d6c8;
      --cream:#fff8ef;
      --text:#1f2937;
      --muted:#6b7280;
      --ok:#16a34a;
      --warn:#f59e0b;
      --bad:#ef4444;
      --radius:14px;
      --shadow:0 16px 40px rgba(0,0,0,.08);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:"Tajawal",system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:var(--cream);
      color:var(--text);
    }

    /* Topbar */
    .topbar{
      background:#fff;
      border-bottom:1px solid var(--beige);
      padding:12px 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      position:sticky;
      top:0;
      z-index:20;
    }
    .brand{
      display:flex; align-items:center; gap:12px;
    }
    .logo{
      width:44px;height:44px;border-radius:14px;
      background:var(--brown);
      display:grid;place-items:center;
      color:#fff;font-weight:800;
    }
    .brand h1{margin:0;font-size:16px}
    .brand p{margin:2px 0 0;font-size:12px;color:var(--muted)}
    .tabs{
      display:flex;gap:10px;align-items:center;flex-wrap:wrap;
      justify-content:center;
    }
    .tab{
      padding:10px 16px;border-radius:999px;
      border:1px solid var(--beige);
      background:#fff;color:var(--brown);
      font-weight:700;font-size:13px;
      cursor:pointer;
      transition:.2s ease;
      user-select:none;
    }
    .tab.active{background:var(--brown);color:#fff;border-color:var(--brown)}
    .pillbar{
      display:flex;gap:8px;align-items:center;flex-wrap:wrap;
      justify-content:flex-start;
    }
    .pill{
      padding:8px 12px;border-radius:999px;border:1px solid var(--beige);
      background:#fff;font-size:12px;color:var(--muted);
      display:flex;gap:8px;align-items:center;
    }
    .dot{width:8px;height:8px;border-radius:999px;background:#bbb}
    .dot.ok{background:var(--ok)}
    .dot.warn{background:var(--warn)}
    .dot.bad{background:var(--bad)}

    /* Layout */
    .wrap{max-width:1180px;margin:18px auto;padding:0 14px}
    .card{
      background:#fff;border:1px solid rgba(232,214,200,.9);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card-h{
      padding:14px 16px;
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      border-bottom:1px solid rgba(232,214,200,.65);
      background:linear-gradient(180deg,#fff, #fffaf6);
    }
    .card-h h2{margin:0;font-size:16px}
    .card-h .sub{font-size:12px;color:var(--muted)}
    .card-b{padding:14px 16px}

    .row{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;
    }
    .grow{flex:1}
    .btn{
      border:1px solid var(--beige);
      background:#fff;
      color:var(--brown);
      border-radius:12px;
      padding:10px 14px;
      font-weight:800;
      cursor:pointer;
      transition:.2s;
      display:inline-flex;align-items:center;gap:8px;
    }
    .btn:hover{background:#faf2ec}
    .btn.primary{
      background:var(--brown);color:#fff;border-color:var(--brown);
    }
    .btn.primary:hover{filter:brightness(1.05)}
    .btn.danger{
      background:#fff;color:var(--bad);border-color:#fecaca;
    }
    .btn.success{
      background:var(--ok);color:#fff;border-color:var(--ok);
    }
    .btn.muted{
      background:#f8fafc;color:#111;border-color:#e5e7eb;
    }
    .btn:disabled{opacity:.55;cursor:not-allowed}

    .input, .select{
      width:100%;
      padding:10px 12px;
      border:1px solid #e5e7eb;
      border-radius:12px;
      outline:none;
      font-size:13px;
      background:#fff;
    }
    .input:focus,.select:focus{border-color:#d9b9a4;box-shadow:0 0 0 3px rgba(232,214,200,.45)}
    .help{margin-top:8px;color:var(--muted);font-size:12px;line-height:1.5}

    /* Table */
    .table-wrap{overflow:auto;border:1px solid rgba(232,214,200,.65);border-radius:12px}
    table{width:100%;border-collapse:separate;border-spacing:0;min-width:980px}
    thead th{
      position:sticky;top:0;background:#fffaf6;
      border-bottom:1px solid rgba(232,214,200,.65);
      padding:12px 10px;font-size:12px;color:#4b5563;
      text-align:center;
      z-index:2;
    }
    tbody td{
      border-bottom:1px solid #f1f5f9;
      padding:10px;
      text-align:center;
      vertical-align:middle;
      font-size:13px;
    }
    tbody tr:hover td{background:#fffdfb}
    .td-left{text-align:right}
    .badge{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 10px;border-radius:999px;
      font-size:12px;font-weight:800;
      border:1px solid rgba(232,214,200,.75);
      background:#fff;
      color:var(--brown);
      white-space:nowrap;
    }
    .badge.move{background:#fff; border-color:#d9b9a4}
    .badge.shoot{background:#fff; border-color:#d9b9a4}
    .small{font-size:12px;color:var(--muted)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace}

    /* Progress */
    .pwrap{display:flex;flex-direction:column;gap:8px}
    .pbar{
      height:10px;background:#f1f5f9;border-radius:999px;
      overflow:hidden;border:1px solid #e5e7eb;
    }
    .pbar > div{
      height:100%;width:0%;
      background:linear-gradient(90deg,var(--brown),#6b3d36);
      transition:width .2s ease;
    }
    .pmeta{display:flex;justify-content:space-between;gap:10px;color:var(--muted);font-size:12px}

    /* Modal */
    .modal-backdrop{
      position:fixed;inset:0;background:rgba(0,0,0,.35);
      display:none;align-items:center;justify-content:center;
      padding:16px;z-index:50;
    }
    .modal{
      width:min(980px, 100%);
      max-height:90vh;
      background:#fff;border-radius:18px;
      box-shadow:0 30px 80px rgba(0,0,0,.25);
      overflow:hidden;
      display:flex;flex-direction:column;
    }
    .modal-h{
      padding:14px 16px;
      border-bottom:1px solid rgba(232,214,200,.7);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      background:linear-gradient(180deg,#fff, #fffaf6);
    }
    .modal-h .title{font-weight:900}
    .modal-h .meta{font-size:12px;color:var(--muted)}
    .modal-b{padding:14px 16px;overflow:auto}
    .modal-f{
      padding:12px 16px;border-top:1px solid rgba(232,214,200,.7);
      display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;
      background:#fff;
    }
    .actionbar{
      display:flex;flex-wrap:wrap;gap:10px;align-items:center;
    }

    .toast{
      position:fixed;left:16px;bottom:16px;
      background:#111827;color:#fff;
      padding:12px 14px;border-radius:14px;
      box-shadow:0 20px 50px rgba(0,0,0,.25);
      display:none;z-index:99;
      max-width:min(520px, 92vw);
      font-size:13px;line-height:1.5;
    }
    .toast.show{display:block}
    .toast .t-title{font-weight:900;margin-bottom:4px}
    .toast .t-sub{opacity:.9}

    @media (max-width:720px){
      table{min-width:860px}
      .tab{padding:9px 12px}
      .brand h1{font-size:14px}
    }
  </style>
</head>

<body>

  <div class="topbar">
    <div class="brand">
      <div class="logo">MZJ</div>
      <div>
        <h1>محمد بن ذعار العجمي للسيارات</h1>
        <p>Workspace — إدارة الطلبات</p>
      </div>
    </div>

    <div class="tabs">
      <div id="tabCreate" class="tab active">طلب جديد</div>
      <div id="tabManage" class="tab">إدارة الطلبات</div>
    </div>

    <div class="pillbar">
      <div class="pill"><span class="dot warn" id="connDot"></span><span id="connTxt">جارٍ الاتصال…</span></div>
      <div class="pill"><span>الدور:</span><strong id="roleTxt">—</strong></div>
      <div class="pill"><span>الأماكن:</span><strong id="locTxt">—</strong></div>
      <div class="pill"><span>Project:</span><strong id="projTxt">—</strong></div>
    </div>
  </div>

  <div class="wrap">
    <!-- CREATE -->
    <div id="viewCreate" class="card">
      <div class="card-h">
        <div>
          <h2>إنشاء طلب سريع</h2>
          <div class="sub">اكتب VIN واضغط Enter — البيانات تظهر تلقائيًا</div>
        </div>
        <div class="row">
          <button id="btnClearDraft" class="btn muted">تفريغ</button>
          <button id="btnSubmitDraft" class="btn primary">إرسال الطلب</button>
        </div>
      </div>

      <div class="card-b">
        <div class="row" style="gap:12px">
          <div style="min-width:260px">
            <input id="vinQuick" class="input mono" placeholder="اكتب رقم الهيكل VIN ثم Enter" />
            <div class="help">
              • يمنع إنشاء طلب لهيكل خارج أماكن المستخدم (إلا Admin).<br>
              • تقدر تضيف أكثر من VIN في نفس الطلب.
            </div>
          </div>

          <div class="grow">
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th style="width:54px">#</th>
                    <th style="width:150px">نوع الطلب</th>
                    <th style="width:140px">VIN</th>
                    <th>السيارة</th>
                    <th>البيان</th>
                    <th style="width:220px">من</th>
                    <th style="width:220px">إلى / مكان التصوير</th>
                    <th style="width:120px">حذف</th>
                  </tr>
                </thead>
                <tbody id="draftTbody">
                  <!-- rows -->
                </tbody>
              </table>
            </div>
            <div class="help">
              المصدر الأساسي للمكان: <span class="mono">inventory/{VIN}</span> — داخل الطلب نخزن: <span class="mono">vins: [{vin, fromLocation, toLocation, kind}]</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- MANAGE -->
    <div id="viewManage" class="card" style="display:none;margin-top:16px">
      <div class="card-h">
        <div>
          <h2>إدارة الطلبات</h2>
          <div class="sub">تحديث لحظي — بدون Refresh</div>
        </div>
        <div class="row">
          <select id="filterKind" class="select" style="width:220px">
            <option value="all">الكل</option>
            <option value="move">طلبات نقل</option>
            <option value="shoot">طلبات تصوير</option>
          </select>
          <input id="searchTxt" class="input" style="width:260px" placeholder="بحث برقم الطلب أو VIN" />
          <button id="btnReload" class="btn">تحديث</button>
        </div>
      </div>

      <div class="card-b">
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th style="width:90px">رقم</th>
                <th style="width:120px">نوع</th>
                <th>VINs</th>
                <th style="width:160px">المنشئ</th>
                <th style="width:160px">التاريخ</th>
                <th style="width:220px">التقدم</th>
                <th style="width:140px">فتح</th>
              </tr>
            </thead>
            <tbody id="reqTbody">
              <tr><td colspan="7" class="small">جارٍ التحميل…</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

  </div>

  <!-- MODAL -->
  <div id="modalBackdrop" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modal-h">
        <div>
          <div class="title" id="mTitle">تفاصيل الطلب</div>
          <div class="meta" id="mMeta">—</div>
        </div>
        <button id="mClose" class="btn">إغلاق</button>
      </div>

      <div class="modal-b">
        <div class="pwrap">
          <div class="pmeta">
            <div><strong>Progress عام</strong> — <span id="mProgTxt">0%</span></div>
            <div class="small" id="mProgNote">—</div>
          </div>
          <div class="pbar"><div id="mProgBar"></div></div>
        </div>

        <div style="height:12px"></div>

        <div class="table-wrap">
          <table style="min-width:920px">
            <thead>
              <tr>
                <th style="width:54px">#</th>
                <th style="width:140px">VIN</th>
                <th>السيارة</th>
                <th style="width:240px">من</th>
                <th style="width:240px">إلى / تصوير</th>
                <th style="width:120px">المرحلة</th>
                <th style="width:160px">آخر تحديث</th>
              </tr>
            </thead>
            <tbody id="mRows"></tbody>
          </table>
        </div>

        <div style="height:14px"></div>

        <div class="card" style="box-shadow:none;border-radius:14px;border:1px solid rgba(232,214,200,.7)">
          <div class="card-h" style="border-bottom:1px solid rgba(232,214,200,.6)">
            <div>
              <h2 style="margin:0;font-size:14px">Log</h2>
              <div class="sub">يظهر للإدارة فقط</div>
            </div>
          </div>
          <div class="card-b">
            <div id="mLog" class="small">—</div>
          </div>
        </div>
      </div>

      <div class="modal-f">
        <div class="actionbar">
          <button id="btnEdit" class="btn">تعديل الطلب</button>

          <button id="btnStep1" class="btn">1 تم استلام الطلب</button>
          <button id="btnStep2" class="btn">2 تم إرسال السيارة</button>
          <button id="btnStep3" class="btn">3 تم استلام السيارة</button>

          <button id="btnStep4" class="btn success">4 تم الانتهاء</button>
        </div>
        <div class="small" id="mPermHint">—</div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast">
    <div class="t-title" id="toastTitle">—</div>
    <div class="t-sub" id="toastSub">—</div>
  </div>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script>
    /* =========================
       CONFIG
    ========================= */
    const firebaseConfig = {
      apiKey: "AIzaSyC614bGqnYf4Q-weTNemzWENTpa8DjGeHw",
      authDomain: "mzj-agenda.firebaseapp.com",
      projectId: "mzj-agenda",
      storageBucket: "mzj-agenda.firebasestorage.app",
      messagingSenderId: "834700407721",
      appId: "1:834700407721:web:75c17665d4f032fd65cab8"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const serverTimestamp = firebase.firestore.FieldValue.serverTimestamp;

    // Optional: persistence
    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(()=>{});

    /* =========================
       DOM
    ========================= */
    const el = (id)=>document.getElementById(id);

    const viewCreate = el("viewCreate");
    const viewManage = el("viewManage");
    const tabCreate = el("tabCreate");
    const tabManage = el("tabManage");

    const connDot = el("connDot");
    const connTxt = el("connTxt");
    const roleTxt = el("roleTxt");
    const locTxt = el("locTxt");
    const projTxt = el("projTxt");

    const vinQuick = el("vinQuick");
    const draftTbody = el("draftTbody");
    const btnClearDraft = el("btnClearDraft");
    const btnSubmitDraft = el("btnSubmitDraft");

    const filterKind = el("filterKind");
    const searchTxt = el("searchTxt");
    const btnReload = el("btnReload");
    const reqTbody = el("reqTbody");

    const modalBackdrop = el("modalBackdrop");
    const mClose = el("mClose");
    const mTitle = el("mTitle");
    const mMeta = el("mMeta");
    const mRows = el("mRows");
    const mLog = el("mLog");
    const mProgBar = el("mProgBar");
    const mProgTxt = el("mProgTxt");
    const mProgNote = el("mProgNote");
    const mPermHint = el("mPermHint");

    const btnEdit = el("btnEdit");
    const btnStep1 = el("btnStep1");
    const btnStep2 = el("btnStep2");
    const btnStep3 = el("btnStep3");
    const btnStep4 = el("btnStep4");

    const toast = el("toast");
    const toastTitle = el("toastTitle");
    const toastSub = el("toastSub");

    projTxt.textContent = firebaseConfig.projectId || "—";

    /* =========================
       STATE
    ========================= */
    let currentUser = null;
    let userProfile = null;
    let isAdmin = false;
    let userLocations = [];

    // draft rows
    let draftRows = []; // [{vin, kind, fromLocation, toLocation, carName, statement, ok, error}]

    // requests live
    let unsubRequests = null;
    let unsubModal = null;
    let currentModalReqId = null;
    let currentModalReq = null;

    /* =========================
       UI helpers
    ========================= */
    function showToast(title, sub){
      toastTitle.textContent = title;
      toastSub.textContent = sub || "";
      toast.classList.add("show");
      setTimeout(()=>toast.classList.remove("show"), 2600);
    }

    function fmtDate(ts){
      try{
        if(!ts) return "—";
        const d = ts.toDate ? ts.toDate() : new Date(ts);
        return d.toLocaleString("ar-SA");
      }catch{ return "—"; }
    }

    function safeStr(x){ return (x ?? "").toString(); }

    function openTab(which){
      const isCreate = which==="create";
      tabCreate.classList.toggle("active", isCreate);
      tabManage.classList.toggle("active", !isCreate);
      viewCreate.style.display = isCreate ? "" : "none";
      viewManage.style.display = isCreate ? "none" : "";
      if(!isCreate) startRequestsListener();
    }

    tabCreate.addEventListener("click", ()=>openTab("create"));
    tabManage.addEventListener("click", ()=>openTab("manage"));

    /* =========================
       PROFILE LOADER (GLOBAL)
       - supports user/{uid} OR query by email in 'user'
    ========================= */
    async function loadUserProfile(user){
      const email = (user?.email || "").toLowerCase().trim();
      const uid = user?.uid || "";

      // 1) user/{uid}
      if(uid){
        const s1 = await db.collection("user").doc(uid).get().catch(()=>null);
        if(s1 && s1.exists) return {id:s1.id, ...s1.data()};
        const s2 = await db.collection("users").doc(uid).get().catch(()=>null);
        if(s2 && s2.exists) return {id:s2.id, ...s2.data()};
      }

      // 2) query by email
      if(email){
        const q1 = await db.collection("user").where("email","==",email).limit(1).get().catch(()=>null);
        if(q1 && !q1.empty){ const d=q1.docs[0]; return {id:d.id, ...d.data()}; }
        const q2 = await db.collection("users").where("email","==",email).limit(1).get().catch(()=>null);
        if(q2 && !q2.empty){ const d=q2.docs[0]; return {id:d.id, ...d.data()}; }
      }

      return null;
    }

    function setConn(status, txt){
      connDot.classList.remove("ok","warn","bad");
      connDot.classList.add(status);
      connTxt.textContent = txt;
    }

    /* =========================
       AUTH
    ========================= */
    auth.onAuthStateChanged(async (u)=>{
      currentUser = u || null;
      if(!currentUser){
        setConn("bad","غير مسجل");
        roleTxt.textContent="—";
        locTxt.textContent="—";
        showToast("غير مسجل", "افتح الصفحة من نفس الدومين اللي بتسجّل عليه دخول.");
        return;
      }

      setConn("warn","جارٍ تحميل البروفايل…");
      userProfile = await loadUserProfile(currentUser);

      if(!userProfile){
        // fallback minimal as admin if your rules allow
        userProfile = { role:"admin", locations:[] };
      }

      const role = (userProfile.role || "").toString().trim();
      userLocations = Array.isArray(userProfile.locations) ? userProfile.locations : [];

      // Admin detection:
      // - role === "admin" OR email includes 'admin' OR specific list
      const email = (currentUser.email || "").toLowerCase();
      const adminEmails = [
        "mr.ahmed_rashed@outlook.sa",
        "mr_ahmed_rashed@outlook.sa"
      ];
      isAdmin = role === "admin" || adminEmails.includes(email);

      roleTxt.textContent = role || (isAdmin ? "admin" : "—");
      locTxt.textContent = isAdmin ? "كل الأماكن" : (userLocations.length ? (userLocations.length + " مكان") : "0");

      setConn("ok","مسجل");
      // default to manage if you want:
      openTab("create");
    });

    /* =========================
       LOCATION permission helpers
    ========================= */
    function canTouchLocation(locationName){
      if(isAdmin) return true;
      if(!locationName) return false;
      return userLocations.includes(locationName);
    }

    // For a request: if user can act on any VIN line whose from/to matches his locations.
    function canActOnReq(req){
      if(isAdmin) return true;
      if(!req || !Array.isArray(req.vins)) return false;
      // allow if any line belongs to his scope
      return req.vins.some(v => canTouchLocation(v.fromLocation) || canTouchLocation(v.toLocation));
    }

    // For step:
    // step1 "استلام الطلب": مسؤول عن "toLocation" (الجهة المستلمة) + admin
    // step2 "ارسال السيارة": مسؤول عن "fromLocation" (الجهة المرسلة) + admin
    // step3 "استلام السيارة": مسؤول عن "toLocation" + admin
    // step4 "انهاء": منشئ الطلب فقط (أو admin)
    function canDoStep(req, step){
      if(!req) return false;
      if(isAdmin) return true;

      const myEmail = (currentUser?.email || "").toLowerCase();
      const createdByEmail = (req.createdByEmail || "").toLowerCase();

      if(step === 4){
        return myEmail && createdByEmail && myEmail === createdByEmail;
      }

      const lines = Array.isArray(req.vins) ? req.vins : [];
      if(step === 1 || step === 3){
        return lines.some(l => canTouchLocation(l.toLocation));
      }
      if(step === 2){
        return lines.some(l => canTouchLocation(l.fromLocation));
      }
      return false;
    }

    /* =========================
       Draft UI (Create)
    ========================= */
    function renderDraft(){
      if(!draftRows.length){
        draftTbody.innerHTML = `
          <tr>
            <td colspan="8" class="small">اكتب VIN واضغط Enter لإضافة سطر.</td>
          </tr>
        `;
        return;
      }

      draftTbody.innerHTML = draftRows.map((r, idx)=>{
        const err = r.error ? `<div class="small" style="color:var(--bad);margin-top:6px">${r.error}</div>` : "";
        const okBadge = r.ok ? `<div class="small" style="color:var(--ok);margin-top:6px">جاهز</div>` : "";
        const car = safeStr(r.carName) || "—";
        const st = safeStr(r.statement) || "—";
        const from = safeStr(r.fromLocation) || "—";
        const to = safeStr(r.toLocation) || "—";

        return `
          <tr>
            <td>${idx+1}</td>
            <td>
              <select class="select" data-k="kind" data-i="${idx}">
                <option value="move" ${r.kind==="move"?"selected":""}>نقل</option>
                <option value="shoot" ${r.kind==="shoot"?"selected":""}>تصوير</option>
              </select>
            </td>
            <td class="mono">${safeStr(r.vin)}</td>
            <td class="td-left">${car}</td>
            <td class="td-left">${st}</td>
            <td class="td-left"><span class="badge">${from}</span></td>
            <td>
              <select class="select" data-k="to" data-i="${idx}">
                ${buildToOptions(r).map(o=>`<option value="${escapeHtml(o)}" ${o===r.toLocation?"selected":""}>${escapeHtml(o)}</option>`).join("")}
              </select>
              ${err || okBadge}
            </td>
            <td>
              <button class="btn danger" data-k="del" data-i="${idx}">حذف</button>
            </td>
          </tr>
        `;
      }).join("");
    }

    function escapeHtml(s){
      return (s||"").toString()
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function buildToOptions(row){
      // You told: places fixed (list in user.locations and general locations list)
      // We'll offer userLocations + known hubs. Admin can see all.
      const base = [
        "الاستديو",
        "الصالة الاساسية",
        "صالة القادسية",
        "معرض الملتقى",
        "المستودع : المخزون المتاح",
        "المستودع : سيارات بها ملاحظات",
        "المستودع : مباع تحت التسليم",
        "المستودع : مباع تم التسليم",
        "فرع 1 الصالة : المخزون المتاح",
        "فرع 1 الصالة : سيارات بها ملاحظات",
        "فرع 1 الصالة : مباع تحت التسليم",
        "فرع 1 الصالة : مباع تم التسليم",
        "فرع 2 الملتقى : المخزون المتاح",
        "فرع 2 الملتقى : سيارات بها ملاحظات",
        "فرع 2 الملتقى : مباع تحت التسليم",
        "فرع 2 الملتقى : مباع تم التسليم",
        "فرع 3 القادسية : المخزون المتاح",
        "فرع 3 القادسية : سيارات بها ملاحظات",
        "فرع 3 القادسية : مباع تحت التسليم",
        "فرع 3 القادسية : مباع تم التسليم"
      ];

      const opts = new Set(base);

      // include user's locations first
      if(Array.isArray(userLocations)) userLocations.forEach(l=>opts.add(l));

      // for move: prefer branch buckets; for shoot: prefer "الاستديو"
      const arr = Array.from(opts).filter(Boolean);

      // Put row.fromLocation as first hint
      const ordered = [];
      if(row.kind==="shoot"){
        if(arr.includes("الاستديو")) ordered.push("الاستديو");
      }
      if(row.fromLocation && arr.includes(row.fromLocation)) ordered.push(row.fromLocation);

      // rest
      arr.forEach(x=>{ if(!ordered.includes(x)) ordered.push(x); });

      return ordered;
    }

    async function addVinToDraft(vin){
      vin = (vin||"").toString().trim();
      if(!vin) return;

      // prevent duplicates in draft
      if(draftRows.some(r => r.vin === vin)){
        showToast("موجود بالفعل", `VIN ${vin} موجود داخل الطلب.`);
        return;
      }

      // fetch inventory/{vin}
      const invSnap = await db.collection("inventory").doc(vin).get().catch(()=>null);

      if(!invSnap || !invSnap.exists){
        draftRows.unshift({vin, kind:"move", ok:false, error:"VIN غير موجود في inventory"});
        renderDraft();
        return;
      }

      const inv = invSnap.data() || {};
      const fromLocation = inv.location || inv.place || inv.branch || "";
      const carName = inv.car || inv.model || inv.name || inv.vehicle || "";
      const statement = inv.statement || inv.trim || inv.variant || "";

      // Gate: can't create for outside user locations unless admin
      if(!canTouchLocation(fromLocation)){
        if(!isAdmin){
          showToast("ممنوع", `VIN خارج أماكن المستخدم: ${fromLocation || "—"}`);
          return;
        }
      }

      const row = {
        vin,
        kind:"move",
        fromLocation: fromLocation || "—",
        toLocation: "", // required
        carName,
        statement,
        ok:false,
        error:"اختر (إلى / مكان التصوير)"
      };

      // default toLocation:
      if(row.kind==="shoot"){
        row.toLocation = "الاستديو";
      }else{
        // default: pick first allowed (not same maybe)
        const opts = buildToOptions(row);
        row.toLocation = opts.find(o=>o && o !== row.fromLocation) || (opts[0]||"");
      }

      validateDraftRow(row);

      draftRows.push(row);
      renderDraft();
    }

    function validateDraftRow(r){
      r.error = "";
      if(!r.toLocation) r.error = "اختر (إلى / مكان التصوير)";
      if(r.kind==="shoot" && !r.toLocation) r.error = "اختر مكان التصوير";
      // For move: allow different location
      if(r.kind==="move" && r.toLocation && r.fromLocation && r.toLocation === r.fromLocation){
        r.error = "لا يمكن النقل لنفس المكان";
      }
      // Gate toLocation? (you can allow to choose any; actions will enforce)
      r.ok = !r.error;
    }

    vinQuick.addEventListener("keydown", async (e)=>{
      if(e.key === "Enter"){
        e.preventDefault();
        const v = vinQuick.value;
        vinQuick.value = "";
        await addVinToDraft(v);
      }
    });

    draftTbody.addEventListener("change", (e)=>{
      const t = e.target;
      const idx = Number(t.getAttribute("data-i"));
      const key = t.getAttribute("data-k");
      if(Number.isNaN(idx) || !draftRows[idx]) return;

      if(key === "kind"){
        draftRows[idx].kind = t.value;
        // for shoot, suggest studio
        if(draftRows[idx].kind==="shoot" && !draftRows[idx].toLocation){
          draftRows[idx].toLocation = "الاستديو";
        }
      }
      if(key === "to"){
        draftRows[idx].toLocation = t.value;
      }
      validateDraftRow(draftRows[idx]);
      renderDraft();
    });

    draftTbody.addEventListener("click", (e)=>{
      const t = e.target;
      const idx = Number(t.getAttribute("data-i"));
      const key = t.getAttribute("data-k");
      if(key === "del" && !Number.isNaN(idx)){
        draftRows.splice(idx,1);
        renderDraft();
      }
    });

    btnClearDraft.addEventListener("click", ()=>{
      draftRows = [];
      renderDraft();
      showToast("تم", "تفريغ الطلب.");
    });

    btnSubmitDraft.addEventListener("click", async ()=>{
      if(!currentUser){
        showToast("غير مسجل", "سجل دخول أولاً");
        return;
      }
      if(!draftRows.length){
        showToast("فارغ", "أضف VIN واحد على الأقل.");
        return;
      }

      // validate all
      draftRows.forEach(validateDraftRow);
      const bad = draftRows.find(r=>!r.ok);
      if(bad){
        renderDraft();
        showToast("غير مكتمل", "راجع السطور التي بها خطأ.");
        return;
      }

      // Split by kind: if mixed move & shoot -> create 2 requests (as you requested previously)
      const groups = { move:[], shoot:[] };
      draftRows.forEach(r=>groups[r.kind].push(r));

      const createdIds = [];
      for(const kind of ["move","shoot"]){
        if(!groups[kind].length) continue;

        const vins = groups[kind].map(r=>({
          vin: r.vin,
          kind,
          fromLocation: r.fromLocation || "",
          toLocation: r.toLocation || ""
        }));

        // canEdit true initially
        const payload = {
          kind,
          vins,
          canEdit: true,
          createdAt: serverTimestamp(),
          createdByUid: currentUser.uid || "",
          createdByEmail: (currentUser.email || ""),
          createdByName: (userProfile?.name || currentUser.displayName || ""),
          // progress structure:
          progress: {
            // per vin step: 0..4
            perVin: vins.reduce((acc,v)=>{ acc[v.vin]=0; return acc; }, {}),
            doneCount: 0,
            totalCount: vins.length,
            percent: 0
          },
          // steps log
          steps: {
            step1: {done:false, at:null, by:""},
            step2: {done:false, at:null, by:""},
            step3: {done:false, at:null, by:""},
            step4: {done:false, at:null, by:""}
          }
        };

        const ref = await db.collection("requests").add(payload);
        createdIds.push(ref.id);

        await writeLog("إنشاء طلب", `تم إنشاء طلب (${kind}) رقم ${ref.id}`, ref.id);
      }

      showToast("تم الإرسال", `تم إنشاء ${createdIds.length} طلب.`);
      draftRows = [];
      renderDraft();
      openTab("manage");
    });

    renderDraft();

    /* =========================
       Requests LIST (Manage) — LIVE
    ========================= */
    function startRequestsListener(){
      if(unsubRequests) return;

      const run = ()=>{
        if(unsubRequests){ unsubRequests(); unsubRequests=null; }
        reqTbody.innerHTML = `<tr><td colspan="7" class="small">جارٍ التحميل…</td></tr>`;

        // base query
        let q = db.collection("requests").orderBy("createdAt","desc");

        // NOTE: we filter client-side by kind/search/location for performance and simplicity
        unsubRequests = q.onSnapshot((snap)=>{
          const rows = [];
          snap.forEach(doc=>{
            const r = doc.data()||{};
            r._id = doc.id;

            // kind filter
            const fk = filterKind.value;
            if(fk !== "all" && r.kind !== fk) return;

            // search filter
            const s = (searchTxt.value||"").trim().toLowerCase();
            if(s){
              const inId = r._id.toString().includes(s);
              const inVin = (r.vins||[]).some(v => (v.vin||"").toLowerCase().includes(s));
              if(!inId && !inVin) return;
            }

            // permission filter: admin sees all, non-admin sees requests that touch his locations
            if(!isAdmin){
              const ok = canActOnReq(r);
              if(!ok) return;
            }

            rows.push(r);
          });

          if(!rows.length){
            reqTbody.innerHTML = `<tr><td colspan="7" class="small">لا توجد طلبات.</td></tr>`;
            return;
          }

          reqTbody.innerHTML = rows.map((r)=>{
            const id = r._id;
            const badge = `<span class="badge ${r.kind}">${r.kind==="move"?"نقل":"تصوير"}</span>`;
            const vins = (r.vins||[]).map(v=>v.vin).join(", ");
            const creator = escapeHtml(r.createdByName || r.createdByEmail || "—");
            const dt = fmtDate(r.createdAt);
            const percent = computeReqPercent(r);

            return `
              <tr>
                <td class="mono">${escapeHtml(id)}</td>
                <td>${badge}</td>
                <td class="td-left mono">${escapeHtml(vins || "—")}</td>
                <td class="td-left">${creator}</td>
                <td class="small">${escapeHtml(dt)}</td>
                <td>
                  <div class="pbar"><div style="width:${percent}%"></div></div>
                  <div class="small">${percent}%</div>
                </td>
                <td><button class="btn primary" data-open="${escapeHtml(id)}">فتح</button></td>
              </tr>
            `;
          }).join("");
        }, (err)=>{
          console.error(err);
          reqTbody.innerHTML = `<tr><td colspan="7" class="small" style="color:var(--bad)">خطأ في تحميل الطلبات</td></tr>`;
        });
      };

      run();
      btnReload.onclick = run;
      filterKind.onchange = run;
      searchTxt.oninput = ()=>{ if(unsubRequests){ /* let snapshot update */ } };

      reqTbody.addEventListener("click", (e)=>{
        const btn = e.target.closest("[data-open]");
        if(!btn) return;
        const id = btn.getAttribute("data-open");
        openRequestModal(id);
      });
    }

    function computeReqPercent(r){
      try{
        const perVin = r?.progress?.perVin || {};
        const vins = r?.vins || [];
        const total = vins.length || 1;
        let sum=0;
        vins.forEach(v=>{
          const st = perVin[v.vin] ?? 0; // 0..4
          sum += (st/4)*100;
        });
        return Math.round(sum / total);
      }catch{ return 0; }
    }

    /* =========================
       MODAL — LIVE onSnapshot
    ========================= */
    function closeModal(){
      modalBackdrop.style.display="none";
      modalBackdrop.setAttribute("aria-hidden","true");
      currentModalReqId = null;
      currentModalReq = null;
      if(unsubModal){ unsubModal(); unsubModal=null; }
    }

    function openModal(){
      modalBackdrop.style.display="flex";
      modalBackdrop.setAttribute("aria-hidden","false");
    }

    mClose.addEventListener("click", closeModal);
    modalBackdrop.addEventListener("click", (e)=>{
      if(e.target === modalBackdrop) closeModal();
    });
    window.addEventListener("keydown", (e)=>{
      if(e.key === "Escape" && modalBackdrop.style.display==="flex"){
        closeModal();
      }
    });

    async function openRequestModal(id){
      currentModalReqId = id;
      openModal();

      // detach old
      if(unsubModal){ unsubModal(); unsubModal=null; }

      // live doc listener
      unsubModal = db.collection("requests").doc(id).onSnapshot(async (snap)=>{
        if(!snap.exists){
          mTitle.textContent = "الطلب غير موجود";
          mMeta.textContent = id;
          return;
        }
        const r = snap.data()||{};
        currentModalReq = r;

        const kindLabel = r.kind==="move" ? "نقل" : "تصوير";
        mTitle.textContent = `تفاصيل الطلب #${id} — ${kindLabel}`;
        mMeta.textContent = `المنشئ: ${(r.createdByName || r.createdByEmail || "—")} • ${fmtDate(r.createdAt)}`;

        // progress
        const percent = computeReqPercent(r);
        mProgBar.style.width = percent + "%";
        mProgTxt.textContent = percent + "%";
        const done = Object.values(r?.progress?.perVin || {}).filter(x=>x>=4).length;
        const total = (r.vins||[]).length || 0;
        mProgNote.textContent = `مكتمل: ${done} / ${total}`;

        // rows
        const perVin = r?.progress?.perVin || {};
        const rows = (r.vins||[]).map((v, idx)=>{
          const st = perVin[v.vin] ?? 0;
          const stageTxt = stageName(st);
          const last = stageLast(r, v.vin);
          return `
            <tr>
              <td>${idx+1}</td>
              <td class="mono">${escapeHtml(v.vin)}</td>
              <td class="td-left">${escapeHtml(v.carName || "—")}</td>
              <td class="td-left"><span class="badge">${escapeHtml(v.fromLocation||"—")}</span></td>
              <td class="td-left"><span class="badge">${escapeHtml(v.toLocation||"—")}</span></td>
              <td>${escapeHtml(stageTxt)}</td>
              <td class="small">${escapeHtml(last || "—")}</td>
            </tr>
          `;
        }).join("");

        mRows.innerHTML = rows || `<tr><td colspan="7" class="small">لا توجد بيانات</td></tr>`;

        // buttons permission
        const canAny = canActOnReq(r);
        const can1 = canDoStep(r,1);
        const can2 = canDoStep(r,2);
        const can3 = canDoStep(r,3);
        const can4 = canDoStep(r,4);

        btnStep1.disabled = !can1;
        btnStep2.disabled = !can2;
        btnStep3.disabled = !can3;
        btnStep4.disabled = !can4;

        // edit allowed only if canEdit true AND no steps done anywhere
        const canEdit = !!r.canEdit && isRequestPristine(r) && (isAdmin || isCreator(r));
        btnEdit.style.display = canEdit ? "" : "none";

        mPermHint.textContent = isAdmin
          ? "Admin: تقدر تعمل كل الإجراءات."
          : "الإجراءات تظهر حسب مكانك + (تم الانتهاء) لمنشئ الطلب فقط.";

        // log (admin only)
        if(isAdmin){
          await loadLogForReq(id);
        }else{
          mLog.textContent = "—";
        }

      }, (err)=>{
        console.error(err);
        showToast("خطأ", "تعذر تحميل تفاصيل الطلب");
      });
    }

    function stageName(st){
      if(st>=4) return "مكتمل";
      if(st===3) return "تم استلام السيارة";
      if(st===2) return "تم إرسال السيارة";
      if(st===1) return "تم استلام الطلب";
      return "لم يبدأ";
    }

    function stageLast(r, vin){
      // show last action timestamp from activity log later (optional), for now use steps ts if exist
      // We'll check steps fields if stored perVin meta; else return createdAt.
      return fmtDate(r.updatedAt || r.createdAt);
    }

    function isCreator(r){
      const my = (currentUser?.email || "").toLowerCase();
      const cr = (r?.createdByEmail || "").toLowerCase();
      return !!my && !!cr && my === cr;
    }

    function isRequestPristine(r){
      // if any perVin stage >0 => not pristine
      const per = r?.progress?.perVin || {};
      return Object.values(per).every(x => (x||0) === 0);
    }

    /* =========================
       MODAL ACTIONS
    ========================= */
    async function applyStep(step){
      const id = currentModalReqId;
      const r = currentModalReq;
      if(!id || !r) return;

      // permission check
      if(!canDoStep(r, step)){
        showToast("لا توجد صلاحية", "الإجراء غير مسموح حسب مكانك/صلاحياتك.");
        return;
      }

      // compute which VINs this user can advance for this step:
      // step1/3 => toLocation owner, step2 => fromLocation owner, step4 => creator/admin and completes all remaining
      const perVin = {...(r.progress?.perVin || {})};
      const vins = (r.vins||[]);

      const advanceVin = (vin, newStage)=>{ perVin[vin] = Math.max(perVin[vin]||0, newStage); };

      if(step === 4){
        // creator finishes all vins to stage 4
        vins.forEach(v=>advanceVin(v.vin, 4));
      } else if(step === 1){
        vins.forEach(v=>{
          if(isAdmin || canTouchLocation(v.toLocation)){
            if((perVin[v.vin]||0) < 1) advanceVin(v.vin, 1);
          }
        });
      } else if(step === 2){
        vins.forEach(v=>{
          if(isAdmin || canTouchLocation(v.fromLocation)){
            if((perVin[v.vin]||0) < 2) advanceVin(v.vin, 2);
          }
        });
      } else if(step === 3){
        vins.forEach(v=>{
          if(isAdmin || canTouchLocation(v.toLocation)){
            if((perVin[v.vin]||0) < 3) advanceVin(v.vin, 3);
          }
        });
      }

      // after any action => canEdit false
      const updates = {
        "progress.perVin": perVin,
        canEdit: false,
        updatedAt: serverTimestamp()
      };

      await db.collection("requests").doc(id).set(updates, {merge:true});
      await writeLog(`تنفيذ خطوة ${step}`, `تم تنفيذ خطوة ${step} على الطلب #${id}`, id);

      showToast("تم", `تم تنفيذ الإجراء (${step})`);
    }

    btnStep1.addEventListener("click", ()=>applyStep(1));
    btnStep2.addEventListener("click", ()=>applyStep(2));
    btnStep3.addEventListener("click", ()=>applyStep(3));
    btnStep4.addEventListener("click", ()=>applyStep(4));

    btnEdit.addEventListener("click", async ()=>{
      const id = currentModalReqId;
      const r = currentModalReq;
      if(!id || !r) return;

      if(!(!!r.canEdit && isRequestPristine(r) && (isAdmin || isCreator(r)))){
        showToast("غير مسموح", "لا يمكن تعديل طلب تم عليه أي إجراء.");
        return;
      }

      // Simple edit UX: copy request vins to draft and go to create tab
      draftRows = (r.vins||[]).map(v=>({
        vin: v.vin,
        kind: r.kind || v.kind || "move",
        fromLocation: v.fromLocation || "",
        toLocation: v.toLocation || "",
        carName: v.carName || "",
        statement: v.statement || "",
        ok:true,
        error:""
      }));
      draftRows.forEach(validateDraftRow);
      renderDraft();
      closeModal();
      openTab("create");
      showToast("تعديل", "تم تحميل بيانات الطلب للتعديل.");
    });

    /* =========================
       LOG
    ========================= */
    async function writeLog(action, details, requestId){
      try{
        const payload = {
          action: action || "",
          details: details || "",
          requestId: requestId || "",
          ts: serverTimestamp(),
          date: new Date().toISOString().slice(0,10),
          user: userProfile?.name || currentUser?.displayName || "",
          email: currentUser?.email || ""
        };
        await db.collection("mzj_activity_log").add(payload);
      }catch(err){
        console.warn("log failed", err);
      }
    }

    async function loadLogForReq(requestId){
      try{
        // last 15 log entries for this request
        const snap = await db.collection("mzj_activity_log")
          .where("requestId","==", requestId)
          .orderBy("ts","desc")
          .limit(15)
          .get();

        if(snap.empty){
          mLog.textContent = "لا يوجد سجل.";
          return;
        }

        mLog.innerHTML = snap.docs.map(d=>{
          const x = d.data()||{};
          const when = fmtDate(x.ts);
          return `<div style="padding:8px 0;border-bottom:1px dashed #eee">
            <div><strong>${escapeHtml(x.action||"—")}</strong> <span class="small">• ${escapeHtml(when)}</span></div>
            <div class="small">${escapeHtml(x.details||"")}</div>
            <div class="small">${escapeHtml(x.user||x.email||"")}</div>
          </div>`;
        }).join("");
      }catch(err){
        console.error(err);
        mLog.textContent = "تعذر تحميل السجل.";
      }
    }
  </script>
</body>
</html>
