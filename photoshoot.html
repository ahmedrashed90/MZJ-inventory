
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<link rel="prefetch" href="admin.html">
<link rel="prefetch" href="inventory.html">
<link rel="prefetch" href="dashboard.html">
<link rel="prefetch" href="photoshoot.html">
<link rel="prefetch" href="index.html">

<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<style id="noFlash">
#authGate,#app{display:none!important}
html{background:#fff8ef}
body{opacity:0;transition:opacity .12s ease}
</style>
<meta name="color-scheme" content="light">
<title>Ù„ÙˆØ­Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª â€” MZJ Cars</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>

<style>
  :root{
    --brown:#3e2420; --beige:#bc8f74; --cream:#fff8ef; --text:#1f2937; --muted:#6b7280;
    --line:#e5e7eb; --line-strong:#d1d5db; --table-head:#fafafa;
    --card:#fff; --radius:14px; --ok:#16a34a; --danger:#ef4444; --info:#0ea5e9;
    --shadow:0 10px 24px rgba(0,0,0,.06);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--cream);color:var(--text);font-family:"Tajawal",system-ui,Arial}

  /* Topbar + tabs + auth badge */
  .topbar{position:sticky;top:0;z-index:1000;background:#fff;border-bottom:1px solid var(--line)}
  .topbar-inner{max-width:1240px;margin:auto;display:flex;align-items:center;justify-content:space-between;padding:10px 16px}
  .brand{display:flex;align-items:center;gap:10px}
  .brand .logo{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,var(--brown),#2a1613);
    display:grid;place-items:center;color:#fff;font-weight:800}
  .brand h1{margin:0;font-size:18px;color:var(--brown)}
  .tabs{display:flex;gap:8px;flex-wrap:wrap}
  .tab{padding:8px 12px;border:1px solid var(--line);border-radius:999px;background:#fff;text-decoration:none;color:inherit;font-weight:800;font-size:13px}
  .tab.active{background:var(--brown);border-color:var(--brown);color:#fff}
  .status-badge{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--line);background:#fff;border-radius:12px;padding:6px 10px;font-size:12px}
  .dot{width:10px;height:10px;border-radius:999px;background:#f59e0b}
  .dot.ok{background:var(--ok)} .dot.err{background:var(--danger)} .dot.warn{background:#f59e0b}

  /* Buttons */
  .btn{position:relative;border:1px solid var(--line);background:#fff;border-radius:12px;padding:8px 12px;cursor:pointer;font-weight:700;display:inline-flex;gap:6px;align-items:center;transition:.15s;font-size:13px}
  .btn:hover{transform:translateY(-1px)} .btn:active{transform:translateY(0)}
  .btn-primary{background:var(--brown);border-color:var(--brown);color:#fff}
  .btn-beige{background:var(--beige);border-color:var(--beige);color:#fff}
  .btn-ghost{background:#fff}
  .btn-danger{background:var(--danger);border-color:var(--danger);color:#fff}
  .btn-outline{background:#fff;border:1px solid var(--brown);color:var(--brown)}
  .btn-success{background:var(--ok);border-color:var(--ok);color:#fff}
  .btn-info{background:var(--info);border-color:var(--info);color:#fff}
  .btn-warn{background:#f59e0b;border-color:#f59e0b;color:#fff}

  /* Layout */
  .container{max-width:1240px;margin:18px auto;padding:0 16px 48px;display:grid;gap:16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
  .card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;gap:12px;flex-wrap:wrap}
  .section-title{display:flex;align-items:center;gap:8px;margin:0}
  .section-title svg{width:20px;height:20px;color:var(--brown)}
  .section-title h2{margin:0;font-size:16px;color:var(--brown)}
  .hint{color:var(--muted);font-size:12px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}

  /* Inputs */
  label{font-weight:800;margin-bottom:6px;display:block;color:var(--brown)}
  .input-wrap{position:relative}
  .input-wrap .i{position:absolute;right:10px;top:50%;transform:translateY(-50%);color:#9ca3af}
  .input-wrap input{padding-right:36px}
  input,select,textarea{width:100%;padding:8px 10px;border:1px solid var(--line);border-radius:12px;background:#fff;outline:none;transition:.15s;font-size:14px}
  input:focus,select:focus,textarea:focus{border-color:var(--beige);box-shadow:0 0 0 3px rgba(188,143,116,.15)}
  textarea{min-height:44px}
  input[readonly]{background:#f9fafb;color:#6b7280}
  .small-input{padding:6px 9px;border-radius:10px;font-size:13px}

  /* Tables */
  .table-wrap{overflow:hidden;border:1px solid var(--line);border-radius:14px}
  table{width:100%;border-collapse:separate;border-spacing:0;table-layout:fixed}
  thead th{position:sticky;top:0;background:var(--table-head);z-index:2;border-bottom:1px solid var(--line-strong);
    text-align:right;color:#111827;font-size:12px;padding:8px 8px;white-space:normal;line-height:1.35}
  tbody td{border-top:1px solid var(--line);padding:6px 8px;vertical-align:middle;font-size:13px;white-space:normal;word-break:break-word;line-height:1.45}
  tbody tr:nth-child(odd){background:#fff}
  tbody tr:nth-child(even){background:#fcfcfc}
  tbody tr:hover{background:#f8fafc}
  td,th{border-left:1px solid var(--line)}
  td:last-child,th:last-child{border-left:0}
  .center{text-align:center}
  .mono{font-family:ui-monospace,Consolas,Menlo,monospace;letter-spacing:.2px}
  .nowrap{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .cell-actions .btn{padding:4px 8px;font-size:12px}

  /* Auth */
  .auth-wrap{min-height:60vh;display:grid;place-items:center;padding:24px}
  .auth-card{background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);padding:18px;max-width:420px;width:96%}
  .auth-card h2{margin:0 0 10px;color:var(--brown);font-size:18px}
  .auth-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}

  /* Modal */
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.38);display:none;align-items:center;justify-content:center;z-index:50}
  .modal{background:#fff;border-radius:16px;box-shadow:0 24px 60px rgba(0,0,0,.35);width:min(1100px,96vw);max-height:92vh;border:1px solid var(--line);display:flex;flex-direction:column}
  .modal header{display:flex;align-items:center;justify-content:space-between;margin-bottom:0;padding:10px 14px;border-bottom:1px solid var(--line)}
  .modal h3{margin:0;font-size:18px;color:var(--brown)}
  .modal .body{padding:12px 14px;overflow:auto}
  .modal .actions{display:flex;gap:8px;justify-content:flex-start;margin-top:12px}

  .subgrid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  @media (max-width:900px){.subgrid{grid-template-columns:repeat(2,1fr)}}
  @media (max-width:620px){.subgrid{grid-template-columns:1fr}}
  .kv{display:grid;grid-template-columns:140px 1fr;gap:6px;align-items:center}
  .hr{height:1px;background:var(--line);margin:10px 0}

  /* Toast */
  .toast{position:fixed;bottom:16px;right:16px;background:#111827;color:#fff;padding:10px 14px;border-radius:12px;box-shadow:0 10px 24px rgba(0,0,0,.25);display:none;z-index:60;font-size:13px}
  .toast.ok{background:var(--ok)} .toast.info{background:var(--info)} .toast.err{background:var(--danger)}

  /* Ø§Ù„ØªØ§Ø¨Ø§Øª Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ© */
  .inner-tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
  .inner-tab{border-radius:999px;border:1px solid var(--line);background:#fff;padding:6px 12px;font-size:13px;font-weight:800;cursor:pointer}
  .inner-tab.active{background:var(--brown);border-color:var(--brown);color:#fff}
  .tab-pane{display:none;gap:16px}
  .tab-pane.active{display:grid}

  /* Grid Ø¹Ø§Ù… */
  .grid{display:grid;gap:8px}
  .grid-3{grid-template-columns:repeat(3,1fr)}
  @media (max-width:900px){.grid-3{grid-template-columns:repeat(2,1fr)}}
  @media (max-width:620px){.grid-3{grid-template-columns:1fr}}

</style>
</head>
<body>

<!-- Topbar -->
<div class="topbar">
  <div class="topbar-inner">
    <div class="brand">
      <div class="logo" title="MZJ">MZJ</div>
      <div>
        <h1>Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h1>
        <small class="hint">Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ø­Ù…Ø¯ Ø¨Ù† Ø°Ø¹Ø§Ø± Ø§Ù„Ø¹Ø¬Ù…ÙŠ Ù„Ù„Ø³ÙŠØ§Ø±Ø§Øª</small>
      </div>
    </div>
    <div class="tabs">
      <a class="tab" href="admin.html">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</a>
      <a class="tab" href="inventory.html">Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</a>
      <a class="tab" href="dashboard.html">Ø§Ù„Ø¯Ø§Ø´ Ø¨ÙˆØ±Ø¯</a>
      <a class="tab active" href="photoshoot.html">Ø§Ù„Ø·Ù„Ø¨Ø§Øª</a>
      <a class="tab" href="photoshoot-user.html">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</a>
      <a class="tab" href="cars.html">ÙƒÙ„ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</a>
      <a class="tab" href="Activity.html">Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·</a>
    </div>
    <div class="row">
      <div class="status-badge"><span id="connDot" class="dot warn"></span><span id="connText">Ø¬Ø§Ø±Ù Ø§Ù„Ø§ØªØµØ§Ù„â€¦</span></div>
      <button id="btnSignOut" class="btn btn-ghost" style="display:none"><i class="fa-solid fa-right-from-bracket"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
    </div>
  </div>
</div>

<!-- Auth Gate -->
<div id="authGate" class="auth-wrap" style="display:none">
  <div class="auth-card">
    <h2><i class="fa-solid fa-right-to-bracket"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
    <label for="email">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
    <input id="email" type="email" placeholder="you@example.com"/>
    <label for="password" style="margin-top:8px">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
    <input id="password" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"/>
    <div class="auth-actions">
      <button class="btn btn-primary" id="btnLogin">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
      <button class="btn btn-outline" id="btnSignup">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
    </div>
    <p class="hint" id="authHint" style="margin-top:10px"></p>
  </div>
</div>

<!-- App -->
<div id="app" style="display:none">
  <div class="container">

    <!-- Ø§Ù„ØªØ§Ø¨Ø§Øª Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ© -->
    <div class="inner-tabs">
      <button class="inner-tab active" data-tab="tab-shoot">Ø§Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨</button>
    </div>

    <!-- ØªØ§Ø¨ Ø·Ù„Ø¨ ØªØµÙˆÙŠØ± -->
    <div id="tab-shoot" class="tab-pane active">

      <!-- Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ ØªØµÙˆÙŠØ± -->
      <div class="card">
        <div class="card-header">
          <div class="section-title">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M4 7h16M4 17h10"/><circle cx="17" cy="17" r="3"/></svg>
            <h2>Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨</h2>
          </div>
          <span class="hint">Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„</span>
        </div>

        <div class="row" style="margin-bottom:8px">
          <div style="flex:1;min-width:220px">
            <label for="reqBy">Ù…Ù‚Ø¯Ù‘Ù… Ø§Ù„Ø·Ù„Ø¨</label>
            <input id="reqBy" class="small-input" value="Ø£Ø­Ù…Ø¯ Ù†Ø§Ø¬ÙŠ" readonly title="Ù…Ø­Ø¯Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§"/>
          </div>
        </div>

        <div class="table-wrap">
          <table id="entryTable">
            <colgroup>
              <col style="width:4ch">
              <col style="width:13ch">
              <col style="width:11ch">
              <col style="width:15ch">
              <col style="width:16ch">
              <col style="width:9ch">
              <col style="width:9ch">
              <col style="width:8ch">
              <col style="width:18ch">
              <col style="width:16ch">
              <col style="width:auto">
              <col style="width:10ch">
            </colgroup>
            <thead>
              <tr>
                <th class="center">#</th>
                <th>Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨</th>
                <th>Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„</th>
                <th>Ø§Ù„Ø³ÙŠØ§Ø±Ø©</th>
                <th>Ø§Ù„Ø¨ÙŠØ§Ù†</th>
                <th>Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ</th>
                <th>Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ</th>
                <th class="center">Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„</th>
                <th>Ù…ÙƒØ§Ù† Ø§Ù„Ø³ÙŠØ§Ø±Ø©</th>
                <th id="placeHeader">Ù…ÙƒØ§Ù† Ø§Ù„ØªØµÙˆÙŠØ±</th>
                <th>Ù…Ù„Ø§Ø­Ø¸Ø©</th>
                <th class="center">Ø­Ø°Ù</th>
              </tr>
            </thead>
            <tbody id="reqRows"></tbody>
          </table>
        </div>

        <div class="row" style="margin-top:12px">
          <button class="btn btn-ghost" id="btnDraft"><i class="fa-regular fa-floppy-disk"></i> Ø­ÙØ¸ ÙƒÙ…Ø³ÙˆØ¯Ø©</button>
          <button class="btn btn-primary" id="btnSubmit"><i class="fa-solid fa-paper-plane"></i> Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
          <button class="btn btn-ghost" id="btnClear"><i class="fa-solid fa-rotate"></i> ØªÙØ±ÙŠØº</button>
        </div>
      </div>

      <!-- Ù…ØªØ§Ø¨Ø¹Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªØµÙˆÙŠØ± -->
      <div class="card" style="display:none">
        <div class="card-header">
          <div class="section-title">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M4 6h16M4 12h10M4 18h7"/></svg>
            <h2>Ù…ØªØ§Ø¨Ø¹Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªØµÙˆÙŠØ±</h2>
          </div>
          <div class="row">
            <select id="statusFilter" class="small-input" style="width:170px">
              <option value="ALL">ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
              <option value="Ù…Ø³ÙˆØ¯Ø©">Ù…Ø³ÙˆØ¯Ø©</option>
              <option value="ØªØ­Øª Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡">ØªØ­Øª Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</option>
              <option value="ØªÙ… Ø§Ù„ØªØµÙˆÙŠØ±">ØªÙ… Ø§Ù„ØªØµÙˆÙŠØ±</option>
            </select>
            <input id="searchRequests" class="small-input" placeholder="Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹" style="min-width:220px">
            <button id="btnExport" class="btn btn-ghost"><i class="fa-regular fa-file-excel"></i> ØªØµØ¯ÙŠØ±</button>
          </div>
        </div>

        <div class="table-wrap">
          <table id="requestsTable">
            <colgroup>
              <col style="width:8ch">
              <col style="width:18ch">
              <col style="width:16ch">
              <col style="width:8ch">
              <col style="width:12ch">
              <col style="width:20ch">
              <col style="width:auto">
            </colgroup>
            <thead>
              <tr>
                <th>Ø±Ù‚Ù…</th>
                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                <th>Ù…Ù‚Ø¯Ù‘Ù…</th>
                <th class="center">Ø§Ù„Ù‡ÙŠØ§ÙƒÙ„</th>
                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                <th>Ø¥Ø¯Ø§Ø±ÙŠ</th>
                <th class="center">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <p class="hint" style="margin:6px 0 0">
          Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„ØµÙ Ù„Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ (Ø§Ù„Ù‡ÙŠØ§ÙƒÙ„ + Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…/Ø§Ù„ØªØ¬Ù‡ÙŠØ²). Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù…Ù† Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙØ§ØµÙŠÙ„ ÙÙ‚Ø·.
        </p>
      </div>
    </div>

    <!-- ØªØ§Ø¨ Ø·Ù„Ø¨ Ù†Ù‚Ù„ -->
    <div id="tab-move" class="tab-pane">

      <!-- Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Ù†Ù‚Ù„ -->
      <div class="card">
        <div class="card-header">
          <div class="section-title">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M7 10l5-5 5 5"/><path d="M7 14l5 5 5-5"/></svg>
            <h2>Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Ù†Ù‚Ù„</h2>
          </div>
          <span class="hint">Ù†ÙØ³ Ø£Ø³Ù„ÙˆØ¨ Ø·Ù„Ø¨ Ø§Ù„ØªØµÙˆÙŠØ± â€” Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„ØŒ ÙŠØªØ³Ø­Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø©ØŒ ÙˆØ­Ø¯Ø¯ Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„Ø¬Ø¯ÙŠØ¯.</span>
        </div>

        <div class="row" style="margin-bottom:8px">
          <div style="flex:1;min-width:220px">
            <label for="moveReqBy">Ù…Ù‚Ø¯Ù‘Ù… Ø·Ù„Ø¨ Ø§Ù„Ù†Ù‚Ù„</label>
            <input id="moveReqBy" class="small-input" value="Ø£Ø­Ù…Ø¯ Ù†Ø§Ø¬ÙŠ" readonly title="Ù…Ø­Ø¯Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§"/>
          </div>
        </div>

        <div class="table-wrap">
          <table id="moveEntryTable">
            <colgroup>
              <col style="width:4ch">
              <col style="width:11ch">
              <col style="width:15ch">
              <col style="width:16ch">
              <col style="width:9ch">
              <col style="width:9ch">
              <col style="width:8ch">
              <col style="width:18ch">
              <col style="width:18ch">
              <col style="width:auto">
              <col style="width:10ch">
            </colgroup>
            <thead>
              <tr>
                <th class="center">#</th>
                <th>Ø±Ù‚Ù… Ø§Ù„Ù‡ÙŠÙƒÙ„</th>
                <th>Ø§Ù„Ø³ÙŠØ§Ø±Ø©</th>
                <th>Ø§Ù„Ø¨ÙŠØ§Ù†</th>
                <th>Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ</th>
                <th>Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ</th>
                <th class="center">Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„</th>
                <th>Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„Ø­Ø§Ù„ÙŠ</th>
                <th>Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„Ø¬Ø¯ÙŠØ¯</th>
                <th>Ù…Ù„Ø§Ø­Ø¸Ø©</th>
                <th class="center">Ø­Ø°Ù</th>
              </tr>
            </thead>
            <tbody id="moveReqRows"></tbody>
          </table>
        </div>

        <div class="row" style="margin-top:12px">
          <button class="btn btn-ghost" id="moveBtnDraft"><i class="fa-regular fa-floppy-disk"></i> Ù…Ø³ÙˆØ¯Ø© Ù†Ù‚Ù„</button>
          <button class="btn btn-primary" id="moveBtnSubmit"><i class="fa-solid fa-paper-plane"></i> Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ù†Ù‚Ù„</button>
          <button class="btn btn-ghost" id="moveBtnClear"><i class="fa-solid fa-rotate"></i> ØªÙØ±ÙŠØº</button>
        </div>
        <p class="hint" style="margin-top:6px">
          ØªÙ†ÙÙŠØ° Ø§Ù„Ù†Ù‚Ù„ Ø§Ù„ÙØ¹Ù„ÙŠ ÙŠØªÙ… Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ Ù…Ù† ØµÙØ­Ø© <b>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</b> Ø¨Ø¹Ø¯ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨.
        </p>
      </div>

      <!-- Ø³Ø¬Ù„ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù†Ù‚Ù„ -->
      <div class="card">
        <div class="card-header">
          <div class="section-title">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M4 6h16M4 12h16M4 18h16"/></svg>
            <h2>Ø³Ø¬Ù„ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù†Ù‚Ù„</h2>
          </div>
          <div class="row">
            <select id="moveStatusFilter" class="small-input" style="width:170px">
              <option value="ALL">ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
              <option value="Ù…Ø³ÙˆØ¯Ø©">Ù…Ø³ÙˆØ¯Ø©</option>
              <option value="Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</option>
              <option value="ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ°">ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ°</option>
            </select>
            <input id="moveSearch" class="small-input" placeholder="Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹" style="min-width:220px">
          </div>
        </div>

        <div class="table-wrap">
          <table id="moveRequestsTable">
            <colgroup>
              <col style="width:8ch">
              <col style="width:18ch">
              <col style="width:18ch">
              <col style="width:8ch">
              <col style="width:12ch">
              <col style="width:auto">
              <col style="width:14ch">
            </colgroup>
            <thead>
              <tr>
                <th>Ø±Ù‚Ù…</th>
                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                <th>Ù…Ù‚Ø¯Ù‘Ù… Ø§Ù„Ø·Ù„Ø¨</th>
                <th class="center">Ø¹Ø¯Ø¯ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</th>
                <th>Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨</th>
                <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                <th class="center">ØªÙØ§ØµÙŠÙ„</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <p class="hint" style="margin-top:6px">
          Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± <b>Ø¹Ø±Ø¶</b> Ø£Ùˆ Ø¹Ù„Ù‰ Ø§Ù„ØµÙ Ù„Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª Ø¯Ø§Ø®Ù„ Ø·Ù„Ø¨ Ø§Ù„Ù†Ù‚Ù„.
        </p>
      </div>

    </div>

  </div>
</div>

<!-- Modal: ØªÙØ§ØµÙŠÙ„ ÙˆØªØ¹Ø¯ÙŠÙ„ Ø·Ù„Ø¨ Ø§Ù„ØªØµÙˆÙŠØ± -->
<div id="backdrop" class="modal-backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <header>
      <h3 id="modalTitle"><i class="fa-regular fa-rectangle-list"></i> ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨</h3>
      <div class="row">
        <button id="btnSaveModal" class="btn btn-success"><i class="fa-solid fa-check"></i> Ø­ÙØ¸</button>
        <button id="btnCloseModal" class="btn btn-danger"><i class="fa-solid fa-xmark"></i> Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </header>
    <div class="body">
      <div class="subgrid">
        <div class="kv">
          <div class="hint">Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</div>
          <input id="m_id" class="small-input" readonly>
        </div>
        <div class="kv">
          <div class="hint">Ø§Ù„ØªØ§Ø±ÙŠØ®</div>
          <input id="m_createdAt" class="small-input" readonly>
        </div>
        <div class="kv">
          <div class="hint">Ù…Ù‚Ø¯Ù‘Ù… Ø§Ù„Ø·Ù„Ø¨</div>
          <input id="m_createdBy" class="small-input" readonly>
        </div>
        <div class="kv">
          <div class="hint">Ø§Ø³ØªÙ„Ø§Ù… Ø¥Ø¯Ø§Ø±ÙŠ</div>
          <input id="m_adminReceived" class="small-input" readonly placeholder="â€”">
        </div>
        <div class="kv">
          <div class="hint">ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</div>
          <input id="m_adminPrepared" class="small-input" readonly placeholder="â€”">
        </div>
      </div>

      <div class="hr"></div>
      <h4 class="section-title" style="font-size:14px">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M4 6h16M4 12h16M4 18h16"/></svg>
        <span>Ù‡ÙŠØ§ÙƒÙ„ Ø§Ù„Ø·Ù„Ø¨</span>
      </h4>
      <div class="table-wrap">
        <table id="modalRows">
          <colgroup>
            <col style="width:4ch">
            <col style="width:18ch">
            <col style="width:18ch">
            <col style="width:18ch">
            <col style="width:10ch">
            <col style="width:10ch">
            <col style="width:8ch">
            <col style="width:18ch">
            <col style="width:16ch">
            <col style="width:auto">
          </colgroup>
          <thead>
            <tr>
              <th class="center">#</th>
              <th>VIN</th>
              <th>Ø§Ù„Ø³ÙŠØ§Ø±Ø©</th>
              <th>Ø§Ù„Ø¨ÙŠØ§Ù†</th>
              <th>Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ</th>
              <th>Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ</th>
              <th class="center">Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„</th>
              <th>Ù…ÙƒØ§Ù† Ø§Ù„Ø³ÙŠØ§Ø±Ø©</th>
              <th>Ù…ÙƒØ§Ù† Ø§Ù„ØªØµÙˆÙŠØ±</th>
              <th>Ù…Ù„Ø§Ø­Ø¸Ø©</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Modal: ØªÙØ§ØµÙŠÙ„ Ø·Ù„Ø¨ Ø§Ù„Ù†Ù‚Ù„ -->
<div id="moveBackdrop" class="modal-backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="moveModalTitle">
    <header>
      <h3 id="moveModalTitle"><i class="fa-regular fa-rectangle-list"></i> ØªÙØ§ØµÙŠÙ„ Ø·Ù„Ø¨ Ø§Ù„Ù†Ù‚Ù„</h3>
      <div class="row">
        <button id="moveBtnCloseModal" class="btn btn-danger"><i class="fa-solid fa-xmark"></i> Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </header>
    <div class="body">
      <div class="subgrid">
        <div class="kv">
          <div class="hint">Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</div>
          <input id="moveModalId" class="small-input" readonly>
        </div>
        <div class="kv">
          <div class="hint">Ø§Ù„ØªØ§Ø±ÙŠØ®</div>
          <input id="moveModalCreatedAt" class="small-input" readonly>
        </div>
        <div class="kv">
          <div class="hint">Ù…Ù‚Ø¯Ù‘Ù… Ø§Ù„Ø·Ù„Ø¨</div>
          <input id="moveModalCreatedBy" class="small-input" readonly>
        </div>
        <div class="kv">
          <div class="hint">Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨</div>
          <input id="moveModalStatus" class="small-input" readonly>
        </div>
      </div>

      <div class="hr"></div>
      <h4 class="section-title" style="font-size:14px">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M4 6h16M4 12h16M4 18h16"/></svg>
        <span>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª Ø¯Ø§Ø®Ù„ Ø·Ù„Ø¨ Ø§Ù„Ù†Ù‚Ù„</span>
      </h4>
      <div class="table-wrap">
        <table id="moveModalRows">
          <colgroup>
            <col style="width:4ch">
            <col style="width:18ch">
            <col style="width:18ch">
            <col style="width:16ch">
            <col style="width:10ch">
            <col style="width:10ch">
            <col style="width:8ch">
            <col style="width:18ch">
            <col style="width:18ch">
            <col style="width:auto">
          </colgroup>
          <thead>
            <tr>
              <th class="center">#</th>
              <th>VIN</th>
              <th>Ø§Ù„Ø³ÙŠØ§Ø±Ø©</th>
              <th>Ø§Ù„Ø¨ÙŠØ§Ù†</th>
              <th>Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ</th>
              <th>Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ</th>
              <th class="center">Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„</th>
              <th>Ù…Ù†</th>
              <th>Ø¥Ù„Ù‰</th>
              <th>Ù…Ù„Ø§Ø­Ø¸Ø©</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

    </div>
  </div>
</div>

<div id="toast" class="toast">ØªÙ…</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
  import { 
    getFirestore, doc, getDoc, setDoc, onSnapshot,
    collection, addDoc, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

  /* ===== Firebase ===== */
  const firebaseConfig = {
    apiKey: "AIzaSyC614bGqnYf4Q-weTNemzWENTpa8DjGeHw",
    authDomain: "mzj-agenda.firebaseapp.com",
    projectId: "mzj-agenda",
    storageBucket: "mzj-agenda.appspot.com",
    messagingSenderId: "834700407721",
    appId: "1:834700407721:web:75c17665d4f032fd65cab8"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);
  const STATE_REF = doc(db, "mzj_admin_state", "v1");

  /* ===== Helpers ===== */
  const $ = s => document.querySelector(s);
  const pad = n => n<10?'0'+n:n;
  const now = ()=>{
    const d=new Date();
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`
  };
  const debounce = (fn,wait=250)=>{let t;return(...args)=>{clearTimeout(t);t=setTimeout(()=>fn(...args),wait);};};

  function setStatus(mode,txt){
    const dot = $('#connDot');
    dot.className='dot '+(mode==='ok'?'ok':mode==='err'?'err':'warn');
    $('#connText').textContent=txt;
  }
  const toast = $('#toast');
  const showToast = (msg,type='ok')=>{ toast.textContent=msg; toast.className='toast '+type; toast.style.display='block'; setTimeout(()=>toast.style.display='none',1400); };

  function normalizeVin(v){
    if(!v) return '';
    const ar={'Ù ':'0','Ù¡':'1','Ù¢':'2','Ù£':'3','Ù¤':'4','Ù¥':'5','Ù¦':'6','Ù§':'7','Ù¨':'8','Ù©':'9'};
    return v.toString().replace(/[Ù -Ù©]/g,d=>ar[d]).toUpperCase().replace(/[\s\-\._]/g,'').trim();
  }

  /* ===== Activity Log helper ===== */
  async function logActivity({ action, entityType, entityId, details }){
    try{
      const u = auth.currentUser;
      const userEmail = u?.email || '';
      const userName  = u?.displayName || '';
      const role      = "Ø§Ù„Ø·Ù„Ø¨Ø§Øª";

      await addDoc(collection(db,"mzj_activity_log"),{
        userEmail,
        userName,
        role,
        action: action || '',
        entityType: entityType || '',
        entityId: entityId != null ? String(entityId) : '',
        details: details || '',
        createdAt: now(),
        createdAtTs: serverTimestamp(),
        ip: '',
        userAgent: navigator.userAgent || ''
      });
    }catch(e){
      console.warn("logActivity error",e);
    }
  }

  /* ===== State ===== */
  let stock=[], shootRequests=[], moves=[], moveRequests=[];
  const SHOOT_PLACES = ["Ø§Ù„Ù…Ø¹Ø±Ø¶","Ø§Ù„Ø§Ø³ØªØ¯ÙŠÙˆ","Ø§Ù„ØµØ§Ù„Ø© Ø§Ù„Ø§Ø³Ø§Ø³ÙŠØ©","ØµØ§Ù„Ø© Ø§Ù„Ù‚Ø§Ø¯Ø³ÙŠØ©","Ù…Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„ØªÙ‚Ù‰"];

  const MOVE_LOCATIONS = [
    "Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ : Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…ØªØ§Ø­","Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ : Ø³ÙŠØ§Ø±Ø§Øª Ø¨Ù‡Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§Øª","Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ : Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…","Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ : Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…",
    "Ø§Ù„ÙˆÙƒØ§Ù„Ø© : Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…ØªØ§Ø­","Ø§Ù„ÙˆÙƒØ§Ù„Ø© : Ø³ÙŠØ§Ø±Ø§Øª Ø¨Ù‡Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§Øª","Ø§Ù„ÙˆÙƒØ§Ù„Ø© : Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…","Ø§Ù„ÙˆÙƒØ§Ù„Ø© : Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…",
    "ÙØ±Ø¹ 1 Ø§Ù„ØµØ§Ù„Ø© : Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…ØªØ§Ø­","ÙØ±Ø¹ 1 Ø§Ù„ØµØ§Ù„Ø© : Ø³ÙŠØ§Ø±Ø§Øª Ø¨Ù‡Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§Øª","ÙØ±Ø¹ 1 Ø§Ù„ØµØ§Ù„Ø© : Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…","ÙØ±Ø¹ 1 Ø§Ù„ØµØ§Ù„Ø© : Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…",
    "ÙØ±Ø¹ 2 Ø§Ù„Ù…Ù„ØªÙ‚Ù‰ : Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…ØªØ§Ø­","ÙØ±Ø¹ 2 Ø§Ù„Ù…Ù„ØªÙ‚Ù‰ : Ø³ÙŠØ§Ø±Ø§Øª Ø¨Ù‡Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§Øª","ÙØ±Ø¹ 2 Ø§Ù„Ù…Ù„ØªÙ‚Ù‰ : Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…","ÙØ±Ø¹ 2 Ø§Ù„Ù…Ù„ØªÙ‚Ù‰ : Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…",
    "ÙØ±Ø¹ 3 Ø§Ù„Ù‚Ø§Ø¯Ø³ÙŠØ© : Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…ØªØ§Ø­","ÙØ±Ø¹ 3 Ø§Ù„Ù‚Ø§Ø¯Ø³ÙŠØ© : Ø³ÙŠØ§Ø±Ø§Øª Ø¨Ù‡Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§Øª","ÙØ±Ø¹ 3 Ø§Ù„Ù‚Ø§Ø¯Ø³ÙŠØ© : Ù…Ø¨Ø§Ø¹ ØªØ­Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…","ÙØ±Ø¹ 3 Ø§Ù„Ù‚Ø§Ø¯Ø³ÙŠØ© : Ù…Ø¨Ø§Ø¹ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…"
  ];

  /* ===== Auth ===== */
  onAuthStateChanged(auth, async (user)=>{
    const nf = document.getElementById('noFlash') || document.getElementById('noflash');
    if(nf) nf.remove();
    if(user){
      $('#authGate').style.display='none';
      $('#app').style.display='block';
      $('#btnSignOut').style.display='inline-flex';
      setStatus('ok', `Ù…ØªØµÙ„: ${user.email}`);
      await initData();
      subscribeLive();
      buildFormRows();
      updatePlaceHeader();
      buildMoveRows();
      renderRequestsTable();
      renderMoveRequestsTable();

      const rb = $('#reqBy'); 
      if(rb){ rb.value= user.displayName || 'Ø£Ø­Ù…Ø¯ Ù†Ø§Ø¬ÙŠ'; rb.setAttribute('readonly','readonly'); }

      const mb = $('#moveReqBy');
      if(mb){ mb.value = user.displayName || user.email || 'Ø£Ø­Ù…Ø¯ Ù†Ø§Ø¬ÙŠ'; mb.setAttribute('readonly','readonly'); }

      document.body.style.opacity='1';
    }else{
      $('#app').style.display='none';
      $('#authGate').style.display='grid';
      $('#btnSignOut').style.display='none';
      setStatus('warn', 'Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
      document.body.style.opacity='1';
    }
  });
  $('#btnLogin').addEventListener('click', async ()=>{
    $('#authHint').textContent='';
    try{ await signInWithEmailAndPassword(auth, $('#email').value.trim(), $('#password').value); }
    catch(e){ $('#authHint').textContent='Ø®Ø·Ø£: '+(e?.message||e); }
  });
  $('#btnSignup').addEventListener('click', async ()=>{
    $('#authHint').textContent='';
    try{ await createUserWithEmailAndPassword(auth, $('#email').value.trim(), $('#password').value); }
    catch(e){ $('#authHint').textContent='Ø®Ø·Ø£: '+(e?.message||e); }
  });
  $('#btnSignOut').addEventListener('click', ()=> signOut(auth));

  /* ===== Data ===== */
  async function initData(){
    try{
      const s=await getDoc(STATE_REF);
      if(s.exists()){
        const d=s.data()||{};
        stock = Array.isArray(d.stock)? d.stock: [];
        shootRequests = Array.isArray(d.shootRequests)? d.shootRequests: [];
        moves = Array.isArray(d.moves)? d.moves: [];
        moveRequests = Array.isArray(d.moveRequests)? d.moveRequests: [];
      }else{
        stock=[]; shootRequests=[]; moves=[]; moveRequests=[];
      }
      setStatus('ok','ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
      renderRequestsTable();
      renderMoveRequestsTable();
    }catch(e){
      setStatus('warn','ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
    }
  }
  function subscribeLive(){
    try{
      onSnapshot(STATE_REF,(snap)=>{
        if(!snap.exists()) return;
        const d=snap.data()||{};
        stock = Array.isArray(d.stock)? d.stock: stock;
        shootRequests = Array.isArray(d.shootRequests)? d.shootRequests: shootRequests;
        moves = Array.isArray(d.moves)? d.moves: moves;
        moveRequests = Array.isArray(d.moveRequests)? d.moveRequests: moveRequests;
        renderRequestsTable();
        renderMoveRequestsTable();
      },()=> setStatus('warn','Ø§Ù†Ù‚Ø·Ø§Ø¹ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¤Ù‚ØªÙ‹Ø§'));
    }catch(e){}
  }
  async function persistAll(){
    try{
      await setDoc(STATE_REF, { stock, shootRequests, moves, moveRequests, updatedAt: now() }, { merge:true });
    }catch(e){
      showToast('ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø­ÙØ¸ Ø¥Ù„Ù‰ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©','err');
    }
  }

  /* ===== ØªØ¨ÙˆÙŠØ¨ Ø¯Ø§Ø®Ù„ÙŠ ===== */
  const innerTabs = document.querySelectorAll('.inner-tab');
  const tabPanes  = document.querySelectorAll('.tab-pane');
  innerTabs.forEach(btn=>{
    btn.addEventListener('click',()=>{
      innerTabs.forEach(b=>b.classList.remove('active'));
      tabPanes.forEach(p=>p.classList.remove('active'));
      btn.classList.add('active');
      const id = btn.getAttribute('data-tab');
      const pane = document.getElementById(id);
      if(pane) pane.classList.add('active');
    });
  });

  /* ===== Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ ØªØµÙˆÙŠØ± (8 ØµÙÙˆÙ) ===== */
  const reqRowsBody = $('#reqRows');
  function buildFormRows(){
    reqRowsBody.innerHTML='';
    for(let i=0;i<8;i++){
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td class="center">${i+1}</td>
        <td>
          <select class="req-type small-input">
            <option value="shoot" selected>Ø·Ù„Ø¨ ØªØµÙˆÙŠØ±</option>
            <option value="move">Ø·Ù„Ø¨ Ù†Ù‚Ù„</option>
          </select>
        </td>
        <td><input class="vin mono small-input" placeholder="VIN"></td>
        <td><input class="car small-input" readonly placeholder="â€”"></td>
        <td><input class="variant small-input" readonly placeholder="â€”"></td>
        <td><input class="ext small-input" readonly placeholder="â€”"></td>
        <td><input class="int small-input" readonly placeholder="â€”"></td>
        <td class="center"><input class="year center small-input" readonly placeholder="â€”"></td>
        <td><input class="loc small-input" readonly placeholder="â€”"></td>
        <td>
          <select class="place small-input">
            <option value="">â€” Ø§Ø®ØªØ± â€”</option>
            ${SHOOT_PLACES.map(p=>`<option>${p}</option>`).join('')}
          </select>
        </td>
        <td><input class="note small-input" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ"></td>
        <td class="center">
          <button class="btn btn-danger btn-ghost btn-row-del"><i class="fa-solid fa-xmark"></i> Ø­Ø°Ù</button>
        </td>
      `;
      reqRowsBody.appendChild(tr);
    }
    const rb = $('#reqBy'); 
    if(rb){ 
      const u = auth.currentUser;
      rb.value = (u?.displayName)||'Ø£Ø­Ù…Ø¯ Ù†Ø§Ø¬ÙŠ'; 
      rb.setAttribute('readonly','readonly'); 
    }
  }
  function updatePlaceHeader(){
    const header = document.getElementById('placeHeader');
    if(!header) return;
    const anyMove = Array.from(document.querySelectorAll('#reqRows .req-type')).some(sel => sel.value === 'move');
    header.textContent = anyMove ? 'Ù…ÙƒØ§Ù† Ø§Ù„Ù†Ù‚Ù„' : 'Ù…ÙƒØ§Ù† Ø§Ù„ØªØµÙˆÙŠØ±';
  }
  $('#btnClear').addEventListener('click', ()=>{
    buildFormRows();
    updatePlaceHeader();
  });

  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨
  reqRowsBody.addEventListener('change',(e)=>{
    if(e.target.classList && e.target.classList.contains('req-type')){
      updatePlaceHeader();
    }
  });
  // Ø­Ø°Ù ØµÙ ØªØµÙˆÙŠØ±
  reqRowsBody.addEventListener('click',(e)=>{
    const b=e.target.closest('.btn-row-del'); if(!b) return;
    const tr=b.closest('tr'); tr.querySelectorAll('input,select').forEach(x=> x.value='');
  });

  // ØªØ¹Ø¨Ø¦Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø¹Ù†Ø¯ Ø¥Ø¯Ø®Ø§Ù„ VIN Ù„Ù„ØªØµÙˆÙŠØ±
  reqRowsBody.addEventListener('blur',(e)=>{
    const vinEl = e.target.closest('input.vin'); if(!vinEl) return;
    const norm = normalizeVin(vinEl.value); vinEl.value = norm;
    if(!norm) return;
    const rec = stock.find(r=> normalizeVin(r.vin)===norm);
    const row = vinEl.closest('tr');
    if(rec){
      row.querySelector('.car').value    = rec.car||'';
      row.querySelector('.variant').value= rec.variant||'';
      row.querySelector('.ext').value    = rec.extColor||'';
      row.querySelector('.int').value    = rec.intColor||'';
      row.querySelector('.year').value   = rec.modelYear||'';
      row.querySelector('.loc').value    = rec.location||'';
      showToast('ØªÙ… Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø©','ok');
    }else{
      row.querySelectorAll('.car,.variant,.ext,.int,.year,.loc').forEach(i=> i.value='');
      showToast('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù‡ÙŠÙƒÙ„ Ù…Ø·Ø§Ø¨Ù‚','info');
    }
  }, true);

  function collectFormRows(){
    const rows=[];
    reqRowsBody.querySelectorAll('tr').forEach(tr=>{
      const vin = normalizeVin(tr.querySelector('.vin').value||''); if(!vin) return;
      rows.push({
        vin,
        car:tr.querySelector('.car').value||'',
        variant:tr.querySelector('.variant').value||'',
        extColor:tr.querySelector('.ext').value||'',
        intColor:tr.querySelector('.int').value||'',
        modelYear:tr.querySelector('.year').value||'',
        currentLocation:tr.querySelector('.loc').value||'',
        shootPlace: (tr.querySelector('.place').value||''),
        note:tr.querySelector('.note').value||''
      });
    });
    return rows;
  }

  async function saveNewRequest(statusLabel){
    const by = ($('#reqBy').value||'').trim() || 'Ø£Ø­Ù…Ø¯ Ù†Ø§Ø¬ÙŠ';
    const rows = collectFormRows();
    if(statusLabel!=='Ù…Ø³ÙˆØ¯Ø©' && rows.length===0) return showToast('Ø£Ø¯Ø®Ù„ Ù‡ÙŠÙƒÙ„ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„','info');

    const nextId = shootRequests.length? Math.max(...shootRequests.map(r=>Number(r.id)||0))+1 : 1;
    const req = {
      id: nextId,
      createdAt: now(),
      createdBy: by,
      rows,
      status: statusLabel,
      admin: { received:null, prepared:null, notes:'' }
    };
    shootRequests.push(req);
    await persistAll();
    await logActivity({
      action: statusLabel==='Ù…Ø³ÙˆØ¯Ø©' ? 'Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ ØªØµÙˆÙŠØ± (Ù…Ø³ÙˆØ¯Ø©)' : 'Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ ØªØµÙˆÙŠØ±',
      entityType: 'photoshootRequest',
      entityId: nextId,
      details: `Ø¹Ø¯Ø¯ Ø§Ù„Ù‡ÙŠØ§ÙƒÙ„: ${rows.length}`
    });
    buildFormRows();
    updatePlaceHeader();
    renderRequestsTable();
    showToast(statusLabel==='Ù…Ø³ÙˆØ¯Ø©'?'ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø³ÙˆØ¯Ø©':'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„ØªØµÙˆÙŠØ±','ok');
  }

  $('#btnDraft').addEventListener('click', ()=> saveNewRequest('Ù…Ø³ÙˆØ¯Ø©'));
  $('#btnSubmit').addEventListener('click', ()=> saveNewRequest('ØªØ­Øª Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡'));

  /* ===== Ù…ØªØ§Ø¨Ø¹Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªØµÙˆÙŠØ± ===== */
  const tblBody = document.querySelector('#requestsTable tbody');
  function renderRequestsTable(){
    if(!tblBody) return;
    const s = ($('#statusFilter').value||'ALL');
    const q = ($('#searchRequests').value||'').toLowerCase().trim();

    let list = shootRequests.slice().sort((a,b)=> b.id - a.id);
    if(s!=='ALL') list = list.filter(r=> (r.status||'')===s);
    if(q){
      list = list.filter(r=>{
        const hay=[
          r.id,r.createdAt,r.createdBy,r.status,(r.admin?.received||''),(r.admin?.prepared||''),(r.admin?.notes||''),(r.adminReceived||''),(r.adminPrepared||''),
          ...(r.rows||[]).flatMap(x=>[x.vin,x.car,x.variant,x.extColor,x.intColor,x.modelYear,x.currentLocation,x.shootPlace,x.note])
        ].join(' ').toLowerCase();
        return hay.includes(q);
      });
    }

    tblBody.innerHTML='';
    list.forEach(r=>{
      const adminInfo = r.admin || {};
      const receivedText = adminInfo.received ? `ğŸ“¥ Ø§Ø³ØªÙ„Ø§Ù…: ${adminInfo.received}` : 'ğŸ“¥ Ø§Ø³ØªÙ„Ø§Ù…: â€”';
      const preparedText = adminInfo.prepared ? `ğŸ›  ØªØ¬Ù‡ÙŠØ²: ${adminInfo.prepared}` : 'ğŸ›  ØªØ¬Ù‡ÙŠØ²: â€”';

      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td class="nowrap">#${r.id}</td>
        <td class="nowrap">${r.createdAt||''}</td>
        <td class="nowrap">${r.createdBy||'-'}</td>
        <td class="center">${r.rows?.length||0}</td>
        <td class="nowrap">${r.status||'-'}</td>
        <td>
          <div style="font-size:12px;line-height:1.5">
            <div>${receivedText}</div>
            <div>${preparedText}</div>
          </div>
        </td>
        <td class="center cell-actions">
          <button class="btn btn-success" data-done="${r.id}"><i class="fa-solid fa-check"></i> ØªÙ… Ø§Ù„ØªØµÙˆÙŠØ±</button>
        </td>
      `;
      tblBody.appendChild(tr);
    });
  }
  $('#statusFilter').addEventListener('change', renderRequestsTable);
  $('#searchRequests').addEventListener('input', renderRequestsTable);

  /* ÙØªØ­ ØªÙØ§ØµÙŠÙ„ Ø·Ù„Ø¨ Ø§Ù„ØªØµÙˆÙŠØ± Ø¨Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„ØµÙ */
  tblBody.addEventListener('click',(e)=>{
    if(e.target.closest('button')) return;
    const row = e.target.closest('tr'); if(!row) return;
    const firstCell = row.querySelector('td'); if(!firstCell) return;
    const txt = (firstCell.textContent||'').trim();
    const id  = Number(txt.replace('#','').trim());
    if(!id) return;
    openModal(id);
  });

  /* Ø²Ø± ØªÙ… Ø§Ù„ØªØµÙˆÙŠØ± Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
  document.addEventListener('click', async (e)=>{
    const done=e.target.closest('button[data-done]');
    if(done){
      const id=Number(done.getAttribute('data-done'));
      const req = shootRequests.find(r=>r.id===id); if(!req) return;
      req.status='ØªÙ… Ø§Ù„ØªØµÙˆÙŠØ±';
      await persistAll(); 
      await logActivity({
        action: 'ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø·Ù„Ø¨ ØªØµÙˆÙŠØ± Ø¥Ù„Ù‰ ØªÙ… Ø§Ù„ØªØµÙˆÙŠØ±',
        entityType: 'photoshootRequest',
        entityId: id,
        details: `Ø¹Ø¯Ø¯ Ø§Ù„Ù‡ÙŠØ§ÙƒÙ„: ${req.rows?.length||0}`
      });
      renderRequestsTable(); 
      showToast('ØªÙ… Ø¥ÙƒÙ…Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„ØªØµÙˆÙŠØ±','ok');
    }
  });

  /* ===== Modal (ØªÙØ§ØµÙŠÙ„ Ø·Ù„Ø¨ Ø§Ù„ØªØµÙˆÙŠØ±) ===== */
  const backdrop = $('#backdrop');
  const modalRowsBody = document.querySelector('#modalRows tbody');

  function fillModal(req){
    $('#m_id').value = '#'+req.id;
    $('#m_createdAt').value = req.createdAt||'';
    $('#m_createdBy').value = req.createdBy||'';
    const adminInfo = req.admin || {};
    $('#m_adminReceived').value = adminInfo.received || req.adminReceived || '';
    $('#m_adminPrepared').value = adminInfo.prepared || req.adminPrepared || '';

    modalRowsBody.innerHTML='';
    (req.rows||[]).forEach((x,i)=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td class="center">${i+1}</td>
        <td><input class="mono small-input m_vin" value="${x.vin||''}" readonly></td>
        <td><input class="small-input m_car" value="${x.car||''}" readonly></td>
        <td><input class="small-input m_variant" value="${x.variant||''}" readonly></td>
        <td><input class="small-input m_ext" value="${x.extColor||''}" readonly></td>
        <td><input class="small-input m_int" value="${x.intColor||''}" readonly></td>
        <td class="center"><input class="small-input m_year center" value="${x.modelYear||''}" readonly></td>
        <td><input class="small-input m_loc" value="${x.currentLocation||''}" readonly></td>
        <td>
          <select class="small-input m_place">
            <option value="">â€” Ø§Ø®ØªØ± â€”</option>
            ${SHOOT_PLACES.map(p=>`<option ${p===(x.shootPlace||'')?'selected':''}>${p}</option>`).join('')}
          </select>
        </td>
        <td><input class="small-input m_note" value="${x.note||''}"></td>
      `;
      modalRowsBody.appendChild(tr);
    });
  }

  function openModal(id){
    const req=shootRequests.find(r=>r.id===id); if(!req) return;
    backdrop.style.display='flex';
    $('#modalTitle').innerHTML = `<i class="fa-regular fa-rectangle-list"></i> ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ #${id}`;
    fillModal(req);

    $('#btnSaveModal').onclick = async ()=>{
      const newRows=[];
      modalRowsBody.querySelectorAll('tr').forEach(tr=>{
        const vin = tr.querySelector('.m_vin').value||'';
        const old = (req.rows||[]).find(x=>x.vin===vin) || {};
        newRows.push({
          vin,
          car:old.car||'',
          variant:old.variant||'',
          extColor:old.extColor||'',
          intColor:old.intColor||'',
          modelYear:old.modelYear||'',
          currentLocation:old.currentLocation||'',
          shootPlace: tr.querySelector('.m_place').value||'',
          note: tr.querySelector('.m_note').value||''
        });
      });
      req.rows = newRows;

      await persistAll(); 
      await logActivity({
        action: 'ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ù‡ÙŠØ§ÙƒÙ„ Ø·Ù„Ø¨ ØªØµÙˆÙŠØ±',
        entityType: 'photoshootRequest',
        entityId: id,
        details: `Ø¹Ø¯Ø¯ Ø§Ù„Ù‡ÙŠØ§ÙƒÙ„: ${req.rows?.length||0}`
      });
      renderRequestsTable(); 
      showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª','ok');
    };
  }
  $('#btnCloseModal').addEventListener('click', ()=> backdrop.style.display='none');
  backdrop.addEventListener('click', (e)=>{ if(e.target===backdrop) backdrop.style.display='none'; });

  /* ===== ØªØµØ¯ÙŠØ± Excel Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªØµÙˆÙŠØ± ===== */
  $('#btnExport').addEventListener('click', ()=>{
    const header=[
      "Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨","Ø§Ù„ØªØ§Ø±ÙŠØ®","Ù…Ù‚Ø¯Ù‘Ù…","Ø¹Ø¯Ø¯ Ø§Ù„Ù‡ÙŠØ§ÙƒÙ„","Ø§Ù„Ø­Ø§Ù„Ø©",
      "Ø§Ø³ØªÙ„Ø§Ù… Ø¥Ø¯Ø§Ø±ÙŠ","ØªØ¬Ù‡ÙŠØ²","Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©",
      "VIN","Ø§Ù„Ø³ÙŠØ§Ø±Ø©","Ø§Ù„Ø¨ÙŠØ§Ù†","Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ","Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ","Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„","Ù…ÙƒØ§Ù† Ø§Ù„Ø³ÙŠØ§Ø±Ø©","Ù…ÙƒØ§Ù† Ø§Ù„ØªØµÙˆÙŠØ± (ØµÙ)","Ù…Ù„Ø§Ø­Ø¸Ø© Ø§Ù„ØµÙ"
    ];
    const data=[header];
    (shootRequests||[]).forEach(r=>{
      if(!r.rows?.length){
        data.push([
          r.id,r.createdAt,r.createdBy,0,r.status,
          (r.admin?.received||''),(r.admin?.prepared||''),(r.admin?.notes||''),
          "","","","","","","","",""
        ]);
      }else{
        r.rows.forEach((x,i)=>{
          data.push([
            i===0?r.id:"",
            i===0?r.createdAt:"",
            i===0?r.createdBy:"",
            i===0?r.rows.length:"",
            i===0?(r.status||""):"",
            i===0?(r.admin?.received||""):"",
            i===0?(r.admin?.prepared||""):"",
            i===0?(r.admin?.notes||""):"",
            x.vin,x.car,x.variant,x.extColor,x.intColor,x.modelYear,x.currentLocation,x.shootPlace||"",x.note||""
          ]);
        });
      }
    });
    const ws=XLSX.utils.aoa_to_sheet(data);
    ws['!cols']=[
      {wch:8},{wch:18},{wch:14},{wch:8},{wch:10},
      {wch:16},{wch:16},{wch:18},
      {wch:20},{wch:18},{wch:12},{wch:12},{wch:10},{wch:10},{wch:16},{wch:18},{wch:20}
    ];
    const wb=XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb,ws,"Shoot Requests");
    XLSX.writeFile(wb,"mzj-photoshoot-requests.xlsx");
  });

  /* ===== Ø·Ù„Ø¨ Ù†Ù‚Ù„ Ø¨Ù†ÙØ³ Ø´ÙƒÙ„ Ø·Ù„Ø¨ Ø§Ù„ØªØµÙˆÙŠØ± + Ø³Ø¬Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ===== */
  const moveReqRowsBody = $('#moveReqRows');

  function buildMoveRows(){
    moveReqRowsBody.innerHTML='';
    const optionsHtml = MOVE_LOCATIONS.map(l=>`<option value="${l}">${l}</option>`).join('');
    for(let i=0;i<8;i++){
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td class="center">${i+1}</td>
        <td><input class="mv_vin mono small-input" placeholder="VIN"></td>
        <td><input class="mv_car small-input" readonly placeholder="â€”"></td>
        <td><input class="mv_variant small-input" readonly placeholder="â€”"></td>
        <td><input class="mv_ext small-input" readonly placeholder="â€”"></td>
        <td><input class="mv_int small-input" readonly placeholder="â€”"></td>
        <td class="center"><input class="mv_year center small-input" readonly placeholder="â€”"></td>
        <td><input class="mv_currentLoc small-input" readonly placeholder="â€”"></td>
        <td>
          <select class="mv_newLoc small-input">
            <option value="">â€” Ø§Ø®ØªØ± â€”</option>
            ${optionsHtml}
          </select>
        </td>
        <td><input class="mv_note small-input" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ"></td>
        <td class="center">
          <button class="btn btn-danger btn-ghost mv-row-del"><i class="fa-solid fa-xmark"></i> Ø­Ø°Ù</button>
        </td>
      `;
      moveReqRowsBody.appendChild(tr);
    }
    const mb = $('#moveReqBy');
    if(mb){
      const u = auth.currentUser;
      mb.value = (u?.displayName)|| (u?.email)||'Ø£Ø­Ù…Ø¯ Ù†Ø§Ø¬ÙŠ';
      mb.setAttribute('readonly','readonly');
    }
  }
  $('#moveBtnClear').addEventListener('click', buildMoveRows);

  // Ø­Ø°Ù ØµÙ Ù†Ù‚Ù„
  moveReqRowsBody.addEventListener('click',(e)=>{
    const b=e.target.closest('.mv-row-del'); if(!b) return;
    const tr=b.closest('tr'); tr.querySelectorAll('input,select').forEach(x=> x.value='');
  });

  // ØªØ¹Ø¨Ø¦Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø¹Ù†Ø¯ Ø¥Ø¯Ø®Ø§Ù„ VIN Ù„Ù„Ù†Ù‚Ù„
  moveReqRowsBody.addEventListener('blur',(e)=>{
    const vinEl = e.target.closest('input.mv_vin'); if(!vinEl) return;
    const norm = normalizeVin(vinEl.value); vinEl.value = norm;
    if(!norm) return;
    const rec = stock.find(r=> normalizeVin(r.vin)===norm);
    const row = vinEl.closest('tr');
    if(rec){
      row.querySelector('.mv_car').value        = rec.car||'';
      row.querySelector('.mv_variant').value    = rec.variant||'';
      row.querySelector('.mv_ext').value        = rec.extColor||'';
      row.querySelector('.mv_int').value        = rec.intColor||'';
      row.querySelector('.mv_year').value       = rec.modelYear||'';
      row.querySelector('.mv_currentLoc').value = rec.location||'';
      showToast('ØªÙ… Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø©','ok');
    }else{
      row.querySelectorAll('.mv_car,.mv_variant,.mv_ext,.mv_int,.mv_year,.mv_currentLoc').forEach(i=> i.value='');
      showToast('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù‡ÙŠÙƒÙ„ Ù…Ø·Ø§Ø¨Ù‚','info');
    }
  }, true);

  function collectMoveFormRows(){
    const rows=[];
    moveReqRowsBody.querySelectorAll('tr').forEach(tr=>{
      const vin = normalizeVin(tr.querySelector('.mv_vin').value||''); 
      const toLoc = (tr.querySelector('.mv_newLoc').value||'').trim();
      if(!vin && !toLoc) return; // Ø³Ø·Ø± ÙØ§Ø¶ÙŠ ØªÙ…Ø§Ù…Ù‹Ø§
      if(!vin) return; // ØªØ¬Ø§Ù‡Ù„ Ø³Ø·Ø± Ø¨Ø¯ÙˆÙ† VIN
      const car        = tr.querySelector('.mv_car').value||'';
      const variant    = tr.querySelector('.mv_variant').value||'';
      const extColor   = tr.querySelector('.mv_ext').value||'';
      const intColor   = tr.querySelector('.mv_int').value||'';
      const modelYear  = tr.querySelector('.mv_year').value||'';
      const fromLoc    = tr.querySelector('.mv_currentLoc').value||'';
      const note       = tr.querySelector('.mv_note').value||'';
      rows.push({
        vin,
        car,
        variant,
        extColor,
        intColor,
        modelYear,
        fromLocation: fromLoc,
        toLocation: toLoc,
        note
      });
    });
    return rows;
  }

  async function saveNewMoveRequest(statusLabel='Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©'){
    const u = auth.currentUser;
    const createdBy = ($('#moveReqBy').value||'').trim() || u?.displayName || u?.email || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';

    const rows = collectMoveFormRows();
    if(rows.length===0){
      showToast('Ø£Ø¯Ø®Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ø³ÙŠØ§Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙŠ Ø·Ù„Ø¨ Ø§Ù„Ù†Ù‚Ù„','info');
      return;
    }

    const errors=[];
    rows.forEach((r,idx)=>{
      if(!r.toLocation){
        errors.push(`Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ø±Ù‚Ù… ${idx+1}: Ø§Ø®ØªØ± Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„Ø¬Ø¯ÙŠØ¯.`);
      }
    });
    if(errors.length){
      showToast('Ø¨Ø±Ø¬Ø§Ø¡ Ø§Ø³ØªÙƒÙ…Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø·Ù„Ø¨ Ø§Ù„Ù†Ù‚Ù„','err');
      alert(errors.join('\n'));
      return;
    }

    const nextId = moveRequests.length? Math.max(...moveRequests.map(r=>Number(r.id)||0))+1 : 1;

    const req = {
      id: nextId,
      type: 'VIN_MOVE',
      createdAt: now(),
      createdBy,
      rows,
      status: statusLabel, // "Ù…Ø³ÙˆØ¯Ø©" Ø£Ùˆ "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©" Ø£Ùˆ "ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ°"
      approvals: {
        adminApproved: null,
        financeApproved: null,
        adminNotes: '',
        financeNotes: '',
        issuesNotes: ''
      }
    };

    moveRequests.push(req);
    await persistAll();

    await logActivity({
      action: statusLabel==='Ù…Ø³ÙˆØ¯Ø©' ? 'Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ÙˆØ¯Ø© Ø·Ù„Ø¨ Ù†Ù‚Ù„ Ø³ÙŠØ§Ø±Ø§Øª' : 'Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ù†Ù‚Ù„ Ø³ÙŠØ§Ø±Ø§Øª',
      entityType: 'vinMoveRequest',
      entityId: nextId,
      details: `Ø¹Ø¯Ø¯ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª ÙÙŠ Ø§Ù„Ø·Ù„Ø¨: ${rows.length}`
    });

    buildMoveRows();
    renderMoveRequestsTable();
    const msg = statusLabel==='Ù…Ø³ÙˆØ¯Ø©'
      ? `ØªÙ… Ø­ÙØ¸ Ù…Ø³ÙˆØ¯Ø© Ø·Ù„Ø¨ Ø§Ù„Ù†Ù‚Ù„ #${nextId}.`
      : `ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ù†Ù‚Ù„ Ø±Ù‚Ù… #${nextId} Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©.`;
    showToast(msg,'ok');
  }

  $('#moveBtnDraft').addEventListener('click', ()=> saveNewMoveRequest('Ù…Ø³ÙˆØ¯Ø©'));
  $('#moveBtnSubmit').addEventListener('click', ()=> saveNewMoveRequest('Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©'));

  /* ===== Ø³Ø¬Ù„ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù†Ù‚Ù„ ===== */
  const moveTblBody = document.querySelector('#moveRequestsTable tbody');
  const moveStatusFilter = $('#moveStatusFilter');
  const moveSearch = $('#moveSearch');

  function renderMoveRequestsTable(){
    if(!moveTblBody) return;
    const s = (moveStatusFilter?.value)||'ALL';
    const q = (moveSearch?.value||'').toLowerCase().trim();

    let list = moveRequests.slice().sort((a,b)=> b.id - a.id);
    if(s!=='ALL') list = list.filter(r=> (r.status||'')===s);
    if(q){
      list = list.filter(r=>{
        const ap = r.approvals||{};
        const hay=[
          r.id,r.createdAt,r.createdBy,r.status,
          ap.adminNotes||'',ap.financeNotes||'',ap.issuesNotes||'',
          ...(r.rows||[]).flatMap(x=>[x.vin,x.car,x.variant,x.extColor,x.intColor,x.modelYear,x.fromLocation,x.toLocation,x.note])
        ].join(' ').toLowerCase();
        return hay.includes(q);
      });
    }

    moveTblBody.innerHTML='';
    list.forEach(r=>{
      const ap = r.approvals || {};
      const notesSummary = [ap.adminNotes, ap.financeNotes, ap.issuesNotes].filter(Boolean).join(' / ');
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td class="nowrap">#${r.id}</td>
        <td class="nowrap">${r.createdAt||''}</td>
        <td class="nowrap">${r.createdBy||''}</td>
        <td class="center">${r.rows?.length||0}</td>
        <td class="nowrap">${r.status||''}</td>
        <td class="nowrap">${notesSummary||'â€”'}</td>
        <td class="center cell-actions">
          <button class="btn btn-ghost" data-move="${r.id}"><i class="fa-regular fa-eye"></i> Ø¹Ø±Ø¶</button>
        </td>
      `;
      moveTblBody.appendChild(tr);
    });
  }

  if(moveStatusFilter) moveStatusFilter.addEventListener('change', renderMoveRequestsTable);
  if(moveSearch) moveSearch.addEventListener('input', renderMoveRequestsTable);

  // ÙØªØ­ ØªÙØ§ØµÙŠÙ„ Ø·Ù„Ø¨ Ø§Ù„Ù†Ù‚Ù„
  const moveBackdrop = $('#moveBackdrop');
  const moveModalRowsBody = document.querySelector('#moveModalRows tbody');

  function openMoveModal(id){
    const req = moveRequests.find(r=>r.id===id); if(!req) return;
    moveBackdrop.style.display='flex';
    $('#moveModalTitle').innerHTML = `<i class="fa-regular fa-rectangle-list"></i> ØªÙØ§ØµÙŠÙ„ Ø·Ù„Ø¨ Ø§Ù„Ù†Ù‚Ù„ #${id}`;

    $('#moveModalId').value = '#'+req.id;
    $('#moveModalCreatedAt').value = req.createdAt || '';
    $('#moveModalCreatedBy').value = req.createdBy || '';
    $('#moveModalStatus').value = req.status || '';

    moveModalRowsBody.innerHTML='';
    (req.rows||[]).forEach((x,i)=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td class="center">${i+1}</td>
        <td><input class="mono small-input" value="${x.vin||''}" readonly></td>
        <td><input class="small-input" value="${x.car||''}" readonly></td>
        <td><input class="small-input" value="${x.variant||''}" readonly></td>
        <td><input class="small-input" value="${x.extColor||''}" readonly></td>
        <td><input class="small-input" value="${x.intColor||''}" readonly></td>
        <td class="center"><input class="small-input center" value="${x.modelYear||''}" readonly></td>
        <td><input class="small-input" value="${x.fromLocation||''}" readonly></td>
        <td><input class="small-input" value="${x.toLocation||''}" readonly></td>
        <td><input class="small-input" value="${x.note||''}" readonly></td>
      `;
      moveModalRowsBody.appendChild(tr);
    });
  }

  if(moveTblBody){
    moveTblBody.addEventListener('click',(e)=>{
      const btn = e.target.closest('button[data-move]');
      if(btn){
        const id = Number(btn.getAttribute('data-move'));
        if(id) openMoveModal(id);
        return;
      }
      const row = e.target.closest('tr');
      if(!row) return;
      const first = row.querySelector('td'); if(!first) return;
      const txt = (first.textContent||'').trim();
      const id  = Number(txt.replace('#','').trim());
      if(id) openMoveModal(id);
    });
  }

  $('#moveBtnCloseModal').addEventListener('click', ()=> moveBackdrop.style.display='none');
  moveBackdrop.addEventListener('click',(e)=>{ if(e.target===moveBackdrop) moveBackdrop.style.display='none'; });

  /* ===== Start ===== */
  setStatus('warn', 'Ø¬Ø§Ø±Ù Ø§Ù„Ø§ØªØµØ§Ù„â€¦');
</script>
</body>
</html>

