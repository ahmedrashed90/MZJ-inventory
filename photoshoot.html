<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>MZJ — طلبات التصوير</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>

<style>
  :root{
    --brown:#3e2420; --beige:#bc8f74; --bg:#faf7f3; --card:#fff; --line:#e7e5e4;
    --text:#1f2937; --muted:#6b7280; --ok:#16a34a; --danger:#ef4444; --info:#0ea5e9; --warn:#f59e0b;
    --radius:12px; --shadow:0 10px 28px rgba(0,0,0,.06);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font-family:"Tajawal",system-ui,Arial}

  /* Topbar */
  .topbar{position:sticky;top:0;z-index:40;background:#fff;border-bottom:1px solid var(--line)}
  .topbar-inner{max-width:1240px;margin:auto;display:flex;align-items:center;justify-content:space-between;padding:10px 14px}
  .brand{display:flex;align-items:center;gap:10px}
  .logo{width:34px;height:34px;border-radius:10px;background:linear-gradient(135deg,var(--brown),#271713);display:grid;place-items:center;color:#fff;font-weight:900}
  .brand h1{margin:0;font-size:17px;color:var(--brown)}
  .tabs{display:flex;gap:6px}
  .tab{font-size:12px;padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#fff;color:inherit;text-decoration:none;font-weight:800}
  .tab.active{background:var(--brown);border-color:var(--brown);color:#fff}
  .status-badge{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--line);border-radius:10px;padding:5px 8px;font-size:12px;background:#fff}
  .dot{width:8px;height:8px;border-radius:999px;background:var(--warn)}
  .dot.ok{background:var(--ok)} .dot.err{background:var(--danger)}

  .container{max-width:1240px;margin:14px auto;padding:0 12px;display:grid;gap:12px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:12px}
  .card header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .title{margin:0;font-size:15px;color:var(--brown);display:flex;align-items:center;gap:8px}
  .hint{color:var(--muted);font-size:12px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .btn{border:1px solid var(--line);background:#fff;border-radius:9px;padding:7px 10px;cursor:pointer;font-weight:800;font-size:13px}
  .btn:hover{transform:translateY(-1px)}
  .btn:active{transform:translateY(0)}
  .btn-primary{background:var(--brown);border-color:var(--brown);color:#fff}
  .btn-success{background:var(--ok);border-color:var(--ok);color:#fff}
  .btn-info{background:var(--info);border-color:var(--info);color:#fff}
  .btn-warn{background:var(--warn);border-color:var(--warn);color:#fff}
  .btn-danger{background:var(--danger);border-color:var(--danger);color:#fff}
  input,select,textarea{width:100%;padding:8px 9px;border:1px solid var(--line);border-radius:8px;background:#fff;font-size:14px}
  input[readonly]{background:#fafafa;color:#6b7280}

  /* جداول بدون سكرول أفقي — تصغير ومسافات مضغوطة + التفاف نصوص */
  .table-wrap{border:1px solid var(--line);border-radius:10px;overflow:hidden}
  table{border-collapse:separate;border-spacing:0;width:100%;table-layout:fixed}
  thead th{position:sticky;top:0;background:#fcfbf9;border-bottom:2px solid var(--line);text-align:right;
           font-size:12px;padding:6px 8px;color:#111827;white-space:normal;line-height:1.3}
  tbody td{border-top:1px solid var(--line);padding:6px 8px;font-size:13px;vertical-align:middle;white-space:normal;
           word-break:break-word;line-height:1.45}
  tbody tr:nth-child(even){background:#fffdfb}
  tbody tr:hover{background:#f7fafc}
  td,th{border-left:1px solid var(--line)}
  td:last-child,th:last-child{border-left:0}
  .center{text-align:center}
  .mono{font-family:ui-monospace,Consolas,Menlo,monospace;letter-spacing:.2px}
  .nowrap{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

  .cell-actions .btn{padding:6px 8px;font-size:12px}

  /* Modal */
  .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.38);display:none;align-items:center;justify-content:center;z-index:80}
  .modal{background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:0 28px 70px rgba(0,0,0,.35);width:min(1100px,96vw);max-height:92vh;display:flex;flex-direction:column}
  .modal header{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--line)}
  .modal .body{padding:10px 12px;overflow:auto}
  .subgrid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  @media (max-width:900px){.subgrid{grid-template-columns:1fr 1fr}}
  @media (max-width:620px){.subgrid{grid-template-columns:1fr}}
  .kv{display:grid;grid-template-columns:140px 1fr;gap:6px;align-items:center}
  .hr{height:1px;background:var(--line);margin:10px 0}

  /* Toast */
  .toast{position:fixed;bottom:16px;right:16px;background:#111827;color:#fff;padding:8px 12px;border-radius:10px;display:none;font-size:13px}
</style>
</head>
<body>

<!-- Topbar -->
<div class="topbar">
  <div class="topbar-inner">
    <div class="brand">
      <div class="logo">MZJ</div>
      <div>
        <h1>طلبات التصوير</h1>
        <small class="hint">مجموعة محمد بن ذعار العجمي للسيارات</small>
      </div>
    </div>
    <div class="tabs">
      <a class="tab" href="admin.html">الإدارة</a>
      <a class="tab" href="inventory.html">المخزون</a>
      <a class="tab" href="dashboard.html">الداش بورد</a>
    </div>
    <div class="row">
      <div class="status-badge"><span id="connDot" class="dot"></span><span id="connText">جارِ الاتصال…</span></div>
      <button id="btnSignOut" class="btn" style="display:none"><i class="fa-solid fa-right-from-bracket"></i> خروج</button>
    </div>
  </div>
</div>

<!-- Auth Gate -->
<div id="authGate" style="min-height:60vh;display:grid;place-items:center;padding:20px">
  <div class="card" style="max-width:420px;width:96%">
    <h2 class="title" style="margin-bottom:8px"><i class="fa-solid fa-right-to-bracket"></i> تسجيل الدخول</h2>
    <label>البريد الإلكتروني</label>
    <input id="email" type="email" placeholder="you@example.com"/>
    <label style="margin-top:8px">كلمة المرور</label>
    <input id="password" type="password" placeholder="••••••••"/>
    <div class="row" style="margin-top:8px">
      <button class="btn btn-primary" id="btnLogin">تسجيل الدخول</button>
      <button class="btn" id="btnSignup">إنشاء حساب</button>
    </div>
    <p class="hint" id="authHint" style="margin-top:8px"></p>
  </div>
</div>

<!-- App -->
<div id="app" style="display:none">
  <div class="container">

    <!-- إنشاء طلب -->
    <div class="card">
      <header>
        <h3 class="title"><i class="fa-solid fa-camera-retro"></i> إنشاء طلب تصوير</h3>
        <small class="hint">اكتب رقم الهيكل — تعبئة تلقائية | حتى 8 هياكل</small>
      </header>

      <div class="row">
        <div style="flex:1;min-width:220px">
          <label>مقدّم الطلب</label>
          <input id="reqBy" class="small-input" value="أحمد ناجي" readonly title="محدد تلقائيًا"/>
        </div>
      </div>

      <div class="table-wrap" style="margin-top:8px">
        <table id="entryTable">
          <colgroup>
            <col style="width:4ch">
            <col style="width:22ch">
            <col style="width:20ch">
            <col style="width:18ch">
            <col style="width:14ch">
            <col style="width:8ch">
            <col style="width:18ch">
            <col style="width:16ch">
            <col style="width:auto">
            <col style="width:8ch">
          </colgroup>
          <thead>
            <tr>
              <th class="center">#</th>
              <th>رقم الهيكل</th>
              <th>السيارة</th>
              <th>البيان</th>
              <th>الخارجي</th>
              <th class="center">الموديل</th>
              <th>مكان السيارة</th>
              <th>مكان التصوير</th>
              <th>ملاحظة</th>
              <th class="center">حذف</th>
            </tr>
          </thead>
          <tbody id="reqRows"></tbody>
        </table>
      </div>

      <div class="row" style="margin-top:8px">
        <button class="btn" id="btnDraft"><i class="fa-regular fa-floppy-disk"></i> حفظ كمسودة</button>
        <button class="btn btn-primary" id="btnSubmit"><i class="fa-solid fa-paper-plane"></i> إرسال الطلب</button>
        <button class="btn" id="btnClear"><i class="fa-solid fa-rotate"></i> تفريغ</button>
      </div>
    </div>

    <!-- متابعة الطلبات -->
    <div class="card">
      <header>
        <h3 class="title"><i class="fa-solid fa-clipboard-list"></i> متابعة الطلبات</h3>
        <div class="row">
          <select id="statusFilter" class="small-input" style="width:170px">
            <option value="ALL">كل الحالات</option>
            <option value="مسودة">مسودة</option>
            <option value="تحت الإجراء">تحت الإجراء</option>
            <option value="تم">تم</option>
          </select>
          <input id="searchRequests" class="small-input" placeholder="بحث سريع" style="min-width:220px">
          <button id="btnExport" class="btn"><i class="fa-regular fa-file-excel"></i> تصدير</button>
        </div>
      </header>

      <div class="table-wrap">
        <table id="requestsTable">
          <colgroup>
            <col style="width:8ch">
            <col style="width:18ch">
            <col style="width:16ch">
            <col style="width:8ch">
            <col style="width:12ch">
            <col style="width:16ch">
            <col style="width:auto">
          </colgroup>
          <thead>
            <tr>
              <th>رقم</th>
              <th>التاريخ</th>
              <th>مقدّم</th>
              <th class="center">الهياكل</th>
              <th>الحالة</th>
              <th>إداري</th>
              <th class="center">إجراءات</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <p class="hint" style="margin:6px 0 0">الإجراءات: <b>عرض</b> / <b>استلام</b> / <b>تجهيز</b> / <b>تم</b> / <b>حذف</b>.</p>
    </div>

  </div>
</div>

<!-- Modal: تفاصيل وتعديل الطلب -->
<div id="backdrop" class="backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <header>
      <h3 id="modalTitle" class="title"><i class="fa-regular fa-rectangle-list"></i> تفاصيل الطلب</h3>
      <div class="row">
        <button id="btnSaveModal" class="btn btn-success"><i class="fa-solid fa-check"></i> حفظ</button>
        <button id="btnCloseModal" class="btn btn-danger"><i class="fa-solid fa-xmark"></i> إغلاق</button>
      </div>
    </header>
    <div class="body">
      <div class="subgrid">
        <div class="kv"><div class="hint">رقم الطلب</div><input id="m_id" class="small-input" readonly></div>
        <div class="kv"><div class="hint">التاريخ</div><input id="m_createdAt" class="small-input" readonly></div>
        <div class="kv"><div class="hint">مقدّم الطلب</div><input id="m_createdBy" class="small-input" readonly></div>
        <div class="kv"><div class="hint">الحالة</div>
          <select id="m_status" class="small-input">
            <option>مسودة</option>
            <option>تحت الإجراء</option>
            <option>تم</option>
          </select>
        </div>
        <div class="kv"><div class="hint">ملاحظات الإدارة</div><input id="m_adminNotes" class="small-input" placeholder="اختياري"></div>
      </div>

      <div class="hr"></div>
      <h4 class="title" style="font-size:14px"><i class="fa-solid fa-user-shield"></i> متابعة إدارية</h4>
      <div class="subgrid">
        <div class="kv"><div class="hint">استلام إداري</div><input id="m_adminReceived" class="small-input" readonly placeholder="—"></div>
        <div class="kv"><div class="hint">تجهيز السيارات</div><input id="m_adminPrepared" class="small-input" readonly placeholder="—"></div>
      </div>
      <div class="row" style="margin-top:6px">
        <button id="m_btnMarkReceived" class="btn btn-info"><i class="fa-solid fa-inbox"></i> تأكيد الاستلام</button>
        <button id="m_btnMarkPrepared" class="btn btn-warn"><i class="fa-solid fa-screwdriver-wrench"></i> تأكيد التجهيز</button>
      </div>

      <div class="hr"></div>
      <h4 class="title" style="font-size:14px"><i class="fa-regular fa-list-ul"></i> هياكل الطلب</h4>
      <div class="table-wrap">
        <table id="modalRows">
          <colgroup>
            <col style="width:4ch">
            <col style="width:20ch">
            <col style="width:18ch">
            <col style="width:16ch">
            <col style="width:16ch">
            <col style="width:8ch">
            <col style="width:18ch">
            <col style="width:16ch">
            <col style="width:auto">
          </colgroup>
          <thead>
            <tr>
              <th class="center">#</th>
              <th>VIN</th>
              <th>السيارة</th>
              <th>البيان</th>
              <th>الخارجي</th>
              <th class="center">الموديل</th>
              <th>مكان السيارة</th>
              <th>مكان التصوير</th>
              <th>ملاحظة</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

    </div>
  </div>
</div>

<div id="toast" class="toast">تم</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

  /* ===== Firebase ===== */
  const firebaseConfig = {
    apiKey: "AIzaSyC614bGqnYf4Q-weTNemzWENTpa8DjGeHw",
    authDomain: "mzj-agenda.firebaseapp.com",
    projectId: "mzj-agenda",
    storageBucket: "mzj-agenda.firebasestorage.app",
    messagingSenderId: "834700407721",
    appId: "1:834700407721:web:75c17665d4f032fd65cab8"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);
  const STATE_REF = doc(db, "mzj_admin_state", "v1");

  /* ===== Helpers ===== */
  const $ = s => document.querySelector(s);
  const pad = n => n<10?'0'+n:n;
  const now = ()=>{const d=new Date();return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`};
  function setStatus(mode,txt){ $('#connDot').className='dot '+(mode==='ok'?'ok':mode==='err'?'err':''); $('#connText').textContent=txt; }
  const toast = $('#toast');
  const showToast = (msg)=>{ toast.textContent=msg; toast.style.display='block'; setTimeout(()=>toast.style.display='none',1200); };
  function normalizeVin(v){ if(!v) return ''; const ar={'٠':'0','١':'1','٢':'2','٣':'3','٤':'4','٥':'5','٦':'6','٧':'7','٨':'8','٩':'9'}; return v.toString().replace(/[٠-٩]/g,d=>ar[d]).toUpperCase().replace(/[\s\-\._]/g,'').trim(); }

  /* ===== State ===== */
  let stock=[], shootRequests=[];
  const SHOOT_PLACES = ["المعرض","الاستديو","الصالة الاساسية","صالة القادسية","معرض الملتقى"];

  /* ===== Auth ===== */
  onAuthStateChanged(auth, async (user)=>{
    if(user){
      $('#authGate').style.display='none';
      $('#app').style.display='block';
      $('#btnSignOut').style.display='inline-block';
      setStatus('ok', `متصل: ${user.email}`);
      await initData(); subscribeLive(); buildFormRows(); renderRequestsTable();
      // تأكيد ضبط مقدّم الطلب تلقائيًا
      const rb = $('#reqBy'); rb.value='أحمد ناجي'; rb.setAttribute('readonly','readonly');
    }else{
      $('#app').style.display='none';
      $('#authGate').style.display='grid';
      $('#btnSignOut').style.display='none';
      setStatus('', 'لم يتم تسجيل الدخول');
    }
  });
  $('#btnLogin').addEventListener('click', async ()=>{
    $('#authHint').textContent=''; try{ await signInWithEmailAndPassword(auth, $('#email').value.trim(), $('#password').value); }
    catch(e){ $('#authHint').textContent='خطأ: '+(e?.message||e); }
  });
  $('#btnSignup').addEventListener('click', async ()=>{
    $('#authHint').textContent=''; try{ await createUserWithEmailAndPassword(auth, $('#email').value.trim(), $('#password').value); }
    catch(e){ $('#authHint').textContent='خطأ: '+(e?.message||e); }
  });
  $('#btnSignOut').addEventListener('click', ()=> signOut(auth));

  /* ===== Data ===== */
  async function initData(){
    try{
      const s=await getDoc(STATE_REF);
      if(s.exists()){
        const d=s.data()||{};
        stock = Array.isArray(d.stock)? d.stock: [];
        shootRequests = Array.isArray(d.shootRequests)? d.shootRequests: [];
      }else{ stock=[]; shootRequests=[]; }
      setStatus('ok','تم التحميل');
    }catch(e){ setStatus('','تعذّر تحميل البيانات'); }
  }
  function subscribeLive(){
    try{
      onSnapshot(STATE_REF,(snap)=>{
        if(!snap.exists()) return;
        const d=snap.data()||{};
        stock = Array.isArray(d.stock)? d.stock: stock;
        shootRequests = Array.isArray(d.shootRequests)? d.shootRequests: shootRequests;
        renderRequestsTable();
      });
    }catch(e){}
  }
  async function persistAll(){
    try{ await setDoc(STATE_REF, { stock, shootRequests, updatedAt: now() }, { merge:true }); }
    catch(e){ showToast('تعذّر الحفظ إلى السحابة'); }
  }

  /* ===== إنشاء الطلب (8 صفوف) ===== */
  const reqRowsBody = $('#reqRows');
  function buildFormRows(){
    reqRowsBody.innerHTML='';
    for(let i=0;i<8;i++){
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td class="center">${i+1}</td>
        <td><input class="vin mono small-input" placeholder="VIN"></td>
        <td><input class="car small-input" readonly placeholder="—"></td>
        <td><input class="variant small-input" readonly placeholder="—"></td>
        <td><input class="ext small-input" readonly placeholder="—"></td>
        <td class="center"><input class="year center small-input" readonly placeholder="—"></td>
        <td><input class="loc small-input" readonly placeholder="—"></td>
        <td>
          <select class="place small-input">
            <option value="">— اختر —</option>
            ${SHOOT_PLACES.map(p=>`<option>${p}</option>`).join('')}
          </select>
        </td>
        <td><input class="note small-input" placeholder="اختياري"></td>
        <td class="center">
          <button class="btn btn-danger btn-row-del"><i class="fa-solid fa-xmark"></i> حذف</button>
        </td>
      `;
      reqRowsBody.appendChild(tr);
    }
    // تأكيد اسم مقدّم الطلب بعد إعادة البناء
    const rb = $('#reqBy'); if(rb){ rb.value='أحمد ناجي'; rb.setAttribute('readonly','readonly'); }
  }
  $('#btnClear').addEventListener('click', buildFormRows);

  // حذف صف (تفريغ حقول)
  reqRowsBody.addEventListener('click',(e)=>{
    const b=e.target.closest('.btn-row-del'); if(!b) return;
    const tr=b.closest('tr'); tr.querySelectorAll('input,select').forEach(x=> x.value='');
  });

  // تعبئة تلقائية من المخزون عند الخروج من خانة VIN
  reqRowsBody.addEventListener('blur',(e)=>{
    const vinEl = e.target.closest('input.vin'); if(!vinEl) return;
    const norm = normalizeVin(vinEl.value); vinEl.value = norm;
    if(!norm) return;
    const rec = stock.find(r=> normalizeVin(r.vin)===norm);
    const row = vinEl.closest('tr');
    if(rec){
      row.querySelector('.car').value    = rec.car||'';
      row.querySelector('.variant').value= rec.variant||'';
      row.querySelector('.ext').value    = rec.extColor||'';
      row.querySelector('.year').value   = rec.modelYear||'';
      row.querySelector('.loc').value    = rec.location||'';
      showToast('تم جلب بيانات السيارة');
    }else{
      row.querySelectorAll('.car,.variant,.ext,.year,.loc').forEach(i=> i.value='');
      showToast('لا يوجد هيكل مطابق');
    }
  }, true);

  function collectFormRows(){
    const rows=[];
    reqRowsBody.querySelectorAll('tr').forEach(tr=>{
      const vin = normalizeVin(tr.querySelector('.vin').value||''); if(!vin) return;
      rows.push({
        vin,
        car:tr.querySelector('.car').value||'',
        variant:tr.querySelector('.variant').value||'',
        extColor:tr.querySelector('.ext').value||'',
        intColor:'',
        modelYear:tr.querySelector('.year').value||'',
        currentLocation:tr.querySelector('.loc').value||'',
        shootPlace: (tr.querySelector('.place').value||''),
        note:tr.querySelector('.note').value||''
      });
    });
    return rows;
  }

  async function saveNewRequest(statusLabel){
    const by = ($('#reqBy').value||'').trim() || 'أحمد ناجي';
    const rows = collectFormRows();
    if(statusLabel!=='مسودة' && rows.length===0) return showToast('أدخل هيكل واحد على الأقل');

    const nextId = shootRequests.length? Math.max(...shootRequests.map(r=>Number(r.id)||0))+1 : 1;
    const req = {
      id: nextId,
      createdAt: now(),
      createdBy: by,
      rows,
      status: statusLabel, // "مسودة" | "تحت الإجراء" | "تم"
      admin: { received:null, prepared:null, notes:'' }
    };
    shootRequests.push(req);
    await persistAll();
    buildFormRows();
    renderRequestsTable();
    showToast(statusLabel==='مسودة'?'تم حفظ المسودة':'تم إرسال الطلب');
  }

  $('#btnDraft').addEventListener('click', ()=> saveNewRequest('مسودة'));
  $('#btnSubmit').addEventListener('click', ()=> saveNewRequest('تحت الإجراء'));

  /* ===== متابعة الطلبات (قائمة + إجراءات) ===== */
  const tblBody = document.querySelector('#requestsTable tbody');
  function renderRequestsTable(){
    const s = ($('#statusFilter').value||'ALL');
    const q = ($('#searchRequests').value||'').toLowerCase().trim();

    let list = shootRequests.slice().sort((a,b)=> b.id - a.id);
    if(s!=='ALL') list = list.filter(r=> (r.status||'')===s);
    if(q){
      list = list.filter(r=>{
        const hay=[
          r.id,r.createdAt,r.createdBy,r.status,(r.admin?.received||''),(r.admin?.prepared||''),(r.admin?.notes||''),
          ...r.rows.flatMap(x=>[x.vin,x.car,x.variant,x.extColor,x.modelYear,x.currentLocation,x.shootPlace,x.note])
        ].join(' ').toLowerCase();
        return hay.includes(q);
      });
    }

    tblBody.innerHTML='';
    list.forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td class="nowrap">#${r.id}</td>
        <td class="nowrap">${r.createdAt}</td>
        <td class="nowrap">${r.createdBy||'-'}</td>
        <td class="center">${r.rows.length}</td>
        <td class="nowrap">${r.status||'-'}</td>
        <td class="nowrap">${r.admin?.received? '✅ '+r.admin.received : '—'}<br>${r.admin?.prepared? '✅ '+r.admin.prepared : '—'}</td>
        <td class="center cell-actions">
          <button class="btn btn-info" data-view="${r.id}"><i class="fa-regular fa-pen-to-square"></i> عرض</button>
          <button class="btn" data-recv="${r.id}"><i class="fa-solid fa-inbox"></i> استلام</button>
          <button class="btn btn-warn" data-prep="${r.id}"><i class="fa-solid fa-screwdriver-wrench"></i> تجهيز</button>
          <button class="btn btn-success" data-done="${r.id}"><i class="fa-solid fa-check"></i> تم</button>
          <button class="btn btn-danger" data-del="${r.id}"><i class="fa-solid fa-trash"></i> حذف</button>
        </td>
      `;
      tblBody.appendChild(tr);
    });
  }
  $('#statusFilter').addEventListener('change', renderRequestsTable);
  $('#searchRequests').addEventListener('input', renderRequestsTable);

  /* ===== إجراءات سريعة من الجدول ===== */
  document.addEventListener('click', async (e)=>{
    const v=e.target.closest('button[data-view]');
    const del=e.target.closest('button[data-del]');
    const recv=e.target.closest('button[data-recv]');
    const prep=e.target.closest('button[data-prep]');
    const done=e.target.closest('button[data-done]');

    if(v){ openModal(Number(v.getAttribute('data-view'))); }
    if(del){
      const id=Number(del.getAttribute('data-del'));
      if(!confirm(`حذف الطلب #${id}؟`)) return;
      shootRequests = shootRequests.filter(r=> r.id!==id);
      await persistAll(); renderRequestsTable(); showToast('تم حذف الطلب');
    }
    if(recv){
      const id=Number(recv.getAttribute('data-recv'));
      const req = shootRequests.find(r=>r.id===id); if(!req) return;
      req.admin = req.admin||{}; req.admin.received = now();
      if(req.status==='مسودة') req.status='تحت الإجراء';
      await persistAll(); renderRequestsTable(); showToast('تم تأكيد الاستلام');
    }
    if(prep){
      const id=Number(prep.getAttribute('data-prep'));
      const req = shootRequests.find(r=>r.id===id); if(!req) return;
      req.admin = req.admin||{}; req.admin.prepared = now();
      if(req.status==='مسودة') req.status='تحت الإجراء';
      await persistAll(); renderRequestsTable(); showToast('تم تأكيد التجهيز');
    }
    if(done){
      const id=Number(done.getAttribute('data-done'));
      const req = shootRequests.find(r=>r.id===id); if(!req) return;
      req.status='تم';
      await persistAll(); renderRequestsTable(); showToast('تم إكمال الطلب');
    }
  });

  /* ===== Modal (عرض/تعديل) ===== */
  const backdrop = $('#backdrop');
  const modalRowsBody = document.querySelector('#modalRows tbody');

  function fillModal(req){
    $('#m_id').value = '#'+req.id;
    $('#m_createdAt').value = req.createdAt||'';
    $('#m_createdBy').value = req.createdBy||'';
    $('#m_status').value = req.status||'مسودة';
    $('#m_adminReceived').value = (req.admin?.received)||'';
    $('#m_adminPrepared').value = (req.admin?.prepared)||'';
    $('#m_adminNotes').value = (req.admin?.notes)||'';

    // rows
    modalRowsBody.innerHTML='';
    (req.rows||[]).forEach((x,i)=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td class="center">${i+1}</td>
        <td><input class="mono small-input m_vin" value="${x.vin||''}" readonly></td>
        <td><input class="small-input m_car" value="${x.car||''}" readonly></td>
        <td><input class="small-input m_variant" value="${x.variant||''}" readonly></td>
        <td><input class="small-input m_ext" value="${x.extColor||''}" readonly></td>
        <td class="center"><input class="small-input m_year center" value="${x.modelYear||''}" readonly></td>
        <td><input class="small-input m_loc" value="${x.currentLocation||''}" readonly></td>
        <td>
          <select class="small-input m_place">
            <option value="">— اختر —</option>
            ${["المعرض","الاستديو","الصالة الاساسية","صالة القادسية","معرض الملتقى"].map(p=>`<option ${p===(x.shootPlace||'')?'selected':''}>${p}</option>`).join('')}
          </select>
        </td>
        <td><input class="small-input m_note" value="${x.note||''}"></td>
      `;
      modalRowsBody.appendChild(tr);
    });
  }

  function openModal(id){
    const req=shootRequests.find(r=>r.id===id); if(!req) return;
    backdrop.style.display='flex';
    $('#modalTitle').innerHTML = `<i class="fa-regular fa-rectangle-list"></i> تفاصيل الطلب #${id}`;
    fillModal(req);

    // أزرار الإدارة داخل المودال
    $('#m_btnMarkReceived').onclick = async ()=>{
      req.admin = req.admin||{}; req.admin.received = now();
      if(req.status==='مسودة') req.status='تحت الإجراء';
      await persistAll(); fillModal(req); renderRequestsTable(); showToast('تم تأكيد الاستلام');
    };
    $('#m_btnMarkPrepared').onclick = async ()=>{
      req.admin = req.admin||{}; req.admin.prepared = now();
      if(req.status==='مسودة') req.status='تحت الإجراء';
      await persistAll(); fillModal(req); renderRequestsTable(); showToast('تم تأكيد التجهيز');
    };

    // حفظ شامل
    $('#btnSaveModal').onclick = async ()=>{
      req.status     = $('#m_status').value||'مسودة';
      req.admin = req.admin||{};
      req.admin.notes = $('#m_adminNotes').value||'';

      // تحديث مكان التصوير + ملاحظة لكل صف
      const newRows=[];
      modalRowsBody.querySelectorAll('tr').forEach(tr=>{
        const vin = tr.querySelector('.m_vin').value||'';
        const old = (req.rows||[]).find(x=>x.vin===vin) || {};
        newRows.push({
          vin,
          car:old.car||'',
          variant:old.variant||'',
          extColor:old.extColor||'',
          intColor:old.intColor||'',
          modelYear:old.modelYear||'',
          currentLocation:old.currentLocation||'',
          shootPlace: tr.querySelector('.m_place').value||'',
          note: tr.querySelector('.m_note').value||''
        });
      });
      req.rows = newRows;

      await persistAll(); renderRequestsTable(); showToast('تم الحفظ');
    };
  }
  $('#btnCloseModal').addEventListener('click', ()=> backdrop.style.display='none');
  backdrop.addEventListener('click', (e)=>{ if(e.target===backdrop) backdrop.style.display='none'; });

  /* ===== تصدير Excel ===== */
  $('#btnExport').addEventListener('click', ()=>{
    const header=["رقم الطلب","التاريخ","مقدّم","عدد الهياكل","الحالة",
      "استلام إداري","تجهيز","ملاحظات الإدارة",
      "VIN","السيارة","البيان","الخارجي","الموديل","مكان السيارة","مكان التصوير (صف)","ملاحظة الصف"];
    const data=[header];
    (shootRequests||[]).forEach(r=>{
      if(!r.rows?.length){
        data.push([r.id,r.createdAt,r.createdBy,0,r.status,(r.admin?.received||''),(r.admin?.prepared||''),(r.admin?.notes||''),"","","","","","","",""]);
      }else{
        r.rows.forEach((x,i)=>{
          data.push([
            i===0?r.id:"", i===0?r.createdAt:"", i===0?r.createdBy:"", i===0?r.rows.length:"", i===0?(r.status||""):"",
            i===0?(r.admin?.received||""):"", i===0?(r.admin?.prepared||""):"", i===0?(r.admin?.notes||""):"",
            x.vin,x.car,x.variant,x.extColor,x.modelYear,x.currentLocation,x.shootPlace||"",x.note||""
          ]);
        });
      }
    });
    const ws=XLSX.utils.aoa_to_sheet(data);
    ws['!cols']=[{wch:8},{wch:18},{wch:14},{wch:8},{wch:10},{wch:16},{wch:18},{wch:16},{wch:20},{wch:14},{wch:10},{wch:16},{wch:16},{wch:18}];
    const wb=XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb,ws,"Shoot Requests");
    XLSX.writeFile(wb,"mzj-photoshoot-requests.xlsx");
  });

  /* ===== Start ===== */
  setStatus('', 'جارِ الاتصال…');
</script>
</body>
</html>

