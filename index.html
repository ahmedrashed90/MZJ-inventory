<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<title>MZJ — لوحة التشغيل</title>

<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
<style>
  :root{
    --brown:#3e2420; --beige:#bc8f74; --cream:#fff8ef; --bg:#faf7f3; --card:#fff; --line:#e7e5e4;
    --text:#1f2937; --muted:#6b7280; --ok:#16a34a; --danger:#ef4444; --info:#0ea5e9; --warn:#f59e0b;
    --radius:12px; --shadow:0 10px 28px rgba(0,0,0,.06);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font-family:"Tajawal",system-ui,Arial}
  #app, #authGate { display:none; } /* prevent login flash */
  .topbar{position:sticky;top:0;z-index:60;background:#fff;border-bottom:1px solid var(--line)}
  .topbar-inner{max-width:1240px;margin:auto;display:flex;align-items:center;justify-content:space-between;padding:10px 14px}
  .brand{display:flex;align-items:center;gap:10px}
  .logo{width:34px;height:34px;border-radius:10px;background:linear-gradient(135deg,var(--brown),#271713);display:grid;place-items:center;color:#fff;font-weight:900}
  .brand h1{margin:0;font-size:17px;color:var(--brown)}
  .tabs{display:flex;gap:6px}
  .tab{font-size:12px;padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#fff;color:inherit;text-decoration:none;font-weight:800}
  .tab.active{background:var(--brown);border-color:var(--brown);color:#fff}
  .status-badge{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--line);border-radius:10px;padding:5px 8px;font-size:12px;background:#fff}
  .dot{width:8px;height:8px;border-radius:999px;background:var(--warn)}
  .dot.ok{background:var(--ok)} .dot.err{background:var(--danger)}
  .container{max-width:1240px;margin:14px auto;padding:0 12px;display:grid;gap:12px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:12px}
  .card header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .title{margin:0;font-size:15px;color:var(--brown);display:flex;align-items:center;gap:8px}
  .hint{color:var(--muted);font-size:12px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .btn{border:1px solid var(--line);background:#fff;border-radius:9px;padding:7px 10px;cursor:pointer;font-weight:800;font-size:13px}
  .btn:hover{transform:translateY(-1px)}
  .btn:active{transform:translateY(0)}
  .btn-primary{background:var(--brown);border-color:var(--brown);color:#fff}
  .btn-success{background:var(--ok);border-color:var(--ok);color:#fff}
  .btn-info{background:var(--info);border-color:var(--info);color:#fff}
  .btn-warn{background:var(--warn);border-color:var(--warn);color:#fff}
  .btn-danger{background:var(--danger);border-color:var(--danger);color:#fff}
  input,select,textarea{width:100%;padding:8px 9px;border:1px solid var(--line);border-radius:8px;background:#fff;font-size:14px}
  input[readonly]{background:#fafafa;color:#6b7280}
  .toast{position:fixed;bottom:16px;right:16px;background:#111827;color:#fff;padding:8px 12px;border-radius:10px;display:none;font-size:13px}
</style>

</head>
<body>

<div class="topbar">
  <div class="topbar-inner">
    <div class="brand">
      <div class="logo">MZJ</div>
      <div>
        <h1>لوحة تشغيل MZJ</h1>
        <small class="hint">مجموعة محمد بن ذعار العجمي للسيارات</small>
      </div>
    </div>
    <div class="tabs">
      <a class="tab " href="admin.html">الإدارة</a>
      <a class="tab " href="inventory.html">المخزون</a>
      <a class="tab " href="dashboard.html">الداش بورد</a>
      <a class="tab " href="photoshoot.html">طلبات التصوير</a>
    </div>
    <div class="row">
      <div class="status-badge"><span id="connDot" class="dot"></span><span id="connText">جارِ الاتصال…</span></div>
      <button id="btnSignOut" class="btn" style="display:none"><i class="fa-solid fa-right-from-bracket"></i> خروج</button>
    </div>
  </div>
</div>


<div id="authGate" style="min-height:60vh;display:none;place-items:center;padding:20px">
  <div class="card" style="max-width:420px;width:96%">
    <h2 class="title" style="margin-bottom:8px"><i class="fa-solid fa-right-to-bracket"></i> تسجيل الدخول</h2>
    <label>البريد الإلكتروني</label>
    <input id="email" type="email" placeholder="you@example.com"/>
    <label style="margin-top:8px">كلمة المرور</label>
    <input id="password" type="password" placeholder="••••••••"/>
    <div class="row" style="margin-top:8px">
      <button class="btn btn-primary" id="btnLogin">تسجيل الدخول</button>
      <button class="btn" id="btnSignup">إنشاء حساب</button>
    </div>
    <p class="hint" id="authHint" style="margin-top:8px"></p>
  </div>
</div>

<div id="app">
  <div class="container">
    <div class="card">
      <header><h3 class="title"><i class="fa-solid fa-house"></i> البداية</h3></header>
      <p>مرحبًا! استخدم التبويب بالأعلى للانتقال للصفحة المطلوبة. سيتم تحويلك تلقائيًا إلى <b>الإدارة</b>.</p>
      <div class="row"><a class="btn btn-primary" href="admin.html"><i class="fa-solid fa-gear"></i> الذهاب للإدارة</a></div>
    </div>
  </div>
</div>
<div id="toast" class="toast"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
  import { getAuth, setPersistence, browserLocalPersistence, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC614bGqnYf4Q-weTNemzWENTpa8DjGeHw",
    authDomain: "mzj-agenda.firebaseapp.com",
    projectId: "mzj-agenda",
    storageBucket: "mzj-agenda.firebasestorage.app",
    messagingSenderId: "834700407721",
    appId: "1:834700407721:web:75c17665d4f032fd65cab8"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  await setPersistence(auth, browserLocalPersistence);
  const db   = getFirestore(app);
  const STATE_REF = doc(db, "mzj_admin_state", "v1");

  const $ = s => document.querySelector(s);
  const pad = n => n<10?'0'+n:n;
  const now = ()=>{const d=new Date();return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`};
  const toast = $('#toast'); const showToast = (msg)=>{ if(!toast) return; toast.textContent=msg; toast.style.display='block'; setTimeout(()=>toast.style.display='none',1200); };
  function setStatus(mode,txt){ const dot=$('#connDot'),txtEl=$('#connText'); if(dot) dot.className='dot '+(mode==='ok'?'ok':mode==='err'?'err':''); if(txtEl) txtEl.textContent=txt; }

  function reveal(authenticated){
    const gate=$('#authGate'); const appRoot=$('#app'); const outBtn=$('#btnSignOut');
    if(authenticated){ if(gate) gate.style.display='none'; if(appRoot) appRoot.style.display='block'; if(outBtn) outBtn.style.display='inline-block'; }
    else{ if(appRoot) appRoot.style.display='none'; if(gate) gate.style.display='grid'; if(outBtn) outBtn.style.display='none'; }
  }

  onAuthStateChanged(auth, async (user)=>{
    if(user){
      setStatus('ok', `متصل: ${user.email}`);
      reveal(true);
      if (typeof window.__pageInit === 'function'){ try{ await window.__pageInit({auth,db,STATE_REF,now,showToast,setStatus}); }catch(e){ console.error(e); } }
    }else{
      setStatus('', 'لم يتم تسجيل الدخول');
      reveal(false);
    }
  });

  const loginBtn=$('#btnLogin'), signupBtn=$('#btnSignup'), emailEl=$('#email'), passEl=$('#password');
  if(loginBtn) loginBtn.addEventListener('click', async ()=>{
    const hint=$('#authHint'); if(hint) hint.textContent=''; try{ await signInWithEmailAndPassword(auth, (emailEl?.value||'').trim(), passEl?.value||''); } catch(e){ if(hint) hint.textContent='خطأ: '+(e?.message||e); }
  });
  if(signupBtn) signupBtn.addEventListener('click', async ()=>{
    const hint=$('#authHint'); if(hint) hint.textContent=''; try{ await createUserWithEmailAndPassword(auth, (emailEl?.value||'').trim(), passEl?.value||''); } catch(e){ if(hint) hint.textContent='خطأ: '+(e?.message||e); }
  });
  const outBtn=$('#btnSignOut'); if(outBtn) outBtn.addEventListener('click', ()=> signOut(auth));

  window.__mzjCtx = { auth, db, STATE_REF, now, showToast, setStatus };
</script>

<script> window.__pageInit = async ()=>{ setTimeout(()=> location.href='admin.html', 400); }; </script>
</body>
</html>
