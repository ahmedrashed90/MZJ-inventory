<!DOCTYPE html>
<html lang="ar" dir="rtl" data-theme="light">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>المخزون — MZJ Cars</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>

<style>
  :root{
    --brown:#3e2420; --beige:#bc8f74; --cream:#fff8ef;
    --text:#1f2937; --muted:#6b7280; --line:#e8e5e2;
    --card:#ffffff; --bg:#faf7f3; --radius:12px;
    --shadow:0 10px 24px rgba(0,0,0,.06);
    --ok:#16a34a; --danger:#ef4444; --info:#0ea5e9;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font-family:"Tajawal",system-ui,Arial}

  /* Topbar + Tabs */
  .topbar{position:sticky;top:0;z-index:60;background:#fff;border-bottom:1px solid var(--line)}
  .topbar-inner{max-width:1280px;margin:auto;display:flex;align-items:center;justify-content:space-between;padding:12px 18px}
  .brand{display:flex;align-items:center;gap:10px}
  .brand h1{margin:0;font-size:18px;color:var(--brown);font-weight:800}
  .brand small{color:var(--muted)}
  .tabs{display:flex;gap:8px;flex-wrap:wrap}
  .tab{padding:8px 12px;border:1px solid var(--line);border-radius:999px;background:#fff;text-decoration:none;color:inherit;font-weight:800;font-size:13px}
  .tab.active{background:var(--brown);border-color:var(--brown);color:#fff}
  .status-badge{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--line);background:#fff;border-radius:12px;padding:6px 10px;font-size:12px}
  .dot{width:10px;height:10px;border-radius:999px;background:#f59e0b}
  .dot.ok{background:var(--ok)} .dot.err{background:var(--danger)} .dot.warn{background:#f59e0b}

  /* Buttons */
  .btn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:8px 12px;cursor:pointer;font-weight:700;display:inline-flex;gap:8px;align-items:center;transition:.15s;font-size:13px}
  .btn:active{transform:translateY(1px)}
  .btn-primary{background:var(--beige);border-color:var(--beige);color:#fff}
  .btn-ghost{background:#fff}
  .btn-outline{background:#fff;border-color:var(--brown);color:var(--brown)}

  .container{max-width:1280px;margin:18px auto;padding:0 16px;display:grid;grid-template-columns:1fr;gap:16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px}

  .summary{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
  @media (max-width:640px){.summary{grid-template-columns:1fr}}
  .stat{display:flex;align-items:center;gap:12px;padding:10px;border:1px solid var(--line);border-radius:10px;background:#fff}
  .stat i{color:var(--beige)}
  .stat-title{font-size:12px;color:var(--muted)}
  .stat-num{font-size:22px;font-weight:800;color:var(--brown)}

  .card h3{margin:0 0 10px;color:var(--brown);font-size:16px;display:flex;align-items:center;gap:8px}
  .hint-text{font-size:12px;color:var(--muted);margin:0 0 8px}

  /* Generic grid helpers مثل صفحة الإدارة */
  .card-header{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px}
  .section-title{display:flex;align-items:center;gap:8px;color:var(--brown)}
  .section-title svg{width:18px;height:18px}
  .hint{font-size:12px;color:var(--muted)}
  .row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .grid{display:grid;gap:8px}
  .grid-3{grid-template-columns:repeat(3,minmax(0,1fr))}
  .grid-4{grid-template-columns:repeat(4,minmax(0,1fr))}
  @media(max-width:900px){.grid-4{grid-template-columns:repeat(2,minmax(0,1fr))}}
  @media(max-width:600px){.grid-3{grid-template-columns:repeat(1,minmax(0,1fr))}}

  /* Filters */
  .filter-grid{display:grid;grid-template-columns:2fr 1fr 1fr 1fr;gap:10px}
  @media(max-width:1100px){.filter-grid{grid-template-columns:1fr 1fr 1fr}}
  @media(max-width:800px){.filter-grid{grid-template-columns:1fr 1fr}}
  @media(max-width:560px){.filter-grid{grid-template-columns:1fr}}
  .input,.select,textarea{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;font-family:inherit;font-size:13px}
  textarea{min-height:80px;resize:vertical}
  .search{position:relative}
  .search i{position:absolute;right:10px;top:50%;transform:translateY(-50%);color:var(--muted)}
  .search input{padding-right:34px}
  .under-field{margin-top:8px;display:flex;justify-content:flex-start}

  /* Table */
  .table{width:100%;border-collapse:separate;border-spacing:0}
  .table th,.table td{border:1px solid var(--line);padding:8px 10px;text-align:right;vertical-align:top;font-size:13px}
  .table thead th{position:sticky;top:0;background:#fff;border-bottom:2px solid var(--line);z-index:1}
  .table tbody tr:nth-child(odd){background:#fff}
  .table tbody tr:nth-child(even){background:#fffdfb}
  .tag{display:inline-block;background:#f6f6f6;border:1px solid var(--line);padding:2px 8px;border-radius:999px;font-size:12px;color:#444}
  .vin{cursor:pointer;color:var(--beige);white-space:nowrap}
  .vin:hover{text-decoration:underline}
  .short{background:#fff4f4}
  .badge{display:inline-block;background:#fff2e9;border:1px solid #f1d0bd;color:var(--brown);padding:2px 8px;border-radius:999px;font-size:12px}
  .muted-text{color:var(--muted);font-size:12px}
  .nowrap{white-space:nowrap}

  .toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:#111827;color:#fff;padding:10px 14px;border-radius:10px;display:none;font-size:13px;z-index:300}
  .toast.show{display:block;animation:fade .2s ease-out}
  @keyframes fade{from{opacity:0;transform:translate(-50%,6px)} to{opacity:1;transform:translate(-50%,0)}}

  /* Auth */
  .auth-wrap{min-height:60vh;display:grid;place-items:center;padding:24px}
  .auth-card{background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);padding:18px;max-width:420px;width:96%}
  .auth-card h2{margin:0 0 10px;color:var(--brown)}
  .auth-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .hint{color:var(--muted);font-size:12px}

  /* حركة نقل السيارات (نفس فكرة صفحة الإدارة) */
  .move-row{border:1px dashed var(--line);border-radius:10px;padding:8px 10px;background:#fff}
  .move-row-title{font-size:12px;font-weight:700;color:var(--brown);margin-bottom:4px}
  .checklist{border:1px solid var(--line);border-radius:10px;background:#fff8ef;padding:10px}
  .checklist h4{margin:0 0 8px;color:var(--brown);font-size:14px}
  .check-row{display:flex;align-items:center;gap:6px;font-size:13px;margin-bottom:4px}
  .move-alert{display:none;align-items:flex-start;gap:10px;border-radius:12px;padding:10px;margin-top:10px}
  .move-alert .icon{font-size:18px;margin-top:2px}
  .move-alert.success{background:#ecfdf3;border:1px solid #bbf7d0;color:#166534}
  .move-alert.info{background:#eff6ff;border:1px solid #bfdbfe;color:#1d4ed8}
  .move-alert.error{background:#fef2f2;border:1px solid #fecaca;color:#b91c1c}
  .move-alert ul{margin:4px 0 0;padding-right:18px;font-size:12px}
  .move-alert li+li{margin-top:2px}

  /* بطاقة عرض بيانات السيارة */
  #carDetailsBox{border-color:var(--line);background:#fff}
  #carDetails{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:6px;font-size:13px}
  #carDetails b{color:var(--brown)}
  #carDetailsHint{font-size:12px;color:var(--muted);margin-top:6px}

  /* مودال ملاحظات احترافي */
  .notes-modal-backdrop{
    position:fixed;inset:0;background:rgba(15,23,42,.45);
    display:none;align-items:center;justify-content:center;z-index:350;
  }
  .notes-modal{
    background:#fff;border-radius:16px;box-shadow:0 20px 45px rgba(0,0,0,.18);
    max-width:420px;width:94%;padding:16px;border:1px solid var(--line);
  }
  .notes-modal h3{margin:0 0 8px;color:var(--brown);font-size:16px}
  .notes-modal p{margin:0 0 10px;font-size:12px;color:var(--muted)}
  .notes-modal textarea{min-height:110px}
  .notes-modal-footer{display:flex;justify-content:flex-end;gap:8px;margin-top:10px}

  .cell-notes{cursor:pointer}
  .cell-notes:hover{background:#fff3e8}

</style>
</head>
<body>

<!-- Topbar + Tabs -->
<div class="topbar">
  <div class="topbar-inner">
    <div class="brand">
      <i class="fa-solid fa-star" style="color:var(--beige)"></i>
      <div>
        <h1>إدارة المخزون</h1>
        <small>مجموعة محمد بن ذعار العجمي للسيارات</small>
      </div>
    </div>
    <div class="tabs">
      <a class="tab" href="admin.html">الإدارة</a>
      <a class="tab active" href="inventory.html">المخزون</a>
      <a class="tab" href="dashboard.html">الداش بورد</a>
      <a class="tab" href="photoshoot.html">الطلبات</a>
      <a class="tab" href="photoshoot-user.html">إدارة الطلبات</a>
      <a class="tab" href="cars.html">كل السيارات</a>
      <a class="tab" href="Activity.html">سجل النشاط</a>
    </div>
    <div class="tabs" style="gap:10px">
      <div class="status-badge" id="connBadge">
        <span class="dot warn" id="connDot"></span>
        <span id="connText">جارِ الاتصال…</span>
      </div>
      <button class="btn btn-ghost" id="btnSignOut" style="display:none"><i class="fa-solid fa-right-from-bracket"></i> تسجيل الخروج</button>
    </div>
  </div>
</div>

<!-- Auth Gate -->
<div id="authGate" class="auth-wrap">
  <div class="auth-card">
    <h2>تسجيل الدخول</h2>
    <label for="email">البريد الإلكتروني</label>
    <input id="email" type="email" class="input" placeholder="you@example.com"/>
    <label for="password" style="margin-top:8px">كلمة المرور</label>
    <input id="password" type="password" class="input" placeholder="••••••••"/>
    <div class="auth-actions">
      <button class="btn btn-primary" id="btnLogin">تسجيل الدخول</button>
      <button class="btn btn-outline" id="btnSignup">إنشاء حساب</button>
    </div>
    <p class="hint" id="authHint" style="margin-top:10px"></p>
  </div>
</div>

<!-- App -->
<div id="app" style="display:none">
  <div class="container">

    <!-- Summary -->
    <div class="card">
      <div class="summary">
        <div class="stat">
          <i class="fa-solid fa-car"></i>
          <div>
            <div class="stat-title">إجمالي السيارات (بعد الفلاتر)</div>
            <div class="stat-num" id="totalCount">0</div>
          </div>
        </div>
        <div class="stat">
          <i class="fa-solid fa-location-dot"></i>
          <div>
            <div class="stat-title">عدد الأماكن (بعد الفلاتر)</div>
            <div class="stat-num" id="placesCount">0</div>
          </div>
        </div>
      </div>
    </div>

    <!-- حركة نقل السيارات (نفس منطق صفحة الإدارة) -->
    <div class="card">
      <div class="card-header">
        <div class="section-title">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M7 10l5-5 5 5"/><path d="M7 14l5 5 5-5"/></svg>
          <h2 style="margin:0;font-size:16px">حركة نقل السيارات (برقم الهيكل)</h2>
        </div>
        <span class="hint">يمكن نقل حتى ٨ سيارات في عملية واحدة — يتم تحديد <b>من</b> تلقائيًا بمجرد كتابة رقم الهيكل.</span>
      </div>

      <!-- 8 صفوف نقل -->
      <div class="grid" style="gap:10px">
        <!-- row 1 -->
        <div class="move-row">
          <div class="move-row-title">السيارة 1</div>
          <div class="grid grid-3">
            <div>
              <label>رقم الهيكل</label>
              <input class="move-vin input" list="vinHints" placeholder="اكتب رقم الهيكل"/>
            </div>
            <div>
              <label>من (محدّد تلقائيًا)</label>
              <select class="move-from select" title="المكان الحالي"></select>
            </div>
            <div>
              <label>إلى</label>
              <select class="move-to select" title="المكان الجديد"></select>
            </div>
          </div>
        </div>
        <!-- row 2 -->
        <div class="move-row">
          <div class="move-row-title">السيارة 2</div>
          <div class="grid grid-3">
            <div>
              <label>رقم الهيكل</label>
              <input class="move-vin input" list="vinHints" placeholder="اكتب رقم الهيكل"/>
            </div>
            <div>
              <label>من (محدّد تلقائيًا)</label>
              <select class="move-from select" title="المكان الحالي"></select>
            </div>
            <div>
              <label>إلى</label>
              <select class="move-to select" title="المكان الجديد"></select>
            </div>
          </div>
        </div>
        <!-- row 3 -->
        <div class="move-row">
          <div class="move-row-title">السيارة 3</div>
          <div class="grid grid-3">
            <div>
              <label>رقم الهيكل</label>
              <input class="move-vin input" list="vinHints" placeholder="اكتب رقم الهيكل"/>
            </div>
            <div>
              <label>من (محدّد تلقائيًا)</label>
              <select class="move-from select" title="المكان الحالي"></select>
            </div>
            <div>
              <label>إلى</label>
              <select class="move-to select" title="المكان الجديد"></select>
            </div>
          </div>
        </div>
        <!-- row 4 -->
        <div class="move-row">
          <div class="move-row-title">السيارة 4</div>
          <div class="grid grid-3">
            <div>
              <label>رقم الهيكل</label>
              <input class="move-vin input" list="vinHints" placeholder="اكتب رقم الهيكل"/>
            </div>
            <div>
              <label>من (محدّد تلقائيًا)</label>
              <select class="move-from select" title="المكان الحالي"></select>
            </div>
            <div>
              <label>إلى</label>
              <select class="move-to select" title="المكان الجديد"></select>
            </div>
          </div>
        </div>
        <!-- row 5 -->
        <div class="move-row">
          <div class="move-row-title">السيارة 5</div>
          <div class="grid grid-3">
            <div>
              <label>رقم الهيكل</label>
              <input class="move-vin input" list="vinHints" placeholder="اكتب رقم الهيكل"/>
            </div>
            <div>
              <label>من (محدّد تلقائيًا)</label>
              <select class="move-from select" title="المكان الحالي"></select>
            </div>
            <div>
              <label>إلى</label>
              <select class="move-to select" title="المكان الجديد"></select>
            </div>
          </div>
        </div>
        <!-- row 6 -->
        <div class="move-row">
          <div class="move-row-title">السيارة 6</div>
          <div class="grid grid-3">
            <div>
              <label>رقم الهيكل</label>
              <input class="move-vin input" list="vinHints" placeholder="اكتب رقم الهيكل"/>
            </div>
            <div>
              <label>من (محدّد تلقائيًا)</label>
              <select class="move-from select" title="المكان الحالي"></select>
            </div>
            <div>
              <label>إلى</label>
              <select class="move-to select" title="المكان الجديد"></select>
            </div>
          </div>
        </div>
        <!-- row 7 -->
        <div class="move-row">
          <div class="move-row-title">السيارة 7</div>
          <div class="grid grid-3">
            <div>
              <label>رقم الهيكل</label>
              <input class="move-vin input" list="vinHints" placeholder="اكتب رقم الهيكل"/>
            </div>
            <div>
              <label>من (محدّد تلقائيًا)</label>
              <select class="move-from select" title="المكان الحالي"></select>
            </div>
            <div>
              <label>إلى</label>
              <select class="move-to select" title="المكان الجديد"></select>
            </div>
          </div>
        </div>
        <!-- row 8 -->
        <div class="move-row">
          <div class="move-row-title">السيارة 8</div>
          <div class="grid grid-3">
            <div>
              <label>رقم الهيكل</label>
              <input class="move-vin input" list="vinHints" placeholder="اكتب رقم الهيكل"/>
            </div>
            <div>
              <label>من (محدّد تلقائيًا)</label>
              <select class="move-from select" title="المكان الحالي"></select>
            </div>
            <div>
              <label>إلى</label>
              <select class="move-to select" title="المكان الجديد"></select>
            </div>
          </div>
        </div>
      </div>

      <!-- datalist للاقتراحات -->
      <datalist id="vinHints"></datalist>

      <!-- Checklist عند مباع تحت التسليم -->
      <div id="underDeliveryBox" class="checklist" style="display:none;margin-top:10px">
        <h4>المتطلبات عند النقل إلى <b>مباع تحت التسليم</b></h4>
        <div class="grid grid-3">
          <div>
            <div class="check-row">
              <input type="checkbox" id="chkAdminApproved"/>
              <label for="chkAdminApproved">موافقة إدارية</label>
            </div>
            <label for="adminNotes" style="margin-top:6px">ملاحظات الموافقة الإدارية</label>
            <textarea id="adminNotes" placeholder="اكتب أي ملاحظات إدارية…"></textarea>
          </div>
          <div>
            <div class="check-row">
              <input type="checkbox" id="chkFinanceApproved"/>
              <label for="chkFinanceApproved">موافقة مالية</label>
            </div>
            <label for="financeNotes" style="margin-top:6px">ملاحظات الموافقة المالية</label>
            <textarea id="financeNotes" placeholder="اكتب أي ملاحظات مالية…"></textarea>
          </div>
        </div>
      </div>

      <!-- ملاحظات سيارات بها ملاحظات -->
      <div id="notesIssuesBox" class="checklist" style="display:none;margin-top:10px">
        <h4>ملاحظات عند النقل إلى <b>سيارات بها ملاحظات</b></h4>
        <label for="issuesNotes">ملاحظات السيارات ذات الملاحظات</label>
        <textarea id="issuesNotes" placeholder="مثال: خدوش بسيطة / انتظار قطع / …"></textarea>
      </div>

      <div class="row" style="margin-top:12px">
        <button class="btn btn-ghost" id="btnFindByVin" title="عرض بيانات السيارة (أول سطر غير فارغ)">
          <i class="fa-solid fa-magnifying-glass"></i> عرض البيانات
        </button>
        <button class="btn btn-primary" id="btnMove" title="تنفيذ النقل">
          <i class="fa-solid fa-right-left"></i> نقل
        </button>
      </div>
      <p class="hint" id="moveStatus" style="margin-top:8px"></p>

      <!-- إشعار حركة النقل الكبير -->
      <div id="moveAlert" class="move-alert">
        <div class="icon">
          <i class="fa-solid fa-circle-check"></i>
        </div>
        <div>
          <div class="title" id="moveAlertTitle" style="font-weight:700;font-size:13px">نتيجة حركة النقل</div>
          <ul id="moveAlertList"></ul>
        </div>
      </div>

      <!-- بطاقة عرض بيانات السيارة -->
      <div id="carDetailsBox" class="card" style="display:none;margin-top:12px">
        <div class="section-title">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3" y="4" width="18" height="16" rx="2"/><path d="M7 8h10"/></svg>
          <h2 style="margin:0;font-size:15px">عرض بيانات السيارة</h2>
        </div>
        <div id="carDetails" style="margin-top:8px"></div>
        <div id="carDetailsHint"></div>
      </div>
    </div>

    <!-- Filters -->
    <div class="card">
      <h3><i class="fa-solid fa-filter" style="color:var(--beige)"></i> الفلاتر</h3>
      <div class="filter-grid">
        <div class="search">
          <input id="search" class="input" placeholder="بحث في: سيارة/بيان/وكيل/ألوان/موديل/لوحة/مكان/رقم الهيكل">
          <i class="fa-solid fa-magnifying-glass"></i>
        </div>
        <select id="modelFilter" class="select"><option value="">كل السيارات</option></select>
        <input id="yearFilter" class="input" type="number" min="2000" max="2100" placeholder="الموديل (سنة)">
        <input id="dealerFilter" class="input" placeholder="الوكيل">
        <div>
          <select id="locationFilter" class="select"><option value="">كل الأماكن</option></select>
          <div class="under-field">
            <button id="exportAll" class="btn btn-primary"><i class="fa-regular fa-file-excel"></i> تصدير Excel (حسب الفلاتر)</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Table -->
    <div class="card table-wrap">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <h3><i class="fa-solid fa-table" style="color:var(--beige)"></i> جدول السيارات</h3>
        <div class="tools">
          <span class="badge" id="visibleCount">0 صف</span>
        </div>
      </div>
      <div style="overflow:auto;border:1px solid var(--line);border-radius:10px">
        <table class="table" id="carsTable">
          <thead>
            <tr>
              <th>م</th>
              <th>السيارة</th>
              <th>البيان</th>
              <th>الوكيل</th>
              <th>اللون الخارجي</th>
              <th>اللون الداخلي</th>
              <th>الموديل</th>
              <th>اللوحة</th>
              <th>المكان</th>
              <th>رقم الهيكل</th>
              <th>الملاحظات (اضغط للتعديل)</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

  </div>
</div>

<!-- Toast -->
<div id="toast" class="toast">تم</div>

<!-- مودال الملاحظات -->
<div id="notesModal" class="notes-modal-backdrop">
  <div class="notes-modal">
    <h3>تعديل الملاحظات</h3>
    <p>اكتب ملاحظات السيارة، ثم اضغط حفظ. تُحفظ مباشرة في قاعدة البيانات.</p>
    <textarea id="notesModalInput" class="input" placeholder="مثال: خدش بسيط في الرفرف الأمامي…"></textarea>
    <div class="notes-modal-footer">
      <button class="btn btn-ghost" id="notesModalCancel">إلغاء</button>
      <button class="btn btn-primary" id="notesModalSave"><i class="fa-regular fa-floppy-disk"></i> حفظ</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<!-- Firebase (Modules) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC614bGqnYf4Q-weTNemzWENTpa8DjGeHw",
    authDomain: "mzj-agenda.firebaseapp.com",
    projectId: "mzj-agenda",
    storageBucket: "mzj-agenda.firebasestorage.app",
    messagingSenderId: "834700407721",
    appId: "1:834700407721:web:75c17665d4f032fd65cab8"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);
  const STATE_REF = doc(db, "mzj_admin_state", "v1");

  /* Helpers / DOM */
  const $ = s => document.querySelector(s);
  const connDot  = $('#connDot');
  const connText = $('#connText');
  const authGate = $('#authGate');
  const appRoot  = $('#app');
  const btnLogin = $('#btnLogin');
  const btnSignup= $('#btnSignup');
  const btnSignOut = $('#btnSignOut');
  const emailEl  = $('#email');
  const passEl   = $('#password');
  const authHint = $('#authHint');
  const toast    = $('#toast');

  const searchEl       = $('#search');
  const modelFilter    = $('#modelFilter');
  const yearFilter     = $('#yearFilter');
  const dealerFilter   = $('#dealerFilter');
  const locationFilter = $('#locationFilter');

  const tb = $('#carsTable tbody');

  const notesModal       = $('#notesModal');
  const notesModalInput  = $('#notesModalInput');
  const notesModalCancel = $('#notesModalCancel');
  const notesModalSave   = $('#notesModalSave');

  /* حركة النقل DOM */
  const moveVinInputs   = Array.from(document.querySelectorAll('.move-vin'));
  const moveFromSelects = Array.from(document.querySelectorAll('.move-from'));
  const moveToSelects   = Array.from(document.querySelectorAll('.move-to'));
  const btnFindByVin    = $('#btnFindByVin');
  const btnMove         = $('#btnMove');
  const moveStatus      = $('#moveStatus');
  const carDetailsBox   = $('#carDetailsBox');
  const carDetails      = $('#carDetails');
  const carDetailsHint  = $('#carDetailsHint');
  const underDeliveryBox= $('#underDeliveryBox');
  const chkAdminApproved   = $('#chkAdminApproved');
  const adminNotes         = $('#adminNotes');
  const chkFinanceApproved = $('#chkFinanceApproved');
  const financeNotes       = $('#financeNotes');
  const notesIssuesBox     = $('#notesIssuesBox');
  const issuesNotes        = $('#issuesNotes');
  const vinHints           = $('#vinHints');
  const moveAlert          = $('#moveAlert');
  const moveAlertTitle     = $('#moveAlertTitle');
  const moveAlertList      = $('#moveAlertList');

  /* State */
  let stock=[], moves=[], models=[], variantsMap={};
  let editingVin = null;

  const uniq = arr => [...new Set(arr)];
  const pad  = n => n<10?'0'+n:n;
  const now  = ()=>{const d=new Date();return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;};
  const onlyDate = str => (str||'').toString().slice(0,10);

  function normalizeVin(v){
    if(!v) return '';
    const ar = {'٠':'0','١':'1','٢':'2','٣':'3','٤':'4','٥':'5','٦':'6','٧':'7','٨':'8','٩':'9'};
    return v.toString().trim().split('').map(ch=> ar[ch] ?? ch).join('').toUpperCase();
  }
  function debounce(fn,wait=250){
    let t; return (...args)=>{clearTimeout(t);t=setTimeout(()=>fn(...args),wait)};
  }

  function setStatus(mode, txt){
    connDot.className='dot '+(mode==='ok'?'ok':mode==='err'?'err':'warn');
    connText.textContent = txt;
  }
  function showToastMsg(text){
    toast.textContent = text;
    toast.classList.add('show');
    setTimeout(()=> toast.classList.remove('show'), 1500);
  }

  /* Auth gate */
  onAuthStateChanged(auth, async (user)=>{
    if(user){
      authGate.style.display='none';
      appRoot.style.display='block';
      btnSignOut.style.display='inline-flex';
      setStatus('ok', `متصل كمستخدم: ${user.email}`);
      await initData();
      subscribeLive();
    }else{
      appRoot.style.display='none';
      authGate.style.display='grid';
      btnSignOut.style.display='none';
      setStatus('warn','لم يتم تسجيل الدخول');
    }
  });
  btnLogin.addEventListener('click', async ()=>{
    authHint.textContent='';
    try{ await signInWithEmailAndPassword(auth, emailEl.value.trim(), passEl.value); }
    catch(e){ authHint.textContent='فشل تسجيل الدخول: '+(e?.message||e); }
  });
  btnSignup.addEventListener('click', async ()=>{
    authHint.textContent='';
    try{ await createUserWithEmailAndPassword(auth, emailEl.value.trim(), passEl.value); }
    catch(e){ authHint.textContent='تعذّر إنشاء الحساب: '+(e?.message||e); }
  });
  btnSignOut.addEventListener('click', ()=> signOut(auth));

  /* Data init / subscribe */
  async function initData(){
    try{
      const s=await getDoc(STATE_REF);
      if(s.exists()){
        const d=s.data()||{};
        stock = Array.isArray(d.stock)? d.stock: [];
        moves = Array.isArray(d.moves)? d.moves: [];
        models = Array.isArray(d.models)? d.models: [];
        variantsMap = d.variantsMap || {};
      }else{
        stock=[]; moves=[]; models=[]; variantsMap={};
      }
      initFilters();
      fillMoveLists();
      renderAll();
      setStatus('ok','تم تحميل البيانات');
    }catch(e){
      console.error(e);
      setStatus('warn','تعذّر الاتصال — عرض آخر نسخة محفوظة غير متاحة');
    }
  }
  function subscribeLive(){
    try{
      onSnapshot(STATE_REF,(snap)=>{
        if(!snap.exists()) return;
        const d=snap.data()||{};
        stock = Array.isArray(d.stock)? d.stock: stock;
        moves = Array.isArray(d.moves)? d.moves: moves;
        models= Array.isArray(d.models)? d.models: models;
        variantsMap = d.variantsMap || variantsMap;
        initFilters();
        fillMoveLists();
        renderAll();
        setStatus('ok','متصل — مزامنة حيّة');
      },(err)=>{
        console.warn('snapshot error', err);
        setStatus('warn','تعذّر الاتصال — مزامنة متوقفة مؤقتًا');
      });
    }catch(e){}
  }

  /* Filters */
  const filters = { q:'', model:'', year:'', dealer:'', location:'' };

  function initFilters(){
    const modelsList = uniq(stock.map(r=> r.car).filter(Boolean)).sort((a,b)=> a.localeCompare(b,'ar'));
    modelFilter.innerHTML = '<option value="">كل السيارات</option>' + modelsList.map(m=> `<option value="${m}">${m}</option>`).join('');
    const locs = uniq(stock.map(r=> r.location || 'غير محدد')).sort((a,b)=> a.localeCompare(b,'ar'));
    locationFilter.innerHTML = '<option value="">كل الأماكن</option>' + locs.map(l=> `<option value="${l==='غير محدد'?'':l}">${l}</option>`).join('');
  }

  function applyFilters(rows){
    return rows.filter(r=>{
      if (filters.q){
        const hay = [r.car,r.variant,r.dealer,r.extColor,r.intColor,r.modelYear,r.plate,r.location,r.vin,r.notes].join(' ').toLowerCase();
        if (!hay.includes(filters.q.toLowerCase())) return false;
      }
      if (filters.model && r.car !== filters.model) return false;
      if (filters.year && String(r.modelYear) !== String(filters.year)) return false;
      if (filters.dealer && (!r.dealer || !r.dealer.toLowerCase().includes(filters.dealer.toLowerCase()))) return false;
      if (filters.location && (r.location||'') !== filters.location) return false;
      return true;
    });
  }

  function renderSummary(filteredRows){
    $('#totalCount').textContent   = filteredRows.length.toLocaleString('ar-SA');
    const locsFiltered = new Set(filteredRows.map(r=> r.location || 'غير محدد')).size;
    $('#placesCount').textContent  = locsFiltered.toLocaleString('ar-SA');
  }

  function renderTable(filteredRows){
    tb.innerHTML = '';
    const colorKey = r => `${r.car||''}⇢${r.variant||''}⇢${r.extColor||''}/${r.intColor||''}⇢${r.location||'غير محدد'}`;
    const colorCount = {};
    stock.forEach(r=>{
      const k=colorKey(r);
      colorCount[k]=(colorCount[k]||0)+1;
    });

    filteredRows.slice().sort((a,b)=> (a.id||0)-(b.id||0)).forEach(r=>{
      const k=colorKey(r);
      const isColorShort = (colorCount[k]||0) < 2;
      const tr = document.createElement('tr');
      if(isColorShort) tr.classList.add('short');
      const safeNotes = (r.notes && String(r.notes).trim().length>0)
        ? String(r.notes)
        : '<span class="muted-text">لا توجد ملاحظات</span>';
      tr.innerHTML = `
        <td>${r.id||''}</td>
        <td>${r.car||''}</td>
        <td>${r.variant||''}</td>
        <td><span class="tag">${r.dealer||'-'}</span></td>
        <td>${r.extColor||''}</td>
        <td>${r.intColor||''}</td>
        <td>${r.modelYear||''}</td>
        <td>${r.plate||''}</td>
        <td>${r.location||''}</td>
        <td class="vin" data-vin="${r.vin||''}">${r.vin||''}</td>
        <td class="cell-notes" data-vin="${r.vin||''}">${safeNotes}</td>
      `;
      tb.appendChild(tr);
    });
    $('#visibleCount').textContent = `${filteredRows.length} صف`;
  }

  function renderAll(){
    const filtered = applyFilters(stock);
    renderSummary(filtered);
    renderTable(filtered);
  }

  /* Filter events */
  searchEl.addEventListener('input', e=>{ filters.q=e.target.value.trim(); renderAll(); });
  modelFilter.addEventListener('change', e=>{ filters.model=e.target.value; renderAll(); });
  yearFilter.addEventListener('input', e=>{ filters.year=e.target.value.trim(); renderAll(); });
  dealerFilter.addEventListener('input', e=>{ filters.dealer=e.target.value.trim(); renderAll(); });
  locationFilter.addEventListener('change', e=>{ filters.location=e.target.value; renderAll(); });

  /* VIN copy */
  document.addEventListener('click', (e)=>{
    const vinEl = e.target.closest('.vin');
    if (vinEl){
      const vin = vinEl.getAttribute('data-vin');
      if(vin){
        navigator.clipboard.writeText(vin)
          .then(()=> showToastMsg('تم نسخ رقم الهيكل'));
    }
    }
  });

  /* Export Excel */
  function exportExcel(rows){
    const header = ["م","سيارة","البيان","الوكيل","اللون الخارجي","اللون الداخلي","موديل","اللوحة","المكان","رقم الهيكل","الملاحظات"];
    const data = [header];
    rows.forEach(r=>{
      data.push([r.id,r.car,r.variant,r.dealer,r.extColor,r.intColor,r.modelYear,r.plate,r.location,r.vin,r.notes||'']);
    });
    const ws = XLSX.utils.aoa_to_sheet(data);
    ws['!cols'] = [{wch:5},{wch:24},{wch:30},{wch:18},{wch:16},{wch:16},{wch:10},{wch:10},{wch:18},{wch:22},{wch:26}];
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Inventory");
    XLSX.writeFile(wb, "mzj-inventory.xlsx");
  }
  $('#exportAll').addEventListener('click', ()=>{
    const rows = applyFilters(stock).slice().sort((a,b)=> (a.id||0)-(b.id||0));
    exportExcel(rows);
  });

  /* مودال ملاحظات بدلاً من prompt */
  document.addEventListener('click', (e)=>{
    const cell = e.target.closest('.cell-notes');
    if(!cell) return;
    const vin = cell.getAttribute('data-vin') || '';
    if(!vin) return;
    const idx = stock.findIndex(r=> (r.vin||'').toString() === vin.toString());
    if(idx === -1) return;
    editingVin = vin;
    const current = stock[idx].notes ? String(stock[idx].notes) : '';
    notesModalInput.value = current;
    notesModal.style.display='flex';
  });

  function closeNotesModal(){
    notesModal.style.display='none';
    editingVin = null;
  }
  notesModalCancel.addEventListener('click', closeNotesModal);
  notesModal.addEventListener('click', e=>{
    if(e.target === notesModal) closeNotesModal();
  });
  notesModalSave.addEventListener('click', async ()=>{
    if(!editingVin){ closeNotesModal(); return; }
    const idx = stock.findIndex(r=> (r.vin||'').toString() === editingVin.toString());
    if(idx === -1){ closeNotesModal(); return; }
    const value = notesModalInput.value || '';
    stock[idx] = { ...stock[idx], notes: value.trim() };
    try{
      await updateDoc(STATE_REF, { stock });
      showToastMsg('تم حفظ الملاحظات');
      renderAll();
    }catch(err){
      console.error(err);
      showToastMsg('تعذّر حفظ الملاحظات');
    }
    closeNotesModal();
  });

  /* حركة نقل السيارات — نفس منطق صفحة الإدارة */

  // نفس قائمة الأماكن الثابتة
  const FIXED_LOCATIONS = [
    "المستودع : المخزون المتاح","المستودع : سيارات بها ملاحظات","المستودع : مباع تحت التسليم","المستودع : مباع تم التسليم",
    "الوكالة : المخزون المتاح","الوكالة : سيارات بها ملاحظات","الوكالة : مباع تحت التسليم","الوكالة : مباع تم التسليم",
    "فرع 1 الصالة : المخزون المتاح","فرع 1 الصالة : سيارات بها ملاحظات","فرع 1 الصالة : مباع تحت التسليم","فرع 1 الصالة : مباع تم التسليم",
    "فرع 2 الملتقى : المخزون المتاح","فرع 2 الملتقى : سيارات بها ملاحظات","فرع 2 الملتقى : مباع تحت التسليم","فرع 2 الملتقى : مباع تم التسليم",
    "فرع 3 القادسية : المخزون المتاح","فرع 3 القادسية : سيارات بها ملاحظات","فرع 3 القادسية : مباع تحت التسليم","فرع 3 القادسية : مباع تم التسليم"
  ];

  function fillMoveLists(){
    const opts = FIXED_LOCATIONS.map(l=> `<option value="${l}">${l}</option>`).join('');
    moveFromSelects.forEach(sel=> sel.innerHTML=opts);
    moveToSelects.forEach(sel=> sel.innerHTML=opts);
  }

  function renderCarDetails(rec){
    carDetails.innerHTML=`
      <div style="grid-column:1/-1"><b>سيارة:</b> ${rec.car??""}</div>
      <div><b>البيان:</b> ${rec.variant??""}</div>
      <div><b>الوكيل:</b> ${rec.dealer??""}</div>
      <div><b>اللون الخارجي:</b> ${rec.extColor??""}</div>
      <div><b>اللون الداخلي:</b> ${rec.intColor??""}</div>
      <div><b>موديل:</b> ${rec.modelYear??""}</div>
      <div><b>اللوحة:</b> ${rec.plate??""}</div>
      <div><b>المكان:</b> ${rec.location??""}</div>
      <div style="grid-column:1/-1"><b>رقم الهيكل:</b> ${rec.vin??""}</div>
      <div style="grid-column:1/-1"><b>الملاحظات:</b> ${rec.notes??""}</div>`;
    carDetailsHint.textContent = rec.vin ? `رقم الهيكل: ${rec.vin}` : 'لا يوجد رقم هيكل محفوظ لهذه السيارة.';
    carDetailsBox.style.display='block';
  }

  function hideMoveAlert(){
    if(moveAlert){
      moveAlert.style.display='none';
      moveAlertList.innerHTML='';
    }
  }
  function showMoveAlert(type, title, lines){
    if(!moveAlert) return;
    moveAlert.className = 'move-alert ' + (type || 'info');
    moveAlertTitle.textContent = title || 'نتيجة حركة النقل';
    moveAlertList.innerHTML = '';
    (lines || []).forEach(txt=>{
      const li = document.createElement('li');
      li.textContent = txt;
      moveAlertList.appendChild(li);
    });
    moveAlert.style.display = 'flex';
  }

  /* اقتراح VIN حسب البادئة (Prefix) */
  function updateVinSuggestionsForPrefix(rawPrefix){
    if(!vinHints) return;
    const prefix = normalizeVin(rawPrefix||'');
    if(prefix.length < 1){
      vinHints.innerHTML = '';
      return;
    }
    const set = new Set();
    stock.forEach(r=>{
      const v = normalizeVin(r.vin||'');
      if(v && v.startsWith(prefix)) set.add(v);
    });
    const list = Array.from(set).sort().slice(0,30);
    vinHints.innerHTML = list.map(v=>`<option value="${v}"></option>`).join('');
  }

  /* اقتراح المكان "من" لكل سطر عند كتابة VIN */
  function autoFindByVinForIndex(idx, strictMessage=false){
    const inp = moveVinInputs[idx];
    const fromSel = moveFromSelects[idx];
    const vinRaw = (inp.value||'').trim();
    if(!vinRaw){
      fromSel.disabled=false;
      fromSel.value='';
      const anyVin = moveVinInputs.some(i=> normalizeVin(i.value));
      if(!anyVin){
        carDetailsBox.style.display='none';
        moveStatus.textContent='';
      }
      return;
    }
    const norm = normalizeVin(vinRaw);
    let match = stock.find(r => normalizeVin(r.vin) === norm);
    if(!match && norm.length >= 8){
      const candidates = stock.filter(r => normalizeVin(r.vin).startsWith(norm));
      if(candidates.length === 1) match = candidates[0];
    }

    if(match){
      renderCarDetails(match);
      if(match.location){
        fromSel.value = match.location;
        fromSel.disabled = true;
        moveStatus.textContent = `تم العثور على السيارة: ${match.car||''} — المكان الحالي: ${match.location||''}`;
      }else{
        fromSel.disabled=false;
        fromSel.value='';
        moveStatus.textContent = `تم العثور: ${match.car||''} — لا يوجد مكان مسجل. اختر المكان يدويًا.`;
      }
    }else{
      if(strictMessage){
        const msg = 'لم يتم العثور على سيارة بهذا الرقم.';
        moveStatus.textContent = msg;
        carDetailsBox.style.display='none';
        showMoveAlert('error','لم يتم العثور على السيارة',[msg]);
      }else{
        moveStatus.textContent = '— لم يتم التعرف على السيارة بعد (أكمل رقم الهيكل).';
      }
    }
  }

  /* ربط أحداث الـ VIN */
  moveVinInputs.forEach((inp,idx)=>{
    inp.addEventListener('input', debounce(()=>{
      updateVinSuggestionsForPrefix(inp.value);
      autoFindByVinForIndex(idx,false);
    },150));
  });

  /* عرض البيانات لأول VIN غير فارغ */
  btnFindByVin.addEventListener('click',()=>{
    const firstIndex = moveVinInputs.findIndex(inp=> normalizeVin((inp.value||'').trim()));
    if(firstIndex === -1){
      const msg = 'اكتب رقم الهيكل في أي سطر أولًا.';
      moveStatus.textContent = msg;
      showMoveAlert('info','لا يوجد رقم هيكل',[msg]);
      return;
    }
    autoFindByVinForIndex(firstIndex,true);
  });

  /* إظهار/إخفاء بوكس المتطلبات حسب اختيار "إلى" */
  function updateRequirementBoxes(){
    const anyUnderDelivery = moveToSelects.some(sel=> /مباع تحت التسليم/.test(sel.value||''));
    const anyIssuesRow     = moveToSelects.some(sel=> /سيارات بها ملاحظات/.test(sel.value||''));
    underDeliveryBox.style.display = anyUnderDelivery ? 'block' : 'none';
    notesIssuesBox.style.display   = anyIssuesRow ? 'block' : 'none';
  }
  moveToSelects.forEach(sel=>{
    sel.addEventListener('change', updateRequirementBoxes);
  });

  /* تنفيذ النقل المتعدد (نفس منطق الإدارة مع شرط "مباع تم التسليم") */
  btnMove.addEventListener('click', async ()=>{
    hideMoveAlert();

    const rows = moveVinInputs.map((inp,idx)=>({
      vinRaw:(inp.value||'').trim(),
      to:(moveToSelects[idx].value||'').trim(),
      fromSel:moveFromSelects[idx]
    }));
    const rowsWithVin = rows.filter(r=> normalizeVin(r.vinRaw));

    if(!rowsWithVin.length){
      const msg = 'لم يتم إدخال أي رقم هيكل للنقل.';
      moveStatus.textContent = msg;
      showMoveAlert('info','لا توجد حركات نقل', [msg]);
      showToastMsg(msg);
      return;
    }

    const anyIssuesRow = rowsWithVin.some(r=> /سيارات بها ملاحظات/.test(r.to));
    if(anyIssuesRow && !issuesNotes.value.trim()){
      const msg = 'اكتب ملاحظات عند النقل إلى سيارات بها ملاحظات.';
      moveStatus.textContent = msg;
      showMoveAlert('info','ملاحظات مطلوبة', [msg]);
      showToastMsg(msg);
      return;
    }

    let movedCount = 0;
    const errors = [];
    const successLines = [];

    for(const row of rowsWithVin){
      const norm = normalizeVin(row.vinRaw);
      const recIdx = stock.findIndex(r=> normalizeVin(r.vin) === norm);
      if(recIdx === -1){
        errors.push(`لم يتم العثور على سيارة برقم الهيكل: ${row.vinRaw}.`);
        continue;
      }
      const rec = stock[recIdx];
      const toVal = row.to;
      if(!toVal){
        errors.push(`اختر مكان "إلى" للسيارة ${rec.car||''} (${rec.vin||row.vinRaw}).`);
        continue;
      }

      const fromSel = row.fromSel;
      const from   = (fromSel.value || rec.location || '').trim();
      if(!from){
        errors.push(`السيارة ${rec.car||''} (${rec.vin||row.vinRaw}) لا يوجد لها مكان حالي؛ حدّد المكان يدويًا في "من".`);
        continue;
      }
      if(from === toVal){
        errors.push(`السيارة ${rec.car||''} (${rec.vin||row.vinRaw}) موجودة بالفعل في نفس المكان.`);
        continue;
      }

      const goingUnderDeliveryRow = /مباع تحت التسليم/.test(toVal);
      const goingIssuesRow        = /سيارات بها ملاحظات/.test(toVal);
      const goingDeliveredRow     = /مباع تم التسليم/.test(toVal);

      // شرط النقل إلى "مباع تم التسليم" — لازم يكون في حركة سابقة بموافقة مالية + إدارية مكتملة
      if(goingDeliveredRow){
        const history = moves.filter(m=> normalizeVin(m.vin||'') === norm);
        const hasFullApproval = history.some(m=> m.adminApproved===true && m.financeApproved===true);
        if(!hasFullApproval){
          errors.push(`لا يمكن نقل ${rec.car||''} (${rec.vin||row.vinRaw}) إلى "مباع تم التسليم" قبل وجود حركة سابقة بموافقة مالية وإدارية مكتملة.`);
          continue;
        }
      }

      const moveMeta = {
        adminApproved: goingUnderDeliveryRow ? !!chkAdminApproved.checked : null,
        adminNotes:    goingUnderDeliveryRow ? (adminNotes.value||'').trim() : '',
        financeApproved: goingUnderDeliveryRow ? !!chkFinanceApproved.checked : null,
        financeNotes:    goingUnderDeliveryRow ? (financeNotes.value||'').trim() : '',
        issuesNotes:     goingIssuesRow ? (issuesNotes.value||'').trim() : ''
      };

      const oldLoc = rec.location || from;
      rec.location = toVal;
      const stamp = now();
      moves.push({
        when: stamp,
        date: onlyDate(stamp),
        vin: rec.vin||'',
        car: rec.car||'',
        from: oldLoc,
        to: toVal,
        id: rec.id,
        ...moveMeta
      });
      movedCount++;
      successLines.push(`تم نقل ${rec.car||''} (${rec.vin||row.vinRaw}) من "${oldLoc}" إلى "${toVal}".`);
    }

    if(!movedCount){
      const title = 'لم يتم تنفيذ أي حركة نقل';
      const lines = errors.length ? errors : ['لم يتم تنفيذ أي حركة نقل.'];
      moveStatus.textContent = lines[0];
      showMoveAlert('info', title, lines);
      showToastMsg(lines[0]);
      return;
    }

    try{
      await updateDoc(STATE_REF, { stock, moves });
    }catch(e){
      console.error(e);
      const msg = 'تعذّر حفظ حركات النقل في قاعدة البيانات.';
      moveStatus.textContent = msg;
      showMoveAlert('error','خطأ في الحفظ',[msg]);
      showToastMsg(msg);
      return;
    }

    const summary = `تم نقل ${movedCount} سيارة بنجاح.`;
    moveStatus.textContent = summary;
    const allLines = [...successLines];
    if(errors.length){
      allLines.push('— ملاحظات على الحركات التي لم تُنفذ:');
      errors.forEach(e=> allLines.push(e));
    }
    showMoveAlert(errors.length ? 'info' : 'success', 'نتيجة حركة النقل', allLines);
    showToastMsg(summary);

    carDetailsBox.style.display='none';

    moveVinInputs.forEach((inp,index)=>{
      inp.value='';
      const selFrom = moveFromSelects[index];
      selFrom.disabled=false;
      selFrom.value='';
      const selTo = moveToSelects[index];
      selTo.value='';
    });

    chkAdminApproved.checked=false; adminNotes.value='';
    chkFinanceApproved.checked=false; financeNotes.value='';
    issuesNotes.value='';
    underDeliveryBox.style.display='none';
    notesIssuesBox.style.display='none';
    if(vinHints) vinHints.innerHTML='';

    renderAll();
  });

  /* Keyboard helper */
  document.addEventListener('keydown',(e)=>{
    if(e.key==='/'){e.preventDefault(); $('#search').focus();}
  });

  setStatus('warn','جارِ الاتصال…');
</script>
</body>
</html>


